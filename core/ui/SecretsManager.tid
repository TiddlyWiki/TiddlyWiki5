title: $:/SecretsManager
caption: {{$:/language/Secrets/Manager/Caption}}

\whitespace trim

\procedure delete-secret-actions()
<$action-delete-secret $name=<<currentSecret>>/>
<$action-sendmessage $message="tm-notify" $param="$:/language/Notifications/SecretDeleted"/>
\end

\define render-current-secret()
§[secret:$(currentSecret)$]
\end

\procedure lingo-base() $:/language/Secrets/

<div class="tc-secrets-manager">

	<h2>🔐 Secrets Manager</h2>

		<$let state=<<secrets-state>>>

			<!-- State indicator -->
			<div class={{{ tc-secrets-state [[tc-secrets-state-]addsuffix<state>] +[join[ ]] }}}>
				<%if [<state>match[unencrypted]] %>
					<<lingo Unencrypted>>
				<%elseif [<state>match[locked]] %>
					<<lingo Locked>>
				<%elseif [<state>match[unlocked]] %>
					<<lingo Unlocked>>
				<% endif %>
			</div>

			<!-- Actions based on state -->
			<%if [<state>match[unencrypted]] %>
				<div class="tc-secrets-setup">
					<p><<lingo FirstTimePassword>></p>
					<$button class="tc-btn-big-green" actions="<$action-setup-secrets/>">
						<<lingo SetPassword>>
					</$button>
				</div>
			<% endif %>

			<%if [<state>match[locked]] %>
				<div class="tc-secrets-unlock">
					<p><<lingo EnterPassword>></p>
					<$button class="tc-btn-big-green" actions="<$action-unlock-secrets/>">
						<<lingo UnlockVault>>
					</$button>
				</div>
			<% endif %>

			<%if [<state>match[unlocked]] %>
				<div class="tc-secrets-unlocked">

					<!-- Add new secret -->
					<h3>Add New Secret</h3>
					<$secret-manager-input/>

					<!-- List existing secrets -->
					<h3>Existing Secrets</h3>
					<$list filter=<<secrets-list>> variable="currentSecret">
						<div class="tc-secret-item">
							<code class="tc-secret-reference"><<render-current-secret>></code>
							<span class="tc-secret-name"><<currentSecret>></span>
							<$button actions=<<delete-secret-actions>> class="tc-btn-invisible tc-secret-delete">
								{{$:/core/images/delete-button}}
							</$button>
						</div>
					</$list>
					<$list filter="[<secrets>count[]match[0]]">
						<div class="tc-muted">
							<<lingo NoSecrets>>
						</div>
					</$list>
				</div>
			<% endif %>

			<!-- Settings section -->
			<h3>Settings</h3>
			<div class="tc-secrets-settings">
				<label>
					<<lingo AutoLockTimeout>> 
					<$edit-text tiddler="$:/config/SecretsAutoLockTimeout" tag="input" size="5" placeholder="5"/>
				</label>
			<div class="tc-muted tc-settings-note">
				<<lingo AutoLockTimeoutHint>>
			</div>
			<%if [<state>match[unlocked]] %>
				<div class="tc-secrets-password-section">
					<h4><<lingo ChangePassword>></h4>
					<p class="tc-muted"><<lingo ChangePasswordHint>></p>
					<$button class="tc-btn-invisible tc-tiddlylink">
						<$action-change-password/>
						{{$:/core/images/locked-padlock}} Change Vault Password
					</$button>
				</div>
			<% endif %>
		</div>

	</$let>

</div>
