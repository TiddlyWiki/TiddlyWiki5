name: Validate Change Notes

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-changenotes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout base repository (for scripts)
      uses: actions/checkout@v4
      with:
        # Always use the base branch scripts for security
        ref: ${{ github.base_ref }}
        fetch-depth: 0
    
    - name: Fetch PR branch for file comparison
      run: |
        git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
        git fetch origin ${{ github.base_ref }}
    
    - name: Get all changed files in PR
      id: all-files
      uses: tj-actions/changed-files@v47
      with:
        base_sha: ${{ github.event.pull_request.base.sha }}
        sha: ${{ github.event.pull_request.head.sha }}
    
    - name: Get changed note files
      id: changed-files
      uses: tj-actions/changed-files@v47
      with:
        files: |
          editions/*/tiddlers/releasenotes/**/*.tid
        base_sha: ${{ github.event.pull_request.base.sha }}
        sha: ${{ github.event.pull_request.head.sha }}
    
    - name: Check if PR needs change notes
      id: check-needs-notes
      run: |
        # Store files in array to handle special characters
        files=()
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            files+=("$file")
          fi
        done <<< "${{ steps.all-files.outputs.all_changed_files }}"
        
        if node bin/changenote.js check-needs "${files[@]}"; then
          echo "needs_note=true" >> $GITHUB_OUTPUT
        else
          echo "needs_note=false" >> $GITHUB_OUTPUT
        fi
        
        echo "has_notes=${{ steps.changed-files.outputs.any_changed }}" >> $GITHUB_OUTPUT
      shell: bash
    
    - name: Validate change note format
      if: steps.changed-files.outputs.any_changed == 'true'
      id: validate
      continue-on-error: true
      run: |
        # Checkout files from PR branch, handling filenames with special characters
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            git checkout pr-branch -- "$file" 2>/dev/null || true
          fi
        done <<< "${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Store files in array to handle special characters
        files=()
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            files+=("$file")
          fi
        done <<< "${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Run validation and capture output
        validation_output=$(node bin/changenote.js validate "${files[@]}" 2>&1)
        exit_code=$?
        
        echo "$validation_output"
        
        # Check if "No Change Notes or Impact Notes found" appears in output
        if echo "$validation_output" | grep -q "No Change Notes or Impact Notes found"; then
          echo "result=no-notes" >> $GITHUB_OUTPUT
          exit 0
        elif [ $exit_code -eq 0 ]; then
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "result=failure" >> $GITHUB_OUTPUT
          # Save error details if they exist
          if [ -f /tmp/validation_errors.md ]; then
            {
              echo 'errors<<EOF'
              cat /tmp/validation_errors.md
              echo EOF
            } >> $GITHUB_OUTPUT
          elif [ -f ./validation_errors.md ]; then
            {
              echo 'errors<<EOF'
              cat ./validation_errors.md
              echo EOF
            } >> $GITHUB_OUTPUT
          fi
          exit 1
        fi
      shell: bash
    
    - name: Parse change note summaries
      if: steps.changed-files.outputs.any_changed == 'true' && steps.validate.outcome == 'success'
      id: parse-notes
      run: |
        # Store files in array to handle special characters
        files=()
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            files+=("$file")
          fi
        done <<< "${{ steps.changed-files.outputs.all_changed_files }}"
        
        summaries=$(node bin/changenote.js parse "${files[@]}")
        
        {
          echo 'summaries<<EOF'
          echo "$summaries"
          echo EOF
        } >> $GITHUB_OUTPUT
      shell: bash
    
    - name: Find existing bot comment
      if: always()
      uses: peter-evans/find-comment@v3
      id: find-comment
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: 'Change Note Status'
    
    - name: Create or update comment (validation passed)
      if: steps.changed-files.outputs.any_changed == 'true' && steps.validate.outcome == 'success' && steps.check-needs-notes.outputs.needs_note == 'true'
      uses: peter-evans/create-or-update-comment@v5
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          ## ‚úÖ Change Note Status
          
          All change notes are properly formatted and validated!
          
          ${{ steps.parse-notes.outputs.summaries }}
          
          <details>
          <summary>üìñ Change Note Guidelines</summary>
          
          Change notes help track and communicate changes effectively. See the [full documentation](https://tiddlywiki.com/prerelease/#Release%20Notes%20and%20Changes) for details.
          
          </details>
    
    - name: Create or update comment (validation failed)
      if: steps.changed-files.outputs.any_changed == 'true' && steps.validate.outcome == 'failure'
      uses: peter-evans/create-or-update-comment@v5
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          ## ‚ùå Change Note Status
          
          Change note validation failed. Please fix the following issues:
          
          ${{ steps.validate.outputs.errors }}
          
          ---
          
          [Release Notes and Changes](https://tiddlywiki.com/prerelease/#Release%20Notes%20and%20Changes)
    
    - name: Create or update comment (has releasenotes files but no actual notes)
      if: steps.changed-files.outputs.any_changed == 'true' && steps.validate.outputs.result == 'no-notes' && steps.check-needs-notes.outputs.needs_note == 'true'
      uses: peter-evans/create-or-update-comment@v5
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          ## ‚ö†Ô∏è Change Note Status
          
          This PR contains code changes but no Change Notes were found.
          
          Files in `editions/*/tiddlers/releasenotes/` were modified, but none of them are tagged as Change Notes (`$:/tags/ChangeNote`) or Impact Notes (`$:/tags/ImpactNote`).
          
          Please add a properly formatted change note. See the [documentation](https://tiddlywiki.com/prerelease/#Release%20Notes%20and%20Changes) for details.
    
    - name: Create or update comment (missing change note)
      if: steps.check-needs-notes.outputs.needs_note == 'true' && steps.changed-files.outputs.any_changed != 'true'
      uses: peter-evans/create-or-update-comment@v5
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          ## ‚ö†Ô∏è Change Note Status
          
          This PR appears to contain code changes but doesn't include a change note.
          
          Please add a change note by creating a `.tid` file in `editions/tw5.com/tiddlers/releasenotes/<version>/` with the following format:
          
          [Release Notes and Changes](https://tiddlywiki.com/prerelease/#Release%20Notes%20and%20Changes)
          
          Note: If this is a documentation-only change or doesn't require a change note, you can ignore this message.
    
    - name: Create or update comment (doc only - has no notes)
      if: steps.check-needs-notes.outputs.needs_note == 'false' && steps.changed-files.outputs.any_changed != 'true'
      uses: peter-evans/create-or-update-comment@v5
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          ## ‚úÖ Change Note Status
          
          This PR contains documentation or configuration changes that typically don't require a change note.
    
    - name: Create or update comment (doc only - has releasenotes files)
      if: steps.check-needs-notes.outputs.needs_note == 'false' && steps.changed-files.outputs.any_changed == 'true'
      uses: peter-evans/create-or-update-comment@v5
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          ## ‚úÖ Change Note Status
          
          This PR contains documentation or configuration changes (including changes to release notes documentation) that typically don't require a change note.
    
    - name: Fail workflow if validation failed
      if: steps.validate.outcome == 'failure'
      run: |
        echo "::error::Change note validation failed. Please check the PR comment for details."
        exit 1
