"use strict";var e=require("prosemirror-state");const t=e=>"submenu"===e.type?[e.id,...e.elements.map((e=>t(e)))].flat():[e.id],n=e=>{const n=(e=>e.filteredElements.map((e=>t(e))).flat())(e);return n.length!==new Set(n).size},s=e=>"submenu"===e.type?[e,...e.elements.map((e=>s(e)))].flat():[e],r=(e,t)=>(e=>e.elements.map((e=>s(e))).flat())(t).find((t=>t.id===e)),l=(e,t,n="root")=>{let s="root";return t.forEach((t=>{if("submenu"===t.type){t.id===e&&(s=n);const r=t.elements.map((e=>e.id));s=r.includes(e)?t.id:l(e,t.elements,t.id)}t.id===e&&(s=n)})),s},a=(e,t,n)=>e.dispatch(e.state.tr.setMeta(t,n)),o=["Unidentified","Alt","AltGraph","CapsLock","Control","Fn","FnLock","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","Hyper","Meta","NumLock","PageDown","PageUp","Pause","PrintScreen","Redo","ScrollLock","Shift","Super","Symbol","SymbolLock","Enter","Tab","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Home","PageDown","PageUp","Backspace","Clear","Copy","CrSel","Cut","Delete","EraseEof","ExSel","Insert","Paste","Redo","Undo","Accept","Again","Attn","Cancel","ContextMenu","Escape","Execute","Find","Finish","Help","Pause","Play","Props","Select","ZoomIn","ZoomOut","BrightnessDown","BrightnessUp","Eject","LogOff","Power","PowerOff","PrintScreen","Hibernate","Standby","WakeUp","AllCandidates","Alphanumeric","CodeInput","Compose","Convert","Dead","FinalMode","GroupFirst","GroupLast","GroupNext","GroupPrevious","ModeChange","NextCandidate","NonConvert","PreviousCandidate","Process","SingleCandidate","HangulMode","HanjaMode","JunjaMode","Eisu","Hankaku","Hiragana","HiraganaKatakana","KanaMode","KanjiMode","Katakana","Romaji","Zenkaku","ZenkakuHanaku"];var i;!function(e){e.OpenMenu="openMenu",e.CloseMenu="closeMenu",e.Execute="Execute",e.NextItem="NextItem",e.PrevItem="PrevItem",e.inputChange="InputChange",e.addChar="addChar",e.removeChar="removeChar",e.Ignore="Ignore",e.Catch="Catch"}(i||(i={}));const u=e=>{const t=(e=>{const t=l(e.selected,e.filteredElements),n=r(t,e);if("root"===t){const t=e.filteredElements.findIndex((t=>t.id===e.selected))+1;if(t<e.filteredElements.length)return e.filteredElements[t].id}if(n&&"submenu"===n.type){const t=n.elements.findIndex((t=>t.id===e.selected))+1;if(t<n.elements.length)return n.elements[t].id}})(e);return t?Object.assign(Object.assign({},e),{selected:t}):e},c=e=>{const t=(e=>{const t=l(e.selected,e.filteredElements),n=r(t,e);if("root"===t){const t=e.filteredElements.findIndex((t=>t.id===e.selected))-1;if(t>=0)return e.filteredElements[t].id}if(n&&"submenu"===n.type){const t=n.elements.findIndex((t=>t.id===e.selected))-1;if(t>=0)return n.elements[t].id}})(e);return t?Object.assign(Object.assign({},e),{selected:t}):e};var p;exports.SlashMetaTypes=void 0,(p=exports.SlashMetaTypes||(exports.SlashMetaTypes={})).open="open",p.close="close",p.execute="execute",p.nextItem="nextItem",p.prevItem="prevItem",p.openSubMenu="openSubMenu",p.closeSubMenu="closeSubMenu",p.inputChange="inputChange";const d=new e.PluginKey("slash-menu-plugin");exports.SlashMenuKey=d,exports.SlashMenuPlugin=(t,s,p,m,f,h)=>{const y={selected:t[0].id,open:!1,filter:"",ignoredKeys:s?[...o,...s]:o,filteredElements:t.filter((e=>!e.locked)),elements:t};if(n(y))throw new Error("Menu elements must have unique id's!");return new e.Plugin({key:d,props:{handleKeyDown(e,t){const n=e.state,s=d.getState(n);if(!s)return!1;const l=((e,t,n,s,l,a)=>{const o=l||((e=!1)=>({shouldOpen:(t,n,s)=>{const r=s.state,l=r.selection.from<0||r.selection.from>r.doc.content.size?null:r.doc.resolve(r.selection.from),a=null==l?void 0:l.parent,o="paragraph"===(null==a?void 0:a.type.name),i=o&&2===(null==a?void 0:a.nodeSize),u=r.selection.$head.parentOffset,c=r.selection.$head.parent.textContent.slice(u-1,u),p="â€Š"===c||""===c||" "===c;return!t.open&&"/"===n.key&&o&&(i||p||r.selection.from!==r.selection.to&&e)},shouldClose:(e,t)=>e.open&&("/"===t.key||"Escape"===t.key||"Backspace"===t.key)&&0===e.filter.length}))(a),u=r(e.selected,e);if(o.shouldOpen(e,t,n))return i.OpenMenu;if(o.shouldClose(e,t,n))return i.CloseMenu;if(e.open){if("ArrowDown"===t.key)return i.NextItem;if("ArrowUp"===t.key)return i.PrevItem;if("Enter"===t.key||"Tab"===t.key||"ArrowRight"===t.key&&"submenu"===(null==u?void 0:u.type))return i.Execute;if("Escape"===t.key||"Backspace"===t.key&&0===e.filter.length||"ArrowLeft"===t.key&&e.subMenuId)return i.CloseMenu;if(e.filter.length>0&&"Backspace"===t.key)return i.removeChar;if(!s.includes(t.key))return i.addChar;if("ArrowLeft"===t.key||"ArrowRight"===t.key)return i.Catch}return i.Ignore})(s,t,e,y.ignoredKeys,p,m);switch(l){case i.OpenMenu:return a(e,d,{type:exports.SlashMetaTypes.open}),!f;case i.CloseMenu:{if(!s.open)return!1;const{subMenuId:l}=s;if(l){const t=r(l,y),n=null==t?void 0:t.callbackOnClose;(null==t?void 0:t.locked)?a(e,d,{type:exports.SlashMetaTypes.close}):(n&&n(),a(e,d,{type:exports.SlashMetaTypes.closeSubMenu,element:r(l,y)}))}else"/"===t.key?e.dispatch(n.tr.insertText("/").setMeta(d,{type:exports.SlashMetaTypes.close})):a(e,d,{type:exports.SlashMetaTypes.close});return!0}case i.Execute:{const t=r(s.selected,s);return!!t&&("command"===t.type&&(t.command(e),a(e,d,{type:exports.SlashMetaTypes.execute})),"submenu"===t.type&&a(e,d,{type:exports.SlashMetaTypes.openSubMenu,element:t}),!0)}case i.NextItem:return a(e,d,{type:exports.SlashMetaTypes.nextItem}),!0;case i.PrevItem:return a(e,d,{type:exports.SlashMetaTypes.prevItem}),!0;case i.addChar:return a(e,d,{type:exports.SlashMetaTypes.inputChange,filter:s.filter+t.key}),!f;case i.removeChar:{const t=1===s.filter.length?"":s.filter.slice(0,-1);return a(e,d,{type:exports.SlashMetaTypes.inputChange,filter:t}),!f}case i.Catch:return!0;case i.Ignore:default:return!1}}},state:{init:()=>y,apply(e,t){var n;const s=e.getMeta(d);switch(null==s?void 0:s.type){case exports.SlashMetaTypes.open:return Object.assign(Object.assign({},y),{open:!0});case exports.SlashMetaTypes.close:return null==h||h(e,t),(e=>{const t=e.callbackOnClose;return null==t||t(),e})(y);case exports.SlashMetaTypes.execute:return y;case exports.SlashMetaTypes.openSubMenu:return((e,t)=>{const n=t.element;return"submenu"===(null==n?void 0:n.type)?Object.assign(Object.assign({},e),{open:!0,filteredElements:n.elements,selected:n.elements[0].id,subMenuId:n.id}):e})(t,s);case exports.SlashMetaTypes.closeSubMenu:return((e,t,n)=>{const s=t.element,a=s.callbackOnClose;if(a&&a(),"submenu"===(null==s?void 0:s.type)){const t=l(s.id,n.filteredElements);if("root"===t)return Object.assign(Object.assign({},n),{open:!0});const a=r(t,n);return"submenu"!==(null==a?void 0:a.type)?e:Object.assign(Object.assign({},e),{filteredElements:a.elements,selected:a.elements[0].id,subMenuId:t})}return e})(t,s,y);case exports.SlashMetaTypes.nextItem:return u(t);case exports.SlashMetaTypes.prevItem:return c(t);case exports.SlashMetaTypes.inputChange:{const e=s.filter?((e,t)=>{const n=new RegExp(`${t.toLowerCase().replace(/\s/g,"\\s")}`);if(e.subMenuId&&"root"!==e.subMenuId)return r(e.subMenuId,e).elements.filter((e=>null!==e.label.toLowerCase().match(n)));return e.elements.filter((e=>null!==e.label.toLowerCase().match(n)&&!e.locked))})(t,s.filter):y.elements,l=null===(n=null==e?void 0:e[0])||void 0===n?void 0:n.id;return Object.assign(Object.assign({},t),{selected:l||t.selected,filteredElements:e,filter:s.filter||""})}default:return t}}},initialState:y})},exports.defaultIgnoredKeys=o,exports.dispatchWithMeta=a,exports.getElementById=r;
