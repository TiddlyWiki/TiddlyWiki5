"use strict";var e=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-state.js"),t=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-view.js"),r=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-language.js"),n=require("$:/plugins/tiddlywiki/codemirror-6/lib/lezer-common.js");const o=e=>{let{state:t}=e,r=t.doc.lineAt(t.selection.main.from),n=h(e.state,r.from);return n.line?i(e):!!n.block&&f(e)};function s(e,t){return({state:r,dispatch:n})=>{if(r.readOnly)return!1;let o=e(t,r);return!!o&&(n(r.update(o)),!0)}}const i=s(g,0),l=s(g,1),a=s(g,2),c=s(m,0),u=s(m,1),d=s(m,2),f=s((e,t)=>m(e,t,function(e){let t=[];for(let r of e.selection.ranges){let n=e.doc.lineAt(r.from),o=r.to<=n.to?n:e.doc.lineAt(r.to);o.from>n.from&&o.from==r.to&&(o=r.to==n.to+1?n:e.doc.lineAt(r.to-1));let s=t.length-1;s>=0&&t[s].to>n.from?t[s].to=o.to:t.push({from:n.from+/^\s*/.exec(n.text)[0].length,to:o.to})}return t}(t)),0);function h(e,t){let r=e.languageDataAt("commentTokens",t,1);return r.length?r[0]:{}}const p=50;function m(e,t,r=t.selection.ranges){let n=r.map(e=>h(t,e.from).block);if(!n.every(e=>e))return null;let o=r.map((e,r)=>function(e,{open:t,close:r},n,o){let s,i,l=e.sliceDoc(n-p,n),a=e.sliceDoc(o,o+p),c=/\s*$/.exec(l)[0].length,u=/^\s*/.exec(a)[0].length,d=l.length-c;if(l.slice(d-t.length,d)==t&&a.slice(u,u+r.length)==r)return{open:{pos:n-c,margin:c&&1},close:{pos:o+u,margin:u&&1}};o-n<=2*p?s=i=e.sliceDoc(n,o):(s=e.sliceDoc(n,n+p),i=e.sliceDoc(o-p,o));let f=/^\s*/.exec(s)[0].length,h=/\s*$/.exec(i)[0].length,m=i.length-h-r.length;return s.slice(f,f+t.length)==t&&i.slice(m,m+r.length)==r?{open:{pos:n+f+t.length,margin:/\s/.test(s.charAt(f+t.length))?1:0},close:{pos:o-h-r.length,margin:/\s/.test(i.charAt(m-1))?1:0}}:null}(t,n[r],e.from,e.to));if(2!=e&&!o.every(e=>e))return{changes:t.changes(r.map((e,t)=>o[t]?[]:[{from:e.from,insert:n[t].open+" "},{from:e.to,insert:" "+n[t].close}]))};if(1!=e&&o.some(e=>e)){let e=[];for(let t,r=0;r<o.length;r++)if(t=o[r]){let o=n[r],{open:s,close:i}=t;e.push({from:s.pos-o.open.length,to:s.pos+s.margin},{from:i.pos-i.margin,to:i.pos+o.close.length})}return{changes:e}}return null}function g(e,t,r=t.selection.ranges){let n=[],o=-1;for(let{from:e,to:s}of r){let r=n.length,i=1e9,l=h(t,e).line;if(l){for(let r=e;r<=s;){let a=t.doc.lineAt(r);if(a.from>o&&(e==s||s>a.from)){o=a.from;let e=/^\s*/.exec(a.text)[0].length,t=e==a.length,r=a.text.slice(e,e+l.length)==l?e:-1;e<a.text.length&&e<i&&(i=e),n.push({line:a,comment:r,token:l,indent:e,empty:t,single:!1})}r=a.to+1}if(i<1e9)for(let e=r;e<n.length;e++)n[e].indent<n[e].line.text.length&&(n[e].indent=i);n.length==r+1&&(n[r].single=!0)}}if(2!=e&&n.some(e=>e.comment<0&&(!e.empty||e.single))){let e=[];for(let{line:t,token:r,indent:o,empty:s,single:i}of n)!i&&s||e.push({from:t.from+o,insert:r+" "});let r=t.changes(e);return{changes:r,selection:t.selection.map(r,1)}}if(1!=e&&n.some(e=>e.comment>=0)){let e=[];for(let{line:t,comment:r,token:o}of n)if(r>=0){let n=t.from+r,s=n+o.length;" "==t.text[s-t.from]&&s++,e.push({from:n,to:s})}return{changes:e}}return null}const y=e.Annotation.define(),x=e.Annotation.define(),k=e.Facet.define(),w=e.Facet.define({combine:t=>e.combineConfig(t,{minDepth:100,newGroupDelay:500,joinToEvent:(e,t)=>t},{minDepth:Math.max,newGroupDelay:Math.min,joinToEvent:(e,t)=>(r,n)=>e(r,n)||t(r,n)})}),S=e.StateField.define({create:()=>P.empty,update(t,r){let n=r.state.facet(w),o=r.annotation(y);if(o){let e=T.fromTransaction(r,o.selection),s=o.side,i=0==s?t.undone:t.done;return i=e?O(i,i.length,n.minDepth,e):F(i,r.startState.selection),new P(0==s?o.rest:i,0==s?i:o.rest)}let s=r.annotation(x);if("full"!=s&&"before"!=s||(t=t.isolate()),!1===r.annotation(e.Transaction.addToHistory))return r.changes.empty?t:t.addMapping(r.changes.desc);let i=T.fromTransaction(r),l=r.annotation(e.Transaction.time),a=r.annotation(e.Transaction.userEvent);return i?t=t.addChanges(i,l,a,n,r):r.selection&&(t=t.addSelection(r.startState.selection,l,a,n.newGroupDelay)),"full"!=s&&"after"!=s||(t=t.isolate()),t},toJSON:e=>({done:e.done.map(e=>e.toJSON()),undone:e.undone.map(e=>e.toJSON())}),fromJSON:e=>new P(e.done.map(T.fromJSON),e.undone.map(T.fromJSON))});const v=S;function A(e,t){return function({state:r,dispatch:n}){if(!t&&r.readOnly)return!1;let o=r.field(S,!1);if(!o)return!1;let s=o.pop(e,r,t);return!!s&&(n(s),!0)}}const C=A(0,!1),B=A(1,!1),E=A(0,!0),D=A(1,!0);function M(e){return function(t){let r=t.field(S,!1);if(!r)return 0;let n=0==e?r.done:r.undone;return n.length-(n.length&&!n[0].changes?1:0)}}const L=M(0),b=M(1);class T{constructor(e,t,r,n,o){this.changes=e,this.effects=t,this.mapped=r,this.startSelection=n,this.selectionsAfter=o}setSelAfter(e){return new T(this.changes,this.effects,this.mapped,this.startSelection,e)}toJSON(){var e,t,r;return{changes:null===(e=this.changes)||void 0===e?void 0:e.toJSON(),mapped:null===(t=this.mapped)||void 0===t?void 0:t.toJSON(),startSelection:null===(r=this.startSelection)||void 0===r?void 0:r.toJSON(),selectionsAfter:this.selectionsAfter.map(e=>e.toJSON())}}static fromJSON(t){return new T(t.changes&&e.ChangeSet.fromJSON(t.changes),[],t.mapped&&e.ChangeDesc.fromJSON(t.mapped),t.startSelection&&e.EditorSelection.fromJSON(t.startSelection),t.selectionsAfter.map(e.EditorSelection.fromJSON))}static fromTransaction(e,t){let r=V;for(let t of e.startState.facet(k)){let n=t(e);n.length&&(r=r.concat(n))}return!r.length&&e.changes.empty?null:new T(e.changes.invert(e.startState.doc),r,void 0,t||e.startState.selection,V)}static selection(e){return new T(void 0,V,void 0,void 0,e)}}function O(e,t,r,n){let o=t+1>r+20?t-r-1:0,s=e.slice(o,t);return s.push(n),s}function I(e,t){return e.length?t.length?e.concat(t):e:t}const V=[],R=200;function F(e,t){if(e.length){let r=e[e.length-1],n=r.selectionsAfter.slice(Math.max(0,r.selectionsAfter.length-R));return n.length&&n[n.length-1].eq(t)?e:(n.push(t),O(e,e.length-1,1e9,r.setSelAfter(n)))}return[T.selection([t])]}function U(e){let t=e[e.length-1],r=e.slice();return r[e.length-1]=t.setSelAfter(t.selectionsAfter.slice(0,t.selectionsAfter.length-1)),r}function N(e,t){if(!e.length)return e;let r=e.length,n=V;for(;r;){let o=G(e[r-1],t,n);if(o.changes&&!o.changes.empty||o.effects.length){let t=e.slice(0,r);return t[r-1]=o,t}t=o.mapped,r--,n=o.selectionsAfter}return n.length?[T.selection(n)]:V}function G(t,r,n){let o=I(t.selectionsAfter.length?t.selectionsAfter.map(e=>e.map(r)):V,n);if(!t.changes)return T.selection(o);let s=t.changes.map(r),i=r.mapDesc(t.changes,!0),l=t.mapped?t.mapped.composeDesc(i):i;return new T(s,e.StateEffect.mapEffects(t.effects,r),l,t.startSelection.map(i),o)}const J=/^(input\.type|delete)($|\.)/;class P{constructor(e,t,r=0,n=void 0){this.done=e,this.undone=t,this.prevTime=r,this.prevUserEvent=n}isolate(){return this.prevTime?new P(this.done,this.undone):this}addChanges(t,r,n,o,s){let i=this.done,l=i[i.length-1];return i=l&&l.changes&&!l.changes.empty&&t.changes&&(!n||J.test(n))&&(!l.selectionsAfter.length&&r-this.prevTime<o.newGroupDelay&&o.joinToEvent(s,function(e,t){let r=[],n=!1;return e.iterChangedRanges((e,t)=>r.push(e,t)),t.iterChangedRanges((e,t,o,s)=>{for(let e=0;e<r.length;){let t=r[e++],i=r[e++];s>=t&&o<=i&&(n=!0)}}),n}(l.changes,t.changes))||"input.type.compose"==n)?O(i,i.length-1,o.minDepth,new T(t.changes.compose(l.changes),I(e.StateEffect.mapEffects(t.effects,l.changes),l.effects),l.mapped,l.startSelection,V)):O(i,i.length,o.minDepth,t),new P(i,V,r,n)}addSelection(e,t,r,n){let o=this.done.length?this.done[this.done.length-1].selectionsAfter:V;return o.length>0&&t-this.prevTime<n&&r==this.prevUserEvent&&r&&/^select($|\.)/.test(r)&&(s=o[o.length-1],i=e,s.ranges.length==i.ranges.length&&0===s.ranges.filter((e,t)=>e.empty!=i.ranges[t].empty).length)?this:new P(F(this.done,e),this.undone,t,r);var s,i}addMapping(e){return new P(N(this.done,e),N(this.undone,e),this.prevTime,this.prevUserEvent)}pop(e,t,r){let n=0==e?this.done:this.undone;if(0==n.length)return null;let o=n[n.length-1],s=o.selectionsAfter[0]||t.selection;if(r&&o.selectionsAfter.length)return t.update({selection:o.selectionsAfter[o.selectionsAfter.length-1],annotations:y.of({side:e,rest:U(n),selection:s}),userEvent:0==e?"select.undo":"select.redo",scrollIntoView:!0});if(o.changes){let r=1==n.length?V:n.slice(0,n.length-1);return o.mapped&&(r=N(r,o.mapped)),t.update({changes:o.changes,selection:o.startSelection,effects:o.effects,annotations:y.of({side:e,rest:r,selection:s}),filter:!1,userEvent:0==e?"undo":"redo",scrollIntoView:!0})}return null}}P.empty=new P(V,V);const H=[{key:"Mod-z",run:C,preventDefault:!0},{key:"Mod-y",mac:"Mod-Shift-z",run:B,preventDefault:!0},{linux:"Ctrl-Shift-z",run:B,preventDefault:!0},{key:"Mod-u",run:E,preventDefault:!0},{key:"Alt-u",mac:"Mod-Shift-u",run:D,preventDefault:!0}];function W(t,r){return e.EditorSelection.create(t.ranges.map(r),t.mainIndex)}function z(e,t){return e.update({selection:t,scrollIntoView:!0,userEvent:"select"})}function q({state:e,dispatch:t},r){let n=W(e.selection,r);return!n.eq(e.selection,!0)&&(t(z(e,n)),!0)}function $(t,r){return e.EditorSelection.cursor(r?t.to:t.from)}function j(e,t){return q(e,r=>r.empty?e.moveByChar(r,t):$(r,t))}function K(e){return e.textDirectionAt(e.state.selection.main.head)==t.Direction.LTR}const _=e=>j(e,!K(e)),Q=e=>j(e,K(e));function X(t,r,n){let o=r.head,s=t.doc.lineAt(o);return o=o==(n?s.to:s.from)?n?Math.min(t.doc.length,s.to+1):Math.max(0,s.from-1):s.from+e.findClusterBreak(s.text,o-s.from,n),e.EditorSelection.cursor(o,n?-1:1)}function Y(e,t){return q(e,r=>r.empty?X(e.state,r,t):$(r,t))}function Z(e,t){return q(e,r=>r.empty?e.moveByGroup(r,t):$(r,t))}const ee=e=>Z(e,!K(e)),te=e=>Z(e,K(e));function re(t,r,n){let o=t.state.charCategorizer(r),s=o(n),i=s!=e.CharCategory.Space;return t=>{let r=o(t);return r!=e.CharCategory.Space?i&&r==s:(i=!1,!0)}}const ne="undefined"!=typeof Intl&&Intl.Segmenter?new Intl.Segmenter(void 0,{granularity:"word"}):null;function oe(t,r,n){let o=t.state.charCategorizer(r.from),s=e.CharCategory.Space,i=r.from,l=0,a=!1,c=!1,u=!1,d=r=>{if(a)return!1;i+=n?r.length:-r.length;let d,f=o(r);if(f==e.CharCategory.Word&&r.charCodeAt(0)<128&&/[\W_]/.test(r)&&(f=-1),s==e.CharCategory.Space&&(s=f),s!=f)return!1;if(s==e.CharCategory.Word)if(r.toLowerCase()==r){if(!n&&c)return!1;u=!0}else if(u){if(n)return!1;a=!0}else{if(c&&n&&o(d=t.state.sliceDoc(i,i+1))==e.CharCategory.Word&&d.toLowerCase()==d)return!1;c=!0}return l++,!0},f=t.moveByChar(r,n,e=>(d(e),d));if(ne&&s==e.CharCategory.Word&&f.from==r.from+l*(n?1:-1)){let o=Math.min(r.head,f.head),s=Math.max(r.head,f.head),i=t.state.sliceDoc(o,s);if(i.length>1&&/[\u4E00-\uffff]/.test(i)){let t=Array.from(ne.segment(i));if(t.length>1)return n?e.EditorSelection.cursor(r.head+t[1].index,-1):e.EditorSelection.cursor(f.head+t[t.length-1].index,1)}}return f}function se(e,t){return q(e,r=>r.empty?oe(e,r,t):$(r,t))}function ie(e,t,r){if(t.type.prop(r))return!0;let n=t.to-t.from;return n&&(n>2||/[^\s,.;:]/.test(e.sliceDoc(t.from,t.to)))||t.firstChild}function le(t,o,s){let i,l,a=r.syntaxTree(t).resolveInner(o.head),c=s?n.NodeProp.closedBy:n.NodeProp.openedBy;for(let e=o.head;;){let r=s?a.childAfter(e):a.childBefore(e);if(!r)break;ie(t,r,c)?a=r:e=s?r.to:r.from}return l=a.type.prop(c)&&(i=s?r.matchBrackets(t,a.from,1):r.matchBrackets(t,a.to,-1))&&i.matched?s?i.end.to:i.end.from:s?a.to:a.from,e.EditorSelection.cursor(l,s?-1:1)}const ae=e=>q(e,t=>le(e.state,t,!K(e))),ce=e=>q(e,t=>le(e.state,t,K(e)));function ue(e,t){return q(e,r=>{if(!r.empty)return $(r,t);let n=e.moveVertically(r,t);return n.head!=r.head?n:e.moveToLineBoundary(r,t)})}const de=e=>ue(e,!1),fe=e=>ue(e,!0);function he(e){let r,n=e.scrollDOM.clientHeight<e.scrollDOM.scrollHeight-2,o=0,s=0;if(n){for(let r of e.state.facet(t.EditorView.scrollMargins)){let t=r(e);(null==t?void 0:t.top)&&(o=Math.max(null==t?void 0:t.top,o)),(null==t?void 0:t.bottom)&&(s=Math.max(null==t?void 0:t.bottom,s))}r=e.scrollDOM.clientHeight-o-s}else r=(e.dom.ownerDocument.defaultView||window).innerHeight;return{marginTop:o,marginBottom:s,selfScroll:n,height:Math.max(e.defaultLineHeight,r-5)}}function pe(e,r){let n,o=he(e),{state:s}=e,i=W(s.selection,t=>t.empty?e.moveVertically(t,r,o.height):$(t,r));if(i.eq(s.selection))return!1;if(o.selfScroll){let r=e.coordsAtPos(s.selection.main.head),l=e.scrollDOM.getBoundingClientRect(),a=l.top+o.marginTop,c=l.bottom-o.marginBottom;r&&r.top>a&&r.bottom<c&&(n=t.EditorView.scrollIntoView(i.main.head,{y:"start",yMargin:r.top-a}))}return e.dispatch(z(s,i),{effects:n}),!0}const me=e=>pe(e,!1),ge=e=>pe(e,!0);function ye(t,r,n){let o=t.lineBlockAt(r.head),s=t.moveToLineBoundary(r,n);if(s.head==r.head&&s.head!=(n?o.to:o.from)&&(s=t.moveToLineBoundary(r,n,!1)),!n&&s.head==o.from&&o.length){let n=/^\s*/.exec(t.state.sliceDoc(o.from,Math.min(o.from+100,o.to)))[0].length;n&&r.head!=o.from+n&&(s=e.EditorSelection.cursor(o.from+n))}return s}const xe=e=>q(e,t=>ye(e,t,!0)),ke=e=>q(e,t=>ye(e,t,!1)),we=e=>q(e,t=>ye(e,t,!K(e))),Se=e=>q(e,t=>ye(e,t,K(e))),ve=t=>q(t,r=>e.EditorSelection.cursor(t.lineBlockAt(r.head).from,1)),Ae=t=>q(t,r=>e.EditorSelection.cursor(t.lineBlockAt(r.head).to,-1));function Ce(t,n,o){let s=!1,i=W(t.selection,n=>{let i=r.matchBrackets(t,n.head,-1)||r.matchBrackets(t,n.head,1)||n.head>0&&r.matchBrackets(t,n.head-1,1)||n.head<t.doc.length&&r.matchBrackets(t,n.head+1,-1);if(!i||!i.end)return n;s=!0;let l=i.start.from==n.head?i.end.to:i.end.from;return o?e.EditorSelection.range(n.anchor,l):e.EditorSelection.cursor(l)});return!!s&&(n(z(t,i)),!0)}const Be=({state:e,dispatch:t})=>Ce(e,t,!1);function Ee(t,r){let n=W(t.state.selection,t=>{let n=r(t);return e.EditorSelection.range(t.anchor,n.head,n.goalColumn,n.bidiLevel||void 0)});return!n.eq(t.state.selection)&&(t.dispatch(z(t.state,n)),!0)}function De(e,t){return Ee(e,r=>e.moveByChar(r,t))}const Me=e=>De(e,!K(e)),Le=e=>De(e,K(e));function be(e,t){return Ee(e,r=>e.moveByGroup(r,t))}const Te=e=>be(e,!K(e)),Oe=e=>be(e,K(e));function Ie(e,t){return Ee(e,r=>oe(e,r,t))}const Ve=e=>Ee(e,t=>le(e.state,t,!K(e))),Re=e=>Ee(e,t=>le(e.state,t,K(e)));function Fe(e,t){return Ee(e,r=>e.moveVertically(r,t))}const Ue=e=>Fe(e,!1),Ne=e=>Fe(e,!0);function Ge(e,t){return Ee(e,r=>e.moveVertically(r,t,he(e).height))}const Je=e=>Ge(e,!1),Pe=e=>Ge(e,!0),He=e=>Ee(e,t=>ye(e,t,!0)),We=e=>Ee(e,t=>ye(e,t,!1)),ze=e=>Ee(e,t=>ye(e,t,!K(e))),qe=e=>Ee(e,t=>ye(e,t,K(e))),$e=t=>Ee(t,r=>e.EditorSelection.cursor(t.lineBlockAt(r.head).from)),je=t=>Ee(t,r=>e.EditorSelection.cursor(t.lineBlockAt(r.head).to)),Ke=({state:e,dispatch:t})=>(t(z(e,{anchor:0})),!0),_e=({state:e,dispatch:t})=>(t(z(e,{anchor:e.doc.length})),!0),Qe=({state:e,dispatch:t})=>(t(z(e,{anchor:e.selection.main.anchor,head:0})),!0),Xe=({state:e,dispatch:t})=>(t(z(e,{anchor:e.selection.main.anchor,head:e.doc.length})),!0),Ye=({state:e,dispatch:t})=>(t(e.update({selection:{anchor:0,head:e.doc.length},userEvent:"select"})),!0),Ze=({state:t,dispatch:r})=>{let n=xt(t).map(({from:r,to:n})=>e.EditorSelection.range(r,Math.min(n+1,t.doc.length)));return r(t.update({selection:e.EditorSelection.create(n),userEvent:"select"})),!0},et=({state:t,dispatch:n})=>{let o=W(t.selection,n=>{let o=r.syntaxTree(t),s=o.resolveStack(n.from,1);if(n.empty){let e=o.resolveStack(n.from,-1);e.node.from>=s.node.from&&e.node.to<=s.node.to&&(s=e)}for(let t=s;t;t=t.next){let{node:r}=t;if((r.from<n.from&&r.to>=n.to||r.to>n.to&&r.from<=n.from)&&t.next)return e.EditorSelection.range(r.to,r.from)}return n});return!o.eq(t.selection)&&(n(z(t,o)),!0)};function tt(t,r){let{state:n}=t,o=n.selection,s=n.selection.ranges.slice();for(let e of n.selection.ranges){let o=n.doc.lineAt(e.head);if(r?o.to<t.state.doc.length:o.from>0)for(let n=e;;){let e=t.moveVertically(n,r);if(e.head<o.from||e.head>o.to){s.some(t=>t.head==e.head)||s.push(e);break}if(e.head==n.head)break;n=e}}return s.length!=o.ranges.length&&(t.dispatch(z(n,e.EditorSelection.create(s,s.length-1))),!0)}const rt=e=>tt(e,!1),nt=e=>tt(e,!0),ot=({state:t,dispatch:r})=>{let n=t.selection,o=null;return n.ranges.length>1?o=e.EditorSelection.create([n.main]):n.main.empty||(o=e.EditorSelection.create([e.EditorSelection.cursor(n.main.head)])),!!o&&(r(z(t,o)),!0)};function st(r,n){if(r.state.readOnly)return!1;let o="delete.selection",{state:s}=r,i=s.changeByRange(t=>{let{from:s,to:i}=t;if(s==i){let e=n(t);e<s?(o="delete.backward",e=it(r,e,!1)):e>s&&(o="delete.forward",e=it(r,e,!0)),s=Math.min(s,e),i=Math.max(i,e)}else s=it(r,s,!1),i=it(r,i,!0);return s==i?{range:t}:{changes:{from:s,to:i},range:e.EditorSelection.cursor(s,s<t.head?-1:1)}});return!i.changes.empty&&(r.dispatch(s.update(i,{scrollIntoView:!0,userEvent:o,effects:"delete.selection"==o?t.EditorView.announce.of(s.phrase("Selection deleted")):void 0})),!0)}function it(e,r,n){if(e instanceof t.EditorView)for(let o of e.state.facet(t.EditorView.atomicRanges).map(t=>t(e)))o.between(r,r,(e,t)=>{e<r&&t>r&&(r=n?t:e)});return r}const lt=(t,n,o)=>st(t,s=>{let i,l,a=s.from,{state:c}=t,u=c.doc.lineAt(a);if(o&&!n&&a>u.from&&a<u.from+200&&!/[^ \t]/.test(i=u.text.slice(0,a-u.from))){if("\t"==i[i.length-1])return a-1;let t=e.countColumn(i,c.tabSize)%r.getIndentUnit(c)||r.getIndentUnit(c);for(let e=0;e<t&&" "==i[i.length-1-e];e++)a--;l=a}else l=e.findClusterBreak(u.text,a-u.from,n,n)+u.from,l==a&&u.number!=(n?c.doc.lines:1)?l+=n?1:-1:!n&&/[\ufe00-\ufe0f]/.test(u.text.slice(l-u.from,a-u.from))&&(l=e.findClusterBreak(u.text,l-u.from,!1,!1)+u.from);return l}),at=e=>lt(e,!1,!0),ct=e=>lt(e,!0,!1),ut=(t,r)=>st(t,n=>{let o=n.head,{state:s}=t,i=s.doc.lineAt(o),l=s.charCategorizer(o);for(let t=null;;){if(o==(r?i.to:i.from)){o==n.head&&i.number!=(r?s.doc.lines:1)&&(o+=r?1:-1);break}let a=e.findClusterBreak(i.text,o-i.from,r)+i.from,c=i.text.slice(Math.min(o,a)-i.from,Math.max(o,a)-i.from),u=l(c);if(null!=t&&u!=t)break;" "==c&&o==n.head||(t=u),o=a}return o}),dt=e=>ut(e,!1),ft=e=>ut(e,!0),ht=e=>st(e,t=>{let r=e.lineBlockAt(t.head).to;return t.head<r?r:Math.min(e.state.doc.length,t.head+1)}),pt=e=>st(e,t=>{let r=e.moveToLineBoundary(t,!1).head;return t.head>r?r:Math.max(0,t.head-1)}),mt=e=>st(e,t=>{let r=e.moveToLineBoundary(t,!0).head;return t.head<r?r:Math.min(e.state.doc.length,t.head+1)}),gt=({state:t,dispatch:r})=>{if(t.readOnly)return!1;let n=t.changeByRange(t=>({changes:{from:t.from,to:t.to,insert:e.Text.of(["",""])},range:e.EditorSelection.cursor(t.from)}));return r(t.update(n,{scrollIntoView:!0,userEvent:"input"})),!0},yt=({state:t,dispatch:r})=>{if(t.readOnly)return!1;let n=t.changeByRange(r=>{if(!r.empty||0==r.from||r.from==t.doc.length)return{range:r};let n=r.from,o=t.doc.lineAt(n),s=n==o.from?n-1:e.findClusterBreak(o.text,n-o.from,!1)+o.from,i=n==o.to?n+1:e.findClusterBreak(o.text,n-o.from,!0)+o.from;return{changes:{from:s,to:i,insert:t.doc.slice(n,i).append(t.doc.slice(s,n))},range:e.EditorSelection.cursor(i)}});return!n.changes.empty&&(r(t.update(n,{scrollIntoView:!0,userEvent:"move.character"})),!0)};function xt(e){let t=[],r=-1;for(let n of e.selection.ranges){let o=e.doc.lineAt(n.from),s=e.doc.lineAt(n.to);if(n.empty||n.to!=s.from||(s=e.doc.lineAt(n.to-1)),r>=o.number){let e=t[t.length-1];e.to=s.to,e.ranges.push(n)}else t.push({from:o.from,to:s.to,ranges:[n]});r=s.number+1}return t}function kt(t,r,n){if(t.readOnly)return!1;let o=[],s=[];for(let r of xt(t)){if(n?r.to==t.doc.length:0==r.from)continue;let i=t.doc.lineAt(n?r.to+1:r.from-1),l=i.length+1;if(n){o.push({from:r.to,to:i.to},{from:r.from,insert:i.text+t.lineBreak});for(let n of r.ranges)s.push(e.EditorSelection.range(Math.min(t.doc.length,n.anchor+l),Math.min(t.doc.length,n.head+l)))}else{o.push({from:i.from,to:r.from},{from:r.to,insert:t.lineBreak+i.text});for(let t of r.ranges)s.push(e.EditorSelection.range(t.anchor-l,t.head-l))}}return!!o.length&&(r(t.update({changes:o,scrollIntoView:!0,selection:e.EditorSelection.create(s,t.selection.mainIndex),userEvent:"move.line"})),!0)}const wt=({state:e,dispatch:t})=>kt(e,t,!1),St=({state:e,dispatch:t})=>kt(e,t,!0);function vt(e,t,r){if(e.readOnly)return!1;let n=[];for(let t of xt(e))r?n.push({from:t.from,insert:e.doc.slice(t.from,t.to)+e.lineBreak}):n.push({from:t.to,insert:e.lineBreak+e.doc.slice(t.from,t.to)});let o=e.changes(n);return t(e.update({changes:o,selection:e.selection.map(o,r?1:-1),scrollIntoView:!0,userEvent:"input.copyline"})),!0}const At=({state:e,dispatch:t})=>vt(e,t,!1),Ct=({state:e,dispatch:t})=>vt(e,t,!0),Bt=e=>{if(e.state.readOnly)return!1;let{state:t}=e,r=t.changes(xt(t).map(({from:e,to:r})=>(e>0?e--:r<t.doc.length&&r++,{from:e,to:r}))),n=W(t.selection,t=>{let r;if(e.lineWrapping){let n=e.lineBlockAt(t.head),o=e.coordsAtPos(t.head,t.assoc||1);o&&(r=n.bottom+e.documentTop-o.bottom+e.defaultLineHeight/2)}return e.moveVertically(t,!0,r)}).map(r);return e.dispatch({changes:r,selection:n,scrollIntoView:!0,userEvent:"delete.line"}),!0};const Et=Mt(!1),Dt=Mt(!0);function Mt(t){return({state:o,dispatch:s})=>{if(o.readOnly)return!1;let i=o.changeByRange(s=>{let{from:i,to:l}=s,a=o.doc.lineAt(i),c=!t&&i==l&&function(e,t){if(/\(\)|\[\]|\{\}/.test(e.sliceDoc(t-1,t+1)))return{from:t,to:t};let o,s=r.syntaxTree(e).resolveInner(t),i=s.childBefore(t),l=s.childAfter(t);return i&&l&&i.to<=t&&l.from>=t&&(o=i.type.prop(n.NodeProp.closedBy))&&o.indexOf(l.name)>-1&&e.doc.lineAt(i.to).from==e.doc.lineAt(l.from).from&&!/\S/.test(e.sliceDoc(i.to,l.from))?{from:i.to,to:l.from}:null}(o,i);t&&(i=l=(l<=a.to?a:o.doc.lineAt(l)).to);let u=new r.IndentContext(o,{simulateBreak:i,simulateDoubleBreak:!!c}),d=r.getIndentation(u,i);for(null==d&&(d=e.countColumn(/^\s*/.exec(o.doc.lineAt(i).text)[0],o.tabSize));l<a.to&&/\s/.test(a.text[l-a.from]);)l++;c?({from:i,to:l}=c):i>a.from&&i<a.from+100&&!/\S/.test(a.text.slice(0,i))&&(i=a.from);let f=["",r.indentString(o,d)];return c&&f.push(r.indentString(o,u.lineIndent(a.from,-1))),{changes:{from:i,to:l,insert:e.Text.of(f)},range:e.EditorSelection.cursor(i+1+f[1].length)}});return s(o.update(i,{scrollIntoView:!0,userEvent:"input"})),!0}}function Lt(t,r){let n=-1;return t.changeByRange(o=>{let s=[];for(let e=o.from;e<=o.to;){let i=t.doc.lineAt(e);i.number>n&&(o.empty||o.to>i.from)&&(r(i,s,o),n=i.number),e=i.to+1}let i=t.changes(s);return{changes:s,range:e.EditorSelection.range(i.mapPos(o.anchor,1),i.mapPos(o.head,1))}})}const bt=({state:e,dispatch:t})=>{if(e.readOnly)return!1;let n=Object.create(null),o=new r.IndentContext(e,{overrideIndentation:e=>{let t=n[e];return null==t?-1:t}}),s=Lt(e,(t,s,i)=>{let l=r.getIndentation(o,t.from);if(null==l)return;/\S/.test(t.text)||(l=0);let a=/^\s*/.exec(t.text)[0],c=r.indentString(e,l);(a!=c||i.from<t.from+a.length)&&(n[t.from]=l,s.push({from:t.from,to:t.from+a.length,insert:c}))});return s.changes.empty||t(e.update(s,{userEvent:"indent"})),!0},Tt=({state:e,dispatch:t})=>!e.readOnly&&(t(e.update(Lt(e,(t,n)=>{n.push({from:t.from,insert:e.facet(r.indentUnit)})}),{userEvent:"input.indent"})),!0),Ot=({state:t,dispatch:n})=>!t.readOnly&&(n(t.update(Lt(t,(n,o)=>{let s=/^\s*/.exec(n.text)[0];if(!s)return;let i=e.countColumn(s,t.tabSize),l=0,a=r.indentString(t,Math.max(0,i-r.getIndentUnit(t)));for(;l<s.length&&l<a.length&&s.charCodeAt(l)==a.charCodeAt(l);)l++;o.push({from:n.from+l,to:n.from+s.length,insert:a.slice(l)})}),{userEvent:"delete.dedent"})),!0),It=e=>(e.setTabFocusMode(),!0),Vt=[{key:"Ctrl-b",run:_,shift:Me,preventDefault:!0},{key:"Ctrl-f",run:Q,shift:Le},{key:"Ctrl-p",run:de,shift:Ue},{key:"Ctrl-n",run:fe,shift:Ne},{key:"Ctrl-a",run:ve,shift:$e},{key:"Ctrl-e",run:Ae,shift:je},{key:"Ctrl-d",run:ct},{key:"Ctrl-h",run:at},{key:"Ctrl-k",run:ht},{key:"Ctrl-Alt-h",run:dt},{key:"Ctrl-o",run:gt},{key:"Ctrl-t",run:yt},{key:"Ctrl-v",run:ge}],Rt=[{key:"ArrowLeft",run:_,shift:Me,preventDefault:!0},{key:"Mod-ArrowLeft",mac:"Alt-ArrowLeft",run:ee,shift:Te,preventDefault:!0},{mac:"Cmd-ArrowLeft",run:we,shift:ze,preventDefault:!0},{key:"ArrowRight",run:Q,shift:Le,preventDefault:!0},{key:"Mod-ArrowRight",mac:"Alt-ArrowRight",run:te,shift:Oe,preventDefault:!0},{mac:"Cmd-ArrowRight",run:Se,shift:qe,preventDefault:!0},{key:"ArrowUp",run:de,shift:Ue,preventDefault:!0},{mac:"Cmd-ArrowUp",run:Ke,shift:Qe},{mac:"Ctrl-ArrowUp",run:me,shift:Je},{key:"ArrowDown",run:fe,shift:Ne,preventDefault:!0},{mac:"Cmd-ArrowDown",run:_e,shift:Xe},{mac:"Ctrl-ArrowDown",run:ge,shift:Pe},{key:"PageUp",run:me,shift:Je},{key:"PageDown",run:ge,shift:Pe},{key:"Home",run:ke,shift:We,preventDefault:!0},{key:"Mod-Home",run:Ke,shift:Qe},{key:"End",run:xe,shift:He,preventDefault:!0},{key:"Mod-End",run:_e,shift:Xe},{key:"Enter",run:Et,shift:Et},{key:"Mod-a",run:Ye},{key:"Backspace",run:at,shift:at,preventDefault:!0},{key:"Delete",run:ct,preventDefault:!0},{key:"Mod-Backspace",mac:"Alt-Backspace",run:dt,preventDefault:!0},{key:"Mod-Delete",mac:"Alt-Delete",run:ft,preventDefault:!0},{mac:"Mod-Backspace",run:pt,preventDefault:!0},{mac:"Mod-Delete",run:mt,preventDefault:!0}].concat(Vt.map(e=>({mac:e.key,run:e.run,shift:e.shift}))),Ft=[{key:"Alt-ArrowLeft",mac:"Ctrl-ArrowLeft",run:ae,shift:Ve},{key:"Alt-ArrowRight",mac:"Ctrl-ArrowRight",run:ce,shift:Re},{key:"Alt-ArrowUp",run:wt},{key:"Shift-Alt-ArrowUp",run:At},{key:"Alt-ArrowDown",run:St},{key:"Shift-Alt-ArrowDown",run:Ct},{key:"Mod-Alt-ArrowUp",run:rt},{key:"Mod-Alt-ArrowDown",run:nt},{key:"Escape",run:ot},{key:"Mod-Enter",run:Dt},{key:"Alt-l",mac:"Ctrl-l",run:Ze},{key:"Mod-i",run:et,preventDefault:!0},{key:"Mod-[",run:Ot},{key:"Mod-]",run:Tt},{key:"Mod-Alt-\\",run:bt},{key:"Shift-Mod-k",run:Bt},{key:"Shift-Mod-\\",run:Be},{key:"Mod-/",run:o},{key:"Alt-A",run:c},{key:"Ctrl-m",mac:"Shift-Alt-m",run:It}].concat(Rt),Ut={key:"Tab",run:Tt,shift:Ot};exports.addCursorAbove=rt,exports.addCursorBelow=nt,exports.blockComment=u,exports.blockUncomment=d,exports.copyLineDown=Ct,exports.copyLineUp=At,exports.cursorCharBackward=e=>j(e,!1),exports.cursorCharBackwardLogical=e=>Y(e,!1),exports.cursorCharForward=e=>j(e,!0),exports.cursorCharForwardLogical=e=>Y(e,!0),exports.cursorCharLeft=_,exports.cursorCharRight=Q,exports.cursorDocEnd=_e,exports.cursorDocStart=Ke,exports.cursorGroupBackward=e=>Z(e,!1),exports.cursorGroupForward=e=>Z(e,!0),exports.cursorGroupForwardWin=e=>q(e,t=>t.empty?e.moveByChar(t,!0,r=>re(e,t.head,r)):$(t,!0)),exports.cursorGroupLeft=ee,exports.cursorGroupRight=te,exports.cursorLineBoundaryBackward=ke,exports.cursorLineBoundaryForward=xe,exports.cursorLineBoundaryLeft=we,exports.cursorLineBoundaryRight=Se,exports.cursorLineDown=fe,exports.cursorLineEnd=Ae,exports.cursorLineStart=ve,exports.cursorLineUp=de,exports.cursorMatchingBracket=Be,exports.cursorPageDown=ge,exports.cursorPageUp=me,exports.cursorSubwordBackward=e=>se(e,!1),exports.cursorSubwordForward=e=>se(e,!0),exports.cursorSyntaxLeft=ae,exports.cursorSyntaxRight=ce,exports.defaultKeymap=Ft,exports.deleteCharBackward=at,exports.deleteCharBackwardStrict=e=>lt(e,!1,!1),exports.deleteCharForward=ct,exports.deleteGroupBackward=dt,exports.deleteGroupForward=ft,exports.deleteGroupForwardWin=e=>st(e,t=>e.moveByChar(t,!0,r=>re(e,t.head,r)).head),exports.deleteLine=Bt,exports.deleteLineBoundaryBackward=pt,exports.deleteLineBoundaryForward=mt,exports.deleteToLineEnd=ht,exports.deleteToLineStart=e=>st(e,t=>{let r=e.lineBlockAt(t.head).from;return t.head>r?r:Math.max(0,t.head-1)}),exports.deleteTrailingWhitespace=({state:e,dispatch:t})=>{if(e.readOnly)return!1;let r=[];for(let t=0,n="",o=e.doc.iter();;){if(o.next(),o.lineBreak||o.done){let e=n.search(/\s+$/);if(e>-1&&r.push({from:t-(n.length-e),to:t}),o.done)break;n=""}else n=o.value;t+=o.value.length}return!!r.length&&(t(e.update({changes:r,userEvent:"delete"})),!0)},exports.emacsStyleKeymap=Vt,exports.history=function(e={}){return[S,w.of(e),t.EditorView.domEventHandlers({beforeinput(e,t){let r="historyUndo"==e.inputType?C:"historyRedo"==e.inputType?B:null;return!!r&&(e.preventDefault(),r(t))}})]},exports.historyField=v,exports.historyKeymap=H,exports.indentLess=Ot,exports.indentMore=Tt,exports.indentSelection=bt,exports.indentWithTab=Ut,exports.insertBlankLine=Dt,exports.insertNewline=({state:e,dispatch:t})=>(t(e.update(e.replaceSelection(e.lineBreak),{scrollIntoView:!0,userEvent:"input"})),!0),exports.insertNewlineAndIndent=Et,exports.insertNewlineKeepIndent=({state:t,dispatch:r})=>(r(t.update(t.changeByRange(r=>{let n=/^\s*/.exec(t.doc.lineAt(r.from).text)[0];return{changes:{from:r.from,to:r.to,insert:t.lineBreak+n},range:e.EditorSelection.cursor(r.from+n.length+1)}}),{scrollIntoView:!0,userEvent:"input"})),!0),exports.insertTab=({state:e,dispatch:t})=>e.selection.ranges.some(e=>!e.empty)?Tt({state:e,dispatch:t}):(t(e.update(e.replaceSelection("\t"),{scrollIntoView:!0,userEvent:"input"})),!0),exports.invertedEffects=k,exports.isolateHistory=x,exports.lineComment=l,exports.lineUncomment=a,exports.moveLineDown=St,exports.moveLineUp=wt,exports.redo=B,exports.redoDepth=b,exports.redoSelection=D,exports.selectAll=Ye,exports.selectCharBackward=e=>De(e,!1),exports.selectCharBackwardLogical=e=>Ee(e,t=>X(e.state,t,!1)),exports.selectCharForward=e=>De(e,!0),exports.selectCharForwardLogical=e=>Ee(e,t=>X(e.state,t,!0)),exports.selectCharLeft=Me,exports.selectCharRight=Le,exports.selectDocEnd=Xe,exports.selectDocStart=Qe,exports.selectGroupBackward=e=>be(e,!1),exports.selectGroupForward=e=>be(e,!0),exports.selectGroupForwardWin=e=>Ee(e,t=>e.moveByChar(t,!0,r=>re(e,t.head,r))),exports.selectGroupLeft=Te,exports.selectGroupRight=Oe,exports.selectLine=Ze,exports.selectLineBoundaryBackward=We,exports.selectLineBoundaryForward=He,exports.selectLineBoundaryLeft=ze,exports.selectLineBoundaryRight=qe,exports.selectLineDown=Ne,exports.selectLineEnd=je,exports.selectLineStart=$e,exports.selectLineUp=Ue,exports.selectMatchingBracket=({state:e,dispatch:t})=>Ce(e,t,!0),exports.selectPageDown=Pe,exports.selectPageUp=Je,exports.selectParentSyntax=et,exports.selectSubwordBackward=e=>Ie(e,!1),exports.selectSubwordForward=e=>Ie(e,!0),exports.selectSyntaxLeft=Ve,exports.selectSyntaxRight=Re,exports.simplifySelection=ot,exports.splitLine=gt,exports.standardKeymap=Rt,exports.temporarilySetTabFocusMode=e=>(e.setTabFocusMode(2e3),!0),exports.toggleBlockComment=c,exports.toggleBlockCommentByLine=f,exports.toggleComment=o,exports.toggleLineComment=i,exports.toggleTabFocusMode=It,exports.transposeChars=yt,exports.undo=C,exports.undoDepth=L,exports.undoSelection=E;
