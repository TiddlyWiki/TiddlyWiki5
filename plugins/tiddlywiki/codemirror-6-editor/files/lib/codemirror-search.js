"use strict";var e=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-view.js"),t=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-state.js");function r(){var e=arguments[0];"string"==typeof e&&(e=document.createElement(e));var t=1,r=arguments[1];if(r&&"object"==typeof r&&null==r.nodeType&&!Array.isArray(r)){for(var n in r)if(Object.prototype.hasOwnProperty.call(r,n)){var o=r[n];"string"==typeof o?e.setAttribute(n,o):null!=o&&(e[n]=o)}t++}for(;t<arguments.length;t++)i(e,arguments[t]);return e}function i(e,t){if("string"==typeof t)e.appendChild(document.createTextNode(t));else if(null==t);else if(null!=t.nodeType)e.appendChild(t);else{if(!Array.isArray(t))throw new RangeError("Unsupported child node: "+t);for(var r=0;r<t.length;r++)i(e,t[r])}}const n="function"==typeof String.prototype.normalize?e=>e.normalize("NFKD"):e=>e;class o{constructor(e,t,r=0,i=e.length,o,s){this.test=s,this.value={from:0,to:0},this.done=!1,this.matches=[],this.buffer="",this.bufferPos=0,this.iter=e.iterRange(r,i),this.bufferStart=r,this.normalize=o?e=>o(n(e)):n,this.query=this.normalize(t)}peek(){if(this.bufferPos==this.buffer.length){if(this.bufferStart+=this.buffer.length,this.iter.next(),this.iter.done)return-1;this.bufferPos=0,this.buffer=this.iter.value}return t.codePointAt(this.buffer,this.bufferPos)}next(){for(;this.matches.length;)this.matches.pop();return this.nextOverlapping()}nextOverlapping(){for(;;){let e=this.peek();if(e<0)return this.done=!0,this;let r=t.fromCodePoint(e),i=this.bufferStart+this.bufferPos;this.bufferPos+=t.codePointSize(e);let n=this.normalize(r);if(n.length)for(let e=0,t=i;;e++){let o=n.charCodeAt(e),s=this.match(o,t,this.bufferPos+this.bufferStart);if(e==n.length-1){if(s)return this.value=s,this;break}t==i&&e<r.length&&r.charCodeAt(e)==o&&t++}}}match(e,t,r){let i=null;for(let t=0;t<this.matches.length;t+=2){let n=this.matches[t],o=!1;this.query.charCodeAt(n)==e&&(n==this.query.length-1?i={from:this.matches[t+1],to:r}:(this.matches[t]++,o=!0)),o||(this.matches.splice(t,2),t-=2)}return this.query.charCodeAt(0)==e&&(1==this.query.length?i={from:t,to:r}:this.matches.push(1,t)),i&&this.test&&!this.test(i.from,i.to,this.buffer,this.bufferStart)&&(i=null),i}}"undefined"!=typeof Symbol&&(o.prototype[Symbol.iterator]=function(){return this});const s={from:-1,to:-1,match:/.*/.exec("")},l="gm"+(null==/x/.unicode?"":"u");class a{constructor(e,t,r,i=0,n=e.length){if(this.text=e,this.to=n,this.curLine="",this.done=!1,this.value=s,/\\[sWDnr]|\n|\r|\[\^/.test(t))return new u(e,t,r,i,n);this.re=new RegExp(t,l+((null==r?void 0:r.ignoreCase)?"i":"")),this.test=null==r?void 0:r.test,this.iter=e.iter();let o=e.lineAt(i);this.curLineStart=o.from,this.matchPos=f(e,i),this.getLine(this.curLineStart)}getLine(e){this.iter.next(e),this.iter.lineBreak?this.curLine="":(this.curLine=this.iter.value,this.curLineStart+this.curLine.length>this.to&&(this.curLine=this.curLine.slice(0,this.to-this.curLineStart)),this.iter.next())}nextLine(){this.curLineStart=this.curLineStart+this.curLine.length+1,this.curLineStart>this.to?this.curLine="":this.getLine(0)}next(){for(let e=this.matchPos-this.curLineStart;;){this.re.lastIndex=e;let t=this.matchPos<=this.to&&this.re.exec(this.curLine);if(t){let r=this.curLineStart+t.index,i=r+t[0].length;if(this.matchPos=f(this.text,i+(r==i?1:0)),r==this.curLineStart+this.curLine.length&&this.nextLine(),(r<i||r>this.value.to)&&(!this.test||this.test(r,i,t)))return this.value={from:r,to:i,match:t},this;e=this.matchPos-this.curLineStart}else{if(!(this.curLineStart+this.curLine.length<this.to))return this.done=!0,this;this.nextLine(),e=0}}}}const c=new WeakMap;class h{constructor(e,t){this.from=e,this.text=t}get to(){return this.from+this.text.length}static get(e,t,r){let i=c.get(e);if(!i||i.from>=r||i.to<=t){let i=new h(t,e.sliceString(t,r));return c.set(e,i),i}if(i.from==t&&i.to==r)return i;let{text:n,from:o}=i;return o>t&&(n=e.sliceString(t,o)+n,o=t),i.to<r&&(n+=e.sliceString(i.to,r)),c.set(e,new h(o,n)),new h(t,n.slice(t-o,r-o))}}class u{constructor(e,t,r,i,n){this.text=e,this.to=n,this.done=!1,this.value=s,this.matchPos=f(e,i),this.re=new RegExp(t,l+((null==r?void 0:r.ignoreCase)?"i":"")),this.test=null==r?void 0:r.test,this.flat=h.get(e,i,this.chunkEnd(i+5e3))}chunkEnd(e){return e>=this.to?this.to:this.text.lineAt(e).to}next(){for(;;){let e=this.re.lastIndex=this.matchPos-this.flat.from,t=this.re.exec(this.flat.text);if(t&&!t[0]&&t.index==e&&(this.re.lastIndex=e+1,t=this.re.exec(this.flat.text)),t){let e=this.flat.from+t.index,r=e+t[0].length;if((this.flat.to>=this.to||t.index+t[0].length<=this.flat.text.length-10)&&(!this.test||this.test(e,r,t)))return this.value={from:e,to:r,match:t},this.matchPos=f(this.text,r+(e==r?1:0)),this}if(this.flat.to==this.to)return this.done=!0,this;this.flat=h.get(this.text,this.flat.from,this.chunkEnd(this.flat.from+2*this.flat.text.length))}}}function f(e,t){if(t>=e.length)return t;let r,i=e.lineAt(t);for(;t<i.to&&(r=i.text.charCodeAt(t-i.from))>=56320&&r<57344;)t++;return t}"undefined"!=typeof Symbol&&(a.prototype[Symbol.iterator]=u.prototype[Symbol.iterator]=function(){return this});const d=r=>{let{state:i}=r,n=String(i.doc.lineAt(r.state.selection.main.head).number),{close:o,result:s}=e.showDialog(r,{label:i.phrase("Go to line"),input:{type:"text",name:"line",value:n},focus:!0,submitLabel:i.phrase("go")});return s.then(n=>{let s=n&&/^([+-])?(\d+)?(:\d+)?(%)?$/.exec(n.elements.line.value);if(!s)return void r.dispatch({effects:o});let l=i.doc.lineAt(i.selection.main.head),[,a,c,h,u]=s,f=h?+h.slice(1):0,d=c?+c:l.number;if(c&&u){let e=d/100;a&&(e=e*("-"==a?-1:1)+l.number/i.doc.lines),d=Math.round(i.doc.lines*e)}else c&&a&&(d=d*("-"==a?-1:1)+l.number);let p=i.doc.line(Math.max(1,Math.min(i.doc.lines,d))),m=t.EditorSelection.cursor(p.from+Math.max(0,Math.min(f,p.length)));r.dispatch({effects:[o,e.EditorView.scrollIntoView(m.from,{y:"center"})],selection:m})}),!0},p={highlightWordAroundCursor:!1,minSelectionLength:1,maxMatches:100,wholeWords:!1},m=t.Facet.define({combine:e=>t.combineConfig(e,p,{highlightWordAroundCursor:(e,t)=>e||t,minSelectionLength:Math.min,maxMatches:Math.min})});const g=e.Decoration.mark({class:"cm-selectionMatch"}),v=e.Decoration.mark({class:"cm-selectionMatch cm-selectionMatch-main"});function x(e,r,i,n){return!(0!=i&&e(r.sliceDoc(i-1,i))==t.CharCategory.Word||n!=r.doc.length&&e(r.sliceDoc(n,n+1))==t.CharCategory.Word)}function y(e,r,i,n){return e(r.sliceDoc(i,i+1))==t.CharCategory.Word&&e(r.sliceDoc(n-1,n))==t.CharCategory.Word}const w=e.ViewPlugin.fromClass(class{constructor(e){this.decorations=this.getDeco(e)}update(e){(e.selectionSet||e.docChanged||e.viewportChanged)&&(this.decorations=this.getDeco(e.view))}getDeco(t){let r=t.state.facet(m),{state:i}=t,n=i.selection;if(n.ranges.length>1)return e.Decoration.none;let s,l=n.main,a=null;if(l.empty){if(!r.highlightWordAroundCursor)return e.Decoration.none;let t=i.wordAt(l.head);if(!t)return e.Decoration.none;a=i.charCategorizer(l.head),s=i.sliceDoc(t.from,t.to)}else{let t=l.to-l.from;if(t<r.minSelectionLength||t>200)return e.Decoration.none;if(r.wholeWords){if(s=i.sliceDoc(l.from,l.to),a=i.charCategorizer(l.head),!x(a,i,l.from,l.to)||!y(a,i,l.from,l.to))return e.Decoration.none}else if(s=i.sliceDoc(l.from,l.to),!s)return e.Decoration.none}let c=[];for(let n of t.visibleRanges){let t=new o(i.doc,s,n.from,n.to);for(;!t.next().done;){let{from:n,to:o}=t.value;if((!a||x(a,i,n,o))&&(l.empty&&n<=l.from&&o>=l.to?c.push(v.range(n,o)):(n>=l.to||o<=l.from)&&c.push(g.range(n,o)),c.length>r.maxMatches))return e.Decoration.none}}return e.Decoration.set(c)}},{decorations:e=>e.decorations}),S=e.EditorView.baseTheme({".cm-selectionMatch":{backgroundColor:"#99ff7780"},".cm-searchMatch .cm-selectionMatch":{backgroundColor:"transparent"}});const b=({state:r,dispatch:i})=>{let{ranges:n}=r.selection;if(n.some(e=>e.from===e.to))return(({state:e,dispatch:r})=>{let{selection:i}=e,n=t.EditorSelection.create(i.ranges.map(r=>e.wordAt(r.head)||t.EditorSelection.cursor(r.head)),i.mainIndex);return!n.eq(i)&&(r(e.update({selection:n})),!0)})({state:r,dispatch:i});let s=r.sliceDoc(n[0].from,n[0].to);if(r.selection.ranges.some(e=>r.sliceDoc(e.from,e.to)!=s))return!1;let l=function(e,t){let{main:r,ranges:i}=e.selection,n=e.wordAt(r.head),s=n&&n.from==r.from&&n.to==r.to;for(let r=!1,n=new o(e.doc,t,i[i.length-1].to);;){if(n.next(),!n.done){if(r&&i.some(e=>e.from==n.value.from))continue;if(s){let t=e.wordAt(n.value.from);if(!t||t.from!=n.value.from||t.to!=n.value.to)continue}return n.value}if(r)return null;n=new o(e.doc,t,0,Math.max(0,i[i.length-1].from-1)),r=!0}}(r,s);return!!l&&(i(r.update({selection:r.selection.addRange(t.EditorSelection.range(l.from,l.to),!1),effects:e.EditorView.scrollIntoView(l.to)})),!0)},C=t.Facet.define({combine:r=>t.combineConfig(r,{top:!1,caseSensitive:!1,literal:!1,regexp:!1,wholeWord:!1,createPanel:e=>new te(e),scrollToMatch:t=>e.EditorView.scrollIntoView(t)})});class M{constructor(e){this.search=e.search,this.caseSensitive=!!e.caseSensitive,this.literal=!!e.literal,this.regexp=!!e.regexp,this.replace=e.replace||"",this.valid=!!this.search&&(!this.regexp||function(e){try{return new RegExp(e,l),!0}catch(e){return!1}}(this.search)),this.unquoted=this.unquote(this.search),this.wholeWord=!!e.wholeWord,this.test=e.test}unquote(e){return this.literal?e:e.replace(/\\([nrt\\])/g,(e,t)=>"n"==t?"\n":"r"==t?"\r":"t"==t?"\t":"\\")}eq(e){return this.search==e.search&&this.replace==e.replace&&this.caseSensitive==e.caseSensitive&&this.regexp==e.regexp&&this.wholeWord==e.wholeWord&&this.test==e.test}create(){return this.regexp?new F(this):new D(this)}getCursor(e,r=0,i){let n=e.doc?e:t.EditorState.create({doc:e});return null==i&&(i=n.doc.length),this.regexp?L(this,n,r,i):E(this,n,r,i)}}class k{constructor(e){this.spec=e}}function E(e,t,r,i){let n;return e.wholeWord&&(n=q(t.doc,t.charCategorizer(t.selection.main.head))),e.test&&(n=function(e,t,r){return(i,n,o,s)=>{if(r&&!r(i,n,o,s))return!1;let l=i>=s&&n<=s+o.length?o.slice(i-s,n-s):t.doc.sliceString(i,n);return e(l,t,i,n)}}(e.test,t,n)),new o(t.doc,e.unquoted,r,i,e.caseSensitive?void 0:e=>e.toLowerCase(),n)}function q(e,r){return(i,n,o,s)=>((s>i||s+o.length<n)&&(s=Math.max(0,i-2),o=e.sliceString(s,Math.min(e.length,n+2))),!(r(A(o,i-s))==t.CharCategory.Word&&r(W(o,i-s))==t.CharCategory.Word||r(W(o,n-s))==t.CharCategory.Word&&r(A(o,n-s))==t.CharCategory.Word))}class D extends k{constructor(e){super(e)}nextMatch(e,t,r){let i=E(this.spec,e,r,e.doc.length).nextOverlapping();if(i.done){let r=Math.min(e.doc.length,t+this.spec.unquoted.length);i=E(this.spec,e,0,r).nextOverlapping()}return i.done||i.value.from==t&&i.value.to==r?null:i.value}prevMatchInRange(e,t,r){for(let i=r;;){let r=Math.max(t,i-1e4-this.spec.unquoted.length),n=E(this.spec,e,r,i),o=null;for(;!n.nextOverlapping().done;)o=n.value;if(o)return o;if(r==t)return null;i-=1e4}}prevMatch(e,t,r){let i=this.prevMatchInRange(e,0,t);return i||(i=this.prevMatchInRange(e,Math.max(0,r-this.spec.unquoted.length),e.doc.length)),!i||i.from==t&&i.to==r?null:i}getReplacement(e){return this.spec.unquote(this.spec.replace)}matchAll(e,t){let r=E(this.spec,e,0,e.doc.length),i=[];for(;!r.next().done;){if(i.length>=t)return null;i.push(r.value)}return i}highlight(e,t,r,i){let n=E(this.spec,e,Math.max(0,t-this.spec.unquoted.length),Math.min(r+this.spec.unquoted.length,e.doc.length));for(;!n.next().done;)i(n.value.from,n.value.to)}}function L(e,t,r,i){let n;return e.wholeWord&&(n=P(t.charCategorizer(t.selection.main.head))),e.test&&(n=function(e,t,r){return(i,n,o)=>(!r||r(i,n,o))&&e(o[0],t,i,n)}(e.test,t,n)),new a(t.doc,e.search,{ignoreCase:!e.caseSensitive,test:n},r,i)}function A(e,r){return e.slice(t.findClusterBreak(e,r,!1),r)}function W(e,r){return e.slice(r,t.findClusterBreak(e,r))}function P(e){return(r,i,n)=>!n[0].length||(e(A(n.input,n.index))!=t.CharCategory.Word||e(W(n.input,n.index))!=t.CharCategory.Word)&&(e(W(n.input,n.index+n[0].length))!=t.CharCategory.Word||e(A(n.input,n.index+n[0].length))!=t.CharCategory.Word)}class F extends k{nextMatch(e,t,r){let i=L(this.spec,e,r,e.doc.length).next();return i.done&&(i=L(this.spec,e,0,t).next()),i.done?null:i.value}prevMatchInRange(e,t,r){for(let i=1;;i++){let n=Math.max(t,r-1e4*i),o=L(this.spec,e,n,r),s=null;for(;!o.next().done;)s=o.value;if(s&&(n==t||s.from>n+10))return s;if(n==t)return null}}prevMatch(e,t,r){return this.prevMatchInRange(e,0,t)||this.prevMatchInRange(e,r,e.doc.length)}getReplacement(e){return this.spec.unquote(this.spec.replace).replace(/\$([$&]|\d+)/g,(t,r)=>{if("&"==r)return e.match[0];if("$"==r)return"$";for(let t=r.length;t>0;t--){let i=+r.slice(0,t);if(i>0&&i<e.match.length)return e.match[i]+r.slice(t)}return t})}matchAll(e,t){let r=L(this.spec,e,0,e.doc.length),i=[];for(;!r.next().done;){if(i.length>=t)return null;i.push(r.value)}return i}highlight(e,t,r,i){let n=L(this.spec,e,Math.max(0,t-250),Math.min(r+250,e.doc.length));for(;!n.next().done;)i(n.value.from,n.value.to)}}const R=t.StateEffect.define(),I=t.StateEffect.define(),V=t.StateField.define({create:e=>new $(J(e).create(),null),update(e,t){for(let r of t.effects)r.is(R)?e=new $(r.value.create(),e.panel):r.is(I)&&(e=new $(e.query,r.value?U:null));return e},provide:t=>e.showPanel.from(t,e=>e.panel)});class ${constructor(e,t){this.query=e,this.panel=t}}const O=e.Decoration.mark({class:"cm-searchMatch"}),z=e.Decoration.mark({class:"cm-searchMatch cm-searchMatch-selected"}),T=e.ViewPlugin.fromClass(class{constructor(e){this.view=e,this.decorations=this.highlight(e.state.field(V))}update(e){let t=e.state.field(V);(t!=e.startState.field(V)||e.docChanged||e.selectionSet||e.viewportChanged)&&(this.decorations=this.highlight(t))}highlight({query:r,panel:i}){if(!i||!r.spec.valid)return e.Decoration.none;let{view:n}=this,o=new t.RangeSetBuilder;for(let e=0,t=n.visibleRanges,i=t.length;e<i;e++){let{from:s,to:l}=t[e];for(;e<i-1&&l>t[e+1].from-500;)l=t[++e].to;r.highlight(n.state,s,l,(e,t)=>{let r=n.state.selection.ranges.some(r=>r.from==e&&r.to==t);o.add(e,t,r?z:O)})}return o.finish()}},{decorations:e=>e.decorations});function N(e){return t=>{let r=t.state.field(V,!1);return r&&r.query.spec.valid?e(t,r):Z(t)}}const Q=N((e,{query:r})=>{let{to:i}=e.state.selection.main,n=r.nextMatch(e.state,i,i);if(!n)return!1;let o=t.EditorSelection.single(n.from,n.to),s=e.state.facet(C);return e.dispatch({selection:o,effects:[oe(e,n),s.scrollToMatch(o.main,e)],userEvent:"select.search"}),Y(e),!0}),j=N((e,{query:r})=>{let{state:i}=e,{from:n}=i.selection.main,o=r.prevMatch(i,n,n);if(!o)return!1;let s=t.EditorSelection.single(o.from,o.to),l=e.state.facet(C);return e.dispatch({selection:s,effects:[oe(e,o),l.scrollToMatch(s.main,e)],userEvent:"select.search"}),Y(e),!0}),B=N((e,{query:r})=>{let i=r.matchAll(e.state,1e3);return!(!i||!i.length)&&(e.dispatch({selection:t.EditorSelection.create(i.map(e=>t.EditorSelection.range(e.from,e.to))),userEvent:"select.search.matches"}),!0)}),K=({state:e,dispatch:r})=>{let i=e.selection;if(i.ranges.length>1||i.main.empty)return!1;let{from:n,to:s}=i.main,l=[],a=0;for(let r=new o(e.doc,e.sliceDoc(n,s));!r.next().done;){if(l.length>1e3)return!1;r.value.from==n&&(a=l.length),l.push(t.EditorSelection.range(r.value.from,r.value.to))}return r(e.update({selection:t.EditorSelection.create(l,a),userEvent:"select.search.matches"})),!0},G=N((r,{query:i})=>{let{state:n}=r,{from:o,to:s}=n.selection.main;if(n.readOnly)return!1;let l=i.nextMatch(n,o,o);if(!l)return!1;let a,c,h=l,u=[],f=[];h.from==o&&h.to==s&&(c=n.toText(i.getReplacement(h)),u.push({from:h.from,to:h.to,insert:c}),h=i.nextMatch(n,h.from,h.to),f.push(e.EditorView.announce.of(n.phrase("replaced match on line $",n.doc.lineAt(o).number)+".")));let d=r.state.changes(u);return h&&(a=t.EditorSelection.single(h.from,h.to).map(d),f.push(oe(r,h)),f.push(n.facet(C).scrollToMatch(a.main,r))),r.dispatch({changes:d,selection:a,effects:f,userEvent:"input.replace"}),!0}),H=N((t,{query:r})=>{if(t.state.readOnly)return!1;let i=r.matchAll(t.state,1e9).map(e=>{let{from:t,to:i}=e;return{from:t,to:i,insert:r.getReplacement(e)}});if(!i.length)return!1;let n=t.state.phrase("replaced $ matches",i.length)+".";return t.dispatch({changes:i,effects:e.EditorView.announce.of(n),userEvent:"input.replace.all"}),!0});function U(e){return e.state.facet(C).createPanel(e)}function J(e,t){var r,i,n,o,s;let l=e.selection.main,a=l.empty||l.to>l.from+100?"":e.sliceDoc(l.from,l.to);if(t&&!a)return t;let c=e.facet(C);return new M({search:(null!==(r=null==t?void 0:t.literal)&&void 0!==r?r:c.literal)?a:a.replace(/\n/g,"\\n"),caseSensitive:null!==(i=null==t?void 0:t.caseSensitive)&&void 0!==i?i:c.caseSensitive,literal:null!==(n=null==t?void 0:t.literal)&&void 0!==n?n:c.literal,regexp:null!==(o=null==t?void 0:t.regexp)&&void 0!==o?o:c.regexp,wholeWord:null!==(s=null==t?void 0:t.wholeWord)&&void 0!==s?s:c.wholeWord})}function X(t){let r=e.getPanel(t,U);return r&&r.dom.querySelector("[main-field]")}function Y(e){let t=X(e);t&&t==e.root.activeElement&&t.select()}const Z=e=>{let r=e.state.field(V,!1);if(r&&r.panel){let t=X(e);if(t&&t!=e.root.activeElement){let i=J(e.state,r.query.spec);i.valid&&e.dispatch({effects:R.of(i)}),t.focus(),t.select()}}else e.dispatch({effects:[I.of(!0),r?R.of(J(e.state,r.query.spec)):t.StateEffect.appendConfig.of(le)]});return!0},_=t=>{let r=t.state.field(V,!1);if(!r||!r.panel)return!1;let i=e.getPanel(t,U);return i&&i.dom.contains(t.root.activeElement)&&t.focus(),t.dispatch({effects:I.of(!1)}),!0},ee=[{key:"Mod-f",run:Z,scope:"editor search-panel"},{key:"F3",run:Q,shift:j,scope:"editor search-panel",preventDefault:!0},{key:"Mod-g",run:Q,shift:j,scope:"editor search-panel",preventDefault:!0},{key:"Escape",run:_,scope:"editor search-panel"},{key:"Mod-Shift-l",run:K},{key:"Mod-Alt-g",run:d},{key:"Mod-d",run:b,preventDefault:!0}];class te{constructor(e){this.view=e;let t=this.query=e.state.field(V).query.spec;function i(e,t,i){return r("button",{class:"cm-button",name:e,onclick:t,type:"button"},i)}this.commit=this.commit.bind(this),this.searchField=r("input",{value:t.search,placeholder:re(e,"Find"),"aria-label":re(e,"Find"),class:"cm-textfield",name:"search",form:"","main-field":"true",onchange:this.commit,onkeyup:this.commit}),this.replaceField=r("input",{value:t.replace,placeholder:re(e,"Replace"),"aria-label":re(e,"Replace"),class:"cm-textfield",name:"replace",form:"",onchange:this.commit,onkeyup:this.commit}),this.caseField=r("input",{type:"checkbox",name:"case",form:"",checked:t.caseSensitive,onchange:this.commit}),this.reField=r("input",{type:"checkbox",name:"re",form:"",checked:t.regexp,onchange:this.commit}),this.wordField=r("input",{type:"checkbox",name:"word",form:"",checked:t.wholeWord,onchange:this.commit}),this.dom=r("div",{onkeydown:e=>this.keydown(e),class:"cm-search"},[this.searchField,i("next",()=>Q(e),[re(e,"next")]),i("prev",()=>j(e),[re(e,"previous")]),i("select",()=>B(e),[re(e,"all")]),r("label",null,[this.caseField,re(e,"match case")]),r("label",null,[this.reField,re(e,"regexp")]),r("label",null,[this.wordField,re(e,"by word")]),...e.state.readOnly?[]:[r("br"),this.replaceField,i("replace",()=>G(e),[re(e,"replace")]),i("replaceAll",()=>H(e),[re(e,"replace all")])],r("button",{name:"close",onclick:()=>_(e),"aria-label":re(e,"close"),type:"button"},["Ã—"])])}commit(){let e=new M({search:this.searchField.value,caseSensitive:this.caseField.checked,regexp:this.reField.checked,wholeWord:this.wordField.checked,replace:this.replaceField.value});e.eq(this.query)||(this.query=e,this.view.dispatch({effects:R.of(e)}))}keydown(t){e.runScopeHandlers(this.view,t,"search-panel")?t.preventDefault():13==t.keyCode&&t.target==this.searchField?(t.preventDefault(),(t.shiftKey?j:Q)(this.view)):13==t.keyCode&&t.target==this.replaceField&&(t.preventDefault(),G(this.view))}update(e){for(let t of e.transactions)for(let e of t.effects)e.is(R)&&!e.value.eq(this.query)&&this.setQuery(e.value)}setQuery(e){this.query=e,this.searchField.value=e.search,this.replaceField.value=e.replace,this.caseField.checked=e.caseSensitive,this.reField.checked=e.regexp,this.wordField.checked=e.wholeWord}mount(){this.searchField.select()}get pos(){return 80}get top(){return this.view.state.facet(C).top}}function re(e,t){return e.state.phrase(t)}const ie=30,ne=/[\s\.,:;?!]/;function oe(t,{from:r,to:i}){let n=t.state.doc.lineAt(r),o=t.state.doc.lineAt(i).to,s=Math.max(n.from,r-ie),l=Math.min(o,i+ie),a=t.state.sliceDoc(s,l);if(s!=n.from)for(let e=0;e<ie;e++)if(!ne.test(a[e+1])&&ne.test(a[e])){a=a.slice(e);break}if(l!=o)for(let e=a.length-1;e>a.length-ie;e--)if(!ne.test(a[e-1])&&ne.test(a[e])){a=a.slice(0,e);break}return e.EditorView.announce.of(`${t.state.phrase("current match")}. ${a} ${t.state.phrase("on line")} ${n.number}.`)}const se=e.EditorView.baseTheme({".cm-panel.cm-search":{padding:"2px 6px 4px",position:"relative","& [name=close]":{position:"absolute",top:"0",right:"4px",backgroundColor:"inherit",border:"none",font:"inherit",padding:0,margin:0},"& input, & button, & label":{margin:".2em .6em .2em 0"},"& input[type=checkbox]":{marginRight:".2em"},"& label":{fontSize:"80%",whiteSpace:"pre"}},"&light .cm-searchMatch":{backgroundColor:"#ffff0054"},"&dark .cm-searchMatch":{backgroundColor:"#00ffff8a"},"&light .cm-searchMatch-selected":{backgroundColor:"#ff6a0054"},"&dark .cm-searchMatch-selected":{backgroundColor:"#ff00ff8a"}}),le=[V,t.Prec.low(T),se];exports.RegExpCursor=a,exports.SearchCursor=o,exports.SearchQuery=M,exports.closeSearchPanel=_,exports.findNext=Q,exports.findPrevious=j,exports.getSearchQuery=function(e){let t=e.field(V,!1);return t?t.query.spec:J(e)},exports.gotoLine=d,exports.highlightSelectionMatches=function(e){let t=[S,w];return e&&t.push(m.of(e)),t},exports.openSearchPanel=Z,exports.replaceAll=H,exports.replaceNext=G,exports.search=function(e){return e?[C.of(e),le]:le},exports.searchKeymap=ee,exports.searchPanelOpen=function(e){var t;return null!=(null===(t=e.field(V,!1))||void 0===t?void 0:t.panel)},exports.selectMatches=B,exports.selectNextOccurrence=b,exports.selectSelectionMatches=K,exports.setSearchQuery=R;
