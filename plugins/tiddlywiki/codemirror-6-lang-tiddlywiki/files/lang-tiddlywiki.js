/*\
title: $:/plugins/tiddlywiki/codemirror-6/plugins/lang-tiddlywiki/lang-tiddlywiki.js
type: application/javascript
module-type: library

TiddlyWiki5 language support for CodeMirror 6 - library module
Built with Rollup - DO NOT EDIT DIRECTLY

Note: The plugin wrapper is in plugin.js, this is the library it uses.

@license MIT
\*/
"use strict";var e,t,n=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-state.js"),s=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-view.js"),i=require("$:/plugins/tiddlywiki/codemirror-6/lib/lezer-common.js"),r=require("$:/plugins/tiddlywiki/codemirror-6/lib/lezer-highlight.js"),a=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-language.js"),o=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-autocomplete.js"),l=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-lang-html.js"),c=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-commands.js");function d(e){return e===t.Space||e===t.Tab}!function(e){e[e.Document=1]="Document",e[e.Pragma=2]="Pragma",e[e.PragmaMark=3]="PragmaMark",e[e.PragmaKeyword=4]="PragmaKeyword",e[e.PragmaName=5]="PragmaName",e[e.PragmaParams=6]="PragmaParams",e[e.PragmaBody=7]="PragmaBody",e[e.PragmaEnd=8]="PragmaEnd",e[e.MacroDefinition=9]="MacroDefinition",e[e.ProcedureDefinition=10]="ProcedureDefinition",e[e.FunctionDefinition=11]="FunctionDefinition",e[e.WidgetDefinition=12]="WidgetDefinition",e[e.RulesPragma=13]="RulesPragma",e[e.ImportPragma=14]="ImportPragma",e[e.ParametersPragma=15]="ParametersPragma",e[e.WhitespacePragma=16]="WhitespacePragma",e[e.Paragraph=17]="Paragraph",e[e.Heading1=18]="Heading1",e[e.Heading2=19]="Heading2",e[e.Heading3=20]="Heading3",e[e.Heading4=21]="Heading4",e[e.Heading5=22]="Heading5",e[e.Heading6=23]="Heading6",e[e.HeadingMark=24]="HeadingMark",e[e.BulletList=25]="BulletList",e[e.OrderedList=26]="OrderedList",e[e.DefinitionList=27]="DefinitionList",e[e.ListItem=28]="ListItem",e[e.DefinitionTerm=29]="DefinitionTerm",e[e.DefinitionDescription=30]="DefinitionDescription",e[e.ListMark=31]="ListMark",e[e.BlockQuote=32]="BlockQuote",e[e.QuoteMark=33]="QuoteMark",e[e.BlockQuoteClass=34]="BlockQuoteClass",e[e.Table=35]="Table",e[e.TableHeader=36]="TableHeader",e[e.TableBody=37]="TableBody",e[e.TableFooter=38]="TableFooter",e[e.TableCaption=39]="TableCaption",e[e.TableRow=40]="TableRow",e[e.TableCell=41]="TableCell",e[e.TableHeaderCell=42]="TableHeaderCell",e[e.TableDelimiter=43]="TableDelimiter",e[e.TableClass=44]="TableClass",e[e.TableMarker=45]="TableMarker",e[e.FencedCode=46]="FencedCode",e[e.CodeMark=47]="CodeMark",e[e.CodeInfo=48]="CodeInfo",e[e.CodeText=49]="CodeText",e[e.PlainText=50]="PlainText",e[e.TypedBlock=51]="TypedBlock",e[e.TypedBlockMark=52]="TypedBlockMark",e[e.TypedBlockType=53]="TypedBlockType",e[e.HardLineBreaks=54]="HardLineBreaks",e[e.HardLineBreaksMark=55]="HardLineBreaksMark",e[e.KaTeXBlock=56]="KaTeXBlock",e[e.KaTeXMark=57]="KaTeXMark",e[e.LaTeXContent=58]="LaTeXContent",e[e.HorizontalRule=59]="HorizontalRule",e[e.CommentBlock=60]="CommentBlock",e[e.CommentMarker=61]="CommentMarker",e[e.HTMLBlock=62]="HTMLBlock",e[e.HTMLEndTag=63]="HTMLEndTag",e[e.Widget=64]="Widget",e[e.WidgetEnd=65]="WidgetEnd",e[e.WidgetName=66]="WidgetName",e[e.TagName=67]="TagName",e[e.TagMark=68]="TagMark",e[e.TagAttributes=69]="TagAttributes",e[e.Attribute=70]="Attribute",e[e.AttributeName=71]="AttributeName",e[e.AttributeValue=72]="AttributeValue",e[e.AttributeString=73]="AttributeString",e[e.AttributeNumber=74]="AttributeNumber",e[e.AttributeIndirect=75]="AttributeIndirect",e[e.AttributeFiltered=76]="AttributeFiltered",e[e.AttributeMacro=77]="AttributeMacro",e[e.AttributeSubstituted=78]="AttributeSubstituted",e[e.AttributeParamRef=79]="AttributeParamRef",e[e.AttributeWikitext=80]="AttributeWikitext",e[e.SelfClosingMarker=81]="SelfClosingMarker",e[e.TransclusionBlock=82]="TransclusionBlock",e[e.FilteredTransclusionBlock=83]="FilteredTransclusionBlock",e[e.MacroCallBlock=84]="MacroCallBlock",e[e.Bold=85]="Bold",e[e.BoldMark=86]="BoldMark",e[e.Italic=87]="Italic",e[e.ItalicMark=88]="ItalicMark",e[e.Underline=89]="Underline",e[e.UnderlineMark=90]="UnderlineMark",e[e.Strikethrough=91]="Strikethrough",e[e.StrikethroughMark=92]="StrikethroughMark",e[e.Superscript=93]="Superscript",e[e.SuperscriptMark=94]="SuperscriptMark",e[e.Subscript=95]="Subscript",e[e.SubscriptMark=96]="SubscriptMark",e[e.Highlight=97]="Highlight",e[e.HighlightMark=98]="HighlightMark",e[e.HighlightStyles=99]="HighlightStyles",e[e.InlineCode=100]="InlineCode",e[e.InlineCodeMark=101]="InlineCodeMark",e[e.WikiLink=102]="WikiLink",e[e.WikiLinkMark=103]="WikiLinkMark",e[e.LinkText=104]="LinkText",e[e.LinkSeparator=105]="LinkSeparator",e[e.LinkTarget=106]="LinkTarget",e[e.ExternalLink=107]="ExternalLink",e[e.ExtLinkMark=108]="ExtLinkMark",e[e.ImageLink=109]="ImageLink",e[e.ImageMark=110]="ImageMark",e[e.ImageSource=111]="ImageSource",e[e.ImageWidth=112]="ImageWidth",e[e.ImageHeight=113]="ImageHeight",e[e.ImageClass=114]="ImageClass",e[e.ImageAlt=115]="ImageAlt",e[e.ImageTooltip=116]="ImageTooltip",e[e.CamelCaseLink=117]="CamelCaseLink",e[e.SystemLink=118]="SystemLink",e[e.URLLink=119]="URLLink",e[e.Transclusion=120]="Transclusion",e[e.TransclusionMark=121]="TransclusionMark",e[e.TransclusionTarget=122]="TransclusionTarget",e[e.TransclusionFieldMark=123]="TransclusionFieldMark",e[e.TransclusionField=124]="TransclusionField",e[e.TransclusionIndexMark=125]="TransclusionIndexMark",e[e.TransclusionIndex=126]="TransclusionIndex",e[e.TransclusionTemplate=127]="TransclusionTemplate",e[e.FilteredTransclusion=128]="FilteredTransclusion",e[e.FilteredTransclusionMark=129]="FilteredTransclusionMark",e[e.FilterExpression=130]="FilterExpression",e[e.MacroCall=131]="MacroCall",e[e.MacroCallMark=132]="MacroCallMark",e[e.MacroName=133]="MacroName",e[e.MacroParam=134]="MacroParam",e[e.MacroParamName=135]="MacroParamName",e[e.MacroParamValue=136]="MacroParamValue",e[e.InlineWidget=137]="InlineWidget",e[e.HTMLTag=138]="HTMLTag",e[e.OpenTag=139]="OpenTag",e[e.CloseTag=140]="CloseTag",e[e.Escape=141]="Escape",e[e.Entity=142]="Entity",e[e.HardBreak=143]="HardBreak",e[e.Dash=144]="Dash",e[e.InvalidWidget=145]="InvalidWidget",e[e.IncompleteWidget=146]="IncompleteWidget",e[e.IncompleteHTMLTag=147]="IncompleteHTMLTag",e[e.IncompleteHTMLBlock=148]="IncompleteHTMLBlock",e[e.Variable=149]="Variable",e[e.VariableMark=150]="VariableMark",e[e.VariableName=151]="VariableName",e[e.FilterSubstitution=152]="FilterSubstitution",e[e.FilterSubstitutionMark=153]="FilterSubstitutionMark",e[e.Placeholder=154]="Placeholder",e[e.PlaceholderMark=155]="PlaceholderMark",e[e.SubstitutedParam=156]="SubstitutedParam",e[e.SubstitutedParamMark=157]="SubstitutedParamMark",e[e.SubstitutedParamName=158]="SubstitutedParamName",e[e.FilterRun=159]="FilterRun",e[e.FilterOperator=160]="FilterOperator",e[e.FilterOperatorName=161]="FilterOperatorName",e[e.FilterOperand=162]="FilterOperand",e[e.FilterVariable=163]="FilterVariable",e[e.FilterTextRef=164]="FilterTextRef",e[e.FilterRegexp=165]="FilterRegexp",e[e.IncompleteFilterRun=166]="IncompleteFilterRun",e[e.StyledBlock=167]="StyledBlock",e[e.StyledBlockMark=168]="StyledBlockMark",e[e.StyledBlockClass=169]="StyledBlockClass",e[e.ConditionalBlock=170]="ConditionalBlock",e[e.Conditional=171]="Conditional",e[e.ConditionalMark=172]="ConditionalMark",e[e.ConditionalKeyword=173]="ConditionalKeyword",e[e.ConditionalBranch=174]="ConditionalBranch",e[e.Text=175]="Text",e[e.ProcessingInstruction=176]="ProcessingInstruction",e[e.Mark=177]="Mark"}(e||(e={})),new Set([e.Document,e.Pragma,e.MacroDefinition,e.ProcedureDefinition,e.FunctionDefinition,e.WidgetDefinition,e.RulesPragma,e.ImportPragma,e.ParametersPragma,e.WhitespacePragma,e.Paragraph,e.Heading1,e.Heading2,e.Heading3,e.Heading4,e.Heading5,e.Heading6,e.BulletList,e.OrderedList,e.DefinitionList,e.ListItem,e.DefinitionTerm,e.DefinitionDescription,e.BlockQuote,e.Table,e.TableHeader,e.TableBody,e.TableFooter,e.TableCaption,e.TableRow,e.FencedCode,e.TypedBlock,e.HardLineBreaks,e.HorizontalRule,e.CommentBlock,e.HTMLBlock,e.IncompleteHTMLBlock,e.Widget,e.IncompleteWidget,e.TransclusionBlock,e.FilteredTransclusionBlock,e.MacroCallBlock]),new Set([e.Document,e.MacroDefinition,e.ProcedureDefinition,e.FunctionDefinition,e.WidgetDefinition,e.BulletList,e.OrderedList,e.DefinitionList,e.BlockQuote,e.Table,e.TableHeader,e.TableBody,e.TableFooter,e.Widget,e.HTMLBlock]),function(e){e[e.Space=32]="Space",e[e.Tab=9]="Tab",e[e.Newline=10]="Newline",e[e.CarriageReturn=13]="CarriageReturn",e[e.Backslash=92]="Backslash",e[e.Exclamation=33]="Exclamation",e[e.Hash=35]="Hash",e[e.Dollar=36]="Dollar",e[e.Percent=37]="Percent",e[e.Ampersand=38]="Ampersand",e[e.Apostrophe=39]="Apostrophe",e[e.LeftParen=40]="LeftParen",e[e.RightParen=41]="RightParen",e[e.Asterisk=42]="Asterisk",e[e.Plus=43]="Plus",e[e.Comma=44]="Comma",e[e.Dash=45]="Dash",e[e.Dot=46]="Dot",e[e.Slash=47]="Slash",e[e.Colon=58]="Colon",e[e.Semicolon=59]="Semicolon",e[e.LessThan=60]="LessThan",e[e.Equals=61]="Equals",e[e.GreaterThan=62]="GreaterThan",e[e.Question=63]="Question",e[e.At=64]="At",e[e.LeftBracket=91]="LeftBracket",e[e.RightBracket=93]="RightBracket",e[e.Caret=94]="Caret",e[e.Underscore=95]="Underscore",e[e.Backtick=96]="Backtick",e[e.LeftBrace=123]="LeftBrace",e[e.Pipe=124]="Pipe",e[e.RightBrace=125]="RightBrace",e[e.Tilde=126]="Tilde"}(t||(t={}));class f{constructor(e,t,n,s=[]){this.type=e,this.from=t,this.to=n,this.children=s}}function u(e,t,n,s){return new f(e,t,n,s)}class h{constructor(){this.text="",this.baseIndent=0,this.basePos=0,this.depth=0,this.markers=[],this.pos=0,this.indent=0,this.next=-1,this.skipPos=0,this.skipNext=-1}skipSpace(e){let t=e;for(;t<this.text.length;){if(!d(this.text.charCodeAt(t)))break;t++}return t}moveBase(e){this.basePos=e,this.baseIndent=this.countIndent(e,this.text.length)}moveBaseColumn(e){this.moveBase(this.findColumn(e))}addMarker(e){this.markers.push(e)}countIndent(e,n=0,s=0){for(let i=n;i<e;i++){const e=this.text.charCodeAt(i);if(e===t.Space)s++;else{if(e!==t.Tab)break;s+=4-s%4}}return s}findColumn(e){let n=0,s=0;for(;n<this.text.length&&s<e;){this.text.charCodeAt(n)===t.Tab?s+=4-s%4:s++,n++}return n}reset(e){this.text=e,this.baseIndent=this.basePos=this.pos=this.indent=0,this.depth=0,this.markers=[],this.next=e.length?e.charCodeAt(0):-1,this.skipPos=this.skipSpace(0),this.skipNext=this.skipPos<e.length?e.charCodeAt(this.skipPos):-1}get textAfterIndent(){return this.text.slice(this.skipPos)}scrub(){if(!this.basePos)return this.text;let e="";for(const t of this.markers)e+=this.text.slice(e.length,t.from)+" ".repeat(t.to-t.from);return e+this.text.slice(e.length)}}class p{static create(e,t,n,s,i){return new p(e,t,n,s+(s<<8)+e+(t<<4)|0,i,[],[])}constructor(e,t,n,s,i,r,a){this.type=e,this.value=t,this.from=n,this.hash=s,this.end=i,this.children=r,this.positions=a}addChild(e,t){e.prop(i.NodeProp.contextHash)!==this.hash&&(e=new i.Tree(e.type,e.children,e.positions,e.length,[[i.NodeProp.contextHash,this.hash]])),this.children.push(e),this.positions.push(t)}toTree(e,t=this.end){const n=this.children.length-1;return n>=0&&(t=Math.max(t,this.positions[n]+this.children[n].length+this.from)),new i.Tree(e.types[this.type],this.children,this.positions,t-this.from).balance({makeTree:(e,t,n)=>new i.Tree(i.NodeType.none,e,t,n,[[i.NodeProp.contextHash,this.hash]])})}}class m{constructor(e,t,n,s){this.type=e,this.from=t,this.to=n,this.side=s}}class g{constructor(){this.content=[],this.nodes=[]}write(e,t,n,s=0){this.content.push(e,t,n,4+4*s)}writeElements(e,t=0){for(const n of e)this.writeElement(n,t)}writeElement(e,t=0){const n=this.content.length;this.writeElements(e.children,t),this.content.push(e.type,e.from+t,e.to+t,this.content.length+4-n)}finish(e,t){return i.Tree.build({buffer:this.content,nodeSet:this.nodeSet,topID:e,length:t})}}class b{setMacroParams(e){this._macroParams=e?new Set(e):null}isValidMacroParam(e){return null!==this._macroParams&&this._macroParams.has(e)}get hasMacroParams(){return null!==this._macroParams}get atEnd(){return this._atEnd}savePosition(){return{lineStart:this.lineStart,lineEnd:this.lineEnd,lineText:this._line.text,atEnd:this._atEnd}}restorePosition(e){this.lineStart=e.lineStart,this.lineEnd=e.lineEnd,this._line.reset(e.lineText),this._atEnd=e.atEnd}constructor(t,n,s,i){this.parser=t,this.input=n,this.ranges=i,this.buf=new g,this.stack=[],this._atEnd=!1,this.dontInject=new Set,this.fragments=null,this.fragmentIndex=0,this.fragmentEnd=-1,this.lineStart=0,this.lineEnd=0,this.stoppedAt=null,this._macroParams=null,this.to=i[i.length-1].to,this.fragments=s.length?s:null,this.buf.nodeSet=t.nodeSet;const r=p.create(e.Document,0,i[0].from,0,0);this.stack.push(r),this._line=new h,this.lineStart=i[0].from,this.lineEnd=this.lineStart,this.moveToNextLine()}get line(){return this._line}get rangeEnd(){return this.to}get parsers(){return this.parser.blockParsers}get pragmaParsers(){return this.parser.pragmaParsers}get block(){return this.stack[this.stack.length-1]}prevLineEnd(){return this.lineStart<=0?0:this.atEnd&&this.lineStart===this.to?this.lineStart:this.lineStart-1}nextLine(){return this.lineStart=this.lineEnd,this.lineStart>=this.to?(this._atEnd=!0,!1):(this.lineEnd=this.findLineEnd(),this._line.reset(this.readLineText()),!0)}skipToPosition(e){return e>=this.to?(this.lineStart=this.to,this.lineEnd=this.to,this._atEnd=!0,this._line.reset(""),!1):(this.lineStart=e,this.lineEnd=this.findLineEnd(e),this._line.reset(this.readLineText()),!0)}peekLine(){const e=this.lineEnd;if(e>=this.to)return null;let n=this.findLineEnd(e);if(n>e){this.input.read(n-1,n).charCodeAt(0)===t.Newline&&(n--,n>e&&this.input.read(n-1,n).charCodeAt(0)===t.CarriageReturn&&n--)}return this.input.read(e,n)}findLineEnd(e=this.lineEnd){let n=e;for(;n<this.to;){const e=this.input.read(n,n+1).charCodeAt(0);if(e===t.Newline)return n+1;if(e===t.CarriageReturn)return n++,n<this.to&&this.input.read(n,n+1).charCodeAt(0)===t.Newline&&n++,n;n++}return n}readLineText(){let e=this.lineEnd;if(e>this.lineStart){this.input.read(e-1,e).charCodeAt(0)===t.Newline&&(e--,e>this.lineStart&&this.input.read(e-1,e).charCodeAt(0)===t.CarriageReturn&&e--)}return this.input.read(this.lineStart,e)}moveToNextLine(){this.nextLine()||this._line.reset("")}startContext(e,t,n=0){const s=p.create(e,n,t,this.block.hash,t);this.stack.push(s),this.addNode(e,t)}startComposite(e,t,n=0){const s=p.create(e,n,t,this.block.hash,t);this.stack.push(s)}addElement(e){this.buf.writeElement(e,-this.block.from)}addNode(e,t,n){"number"==typeof e?this.buf.write(e,t-this.block.from,(n??t)-this.block.from,0):this.block.addChild(e,t-this.block.from)}addLeafElement(e,t){this.addElement(this.elt(t.type,t.from,t.to,[...e.marks.map(e=>this.elt(e.type,e.from,e.to)),...t.children]))}finishContext(){const e=this.stack.pop(),t=e.toTree(this.parser.nodeSet);this.dontInject.has(t)||this.block.addChild(t,e.from-this.block.from)}elt(e,t,n,s){return new f(e,t,n,s)}advance(){if(null!==this.stoppedAt&&this.lineStart>this.stoppedAt)return this.finishDocument();for(this.lineStart===this.ranges[0].from&&this.parsePragmas();!this.atEnd;)this.parseBlock();return this.finishDocument()}parsePragmas(){let n=!1;for(;!this.atEnd;){const s=this._line.text,i=s.trim();if(""===i){this.nextLine();continue}if(i.startsWith("\x3c!--")){const t=this.lineStart,n=[],i=s.indexOf("--\x3e");if(-1!==i){const r=s.slice(i+3),a=t+i+3;if(n.push(u(e.CommentMarker,t,t+4)),n.push(u(e.CommentMarker,a-3,a)),this.addElement(u(e.CommentBlock,t,a,n)),r.trim()){const t=this.parser.parseInline(r,a),n=this.elt(e.Paragraph,a,a+r.length,t);this.addElement(n),this.nextLine();break}this.nextLine();continue}let r=!1,a=!1;for(;this.nextLine();){const n=this._line.text,s=n.indexOf("--\x3e");if(-1!==s){const i=n.slice(s+3),o=this.lineStart+s+3;if(this.addElement(u(e.CommentBlock,t,o)),r=!0,i.trim()){const t=this.parser.parseInline(i,o),n=this.elt(e.Paragraph,o,o+i.length,t);this.addElement(n),a=!0}this.nextLine();break}}if(r||this.addElement(u(e.CommentBlock,t,this.lineStart)),a)break;continue}if(s.charCodeAt(this._line.skipSpace(0))!==t.Backslash){if(n&&!this.looksLikeBlockStart(i)&&this.hasUpcomingPragma()){this.nextLine();continue}break}if("\\"===i){this.nextLine();continue}let r=!1;for(const e of this.pragmaParsers){const t=e.parse(this,this._line);if(null!==t){for(const e of t)this.addElement(e);r=!0,n=!0;break}}if(!r){if(n&&this.hasUpcomingPragma()){this.nextLine();continue}break}}}looksLikeBlockStart(e){if(!e)return!1;const n=e.charCodeAt(0);return!!e.startsWith("```")||(!!e.startsWith("$$$")||(n===t.Exclamation||(n===t.Asterisk||n===t.Hash||n===t.Semicolon||n===t.Colon||(!!e.startsWith("<<<")||(!!/^-{3,}\s*$/.test(e)||(n===t.Pipe||(n===t.LessThan||(!!e.startsWith("{{")||(!!e.startsWith("<<")||!!e.startsWith("<%"))))))))))}hasUpcomingPragma(){const e=this.savePosition();let n=!1;for(;this.nextLine();){const e=this._line.text.trim();if(""!==e)if(e.startsWith("```"))for(;this.nextLine()&&!this._line.text.trim().startsWith("```"););else if(e.startsWith("$$$"))for(;this.nextLine()&&!this._line.text.trim().startsWith("$$$"););else if(e.charCodeAt(0)===t.Backslash){n=!0;break}}return this.restorePosition(e),n}parseBlock(){if(""!==this._line.text.trim()){for(const e of this.parsers){const t=e.parse(this,this._line);if(!1!==t)return void(!0===t&&this.nextLine())}this.parseParagraph()}else this.nextLine()}parseParagraph(){const t=this.lineStart,n=[this._line.text];let s=!1;for(;this.nextLine();){const e=this._line.text;if(""!==e.trim()){if(s){const e=this._line.skipNext,t=this._line.textAfterIndent,s=this._line.skipPos>0;if(this.isBlockStarter(t,e,s)){for(;n.length>0&&""===n[n.length-1].trim();)n.pop();break}}n.push(e),s=!1}else n.push(e),s=!0}const i=n.join("\n"),r=this.parser.parseInline(i,t),a=this.elt(e.Paragraph,t,t+i.length,r);this.addElement(a)}isBlockStarter(e,n,s){if(n===t.Exclamation)return!0;if(n===t.Asterisk||n===t.Hash||n===t.Semicolon||n===t.Colon||n===t.GreaterThan)return!0;if(n===t.Backtick&&e.startsWith("```"))return!0;if(n===t.Dollar&&e.startsWith("$$$"))return!0;if(n===t.Dash&&/^-{3,}$/.test(e.trim()))return!0;if(n===t.LessThan){if(e.startsWith("<<<"))return!0;if(e.startsWith("\x3c!--"))return!e.includes("--\x3e");if(e.startsWith("<<")){if(s)return!1;const t=e.indexOf(">>",2);return-1===t||!e.slice(t+2).trim()}const t=e.match(/^<(\$?[a-zA-Z][a-zA-Z0-9\-\.]*)/);if(!t)return!1;const n=t[1];if(/\/>\s*$/.test(e))return!1;const i=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");return!new RegExp(`</${i}>`).test(e)}return!s&&(n===t.Pipe||(!(n!==t.LeftBrace||!e.startsWith("{{"))||(n===t.Backslash||!(n!==t.Dollar||!e.startsWith("$$")||e.startsWith("$$$")||!this.parsers.some(e=>"KaTeXBlock"===e.name)))))}finishDocument(){for(;this.stack.length>1;)this.finishContext();const t=this.stack[0],n=this.buf.content;if(n.length>0){return i.Tree.build({buffer:n,nodeSet:this.parser.nodeSet,topID:e.Document,length:this.to-t.from})}return t.toTree(this.parser.nodeSet,this.to)}get parsedPos(){return this.lineStart}stopAt(e){this.stoppedAt=e}startsWithBlankLine(e,t){if(e>=t)return!1;const n=this.input.read(e,Math.min(e+20,t));return/^[\t ]*[\r\n][\t ]*[\r\n]/.test(n)}parseInlineRange(e,t){if(e>=t)return[];const n=this.input.read(e,t);return this.parser.parseInline(n,e)}parseWidgetContent(e,t){return e>=t?[]:this.startsWithBlankLine(e,t)?this.parseContentRange(e,t,!1):this.parseInlineRange(e,t)}parseContentRange(e,t,n=!0){if(e>=t)return[];const s=this.input.read(e,t),i=this.parser.parse(s);return this.extractElements(i,e)}extractElements(e,t){const n=[],s=e.cursor();if(s.firstChild())do{const e=this.nodeToElement(s,t);e&&n.push(e)}while(s.nextSibling());return n}nodeToElement(t,n){const s=t.type.name,i=t.from+n,r=t.to+n,a=e[s];if(void 0===a||"number"!=typeof a)return"LaTeX"===s?new f(e.LaTeXContent,i,r,[]):"JavaScript"===s||"CSS"===s||"Script"===s?new f(e.CodeText,i,r,[]):null;const o=[];if(t.firstChild()){do{const e=this.nodeToElement(t,n);e&&o.push(e)}while(t.nextSibling());t.parent()}return new f(a,i,r,o)}}class k{constructor(e,t,n){this.parser=e,this.text=t,this.offset=n,this.parts=[]}get end(){return this.offset+this.text.length}char(e){const t=e-this.offset;return t<0||t>=this.text.length?-1:this.text.charCodeAt(t)}slice(e,t){const n=Math.max(0,e-this.offset),s=Math.min(this.text.length,t-this.offset);return this.text.slice(n,s)}get hasOpenLink(){for(let e=this.parts.length-1;e>=0;e--){const t=this.parts[e];if(t instanceof m&&t.type.isLink)return!0}return!1}skipSpace(e){let t=e-this.offset;for(;t<this.text.length&&d(this.text.charCodeAt(t));)t++;return t+this.offset}addElement(e){return this.parts.push(e),e.to}addDelimiter(e,t,n,s,i){const r=(s?1:0)|(i?2:0);return this.parts.push(new m(e,t,n,r)),n}append(e){return this.parts.push(e),e.to}elt(e,t,n,s){return new f(e,t,n,s)}findOpeningDelimiter(e){for(let t=this.parts.length-1;t>=0;t--){const n=this.parts[t];if(n instanceof m&&n.type===e&&1&n.side)return t}return null}takeContent(t){const n=[];for(let s=t;s<this.parts.length;s++){const t=this.parts[s];t instanceof f?n.push(t):t instanceof m&&n.push(this.elt(e.Text,t.from,t.to))}return this.parts.length=t,n}resolveDelimiters(){for(let t=0;t<this.parts.length;t++){const n=this.parts[t];if(!(n instanceof m&&2&n.side))continue;const s=n.type;if(!s.resolve)continue;let i=null;for(let e=t-1;e>=0;e--){const t=this.parts[e];if(t instanceof m&&t.type===s&&1&t.side){i=e;break}}if(null===i)continue;const r=this.parts[i],a=[];s.mark&&a.push(this.elt(this.getMarkType(s.mark),r.from,r.to));for(let n=i+1;n<t;n++){const t=this.parts[n];t instanceof f?a.push(t):t instanceof m&&a.push(this.elt(e.Text,t.from,t.to)),this.parts[n]=null}s.mark&&a.push(this.elt(this.getMarkType(s.mark),n.from,n.to));const o=this.getResolveType(s.resolve),l=this.elt(o,r.from,n.to,a);this.parts[i]=l,this.parts[t]=null}const t=[];for(const n of this.parts)n instanceof f?t.push(n):n instanceof m&&t.push(this.elt(e.Text,n.from,n.to));return t}getResolveType(t){return{Bold:e.Bold,Italic:e.Italic,Underline:e.Underline,Strikethrough:e.Strikethrough,Superscript:e.Superscript,Subscript:e.Subscript,Highlight:e.Highlight,InlineCode:e.InlineCode}[t]||e.Text}getMarkType(t){return{BoldMark:e.BoldMark,ItalicMark:e.ItalicMark,UnderlineMark:e.UnderlineMark,StrikethroughMark:e.StrikethroughMark,SuperscriptMark:e.SuperscriptMark,SubscriptMark:e.SubscriptMark,HighlightMark:e.HighlightMark,InlineCodeMark:e.InlineCodeMark}[t]||e.Mark}parse(){const e=this.parser.inlineParsers;let t=this.offset;for(;t<this.end;){const n=this.char(t);let s=!1;for(const i of e){const e=i.parse(this,n,t);if(e>=0){t=e,s=!0;break}}s||t++}return this.resolveDelimiters()}}const x={whitespaceOrStart:/\s|^$/,placeholder:/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/};function $(t,n,s){const i=n+1,r=s===i+t.length+1,a=r?s-1:s,o=x.placeholder.exec(t);if(o){const t=o[1],l=[u(e.TransclusionMark,n,n+1),u(e.PlaceholderMark,i,i+1),u(e.VariableName,i+1,i+1+t.length),u(e.PlaceholderMark,a-1,a)];return r&&l.push(u(e.TransclusionMark,a,s)),u(e.Placeholder,n,s,l)}const l=[u(e.TransclusionMark,n,n+1)];if(t.includes("!!")){const n=t.indexOf("!!");n>0&&l.push(u(e.TransclusionTarget,i,i+n)),l.push(u(e.TransclusionField,i+n,a))}else if(t.includes("##")){const n=t.indexOf("##");n>0&&l.push(u(e.TransclusionTarget,i,i+n)),l.push(u(e.TransclusionIndex,i+n,a))}else l.push(u(e.TransclusionTarget,i,a));return r&&l.push(u(e.TransclusionMark,a,s)),u(e.FilterTextRef,n,s,l)}function y(t,n,s){const i=n+1,r=s===i+t.length+1,a=r?s-1:s,o=/^__(.+)__$/.exec(t);if(o){const t=o[1],l=[u(e.MacroCallMark,n,n+1),u(e.SubstitutedParamMark,i,i+2),u(e.SubstitutedParamName,i+2,i+2+t.length),u(e.SubstitutedParamMark,a-2,a)];return r&&l.push(u(e.MacroCallMark,a,s)),u(e.SubstitutedParam,n,s,l)}const l=x.placeholder.exec(t);if(l){const t=l[1],o=[u(e.MacroCallMark,n,n+1),u(e.PlaceholderMark,i,i+1),u(e.VariableName,i+1,i+1+t.length),u(e.PlaceholderMark,a-1,a)];return r&&o.push(u(e.MacroCallMark,a,s)),u(e.Placeholder,n,s,o)}const c=[u(e.MacroCallMark,n,n+1),u(e.VariableName,i,a)];return r&&c.push(u(e.MacroCallMark,a,s)),u(e.FilterVariable,n,s,c)}function w(t,n,s){const i=x.placeholder.exec(t);if(i){const t=i[1];return u(e.Placeholder,n,s,[u(e.PlaceholderMark,n,n+1),u(e.VariableName,n+1,n+1+t.length),u(e.PlaceholderMark,s-1,s)])}return u(e.AttributeName,n,s)}function T(t,n,s){const i=x.placeholder.exec(t);if(i){const t=i[1];return u(e.Placeholder,n,s,[u(e.PlaceholderMark,n,n+1),u(e.VariableName,n+1,n+1+t.length),u(e.PlaceholderMark,s-1,s)])}return u(e.ImageSource,n,s)}function S(t,n,s){const i=x.placeholder.exec(t);if(i){const t=i[1];return u(e.Placeholder,n,s,[u(e.PlaceholderMark,n,n+1),u(e.VariableName,n+1,n+1+t.length),u(e.PlaceholderMark,s-1,s)])}return u(e.URLLink,n,s)}function C(t,n){const s=[],i=/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/g;let r;for(;null!==(r=i.exec(t));){const t=r.index,i=t+r[0].length,a=r[1],o=[u(e.PlaceholderMark,n+t,n+t+1),u(e.VariableName,n+t+1,n+t+1+a.length),u(e.PlaceholderMark,n+i-1,n+i)];s.push(u(e.Placeholder,n+t,n+i,o))}return s}function v(t,n){const s=[];let i=0;const r=t.length;for(;i<r;){const a=t[i];if(/\s/.test(a))i++;else{if("["===a){const a=i;i++;const o=[];let l="";for(;i<r&&"]"!==t[i];){"!"===t[i]&&i++;const s=t[i];if("["===s){i++;const s=i;let a=1;for(;i<r&&a>0;)"["===t[i]?a++:"]"===t[i]&&a--,a>0&&i++;const c=t.slice(s,i),d="regexp"===l?e.FilterRegexp:e.FilterOperand;if(c.includes("$")){const e=C(c,n+s);e.length>0?o.push(u(d,n+s,n+i,e)):o.push(u(d,n+s,n+i))}else o.push(u(d,n+s,n+i));i<r&&"]"===t[i]&&i++,l=""}else if("<"===s){i++;const s=i;for(;i<r&&">"!==t[i];)i++;const a=t.slice(s,i),l=i<r&&">"===t[i],c=/^__(.+)__$/.exec(a),d=!c&&/^__(.*)$/.exec(a);if(c){const t=c[1],r=n+s-1,a=n+i+1,l=n+s,d=[u(e.SubstitutedParamMark,l,l+2),u(e.SubstitutedParamName,l+2,l+2+t.length),u(e.SubstitutedParamMark,l+2+t.length,n+i)];o.push(u(e.SubstitutedParam,r,a,d))}else if(d){const t=d[1],r=n+s-1,a=l?n+i+1:n+i,c=n+s,f=[u(e.SubstitutedParamMark,c,c+2)];t&&f.push(u(e.SubstitutedParamName,c+2,c+2+t.length)),o.push(u(e.SubstitutedParam,r,a,f))}else{const t=a.search(/\s/);if(-1!==t){const r=n+s-1,c=l?n+i+1:n+i,d=[u(e.MacroCallMark,r,r+1)],f=a.slice(0,t),h=n+s,p=h+f.length,m=x.placeholder.exec(f);if(m){const t=m[1];d.push(u(e.Placeholder,h,p,[u(e.PlaceholderMark,h,h+1),u(e.VariableName,h+1,h+1+t.length),u(e.PlaceholderMark,p-1,p)]))}else d.push(u(e.MacroName,h,p));const g=a.slice(t),b=n+s+t,k=I(g.trim(),b+(g.length-g.trimStart().length));d.push(...k),l&&d.push(u(e.MacroCallMark,n+i,n+i+1)),o.push(u(e.MacroCall,r,c,d))}else{const e=n+s-1,t=l?n+i+1:n+i;o.push(y(a,e,t))}}i<r&&i++}else if("{"===s){i++;const e=i;for(;i<r&&"}"!==t[i];)i++;const s=t.slice(e,i),a=n+e-1,l=i<r&&"}"===t[i]?n+i+1:n+i;o.push($(s,a,l)),i<r&&i++}else if("/"===s){i++;const s=i;for(;i<r&&"/"!==t[i];)"\\"===t[i]&&i++,i++;for(o.push(u(e.FilterRegexp,n+s,n+i)),i<r&&i++;i<r&&/[gimsuy]/.test(t[i]);)i++}else if("$"===s){const s=t.slice(i).match(/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/);if(s){const t=s[1],r=i+s[0].length,a=[u(e.PlaceholderMark,n+i,n+i+1),u(e.VariableName,n+i+1,n+i+1+t.length),u(e.PlaceholderMark,n+r-1,n+r)];o.push(u(e.Placeholder,n+i,n+r,a)),i=r}else i++}else if(","===s)i++;else if(/[^\s\[\]<>{},]/.test(s)){const s=i;for(;i<r&&/[^\s\[\]<>{},]/.test(t[i]);)i++;l=t.slice(s,i).replace(/^!/,"").replace(/:.*$/,""),o.push(u(e.FilterOperatorName,n+s,n+i))}else i++}i<r&&"]"===t[i]&&i++;const c=i;s.push(u(e.FilterOperator,n+a,n+c,o));continue}if("["===a&&"["===t[i+1]){const a=i;for(i+=2;i<r&&("]"!==t[i]||"]"!==t[i+1]);)i++;i+=2,s.push(u(e.FilterOperand,n+a,n+i));continue}if("+"!==a&&"-"!==a&&"~"!==a&&":"!==a){if("$"===a){const r=t.slice(i).match(/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/);if(r){const t=r[1],a=i+r[0].length,o=[u(e.PlaceholderMark,n+i,n+i+1),u(e.VariableName,n+i+1,n+i+1+t.length),u(e.PlaceholderMark,n+a-1,n+a)];s.push(u(e.Placeholder,n+i,n+a,o)),i=a;continue}}i++}else for(i++;i<r&&/[a-zA-Z]/.test(t[i]);)i++}}return s}function M(e,t,n,s=2){let i=t;for(;e.char(i-1)===n;)i--;let r=t+s;for(;e.char(r)===n;)r++;const a=r-i,o=e.slice(i-1,i);e.slice(r,r+1);var l;let c;return c=!(l=o,x.whitespaceOrStart.test(l))&&a>s?r-s:i,e.slice(c-1,c),e.slice(c+s,c+s+1),{runStart:i,runEnd:r,runLength:a,matchStart:c,canOpen:!0,canClose:!0}}function L(e){const{charCode:t,delimType:n,delimLength:s=2,rejectOddRuns:i=!1}=e;return function(e,r,a){if(r!==t)return-1;for(let n=1;n<s;n++)if(e.char(a+n)!==t)return-1;const o=M(e,a,t,s);return o?i&&o.runLength%2==1||a!==o.matchStart?-1:e.addDelimiter(n,a,a+s,o.canOpen,o.canClose):-1}}function P(t,n){const s=[],i=(t,n)=>{const i=/\$(\(([a-zA-Z][a-zA-Z0-9\-_]*)\)\$|([a-zA-Z][a-zA-Z0-9\-_]*)\$)/g;let r,a=0;const o=[];let l=!1;for(;null!==(r=i.exec(t));){l=!0;const t=r.index,s=t+r[0].length;if(t>a&&o.push(u(e.TransclusionTarget,n+a,n+t)),r[2]){const i=r[2];o.push(u(e.Variable,n+t,n+s,[u(e.PlaceholderMark,n+t,n+t+2),u(e.VariableName,n+t+2,n+t+2+i.length),u(e.PlaceholderMark,n+s-2,n+s)]))}else if(r[3]){const i=r[3];o.push(u(e.Placeholder,n+t,n+s,[u(e.PlaceholderMark,n+t,n+t+1),u(e.VariableName,n+t+1,n+t+1+i.length),u(e.PlaceholderMark,n+s-1,n+s)]))}a=s}l?(a<t.length&&o.push(u(e.TransclusionTarget,n+a,n+t.length)),s.push(...o)):s.push(u(e.TransclusionTarget,n,n+t.length))},r=t.indexOf("!!");if(r>=0){r>0&&i(t.slice(0,r),n),s.push(u(e.TransclusionFieldMark,n+r,n+r+2));return t.slice(r+2).length>0&&s.push(u(e.TransclusionField,n+r+2,n+t.length)),s}const a=t.indexOf("##");if(a>=0){a>0&&i(t.slice(0,a),n),s.push(u(e.TransclusionIndexMark,n+a,n+a+2));return t.slice(a+2).length>0&&s.push(u(e.TransclusionIndex,n+a+2,n+t.length)),s}return t.length>0&&i(t,n),s}const A=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/;function E(t,n,s){const i=A.exec(t);if(i){const t=i[1];return u(e.Placeholder,n,s,[u(e.PlaceholderMark,n,n+1),u(e.VariableName,n+1,n+1+t.length),u(e.PlaceholderMark,s-1,s)])}return u(e.MacroParamName,n,s)}function B(t,n){const s=[],i=/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/g;let r,a=0;for(;null!==(r=i.exec(t));){r.index>a&&s.push(u(e.Text,n+a,n+r.index));const t=r[1],i=n+r.index,o=i+r[0].length;s.push(u(e.Placeholder,i,o,[u(e.PlaceholderMark,i,i+1),u(e.VariableName,i+1,i+1+t.length),u(e.PlaceholderMark,o-1,o)])),a=r.index+r[0].length}return a<t.length&&s.push(u(e.Text,n+a,n+t.length)),s}function I(t,n){const s=[];let i=0;const r=Math.min(t.length,5e3);let a=0;for(;i<r&&a<200;){for(a++;i<r&&/\s/.test(t[i]);)i++;if(i>=r)break;const o=i;let l=i;for(;l<r&&/[a-zA-Z0-9\-_$]/.test(t[l]);)l++;if(l>i&&":"===t[l]){const a=i;i=l+1;const c=i;let d=i;if('"'===t[i]||"'"===t[i]){const e=t[i];for(i++;i<r&&t[i]!==e;)"\\"===t[i]&&i++,i++;i<r&&i++,d=i}else if("[[["===t.slice(i,i+3)){for(i+=3;i<r&&"]]]"!==t.slice(i,i+3);)i++;i<r&&(i+=3),d=i}else if("[["===t.slice(i,i+2)){for(i+=2;i<r&&"]]"!==t.slice(i,i+2);)i++;i<r&&(i+=2),d=i}else{for(;i<r&&!/[\s>]/.test(t[i]);)i++;d=i}const f=E(t.slice(a,l),n+a,n+l);let h;const p=t.slice(c,d);if((p.startsWith('"')||p.startsWith("'"))&&p.length>=2){const t=p[0],s=B(p.slice(1,p.length-(p.endsWith(t)?1:0)),n+c+1);if(s.length>0&&s.some(t=>t.type===e.Placeholder)){const t=[u(e.Mark,n+c,n+c+1),...s,u(e.Mark,n+d-1,n+d)];h=u(e.MacroParamValue,n+c,n+d,t)}else h=u(e.MacroParamValue,n+c,n+d)}else{const t=B(p,n+c);h=t.length>0&&t.some(t=>t.type===e.Placeholder)?u(e.MacroParamValue,n+c,n+d,t):u(e.MacroParamValue,n+c,n+d)}const m=[f,h];s.push(u(e.MacroParam,n+o,n+d,m))}else{const a=i;let l,c=!1,d="";if('"'===t[i]||"'"===t[i]){for(c=!0,d=t[i],i++;i<r&&t[i]!==d;)"\\"===t[i]&&i++,i++;i<r&&i++}else if("[[["===t.slice(i,i+3)){for(i+=3;i<r&&"]]]"!==t.slice(i,i+3);)i++;i<r&&(i+=3)}else if("[["===t.slice(i,i+2)){for(i+=2;i<r&&"]]"!==t.slice(i,i+2);)i++;i<r&&(i+=2)}else for(;i<r&&!/[\s>]/.test(t[i]);)i++;const f=t.slice(a,i);if(c&&f.length>=2){const t=B(f.slice(1,f.length-(f.endsWith(d)?1:0)),n+a+1);if(t.length>0&&t.some(t=>t.type===e.Placeholder)){const s=[u(e.Mark,n+a,n+a+1),...t,u(e.Mark,n+i-1,n+i)];l=u(e.MacroParamValue,n+a,n+i,s)}else l=u(e.MacroParamValue,n+a,n+i)}else{const t=B(f,n+a);l=t.length>0&&t.some(t=>t.type===e.Placeholder)?u(e.MacroParamValue,n+a,n+i,t):u(e.MacroParamValue,n+a,n+i)}const h=[l];s.push(u(e.MacroParam,n+o,n+i,h))}}return s}const W=/^\s*\\define\s+([^(\s]+)\s*\(\s*([^)]*)\s*\)(.*)$/,D=/^\s*\\define\s+([^(\s]+)\s*\(\s*([^)]*)\s*\)\s*$/,F=/^\s*\\(function|procedure|widget)\s+([^(\s]+)\s*\(\s*([^)]*)\s*\)(.*)$/,N=/^\s*\\(function|procedure|widget)\s+([^(\s]+)\s*\(\s*([^)]*)\s*\)$/,O=/^\s*\\rules\s+(only|except)\s+(.*)$/,H=/^\s*\\import\s+(.*)$/,_=/^\s*\\parameters\s*\(\s*([^)]*)\s*\)$/,z=/^\s*\\whitespace\s+(trim|notrim)$/;function R(e,t){const n=/^\s*\\(define|procedure|function|widget)\s+([^(\s]+)\s*\([^)]*\)\s*$/,s=/^\s*\\end(?:\s+(\S+))?\s*$/,i=e.lineStart+e.line.text.length+1,r=[];for(;e.nextLine();){const a=e.line.text,o=n.exec(a);if(o){r.push(o[2]);continue}const l=s.exec(a);if(l){const n=l[1];if(0===r.length){if(!n||n===t)return{bodyStart:i,bodyEnd:e.lineStart-1,endStart:e.lineStart,endEnd:e.lineStart+a.length}}else if(n){if(n===r[r.length-1])r.pop();else if(n===t)return{bodyStart:i,bodyEnd:e.lineStart-1,endStart:e.lineStart,endEnd:e.lineStart+a.length}}else r.pop()}}return null}function Z(t,n){const s=[];let i=0;const r=t.length;for(;i<r;){const a=t[i];if(/\s/.test(a))i++;else if("["===a){const a=i;i++;const o=[];let l="";for(;i<r&&"]"!==t[i];){"!"===t[i]&&i++;const s=t[i];if("["===s){i++;const s=i;let a=1;for(;i<r&&a>0;)"["===t[i]?a++:"]"===t[i]&&a--,a>0&&i++;const c="regexp"===l?e.FilterRegexp:e.FilterOperand;o.push(u(c,n+s,n+i)),i<r&&"]"===t[i]&&i++,l=""}else if("<"===s){i++;const s=i;for(;i<r&&">"!==t[i];)i++;const a=t.slice(s,i),l=i<r&&">"===t[i],c=/^__(.+)__$/.exec(a);if(c){const t=c[1],r=n+s-1,a=n+i+1,l=n+s,d=[u(e.SubstitutedParamMark,l,l+2),u(e.SubstitutedParamName,l+2,l+2+t.length),u(e.SubstitutedParamMark,l+2+t.length,n+i)];o.push(u(e.SubstitutedParam,r,a,d))}else{const t=a.search(/\s/);if(-1!==t){const r=n+s-1,c=l?n+i+1:n+i,d=[u(e.MacroCallMark,r,r+1)],f=a.slice(0,t),h=n+s,p=h+f.length,m=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(f);if(m){const t=m[1];d.push(u(e.Placeholder,h,p,[u(e.PlaceholderMark,h,h+1),u(e.VariableName,h+1,h+1+t.length),u(e.PlaceholderMark,p-1,p)]))}else d.push(u(e.MacroName,h,p));const g=a.slice(t),b=n+s+t,k=I(g.trim(),b+(g.length-g.trimStart().length));d.push(...k),l&&d.push(u(e.MacroCallMark,n+i,n+i+1)),o.push(u(e.MacroCall,r,c,d))}else{const e=n+s-1,t=l?n+i+1:n+i;o.push(y(a,e,t))}}i<r&&i++}else if("{"===s){i++;const e=i;for(;i<r&&"}"!==t[i];)i++;const s=t.slice(e,i),a=n+e-1,l=i<r&&"}"===t[i]?n+i+1:n+i;o.push($(s,a,l)),i<r&&i++}else if("/"===s){i++;const s=i;for(;i<r&&"/"!==t[i];)"\\"===t[i]&&i++,i++;for(o.push(u(e.FilterRegexp,n+s,n+i)),i<r&&i++;i<r&&/[gimsuy]/.test(t[i]);)i++}else if(","===s)i++;else if(/[^\s\[\]<>{},]/.test(s)){const s=i;for(;i<r&&/[^\s\[\]<>{},]/.test(t[i]);)i++;l=t.slice(s,i).replace(/^!/,"").replace(/:.*$/,""),o.push(u(e.FilterOperatorName,n+s,n+i))}else i++}i<r&&"]"===t[i]&&i++,s.push(u(e.FilterOperator,n+a,n+i,o))}else if("+"===a||"-"===a||"~"===a||"="===a)i++;else if(":"===a)for(i++;i<r&&/[a-zA-Z0-9\-_]/.test(t[i]);)i++;else i++}return s}function V(t,n){const s=[];if(!t.trim())return s;const i=/\s*([^:),\s]+)(?:\s*:\s*(?:"""([\s\S]*?)"""|"([^"]*)"|'([^']*)'|\[\[([^\]]*)\]\]|([^,\s)]+)))?/g;let r;for(;null!==(r=i.exec(t));){const t=n+r.index,i=t+r[0].length;s.push(u(e.PragmaParams,t,i))}return s}function K(t,n,s,i,r){const a=n.indexOf("\\"),o=[u(e.PragmaMark,t+a,t+a+1),u(e.PragmaKeyword,t+a+1,t+a+1+s.length)];if(i){const s=t+n.indexOf(i);o.push(u(e.PragmaName,s,s+i.length))}if(r){const e=t+n.indexOf("(")+1;o.push(...V(r,e))}return o}const X=/^\s*\\define(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,j=/^\s*\\(d|de|def|defi|defin)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,q=/^\s*\\(function|procedure|widget)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,U=/^\s*\\(f|fu|fun|func|funct|functi|functio)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,Q=/^\s*\\(p|pr|pro|proc|proce|proced|procedu|procedur)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,G=/^\s*\\(w|wi|wid|widg|widge)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,Y=/^\s*\\rules(?:\s+(only|except)?)?(?:\s+(.*))?$/,J=/^\s*\\(r|ru|rul|rule)\s*$/,ee=/^\s*\\import\s*(.*)$/,te=/^\s*\\(i|im|imp|impo|impor)\s*$/,ne=/^\s*\\parameters(?:\s*\(([^)]*)?)?\s*$/,se=/^\s*\\(pa|par|para|param|parame|paramet|paramete|parameter)\s*$/,ie=/^\s*\\whitespace(?:\s+(.*))?$/,re=/^\s*\\(wh|whi|whit|white|whites|whitesp|whitespa|whitespac)\s*$/,ae=/^\s*\\(e|en|end)(?:\s+.*)?\s*$/,oe=[{name:"macrodef",parse(t,n){const s=n.text,i=D.exec(s);if(i){const n=t.lineStart,r=i[1],a=i[2],o=t.savePosition(),l=R(t,r);if(l){const i=K(n,s,"define",r,a);if(l.bodyEnd>l.bodyStart){const e=t.parseContentRange(l.bodyStart,l.bodyEnd,!0);i.push(...e)}return i.push(u(e.PragmaEnd,l.endStart,l.endEnd)),t.nextLine(),[u(e.MacroDefinition,n,t.prevLineEnd(),i)]}t.restorePosition(o)}const r=W.exec(s);if(r){const n=t.lineStart,i=r[1],a=r[2],o=r[3];if(o){const r=t.savePosition(),l=R(t,i);if(l){const r=K(n,s,"define",i,a),c=n+s.length-o.length;if(l.bodyEnd>c){const e=t.parseContentRange(c,l.bodyEnd,!0);r.push(...e)}return r.push(u(e.PragmaEnd,l.endStart,l.endEnd)),t.nextLine(),[u(e.MacroDefinition,n,t.prevLineEnd(),r)]}t.restorePosition(r)}const l=K(n,s,"define",i,a);if(o){const i=n+s.length-o.length;if(function(e){const t=e.trim();return!(!t.startsWith("[")||!t.endsWith("]")||/^\[img\[/i.test(t)||/^\[ext\[/i.test(t))}(o)){const t=o.trim(),n=i+o.indexOf(t),s=Z(t,n);l.push(u(e.FilterExpression,n,n+t.length,s))}else{const e=t.parser.parseInline(o,i);l.push(...e)}}return t.nextLine(),[u(e.MacroDefinition,n,t.prevLineEnd(),l)]}return null}},{name:"fnprocdef",parse(t,n){const s=n.text,i=N.exec(s);if(i){const n=t.lineStart,r=i[1],a=i[2],o=i[3];let l;switch(r){case"function":l=e.FunctionDefinition;break;case"procedure":l=e.ProcedureDefinition;break;case"widget":l=e.WidgetDefinition;break;default:return null}const c=t.savePosition(),d=R(t,a);if(d){const i=K(n,s,r,a,o);if(d.bodyEnd>d.bodyStart)if("function"===r){const n=Z(t.input.read(d.bodyStart,d.bodyEnd),d.bodyStart);i.push(u(e.FilterExpression,d.bodyStart,d.bodyEnd,n))}else{const e=t.parseContentRange(d.bodyStart,d.bodyEnd,!0);i.push(...e)}return i.push(u(e.PragmaEnd,d.endStart,d.endEnd)),t.nextLine(),[u(l,n,t.prevLineEnd(),i)]}t.restorePosition(c)}const r=F.exec(s);if(r){const n=t.lineStart,i=r[1],a=r[2],o=r[3],l=r[4];let c;switch(i){case"function":c=e.FunctionDefinition;break;case"procedure":c=e.ProcedureDefinition;break;case"widget":c=e.WidgetDefinition;break;default:return null}if(l){const r=t.savePosition(),d=R(t,a);if(d){const r=K(n,s,i,a,o),f=n+s.length-l.length;if(d.bodyEnd>f)if("function"===i){const n=Z(t.input.read(f,d.bodyEnd),f);r.push(u(e.FilterExpression,f,d.bodyEnd,n))}else{const e=t.parseContentRange(f,d.bodyEnd,!0);r.push(...e)}return r.push(u(e.PragmaEnd,d.endStart,d.endEnd)),t.nextLine(),[u(c,n,t.prevLineEnd(),r)]}t.restorePosition(r)}const d=K(n,s,i,a,o);if(l){const r=n+s.length-l.length;if("function"===i){const t=Z(l,r);d.push(u(e.FilterExpression,r,n+s.length,t))}else{const e=t.parser.parseInline(l,r);d.push(...e)}}return t.nextLine(),[u(c,n,t.prevLineEnd(),d)]}return null}},{name:"rules",parse(t,n){const s=O.exec(n.text);if(!s)return null;const i=t.lineStart;s[1],s[2];const r=n.text.indexOf("\\"),a=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+6)];return t.nextLine(),[u(e.RulesPragma,i,t.prevLineEnd(),a)]}},{name:"import",parse(t,n){const s=H.exec(n.text);if(!s)return null;const i=t.lineStart,r=s[1],a=n.text.indexOf("\\"),o=i+n.text.indexOf(r),l=Z(r,o),c=[u(e.PragmaMark,i+a,i+a+1),u(e.PragmaKeyword,i+a+1,i+a+7),u(e.FilterExpression,o,o+r.length,l)];return t.nextLine(),[u(e.ImportPragma,i,t.prevLineEnd(),c)]}},{name:"parameters",parse(t,n){const s=_.exec(n.text);if(!s)return null;const i=t.lineStart,r=s[1],a=n.text.indexOf("\\"),o=[u(e.PragmaMark,i+a,i+a+1),u(e.PragmaKeyword,i+a+1,i+a+11)];if(r){const e=i+n.text.indexOf("(")+1;o.push(...V(r,e))}return t.nextLine(),[u(e.ParametersPragma,i,t.prevLineEnd(),o)]}},{name:"whitespace",parse(t,n){if(!z.exec(n.text))return null;const s=t.lineStart,i=n.text.indexOf("\\"),r=[u(e.PragmaMark,s+i,s+i+1),u(e.PragmaKeyword,s+i+1,s+i+11)];return t.nextLine(),[u(e.WhitespacePragma,s,t.prevLineEnd(),r)]}},{name:"partial",parse(t,n){const s=n.text,i=t.lineStart,r=s.indexOf("\\");let a=X.exec(s);if(a){const n=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+7)],o=a[1];if(o){const t=i+s.indexOf(o);n.push(u(e.PragmaName,t,t+o.length))}const l=a[2];if(void 0!==l){const e=i+s.indexOf("(")+1;l&&n.push(...V(l,e))}return t.nextLine(),[u(e.MacroDefinition,i,t.prevLineEnd(),n)]}if(a=q.exec(s),a){const n=a[1];let o;switch(n){case"function":o=e.FunctionDefinition;break;case"procedure":o=e.ProcedureDefinition;break;case"widget":o=e.WidgetDefinition;break;default:return null}const l=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)],c=a[2];if(c){const t=i+s.indexOf(c);l.push(u(e.PragmaName,t,t+c.length))}const d=a[3];if(void 0!==d){const e=i+s.indexOf("(")+1;d&&l.push(...V(d,e))}return t.nextLine(),[u(o,i,t.prevLineEnd(),l)]}if(a=Y.exec(s),a){const n=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+6)];return t.nextLine(),[u(e.RulesPragma,i,t.prevLineEnd(),n)]}if(a=ee.exec(s),a){const n=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+7)],o=a[1];if(o&&o.trim()){const t=i+s.indexOf(o);n.push(u(e.FilterExpression,t,t+o.length))}return t.nextLine(),[u(e.ImportPragma,i,t.prevLineEnd(),n)]}if(a=ne.exec(s),a){const n=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+11)],o=a[1];if(void 0!==o){const e=i+s.indexOf("(")+1;o&&n.push(...V(o,e))}return t.nextLine(),[u(e.ParametersPragma,i,t.prevLineEnd(),n)]}if(a=ie.exec(s),a){const n=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+11)];return t.nextLine(),[u(e.WhitespacePragma,i,t.prevLineEnd(),n)]}if(a=j.exec(s),a){const n=a[1],o=a[2],l=a[3],c=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];if(o){const t=i+s.indexOf(o);c.push(u(e.PragmaName,t,t+o.length))}if(void 0!==l){const e=i+s.indexOf("(")+1;l&&c.push(...V(l,e))}return t.nextLine(),[u(e.MacroDefinition,i,t.prevLineEnd(),c)]}if(a=U.exec(s),a){const n=a[1],o=a[2],l=a[3],c=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];if(o){const t=i+s.indexOf(o);c.push(u(e.PragmaName,t,t+o.length))}if(void 0!==l){const e=i+s.indexOf("(")+1;l&&c.push(...V(l,e))}return t.nextLine(),[u(e.FunctionDefinition,i,t.prevLineEnd(),c)]}if(a=Q.exec(s),a){const n=a[1],o=a[2],l=a[3],c=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];if(o){const t=i+s.indexOf(o);c.push(u(e.PragmaName,t,t+o.length))}if(void 0!==l){const e=i+s.indexOf("(")+1;l&&c.push(...V(l,e))}return t.nextLine(),[u(e.ProcedureDefinition,i,t.prevLineEnd(),c)]}if(a=G.exec(s),a){const n=a[1],o=a[2],l=a[3],c=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];if(o){const t=i+s.indexOf(o);c.push(u(e.PragmaName,t,t+o.length))}if(void 0!==l){const e=i+s.indexOf("(")+1;l&&c.push(...V(l,e))}return t.nextLine(),[u(e.WidgetDefinition,i,t.prevLineEnd(),c)]}if(a=J.exec(s),a){const n=a[1],s=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];return t.nextLine(),[u(e.RulesPragma,i,t.prevLineEnd(),s)]}if(a=te.exec(s),a){const n=a[1],s=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];return t.nextLine(),[u(e.ImportPragma,i,t.prevLineEnd(),s)]}if(a=se.exec(s),a){const n=a[1],s=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];return t.nextLine(),[u(e.ParametersPragma,i,t.prevLineEnd(),s)]}if(a=re.exec(s),a){const n=a[1],s=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];return t.nextLine(),[u(e.WhitespacePragma,i,t.prevLineEnd(),s)]}if(a=ae.exec(s),a){const n=a[1],s=[u(e.PragmaMark,i+r,i+r+1),u(e.PragmaKeyword,i+r+1,i+r+1+n.length)];return t.nextLine(),[u(e.PragmaEnd,i,t.prevLineEnd(),s)]}return null}}];const le={name:"Heading",parse(n,s){const i=function(e){if(e.skipNext!==t.Exclamation)return-1;let n=1,s=e.skipPos+1;for(;s<e.text.length&&e.text.charCodeAt(s)===t.Exclamation&&n<6;)n++,s++;return n}(s);if(i<0)return!1;const r=n.lineStart,a=r+s.skipPos,o=a+i,l=o,c=s.text.slice(s.skipPos+i),d=n.parser.parseInline(c,l),f=[e.Heading1,e.Heading2,e.Heading3,e.Heading4,e.Heading5,e.Heading6][i-1],h=[u(e.HeadingMark,a,o),...d];return n.addElement(u(f,r,r+s.text.length,h)),!0}},ce=/^-{3,}\s*$/,de={name:"HorizontalRule",parse:(t,n)=>!!ce.test(n.textAfterIndent)&&(t.addElement(u(e.HorizontalRule,t.lineStart,t.lineStart+n.text.length)),!0)},fe=/^```(\S*)/,ue=/^```\s*$/,he={name:"FencedCode",parse(t,n){const s=fe.exec(n.textAfterIndent);if(!s)return!1;const i=t.lineStart,r=i+n.skipPos,a=s[1],o=[u(e.CodeMark,r,r+3)];a&&o.push(u(e.CodeInfo,r+3,r+3+a.length));let l="",c=t.lineStart+n.text.length+1,d=!1;for(;t.nextLine();){if(ue.test(t.line.textAfterIndent)){o.push(u(e.CodeText,c,t.prevLineEnd()));const n=t.lineStart+t.line.skipPos;o.push(u(e.CodeMark,n,n+3)),d=!0;break}l&&(l+="\n"),l+=t.line.text}if(!d){const n=t.prevLineEnd();n>c&&o.push(u(e.CodeText,c,n))}const f=d?t.lineStart+t.line.text.length:t.prevLineEnd();return t.addElement(u(e.FencedCode,i,f,o)),!0}},pe=/^\$\$\$([\w\/\-\.\+]*)$/,me=/^\$\$\$\s*$/,ge={name:"TypedBlock",parse(t,n){const s=pe.exec(n.textAfterIndent);if(!s)return!1;const i=t.lineStart,r=i+n.skipPos,a=s[1],o=[u(e.TypedBlockMark,r,r+3)];a&&o.push(u(e.TypedBlockType,r+3,r+3+a.length));const l="text/plain"===a?e.PlainText:e.CodeText;let c=t.lineStart+n.text.length+1,d=!1;for(;t.nextLine();)if(me.test(t.line.textAfterIndent)){o.push(u(l,c,t.prevLineEnd()));const n=t.lineStart+t.line.skipPos;o.push(u(e.TypedBlockMark,n,n+3)),d=!0;break}if(!d){const e=t.prevLineEnd();e>c&&o.push(u(l,c,e))}const f=d?t.lineStart+t.line.text.length:t.prevLineEnd();return t.addElement(u(e.TypedBlock,i,f,o)),!0}},be=/^"""\s*$/,ke={name:"HardLineBreaks",parse(t,n){if(!be.test(n.textAfterIndent))return!1;const s=t.lineStart,i=s+n.skipPos,r=[u(e.HardLineBreaksMark,i,i+3)];let a=t.lineStart+n.text.length+1,o=!1;for(;t.nextLine();)if(be.test(t.line.textAfterIndent)){if(t.lineStart-1>a){const e=t.input.read(a,t.lineStart-1),n=t.parser.parseInline(e,a);r.push(...n)}const n=t.lineStart+t.line.skipPos;r.push(u(e.HardLineBreaksMark,n,n+3)),o=!0;break}if(!o&&t.lineStart>a){const e=t.input.read(a,t.lineStart),n=t.parser.parseInline(e,a);r.push(...n)}const l=o?t.lineStart+t.line.text.length:t.lineStart;return t.addElement(u(e.HardLineBreaks,s,l,r)),!0}},xe=/^\$\$(?!\$)/,$e=/\$\$\s*$/,ye={name:"KaTeXBlock",after:"TypedBlock",parse(t,n){if(!xe.test(n.text))return!1;const s=t.lineStart,i=[u(e.KaTeXMark,s,s+2)],r=n.text.slice(2),a=r.match(/^(.*)\$\$\s*$/);if(a){const r=a[1];return r.length>0&&i.push(u(e.LaTeXContent,s+2,s+2+r.length)),i.push(u(e.KaTeXMark,s+2+r.length,s+2+r.length+2)),t.addElement(u(e.KaTeXBlock,s,s+n.text.length,i)),!0}let o=s+2;o=r.trim()?s+2:t.lineStart+n.text.length+1;let l=!1;for(;t.nextLine();){if($e.exec(t.line.text)){const n=t.line.text.lastIndexOf("$$"),s=t.lineStart+n;s>o&&i.push(u(e.LaTeXContent,o,s)),i.push(u(e.KaTeXMark,t.lineStart+n,t.lineStart+n+2)),l=!0;break}}if(!l){const n=t.prevLineEnd();n>o&&i.push(u(e.LaTeXContent,o,n))}const c=l?t.lineStart+t.line.text.length:t.prevLineEnd();return t.addElement(u(e.KaTeXBlock,s,c,i)),!0}},we=/^([*#;:>]+)/,Te={"*":{list:e.BulletList,item:e.ListItem},"#":{list:e.OrderedList,item:e.ListItem},";":{list:e.DefinitionList,item:e.DefinitionTerm},":":{list:e.DefinitionList,item:e.DefinitionDescription},">":{list:e.BlockQuote,item:e.ListItem}};function Se(e,t){return e===t||!(";"!==e&&":"!==e||";"!==t&&":"!==t)}function Ce(e){let n=0;for(;n<e.length&&(e.charCodeAt(n)===t.Space||e.charCodeAt(n)===t.Tab);)n++;return n}const ve={name:"List",parse(t,n){const s=we.exec(n.textAfterIndent);if(!s)return!1;const i=s[1],r=i[0],a=Te[r];if(!a)return!1;if(">"===r&&/<[$a-zA-Z\/]/.test(n.textAfterIndent.slice(i.length)))return!1;const o=t.lineStart,l=[];for(;;){const n=we.exec(t.line.textAfterIndent);if(!n||!Se(r,n[1][0]))break;const s=n[1],i=t.lineStart,a=i+t.line.skipPos,o=a+s.length,c=t.line.text.slice(t.line.skipPos+s.length),d=t.parser.parseInline(c,o),f=[u(e.ListMark,a,o),...d],h=Te[s[s.length-1]]?.item||e.ListItem;l.push(u(h,i,i+t.line.text.length,f));const p=t.peekLine();if(null===p)break;const m=Ce(p),g=p.slice(m),b=we.exec(g);if(!b||!Se(r,b[1][0]))break;t.nextLine()}return t.addElement(u(a.list,o,t.lineStart+t.line.text.length,l)),!0}},Me=/^<<<(.*)$/,Le={name:"MultiLineBlockQuote",parse(t,n){const s=Me.exec(n.textAfterIndent);if(!s)return!1;if(!n.textAfterIndent.startsWith("<<<")||n.textAfterIndent.startsWith("<<<<"))return!1;const i=t.lineStart,r=i+n.skipPos,a=r+3,o=s[1].trim(),l=[u(e.QuoteMark,r,a)];if(o){const t=s[1],n=a+(t.length-t.trimStart().length);l.push(u(e.BlockQuoteClass,n,n+o.length))}const c=i+n.text.length+1;let d=c,f=-1,h=-1,p="",m="";for(;t.nextLine();){const e=t.line.textAfterIndent;if(e.startsWith("<<<")&&!e.startsWith("<<<<")){f=t.lineStart+t.line.skipPos,h=t.lineStart+t.line.text.length,d=t.lineStart-1,m=e,p=e.slice(3).trim();break}}if(d>c){const e=t.parseContentRange(c,d,!1);l.push(...e)}if(f>=0&&(l.push(u(e.QuoteMark,f,f+3)),p)){const e=m.slice(3),n=f+3+(e.length-e.trimStart().length),s=t.parser.parseInline(p,n);l.push(...s)}const g=h>=0?h:t.prevLineEnd();return t.addElement(u(e.BlockQuote,i,g,l)),!0}},Pe=/^\|.*\|([fhck])?\s*$/,Ae={c:e.TableCaption,k:e.TableClass,h:e.TableHeader,f:e.TableFooter},Ee={name:"Table",parse(t,n){if(!Pe.test(n.text))return!1;const s=t.lineStart,i=[];for(;;){const n=Pe.exec(t.line.text);if(!n)break;const s=t.lineStart,r=n[1],a=r?Ae[r]:e.TableRow,o=Be(t.line.text,s,t,r);if(i.push(u(a,s,s+t.line.text.length,o)),!t.nextLine())break}return t.addElement(u(e.Table,s,t.prevLineEnd(),i)),!0}};function Be(n,s,i,r){const a=[];let o=0,l=-1;const c=r?n.length-1:n.length;for(;o<c;){if(n.charCodeAt(o)===t.Pipe){if(l>=0){const t=n.slice(l,o),r=t.length-t.trimStart().length,c=t.trim(),d=c.startsWith("!"),f=d?e.TableHeaderCell:e.TableCell,h=l+r+(d?1:0),p=d?c.slice(1):c,m=i.parser.parseInline(p,s+h);a.push(u(f,s+l,s+o,m))}a.push(u(e.TableDelimiter,s+o,s+o+1)),l=-1,o++}else l<0&&(l=o),o++}return r&&a.push(u(e.TableMarker,s+n.length-1,s+n.length)),a}const Ie=/^<!--/,We={name:"CommentBlock",parse(t,n){const s=n.text.trim();if(Ie.test(s)){const i=t.lineStart;if(s.match(/-->/)){const s=i+n.text.indexOf("--\x3e")+3;t.addElement(u(e.CommentBlock,i,s,[u(e.CommentMarker,i,i+4),u(e.CommentMarker,s-3,s)]));const r=n.text.slice(n.text.indexOf("--\x3e")+3);if(r.trim()){const n=t.parser.parseInline(r,s),i=t.elt(e.Paragraph,s,s+r.length,n);t.addElement(i)}return!0}for(;t.nextLine();){const n=t.line.text,s=n.indexOf("--\x3e");if(-1!==s){const r=t.lineStart+s+3;t.addElement(u(e.CommentBlock,i,r));const a=n.slice(s+3);if(a.trim()){const n=t.parser.parseInline(a,r),s=t.elt(e.Paragraph,r,r+a.length,n);t.addElement(s)}return!0}}return t.addElement(u(e.CommentBlock,i,t.lineStart)),!0}return!1}},De=/^\{\{([^{}|]*)(?:\|\|([^{}|]+))?(?:\|([^{}]+))?\}\}\s*$/,Fe={name:"TransclusionBlock",parse(t,n){const s=De.exec(n.text);if(!s)return!1;const i=t.lineStart,r=s[1],a=s[2];s[3];const o=[u(e.TransclusionMark,i,i+2)],l=P(r,i+2);o.push(...l);let c=i+2+r.length;return a&&(o.push(u(e.TransclusionTemplate,c+2,c+2+a.length)),c+=2+a.length),o.push(u(e.TransclusionMark,i+n.text.length-2,i+n.text.length)),t.addElement(u(e.TransclusionBlock,i,i+n.text.length,o)),!0}},Ne={name:"FilteredTransclusionBlock",parse(t,n){if(!n.text.startsWith("{{{"))return!1;const s=n.text.indexOf("}}}",3);if(-1===s)return!1;const i=n.text.slice(s+3).trim();let r="";if(i){if(!i.startsWith("||"))return!1;r=i.slice(2)}const a=t.lineStart,o=n.text.slice(3,s),l=v(o,a+3),c=[u(e.FilteredTransclusionMark,a,a+3),u(e.FilterExpression,a+3,a+3+o.length,l),u(e.FilteredTransclusionMark,a+3+o.length,a+6+o.length)];return r&&c.push(u(e.TransclusionTemplate,a+s+5,a+s+5+r.length)),t.addElement(u(e.FilteredTransclusionBlock,a,a+n.text.length,c)),!0}},Oe={name:"MacroCallBlock",parse(t,n){if(!n.text.startsWith("<<"))return!1;const s=t.lineStart;let i=2;for(;i<n.text.length&&!/[\s>]/.test(n.text[i]);)i++;const r=n.text.slice(2,i);if(!r)return!1;let a=n.text.indexOf(">>",2),o=n.text,l=t.lineStart+n.text.length;const c=-1===a?n.text.indexOf(">",i):-1,d=t=>{const n=/^__(.+)__$/.exec(r),i=!n&&/^__(.*)$/.exec(r);if(n){const i=n[1],a=s+2,o=[u(e.SubstitutedParamMark,a,a+2),u(e.SubstitutedParamName,a+2,a+2+i.length),u(e.SubstitutedParamMark,a+2+i.length,a+r.length)];t.push(u(e.SubstitutedParam,a,a+r.length,o))}else if(i){const n=i[1],a=s+2,o=[u(e.SubstitutedParamMark,a,a+2)];n&&o.push(u(e.SubstitutedParamName,a+2,a+2+n.length)),t.push(u(e.SubstitutedParam,a,a+r.length,o))}else{const n=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(r);if(n){const i=n[1],a=s+2,o=[u(e.PlaceholderMark,a,a+1),u(e.VariableName,a+1,a+1+i.length),u(e.PlaceholderMark,a+r.length-1,a+r.length)];t.push(u(e.Placeholder,a,a+r.length,o))}else t.push(u(e.MacroName,s+2,s+2+r.length))}};let f="",h=0;if(-1!==c){const r=[u(e.MacroCallMark,s,s+2)];d(r);const a=n.text.slice(i,c);if(a.trim()){const e=I(a,s+i);r.push(...e)}return t.addElement(u(e.MacroCallBlock,s,l,r)),!0}if(-1===a){for(;t.nextLine();){const e=t.line.text;o+="\n"+e;const n=e.indexOf(">>");if(-1!==n){a=o.length-(e.length-n);const s=t.lineStart+n+2;l=t.lineStart+e.length;const i=e.slice(n+2);i.trim()&&(f=i,h=s);break}l=t.lineStart+e.length}if(-1===a){const n=[u(e.MacroCallMark,s,s+2)];d(n);const r=o.slice(i);if(r.trim()){const e=I(r,s+i);n.push(...e)}return t.addElement(u(e.MacroCallBlock,s,l,n)),!0}}else if(n.text.slice(a+2).trim())return!1;const p=[u(e.MacroCallMark,s,s+2)];d(p);const m=o.slice(i,a);if(m.trim()){const e=I(m,s+i);p.push(...e)}const g=s+a;p.push(u(e.MacroCallMark,g,g+2));const b=f?h:l;if(t.addElement(u(e.MacroCallBlock,s,b,p)),f.trim()){const n=t.parser.parseInline(f,h),s=u(e.Paragraph,h,h+f.length,n);t.addElement(s)}return!0}},He=new Set(["emptymessage","template","caption","tooltip","placeholder","default","alt","description","message","content"]);function _e(t,n){const s=[],i=/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/g;let r,a=0;for(;null!==(r=i.exec(t));){const t=r.index,i=t+r[0].length,o=r[1];t>a&&s.push(u(e.AttributeValue,n+a,n+t));const l=[u(e.PlaceholderMark,n+t,n+t+1),u(e.VariableName,n+t+1,n+t+1+o.length),u(e.PlaceholderMark,n+i-1,n+i)];s.push(u(e.Placeholder,n+t,n+i,l)),a=i}return s.length>0&&a<t.length&&s.push(u(e.AttributeValue,n+a,n+t.length)),s}function ze(t,n,s,i,r){const a=[];let o=0;const l=t.length;for(;o<l;){for(;o<l&&/\s/.test(t[o]);)o++;if(o>=l)break;const s=o;for(;o<l&&/[^\/\s>"'`=]/.test(t[o]);)o++;if(o===s){o++;continue}const c=o;for(;o<l&&/\s/.test(t[o]);)o++;if(o>=l||"="!==t[o]){const i=[w(t.slice(s,c),n+s,n+c)];a.push(u(e.Attribute,n+s,n+c,i));continue}for(o++;o<l&&/\s/.test(t[o]);)o++;if(o>=l){const i=[w(t.slice(s,c),n+s,n+c)];a.push(u(e.Attribute,n+s,n+o,i));continue}const d=o;let f=o,h=e.AttributeValue;const p=t[o];if('"'===p&&'"""'===t.slice(o,o+3)){const h=o;o+=3;const p=o;for(;o<l&&'"""'!==t.slice(o,o+3);)o++;const m=o,g=o;'"""'===t.slice(o,o+3)&&(o+=3),f=o;const b=t.slice(p,m);let k=[u(e.Mark,n+h,n+p)];if(b.trim()&&(r||i)){const o=r?r(b,n+p):i(b,n+p);k.push(...o),k.push(u(e.Mark,n+g,n+f));const l=[w(t.slice(s,c),n+s,n+c),u(e.AttributeWikitext,n+d,n+f,k)];a.push(u(e.Attribute,n+s,n+f,l))}else{const i=[w(t.slice(s,c),n+s,n+c),u(e.AttributeString,n+d,n+f)];a.push(u(e.Attribute,n+s,n+f,i))}continue}if('"'===p||"'"===p){const m=p;o++;const g=o;for(;o<l&&t[o]!==m;)"\\"===t[o]&&o+1<l&&o++,o++;const b=o;o<l&&o++,f=o,h=e.AttributeString;const k=t.slice(s,c).toLowerCase();if("filter"===k||"$filter"===k||"$names"===k||"$values"===k){const i=v(t.slice(g,b),n+g),r=[u(e.Mark,n+d,n+g),u(e.FilterExpression,n+g,n+b,i),u(e.Mark,n+b,n+f)],o=[w(t.slice(s,c),n+s,n+c),u(e.AttributeFiltered,n+d,n+f,r)];a.push(u(e.Attribute,n+s,n+f,o));continue}if((r||i)&&He.has(k)){const o=t.slice(g,b);if(o.trim()){const l=r?r(o,n+g):i(o,n+g),h=[u(e.Mark,n+d,n+g),...l,u(e.Mark,n+b,n+f)],p=[w(t.slice(s,c),n+s,n+c),u(e.AttributeWikitext,n+d,n+f,h)];a.push(u(e.Attribute,n+s,n+f,p));continue}}const x=t.slice(g,b);if(x.includes("$")){const i=_e(x,n+g);if(i.length>0){const r=[u(e.Mark,n+d,n+g),...i,u(e.Mark,n+b,n+f)],o=[w(t.slice(s,c),n+s,n+c),u(e.AttributeString,n+d,n+f,r)];a.push(u(e.Attribute,n+s,n+f,o));continue}}}else if("{"===p){if("{{{"===t.slice(o,o+3)){const i=o;o+=3;const r=o;for(;o<l&&"}}}"!==t.slice(o,o+3);)o++;const p=o;"}}}"===t.slice(o,o+3)&&(o+=3),f=o,h=e.AttributeFiltered;const m=v(t.slice(r,p),n+r),g=[u(e.FilteredTransclusionMark,n+i,n+i+3),u(e.FilterExpression,n+r,n+p,m),u(e.FilteredTransclusionMark,n+p,n+f)],b=[w(t.slice(s,c),n+s,n+c),u(h,n+d,n+f,g)];a.push(u(e.Attribute,n+s,n+f,b));continue}if("{{"===t.slice(o,o+2)){const i=o;o+=2;const r=o;for(;o<l&&"}}"!==t.slice(o,o+2);)o++;const p=o;"}}"===t.slice(o,o+2)&&(o+=2),f=o,h=e.AttributeIndirect;const m=P(t.slice(r,p),n+r),g=[u(e.TransclusionMark,n+i,n+i+2),...m,u(e.TransclusionMark,n+p,n+f)],b=[w(t.slice(s,c),n+s,n+c),u(h,n+d,n+f,g)];a.push(u(e.Attribute,n+s,n+f,b));continue}for(;o<l&&!/[\s>]/.test(t[o]);)o++;f=o}else{if("<"===p&&"<"===t[o+1]){const i=o;o+=2;const r=o;for(;o<l&&/[^\s>"'=]/.test(t[o]);)o++;const p=o;let m=1;for(;o<l&&m>0;)if("<<"===t.slice(o,o+2))m++,o+=2;else if(">>"===t.slice(o,o+2)){if(m--,0===m)break;o+=2}else o++;const g=o;">>"===t.slice(o,o+2)&&(o+=2),f=o,h=e.AttributeMacro;const b=t.slice(r,p),k=[u(e.MacroCallMark,n+i,n+i+2)],x=/^__(.+)__$/.exec(b);if(x){const t=x[1],s=n+r,i=[u(e.SubstitutedParamMark,s,s+2),u(e.SubstitutedParamName,s+2,s+2+t.length),u(e.SubstitutedParamMark,s+2+t.length,n+p)];k.push(u(e.SubstitutedParam,s,n+p,i))}else k.push(u(e.MacroName,n+r,n+p));k.push(u(e.MacroCallMark,n+g,n+f));const $=[w(t.slice(s,c),n+s,n+c),u(h,n+d,n+f,k)];a.push(u(e.Attribute,n+s,n+f,$));continue}if("`"===p){let i,r;if("```"===t.slice(o,o+3)){for(i=o+3,o+=3;o<l&&"```"!==t.slice(o,o+3);)o++;r=o,"```"===t.slice(o,o+3)&&(o+=3)}else{for(i=o+1,o++;o<l&&"`"!==t[o];)o++;r=o,o<l&&o++}f=o,h=e.AttributeSubstituted;const p=[u(e.Mark,n+d,n+i)],m=t.slice(i,r);let g=0;const b=n+i;for(;g<m.length;){if("${"===m.slice(g,g+2)){let t=-1;for(let e=g+2;e<m.length-1;e++)if("}"===m[e]&&"$"===m[e+1]){t=e;break}if(-1!==t){const n=[m.slice(g,t+2),m.slice(g+2,t)],s=b+g,i=s+n[0].length,r=s+2,a=i-2,o=v(n[1].trim(),r+(n[1].length-n[1].trimStart().length));p.push(u(e.FilterSubstitution,s,i,[u(e.FilterSubstitutionMark,s,s+2),u(e.FilterExpression,r,a,o),u(e.FilterSubstitutionMark,i-2,i)])),g+=n[0].length;continue}}const t=m.slice(g).match(/^\$\(([^)]+)\)\$/);if(t){const n=b+g,s=n+t[0].length,i=n+2,r=i+t[1].length;p.push(u(e.Variable,n,s,[u(e.VariableMark,n,n+2),u(e.VariableName,i,r),u(e.VariableMark,r,s)])),g+=t[0].length}else g++}p.push(u(e.Mark,n+r,n+f));const k=[w(t.slice(s,c),n+s,n+c),u(h,n+d,n+f,p)];a.push(u(e.Attribute,n+s,n+f,k));continue}{for(;o<l&&!/[\s>\/]/.test(t[o]);)o++;f=o;const i=t.slice(d,f),r=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(i);if(r){const i=r[1],o=[u(e.PlaceholderMark,n+d,n+d+1),u(e.VariableName,n+d+1,n+d+1+i.length),u(e.PlaceholderMark,n+f-1,n+f)],l=[w(t.slice(s,c),n+s,n+c),u(e.Placeholder,n+d,n+f,o)];a.push(u(e.Attribute,n+s,n+f,l));continue}h=/^-?\d+(\.\d+)?$/.test(i)?e.AttributeNumber:/^@[a-zA-Z][a-zA-Z0-9\-_]*$/.test(i)?e.AttributeParamRef:e.AttributeString}}const m=[w(t.slice(s,c),n+s,n+c),u(h,n+d,n+f)];a.push(u(e.Attribute,n+s,n+f,m))}return a}const Re=/^(\s*)<([a-zA-Z][a-zA-Z0-9\-\.]*|\$[a-zA-Z0-9\-\$\.]*)/,Ze=/^(\s*)<\/([a-zA-Z][a-zA-Z0-9\-\.]*|\$[a-zA-Z0-9\-\$\.]*)>/,Ve=/^(\s*)<\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/,Ke=/^(\s*)<\/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$>/,Xe={name:"HTMLBlock",parse(t,n){const s=n.text,i=Ve.exec(s);if(i){const n=i[1].length,r=i[2],a=t.lineStart,o=a+n,l=[];l.push(u(e.TagMark,o,o+1));const c=o+1,d=c+r.length+2,f=[u(e.PlaceholderMark,c,c+1),u(e.VariableName,c+1,c+1+r.length),u(e.PlaceholderMark,d-1,d)];l.push(u(e.Placeholder,c,d,f));let h=s.slice(n+1+r.length+2),p=d,m=h,g=t.lineStart+s.length;const b=e=>{let t=0;for(;t<e.length;){const n=e[t];if(">"===n)return{pos:t+1,selfClose:!1};if("/"===n&&">"===e[t+1])return{pos:t+2,selfClose:!0};if('"'===n&&'"""'===e.slice(t,t+3)){for(t+=3;t<e.length&&'"""'!==e.slice(t,t+3);)t++;t+=3}else if('"'===n||"'"===n){const s=n;for(t++;t<e.length&&e[t]!==s;)"\\"===e[t]&&t++,t++;t++}else if("<"===n&&"<"===e[t+1]){t+=2;let n=1;for(;t<e.length&&n>0;)"<"===e[t]&&"<"===e[t+1]?(n++,t+=2):">"===e[t]&&">"===e[t+1]?(n--,t+=2):t++}else if("{"===n&&"{{{"===e.slice(t,t+3)){for(t+=3;t<e.length&&"}}}"!==e.slice(t,t+3);)t++;t+=3}else if("{"===n&&"{"===e[t+1]){for(t+=2;t<e.length&&"}}"!==e.slice(t,t+2);)t++;t+=2}else{if("<"===n)return null;t++}}return null};let k=b(h);const x=t.savePosition();for(;!k&&t.nextLine();)m+="\n"+t.line.text,g=t.lineStart+t.line.text.length,k=b(m);if(!k){t.restorePosition(x);const n=t.parser.parseInline(s,a);return t.addElement(t.elt(e.Paragraph,a,a+s.length,n)),!0}const $=m.slice(0,k.pos-(k.selfClose?2:1));if($.trim()){const e=ze($,p,0,t.parser.parseInline.bind(t.parser),t.parser.parseContent.bind(t.parser));l.push(...e)}const y=p+k.pos;if(k.selfClose)return l.push(u(e.SelfClosingMarker,y-2,y-1)),l.push(u(e.TagMark,y-1,y)),t.addElement(u(e.Widget,o,y,l)),!0;l.push(u(e.TagMark,y-1,y));const w=`</$${r}$>`,T=new RegExp(`<\\/\\$${r.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")}\\$>`),S=t.input.read(y,g),C=T.exec(S);if(C){const n=y,s=y+C.index;if(s>n){const e=t.input.read(n,s),i=t.parser.parseInline(e,n);l.push(...i)}const i=s,a=i+w.length,c=i+2,d=a-1,f=[u(e.TagMark,i,i+2),u(e.Placeholder,c,d,[u(e.PlaceholderMark,c,c+1),u(e.VariableName,c+1,c+1+r.length),u(e.PlaceholderMark,d-1,d)]),u(e.TagMark,a-1,a)];return l.push(u(e.WidgetEnd,i,a,f)),t.addElement(u(e.Widget,o,g,l)),!0}const v=t.savePosition();let M=g,L=!1;for(;t.nextLine();){const n=t.line.text,s=T.exec(n);if(s){const n=t.lineStart+s.index;if(n>y){const e=t.parseWidgetContent(y,n);l.push(...e)}const i=t.lineStart+s.index,a=i+w.length,o=i+2,c=a-1,d=[u(e.TagMark,i,i+2),u(e.Placeholder,o,c,[u(e.PlaceholderMark,o,o+1),u(e.VariableName,o+1,o+1+r.length),u(e.PlaceholderMark,c-1,c)]),u(e.TagMark,a-1,a)];l.push(u(e.WidgetEnd,i,a,d)),M=a,L=!0;break}}return L||(t.restorePosition(v),M=g),t.addElement(u(e.Widget,o,M,l)),!0}if(Ke.exec(s)){const n=t.lineStart,i=n+s.length,r=t.parser.parseInline(s,n);return t.addElement(t.elt(e.Paragraph,n,i,r)),!0}const r=Ze.exec(s);if(r){const n=r[1].length,i=r[2],a=i.startsWith("$"),o=t.lineStart,l=[],c=o+n;l.push(u(e.TagMark,c,c+2));const d=o+n+2;l.push(u(a?e.WidgetName:e.TagName,d,d+i.length));const f=o+r[0].length;l.push(u(e.TagMark,f-1,f)),t.addElement(u(a?e.WidgetEnd:e.HTMLEndTag,c,f,l));const h=s.slice(r[0].length);if(h.trim()){const n=t.parser.parseInline(h,f),s=t.elt(e.Paragraph,f,f+h.length,n);t.addElement(s)}return!0}const a=Re.exec(s);if(!a)return!1;const o=a[1].length,l=a[2],c=l.startsWith("$"),d=t.lineStart;if("$"===l){const n=d+o,i=d+o+1,r=a[0].length,l=s[r];if(">"===l){const s=[u(e.TagMark,n,n+1),u(e.WidgetName,i,i+1),u(e.TagMark,d+r,d+r+1)];return t.nextLine(),t.addElement(u(e.Widget,d,d+r+1,s)),!0}if("/"===l&&">"===s[r+1]){const s=[u(e.TagMark,n,n+1),u(e.WidgetName,i,i+1),u(e.SelfClosingMarker,d+r,d+r+1),u(e.TagMark,d+r+1,d+r+2)];return t.nextLine(),t.addElement(u(e.Widget,d,d+r+2,s)),!0}return!1}const f=[],h=d+o;f.push(u(e.TagMark,h,h+1));const p=d+o+1;let m,g;f.push(u(c?e.WidgetName:e.TagName,p,p+l.length));let b,k=p+l.length;const x=e=>{let t=0;const n=e.length;for(;t<n;){const s=e[t];if(">"===s)return{pos:t+1,selfClose:!1};if("/"===s&&">"===e[t+1])return{pos:t+2,selfClose:!0};if('"'===s&&'"'===e[t+1]&&'"'===e[t+2]){for(t+=3;t<n&&('"'!==e[t]||'"'!==e[t+1]||'"'!==e[t+2]);)t++;t+=3}else if('"'===s||"'"===s){const i=s;for(t++;t<n&&e[t]!==i;)"\\"===e[t]&&t++,t++;t++}else if("<"===s&&"<"===e[t+1]){t+=2;let s=1;for(;t<n&&s>0;)"<"===e[t]&&"<"===e[t+1]?(s++,t+=2):">"===e[t]&&">"===e[t+1]?(s--,t+=2):t++}else if("<"===s){const s=e[t+1];if("/"===s)return null;if(s&&/[a-zA-Z$]/.test(s)){let s=t+2;for(;s<n&&/[a-zA-Z0-9\-_$.]/.test(e[s]);)s++;const i=e[s];if(">"===i)t=s+1;else{if("/"===i&&">"===e[s+1])return null;if(i&&(/\s/.test(i)||"="===i))return null;t=s}}else t++}else if("{"===s&&"{"===e[t+1]&&"{"===e[t+2]){for(t+=3;t<n&&("}"!==e[t]||"}"!==e[t+1]||"}"!==e[t+2]);)t++;t+=3}else if("{"===s&&"{"===e[t+1]){for(t+=2;t<n&&("}"!==e[t]||"}"!==e[t+1]);)t++;t+=2}else if("`"===s)if("```"===e.slice(t,t+3)){for(t+=3;t<n&&"```"!==e.slice(t,t+3);)t++;t+=3}else{for(t++;t<n&&"`"!==e[t];)t++;t++}else t++}return null},$=s.slice(o+1+l.length);let y=x($),w=$;const T=t.savePosition();for(;!y&&t.nextLine();)w+="\n"+t.line.text,y=x(w);if(y||t.restorePosition(T),!y){g=!1;let n=$.length,i=0,r=0,a=0,h=0;for(;i<$.length;){const e=$[i],t=$.slice(i,i+2),s=$.slice(i,i+3);if('"'===e||"'"===e){const t=e;if('"'===e&&'"""'===s){for(i+=3;i<$.length&&'"""'!==$.slice(i,i+3);)i++;i<$.length&&(i+=3);continue}for(i++;i<$.length&&$[i]!==t;)"\\"===$[i]&&i++,i++;i++}else if("{{{"===s)r++,i+=3;else if("}}}"===s)r>0&&r--,i+=3;else if("<<"===t)h++,i+=2;else if(">>"===t)h>0&&h--,i+=2;else if("["===e&&(r>0||h>0))a++,i++;else if("]"===e&&a>0)a--,i++;else if("<"===e){if(0===r&&0===a&&0===h){const e=$[i+1];if(e&&/[a-zA-Z$\/]/.test(e)){n=i;break}}i++}else i++}const p=$.slice(0,n);m=d+o+1+l.length+n;const b=t.lineStart+s.length;if(p.trim()){const e=ze(p,k,0,t.parser.parseInline.bind(t.parser),t.parser.parseContent.bind(t.parser));f.push(...e)}if(t.addElement(u(c?e.IncompleteWidget:e.IncompleteHTMLBlock,d,m,f)),m<b){if(t.input.read(m,b).trim()){const e=t.parseContentRange(m,b,!1);for(const n of e)t.addElement(n);t.skipToPosition(b)}}return!0}{g=y.selfClose,m=d+o+1+l.length+y.pos,b=t.lineStart+t.line.text.length;let n=w.slice(0,y.pos-1);if(g&&n.endsWith("/")&&(n=n.slice(0,-1)),n.trim()){const e=ze(n,k,0,t.parser.parseInline.bind(t.parser),t.parser.parseContent.bind(t.parser));f.push(...e)}g?(f.push(u(e.SelfClosingMarker,m-2,m-1)),f.push(u(e.TagMark,m-1,m))):f.push(u(e.TagMark,m-1,m))}if(!g){new RegExp(`<${l.replace(/\$/g,"\\$")}(?:\\s|>|/>)`),new RegExp(`</${l.replace(/\$/g,"\\$")}>`),new RegExp(`^(\\s*)</${l.replace(/\$/g,"\\$")}>`);let n=b,s=!1;const i=t.input.read(m,b);let r=-1,a=0,o=1,h=0;const p=`<${l}`,g=`</${l}>`;for(;h<i.length&&o>0;){const e=i.indexOf(p,h),t=i.indexOf(g,h);if(-1===t)break;if(-1!==e&&e<t){const t=i[e+p.length];if(" "===t||">"===t||"\t"===t||"\n"===t||"/"===t||void 0===t){i.slice(e).match(/^<[a-zA-Z\$][a-zA-Z0-9\-\$\.]*[^>]*\/>/)||o++}h=e+1}else{if(o--,0===o){r=t,a=g.length;break}h=t+1}}if(-1!==r){const o=m,h=m+r;if(h>o){const e=t.input.read(o,h),n=t.parser.parseInline(e,o);f.push(...n)}const p=m+r,g=m+r+a,k=[];k.push(u(e.TagMark,p,p+2));const x=m+r+2;k.push(u(c?e.WidgetName:e.TagName,x,x+l.length)),k.push(u(e.TagMark,g-1,g)),f.push(u(c?e.WidgetEnd:e.HTMLEndTag,p,g,k));const $=i.slice(r+a);if($.trim()){if(/^<[$a-zA-Z]/.test($.trim())){t.addElement(u(c?e.Widget:e.HTMLBlock,d,g,f));const n=g,s=t.rangeEnd;if(s>n){const e=t.parseContentRange(n,s,!1);for(const n of e)t.addElement(n);t.skipToPosition(s)}return!0}const n=g,s=t.parser.parseInline($,n);f.push(...s)}n=b,s=!0}if(!s){const i=t.input.read(m,b),r=b+1;let a=r,o=1,h=0;const p=e=>{const t=[];let n=0,s=0,i=0,r=0,a=0,o=0;for(;n<e.length;){const l=e[n],c=e.slice(n,n+2),d=e.slice(n,n+3);if("<%"===c){const t=e.slice(n).match(/^<%\s*(if|endif)\b/);if(t){"if"===t[1]?o++:"endif"===t[1]&&o>0&&o--,n+=2;continue}}if("{{{"!==d)if("}}}"===d&&i>0)i--,n+=3;else if("{{"!==c||"{{{"===d)if("}}"===c&&"}}}"!==d&&r>0)r--,n+=2;else if("<<"!==c)if(">>"===c&&a>0)a--,n+=2;else if("["!==l)if("]"===l&&s>0)s--,n++;else{if('"'===l||"'"===l){const t=l;for(n++;n<e.length&&e[n]!==t;)"\\"===e[n]&&n++,n++;n++;continue}if(0===s&&0===i&&0===r&&0===a&&0===o){const s=e.slice(n).match(/^<\/([a-zA-Z\$][a-zA-Z0-9\-\$\.]*)>/);if(s){t.push({pos:n,name:s[1],isClose:!0,isSelfClosing:!1}),n+=s[0].length;continue}const i=e.slice(n).match(/^<([a-zA-Z\$][a-zA-Z0-9\-\$\.]*)(?=[\s>\/])/);if(i){const s=i[1].toLowerCase();let r=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"].includes(s);if(!r){let t=n+i[0].length,s=0,a=0,o=0;for(;t<e.length;){const n=e[t],i=e.slice(t,t+2),l=e.slice(t,t+3);if("{{{"!==l)if("}}}"===l&&o>0)o--,t+=3;else if("{{"!==i||"{{{"===l)if("}}"===i&&"}}}"!==l&&a>0)a--,t+=2;else if("<<"!==i)if(">>"===i&&s>0)s--,t+=2;else{if('"'===n||"'"===n){const s=n;for(t++;t<e.length&&e[t]!==s;)"\\"===e[t]&&t++,t++;t++;continue}if(0===s&&0===a&&0===o){if("/>"===i){r=!0;break}if(">"===n){r=!1;break}}t++}else s++,t+=2;else a++,t+=2;else o++,t+=3}}t.push({pos:n,name:i[1],isClose:!1,isSelfClosing:r}),n+=i[0].length;continue}}n++}else s++,n++;else a++,n+=2;else r++,n+=2;else i++,n+=3}return t},g=p(i);for(const e of g)e.name===l?e.isClose?o>1&&o--:e.isSelfClosing||o++:e.isClose?h>0&&h--:e.isSelfClosing||h++;const k=t.savePosition();for(;t.nextLine();){const g=t.line.text,b=p(g);let k=-1,x=0;for(const e of b)if(e.name===l)if(e.isClose){if(1===o&&0===h){o--,k=e.pos,x=l.length+3;break}o>1&&o--}else e.isSelfClosing||o++;else e.isClose?h>0&&h--:e.isSelfClosing||h++;if(-1!==k&&0===o&&0===h){const o=t.lineStart+k,h=x,p=o+h;a=o-1;const b=i.trim(),$=b&&/<[$a-zA-Z]/.test(b),y=t.startsWithBlankLine(m,a+1);if(i.trim()&&!$){const e=t.parser.parseInline(i,m);f.push(...e)}const w=$?m:r;if(a>=w)if(y){const e=t.parseContentRange(w,a+1,!1);f.push(...e)}else{const e=t.parseInlineRange(w,a+1);f.push(...e)}const T=[];T.push(u(e.TagMark,o,o+2));const S=o+2;T.push(u(c?e.WidgetName:e.TagName,S,S+l.length)),T.push(u(e.TagMark,p-1,p)),f.push(u(c?e.WidgetEnd:e.HTMLEndTag,o,p,T)),n=p;const C=g.slice(k+h);if(C.trim()&&/^<[$a-zA-Z]/.test(C.trim())){t.addElement(u(c?e.Widget:e.HTMLBlock,d,n,f));const s=p,i=t.rangeEnd;if(i>s){const e=t.parseContentRange(s,i,!1);for(const n of e)t.addElement(n);t.skipToPosition(i)}return!0}s=!0;break}}s||(t.restorePosition(k),n=b)}return t.addElement(u(c?e.Widget:e.HTMLBlock,d,n,f)),!0}if(t.input.read(m,b).trim()){t.addElement(u(c?e.Widget:e.HTMLBlock,d,m,f));const n=m,s=t.rangeEnd;if(s>n){const e=t.parseContentRange(n,s,!1);for(const n of e)t.addElement(n);t.skipToPosition(s)}return!0}return t.addElement(u(c?e.Widget:e.HTMLBlock,d,m,f)),!0}},je={name:"StyledBlock",parse(t,n){if(!n.text.startsWith("@@"))return!1;if(-1!==n.text.indexOf("@@",2))return!1;const s=t.lineStart,i=[u(e.HighlightMark,s,s+2)],r=n.text.slice(2);let a=-1;for(let e=0;e<r.length;e++)if("."===r[e]){const t=r[e+1];if(!t||/[a-zA-Z_\s\.]/.test(t)){a=e;break}}let o=-1!==a?a:r.trimEnd().length;o>0&&i.push(u(e.HighlightStyles,s+2,s+2+o));let l=-1!==a?2+a:n.text.length;for(;l<n.text.length;)if("."===n.text[l]){const t=l;l++;const r=l;for(;l<n.text.length&&/[a-zA-Z0-9_\-]/.test(n.text[l]);)l++;l>r&&(i.push(u(e.StyledBlockMark,s+t,s+t+1)),i.push(u(e.StyledBlockClass,s+r,s+l)))}else l++;const c=s+n.text.length;let d=t.lineStart+n.text.length+1,f=d;for(;d<t.input.length;){let n=d;for(;n<t.input.length&&"\n"!==t.input.read(n,n+1);)n++;const r=t.input.read(d,n);if("@@"===r.trim()){if(f=d,f>c+1){const e=t.parseContentRange(c+1,f);i.push(...e)}const a=d+r.indexOf("@@");for(i.push(u(e.HighlightMark,a,a+2)),t.addElement(u(e.Highlight,s,n,i));t.lineStart<d;)t.nextLine();return!0}d=n+1}return!1}},qe=/^\s*<%\s*if\s+(.+?)\s*%>/,Ue=/^\s*<%\s*elseif\s+(.+?)\s*%>/,Qe=/^\s*<%\s*else\s*%>/,Ge=/^\s*<%\s*endif\s*%>/,Ye=[he,ge,{name:"ConditionalBlock",parse(t,n){const s=qe.exec(n.text);if(!s)return!1;const i=t.lineStart,r=s[1],a=[],o=i+n.text.indexOf("<%"),l=i+n.text.indexOf("if");a.push(u(e.ConditionalMark,o,o+2)),a.push(u(e.ConditionalKeyword,l,l+2));const c=i+n.text.indexOf(r),d=v(r,c);a.push(u(e.FilterExpression,c,c+r.length,d));const f=i+n.text.indexOf("%>");a.push(u(e.ConditionalMark,f,f+2));const h=i+n.text.length;let p=f+2,m=p,g=1,b=-1,k=-1;const x=n.text.slice(f+2-i),$=/<%\s*endif\s*%>/.exec(x);if($){const n=x.slice(0,$.index);if(n.trim()){const s=f+2,i=f+2+$.index,r=t.parser.parseInline(n,s);a.push(u(e.ConditionalBranch,s,i,r))}const s=f+2+$.index,r=f+2+x.indexOf("endif",$.index),o=f+2+x.indexOf("%>",$.index);return a.push(u(e.ConditionalMark,s,s+2)),a.push(u(e.ConditionalKeyword,r,r+5)),a.push(u(e.ConditionalMark,o,o+2)),b=o+2,t.addElement(u(e.ConditionalBlock,i,b,a)),!0}for(m=h+1;m<t.input.length&&g>0;){let n=m;for(;n<t.input.length&&"\n"!==t.input.read(n,n+1);)n++;const s=t.input.read(m,n);if(qe.test(s))g++;else if(Ge.test(s)){if(g--,0===g){if(m>p){const n=t.parseContentRange(p,m);n.length>0&&a.push(u(e.ConditionalBranch,p,m,n))}const i=m+s.indexOf("<%"),r=m+s.indexOf("endif"),o=m+s.indexOf("%>");a.push(u(e.ConditionalMark,i,i+2)),a.push(u(e.ConditionalKeyword,r,r+5)),a.push(u(e.ConditionalMark,o,o+2)),k=m,b=n;break}}else if(1===g&&Ue.test(s)){if(m>p){const n=t.parseContentRange(p,m);n.length>0&&a.push(u(e.ConditionalBranch,p,m,n))}const i=Ue.exec(s);if(i){const t=m+s.indexOf("<%"),n=m+s.indexOf("elseif");a.push(u(e.ConditionalMark,t,t+2)),a.push(u(e.ConditionalKeyword,n,n+6));const r=i[1],o=m+s.indexOf(r),l=v(r,o);a.push(u(e.FilterExpression,o,o+r.length,l)),a.push(u(e.ConditionalMark,m+s.indexOf("%>"),m+s.indexOf("%>")+2))}p=n+1}else if(1===g&&Qe.test(s)){if(m>p){const n=t.parseContentRange(p,m);n.length>0&&a.push(u(e.ConditionalBranch,p,m,n))}const i=m+s.indexOf("<%"),r=m+s.indexOf("else"),o=m+s.indexOf("%>");a.push(u(e.ConditionalMark,i,i+2)),a.push(u(e.ConditionalKeyword,r,r+4)),a.push(u(e.ConditionalMark,o,o+2)),p=n+1}m=n+1}if(-1===b){if(p<=t.input.length){const n=t.parseContentRange(p,t.input.length);a.push(u(e.ConditionalBranch,p,t.input.length,n))}for(t.addElement(u(e.ConditionalBlock,i,t.input.length,a));!t.atEnd;)t.nextLine();return!0}for(t.addElement(u(e.ConditionalBlock,i,b,a));t.lineStart<k;)t.nextLine();return!0}},je,le,de,ke,Le,ve,Ee,We,Fe,Ne,Oe,Xe],Je=new Set(["'".charCodeAt(0),"/".charCodeAt(0),"_".charCodeAt(0),"^".charCodeAt(0),",".charCodeAt(0),"~".charCodeAt(0),"`".charCodeAt(0),"[".charCodeAt(0),"]".charCodeAt(0),"{".charCodeAt(0),"}".charCodeAt(0),"<".charCodeAt(0),">".charCodeAt(0),"(".charCodeAt(0),")".charCodeAt(0),"*".charCodeAt(0),"#".charCodeAt(0),";".charCodeAt(0),":".charCodeAt(0),"!".charCodeAt(0),"|".charCodeAt(0),"\\".charCodeAt(0),"@".charCodeAt(0),"$".charCodeAt(0),"%".charCodeAt(0),"&".charCodeAt(0),"-".charCodeAt(0),"=".charCodeAt(0),"+".charCodeAt(0)]),et={name:"Escape",parse(n,s,i){if(s!==t.Tilde&&s!==t.Backslash)return-1;const r=n.char(i+1);return r<0?-1:s===t.Tilde?r>=65&&r<=90?n.addElement(n.elt(e.Escape,i,i+1)):-1:Je.has(r)?n.addElement(n.elt(e.Escape,i,i+2)):-1}},tt=/^&(?:#x[0-9a-fA-F]+|#[0-9]+|[a-zA-Z]+);/,nt={name:"Entity",parse(n,s,i){if(s!==t.Ampersand)return-1;const r=n.slice(i,n.end),a=tt.exec(r);return a?n.addElement(n.elt(e.Entity,i,i+a[0].length)):-1}},st={name:"InlineCode",parse(n,s,i){if(s!==t.Backtick)return-1;const r=n.char(i+1)===t.Backtick?2:1,a=i+r;let o=a;for(;o<n.end;){if(n.char(o)===t.Backtick){const s=o+1<n.end&&n.char(o+1)===t.Backtick?2:1;if(s===r){const t=o+s;return n.addElement(n.elt(e.InlineCode,i,t,[n.elt(e.InlineCodeMark,i,a),n.elt(e.CodeText,a,o),n.elt(e.InlineCodeMark,o,t)]))}o+=s;continue}o++}const l=[n.elt(e.InlineCodeMark,i,a)];return n.end>a&&l.push(n.elt(e.CodeText,a,n.end)),n.addElement(n.elt(e.InlineCode,i,n.end,l))}},it={name:"InlineKaTeX",after:"InlineCode",parse(n,s,i){if(s!==t.Dollar)return-1;if(n.char(i+1)!==t.Dollar)return-1;if(n.char(i+2)===t.Dollar)return-1;const r=n.char(i+2);if(r>=0&&/[a-zA-Z_]/.test(String.fromCharCode(r)))return-1;const a=i+2;let o=a;for(;o<n.end-1;){if(n.char(o)===t.Dollar&&n.char(o+1)===t.Dollar){const t=o+2,s=[n.elt(e.KaTeXMark,i,a)];return o>a&&s.push(n.elt(e.LaTeXContent,a,o)),s.push(n.elt(e.KaTeXMark,o,t)),n.addElement(n.elt(e.KaTeXBlock,i,t,s))}o++}return-1}},rt={name:"Bold",parse:L({charCode:t.Apostrophe,delimType:{resolve:"Bold",mark:"BoldMark"}})},at={name:"Italic",parse:L({charCode:t.Slash,delimType:{resolve:"Italic",mark:"ItalicMark"}})},ot={name:"Underline",parse:L({charCode:t.Underscore,delimType:{resolve:"Underline",mark:"UnderlineMark"}})},lt={name:"Strikethrough",parse:L({charCode:t.Tilde,delimType:{resolve:"Strikethrough",mark:"StrikethroughMark"}})},ct={name:"Superscript",parse:L({charCode:t.Caret,delimType:{resolve:"Superscript",mark:"SuperscriptMark"}})},dt={name:"Subscript",parse:L({charCode:t.Comma,delimType:{resolve:"Subscript",mark:"SubscriptMark"}})},ft=/^((?:[^\.\r\n\s:]+:[^\r\n;]+;)+)/,ut={name:"Highlight",parse(n,s,i){if(s!==t.At||n.char(i+1)!==t.At)return-1;const r=n.slice(i,n.end);let a=-1;for(let e=2;e<r.length-1;e++)if("@"===r[e]&&"@"===r[e+1]){a=e;break}if(-1===a)return-1;const o=i+a+2,l=r.slice(2,a),c=[n.elt(e.HighlightMark,i,i+2)];let d=0;const f=ft.exec(l);if(f){const t=f[1].length;c.push(n.elt(e.HighlightStyles,i+2,i+2+t)),d=t}for(;d<l.length&&"."===l[d];){const t=d;d++;const s=d;for(;d<l.length&&/[a-zA-Z0-9_\-]/.test(l[d]);)d++;d>s&&(c.push(n.elt(e.StyledBlockMark,i+2+t,i+2+t+1)),c.push(n.elt(e.StyledBlockClass,i+2+s,i+2+d)))}if(d<l.length&&/\s/.test(l[d])&&d++,d<a){const e=l.slice(d),t=n.parser.parseInline(e,i+2+d);c.push(...t)}return c.push(n.elt(e.HighlightMark,o-2,o)),n.addElement(n.elt(e.Highlight,i,o,c))}},ht=/^\[\[([^\]|]*?)(?:\|([^\]]*?))?\]\]/,pt=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/;function mt(t,n,s,i){const r=pt.exec(n);if(r){const n=r[1];return t.elt(e.Placeholder,s,i,[t.elt(e.PlaceholderMark,s,s+1),t.elt(e.VariableName,s+1,s+1+n.length),t.elt(e.PlaceholderMark,i-1,i)])}return t.elt(e.LinkTarget,s,i)}const gt={name:"WikiLink",parse(n,s,i){if(s!==t.LeftBracket||n.char(i+1)!==t.LeftBracket)return-1;const r=n.slice(i,n.end),a=ht.exec(r);if(!a){const t=/^\[\[([^\]\n]*)$/.exec(r);if(t){const s=i+t[0].length,r=t[1],a=[n.elt(e.WikiLinkMark,i,i+2)],o=r.indexOf("|");if(-1!==o){if(a.push(n.elt(e.LinkText,i+2,i+2+o)),a.push(n.elt(e.LinkSeparator,i+2+o,i+3+o)),r.length>o+1){const e=r.slice(o+1);a.push(mt(n,e,i+3+o,s))}}else r&&a.push(mt(n,r,i+2,s));return n.addElement(n.elt(e.WikiLink,i,s,a))}return-1}const o=i+a[0].length,l=a[1],c=a[2],d=[n.elt(e.WikiLinkMark,i,i+2)];return void 0!==c?(d.push(n.elt(e.LinkText,i+2,i+2+l.length)),d.push(n.elt(e.LinkSeparator,i+2+l.length,i+3+l.length)),d.push(mt(n,c,i+3+l.length,o-2))):d.push(mt(n,l,i+2,o-2)),d.push(n.elt(e.WikiLinkMark,o-2,o)),n.addElement(n.elt(e.WikiLink,i,o,d))}},bt=/^\[ext\[([^\]|]*?)(?:\|([^\]]*?))?\]\]/,kt={name:"ExternalLink",parse(n,s,i){if(s!==t.LeftBracket)return-1;const r=n.slice(i,n.end),a=bt.exec(r);if(!a){const t=/^\[ext\[([^\]\n]*)$/.exec(r);if(t){const s=i+t[0].length,r=t[1],a=[n.elt(e.ExtLinkMark,i,i+5)],o=r.indexOf("|");if(-1!==o){if(a.push(n.elt(e.LinkText,i+5,i+5+o)),a.push(n.elt(e.LinkSeparator,i+5+o,i+6+o)),r.length>o+1){const e=r.slice(o+1);a.push(S(e,i+6+o,s))}}else r&&a.push(S(r,i+5,s));return n.addElement(n.elt(e.ExternalLink,i,s,a))}return-1}const o=i+a[0].length,l=a[1],c=a[2],d=[n.elt(e.ExtLinkMark,i,i+5)];return void 0!==c?(d.push(n.elt(e.LinkText,i+5,i+5+l.length)),d.push(n.elt(e.LinkSeparator,i+5+l.length,i+6+l.length)),d.push(S(c,i+6+l.length,o-2))):d.push(S(l,i+5,o-2)),d.push(n.elt(e.ExtLinkMark,o-2,o)),n.addElement(n.elt(e.ExternalLink,i,o,d))}},xt=/^\[img(\s+[^\[]+)?\[([^\]|]*?)(?:\|([^\]]*?))?\]\]/,$t={name:"ImageLink",parse(n,s,i){if(s!==t.LeftBracket)return-1;const r=n.slice(i,n.end),a=xt.exec(r);if(!a){const t=/^\[img(\s+[^\[\n]+)?\[([^\]\n]*)$/.exec(r);if(t){const s=i+t[0].length,r=t[1],a=t[2],o=[n.elt(e.ImageMark,i,i+4)];let l=i+4;if(r){const e=i+4;l=e+r.length;const t=Et(n,r.trim(),e+(r.length-r.trimStart().length));o.push(...t)}if(o.push(n.elt(e.ImageMark,l,l+1)),a){const t=l+1,i=a.indexOf("|");if(-1!==i){if(o.push(n.elt(e.ImageTooltip,t,t+i)),o.push(n.elt(e.LinkSeparator,t+i,t+i+1)),a.length>i+1){const e=a.slice(i+1);o.push(T(e,t+i+1,s))}}else o.push(T(a,t,s))}return n.addElement(n.elt(e.ImageLink,i,s,o))}return-1}const o=i+a[0].length,l=a[1],c=a[2],d=a[3],f=[n.elt(e.ImageMark,i,i+4)];let u=i+4;if(l){const e=i+4;u=e+l.length;const t=Et(n,l.trim(),e+(l.length-l.trimStart().length));f.push(...t)}const h=u;f.push(n.elt(e.ImageMark,h,h+1));const p=h+1;if(void 0!==d){const t=p+c.length;c&&f.push(n.elt(e.ImageTooltip,p,t)),f.push(n.elt(e.LinkSeparator,t,t+1));const s=t+1,i=s+d.length;d&&f.push(T(d,s,i))}else{const e=p+c.length;c&&f.push(T(c,p,e))}return f.push(n.elt(e.ImageMark,o-2,o)),n.addElement(n.elt(e.ImageLink,i,o,f))}},yt={name:"IncompleteFilterRun",parse(n,s,i){if(s!==t.LeftBracket)return-1;const r=n.slice(i,n.end);if(r.startsWith("[[")||r.startsWith("[img")||r.startsWith("[ext"))return-1;if(!/^\[(?:!?[\w][\w\-:!.]*(?:[\[{<]|$)|[<{])/.test(r))return-1;let a=i+1,o=1,l=!1,c="";for(;a<n.end&&o>0;){const e=n.char(a);if(e===t.Newline)break;if(l){if("["===c&&e===t.RightBracket||"{"===c&&e===t.RightBrace||"<"===c&&e===t.GreaterThan){l=!1,c="",a++;continue}}else if(e===t.LeftBracket){if(n.char(a+1)===t.LeftBracket)break;l=!0,c="["}else if(e===t.LeftBrace)l=!0,c="{";else if(e===t.LessThan)l=!0,c="<";else if(e===t.RightBracket){if(o--,0===o){if(a++,n.char(a)===t.RightBracket)return-1;break}}else{if(e===t.Comma){a++;continue}if(e===t.Space||e===t.Tab){const e=wt(n,a);if(-1===e||n.char(e)!==t.LeftBracket)break}}a++}if(a<=i+1)return-1;const d=v(n.slice(i,a),i);return n.addElement(n.elt(e.IncompleteFilterRun,i,a,d))}};function wt(e,n){for(;n<e.end;){const s=e.char(n);if(s!==t.Space&&s!==t.Tab)return n;n++}return-1}const Tt=/^\{\{([^{}|]*?)(?:\|\|([^{}|]+?))?(?:\|([^{}]+?))?\}\}/,St={name:"Transclusion",parse(n,s,i){if(s!==t.LeftBrace||n.char(i+1)!==t.LeftBrace)return-1;if(n.char(i+2)===t.LeftBrace)return-1;const r=n.slice(i,n.end),a=Tt.exec(r);if(!a){const t=/^\{\{([^{}\n~'^/_`<\[]*?)(?=~~|''|\/\/|^^|,,|``|<<|__|$)/.exec(r);if(t&&t[0].length>2){const s=i+t[0].length,r=t[1],a=[n.elt(e.TransclusionMark,i,i+2)];if(r){const e=P(r,i+2);a.push(...e)}return n.addElement(n.elt(e.Transclusion,i,s,a))}return-1}const o=i+a[0].length,l=a[1],c=a[2],d=[n.elt(e.TransclusionMark,i,i+2)],f=P(l,i+2);if(d.push(...f),c){const t=i+2+l.length+2;d.push(n.elt(e.TransclusionTemplate,t,t+c.length))}return d.push(n.elt(e.TransclusionMark,o-2,o)),n.addElement(n.elt(e.Transclusion,i,o,d))}},Ct={name:"FilteredTransclusion",parse(n,s,i){if(s!==t.LeftBrace||n.char(i+1)!==t.LeftBrace||n.char(i+2)!==t.LeftBrace)return-1;const r=n.slice(i,n.end);let a=-1;for(let e=3;e<r.length-2;e++)if("}"===r[e]&&"}"===r[e+1]&&"}"===r[e+2]){a=e;break}if(-1===a){const t=/^\{\{\{([^\n~'^/_`<\[]*?)(?=~~|''|\/\/|^^|,,|``|<<|__|$)/.exec(r);if(t&&t[0].length>3){const s=i+t[0].length,r=t[1],a=v(r,i+3),o=[n.elt(e.FilteredTransclusionMark,i,i+3)];return r&&o.push(n.elt(e.FilterExpression,i+3,s,a)),n.addElement(n.elt(e.FilteredTransclusion,i,s,o))}return-1}const o=r.slice(3,a);let l=i+a+3,c="";if("||"===r.slice(a+3,a+5)){const e=a+5;let t=e;for(;t<r.length&&!/[\s}]/.test(r[t]);)t++;c=r.slice(e,t),l=i+t}const d=v(o,i+3),f=[n.elt(e.FilteredTransclusionMark,i,i+3),n.elt(e.FilterExpression,i+3,i+3+o.length,d),n.elt(e.FilteredTransclusionMark,i+3+o.length,i+a+3)];return c&&f.push(n.elt(e.TransclusionTemplate,i+a+5,l)),n.addElement(n.elt(e.FilteredTransclusion,i,l,f))}},vt={name:"MacroCall",parse(n,s,i){if(s!==t.LessThan||n.char(i+1)!==t.LessThan)return-1;if(n.char(i+2)===t.LessThan)return-1;const r=n.slice(i,n.end),a=r.length-1;let o=-1,l=1,c=-1;for(let e=2;e<a;e++)if(-1===c&&"\n"===r[e]&&(c=e),"<"===r[e]&&"<"===r[e+1])l++,e++;else if(">"===r[e]&&">"===r[e+1]){if(l--,0===l){o=e;break}e++}const d=-1===o;if(d){o=-1===c?r.length:c;let e=2;for(;e<o&&!/[\s\n>]/.test(r[e]);)e++;if(2===e)return-1}const f=i+o+(d?0:2);if(f<=i||f>n.end)return-1;let u=2;for(;u<o&&!/[\s>]/.test(r[u]);)u++;const h=r.slice(2,u);if(!h)return-1;const p=[n.elt(e.MacroCallMark,i,i+2)],m=/^__(.+)__$/.exec(h),g=!m&&/^__(.*)$/.exec(h);if(m){const t=m[1],s=i+2,r=[n.elt(e.SubstitutedParamMark,s,s+2),n.elt(e.SubstitutedParamName,s+2,s+2+t.length),n.elt(e.SubstitutedParamMark,s+2+t.length,s+h.length)];p.push(n.elt(e.SubstitutedParam,s,s+h.length,r))}else if(g){const t=g[1],s=i+2,r=[n.elt(e.SubstitutedParamMark,s,s+2)];t&&r.push(n.elt(e.SubstitutedParamName,s+2,s+2+t.length)),p.push(n.elt(e.SubstitutedParam,s,s+h.length,r))}else{const t=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(h);if(t){const s=t[1],r=i+2,a=[n.elt(e.PlaceholderMark,r,r+1),n.elt(e.VariableName,r+1,r+1+s.length),n.elt(e.PlaceholderMark,r+h.length-1,r+h.length)];p.push(n.elt(e.Placeholder,r,r+h.length,a))}else p.push(n.elt(e.MacroName,i+2,i+2+h.length))}if(u<o){const e=r.slice(u,o);if(e.trim()){const t=I(e,i+u);p.push(...t)}}return d||p.push(n.elt(e.MacroCallMark,f-2,f)),n.addElement(n.elt(e.MacroCall,i,f,p))}};function Mt(e){let t=0;const n=e.length;for(;t<n;){const s=e[t];if(">"===s)return{end:t+1,selfClose:!1};if("/"===s&&">"===e[t+1])return{end:t+2,selfClose:!0};if('"'===s&&'"'===e[t+1]&&'"'===e[t+2]){for(t+=3;t<n&&('"'!==e[t]||'"'!==e[t+1]||'"'!==e[t+2]);)t++;t+=3}else if('"'===s||"'"===s){const i=s;for(t++;t<n&&e[t]!==i;)"\\"===e[t]&&t++,t++;t++}else if("<"===s&&"<"===e[t+1]){t+=2;let s=1;for(;t<n&&s>0;)"<"===e[t]&&"<"===e[t+1]?(s++,t+=2):">"===e[t]&&">"===e[t+1]?(s--,t+=2):t++}else if("{"===s&&"{"===e[t+1]&&"{"===e[t+2]){for(t+=3;t<n&&("}"!==e[t]||"}"!==e[t+1]||"}"!==e[t+2]);)t++;t+=3}else if("{"===s&&"{"===e[t+1]){for(t+=2;t<n&&("}"!==e[t]||"}"!==e[t+1]);)t++;t+=2}else if("`"===s)if("```"===e.slice(t,t+3)){for(t+=3;t<n&&"```"!==e.slice(t,t+3);)t++;t+=3}else{for(t++;t<n&&"`"!==e[t];)t++;t++}else if("<"===s){const s=e[t+1];if("/"===s)return null;if(s&&/[a-zA-Z$]/.test(s)){let s=t+2;for(;s<n&&/[a-zA-Z0-9\-_$.]/.test(e[s]);)s++;const i=e[s];if(">"===i)t=s+1;else{if("/"===i&&">"===e[s+1])return null;if(i&&(/\s/.test(i)||"="===i))return null;t=s}}else t++}else t++}return null}function Lt(e,t){let n=t;const s=e.length;let i=null,r=0,a=0,o=0;for(;n<s;){const t=e[n],l=e.slice(n,n+2),c=e.slice(n,n+3);if(i)t===i&&"\\"!==e[n-1]&&(i=null),n++;else if('"'!==t&&"'"!==t)if("{{{"!==c)if("}}}"!==c)if("<<"!==l)if(">>"!==l)if("["===t&&(r>0||o>0))a++,n++;else if("]"===t&&a>0)a--,n++;else if("<"!==t)if("\n"!==t){if(0===r&&0===a&&0===o&&("~~"===l||"''"===l||"//"===l||"^^"===l||",,"===l||"``"===l||"__"===l))return n;n++}else{if(0===r&&0===a&&0===o)return n;n++}else{if(0===r&&0===a&&0===o)return n;n++}else o>0&&o--,n+=2;else o++,n+=2;else r>0&&r--,n+=3;else r++,n+=3;else{if('"'===t&&'"""'===c){for(n+=3;n<s&&'"""'!==e.slice(n,n+3);)n++;n<s&&(n+=3);continue}i=t,n++}}return n}const Pt=new Set(["emptymessage","template","caption","tooltip","placeholder","default","alt","description","message","content"]);function At(t,n,s){const i=[],r=/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/g;let a,o=0;for(;null!==(a=r.exec(n));){const n=a.index,r=n+a[0].length,l=a[1];n>o&&i.push(t.elt(e.AttributeValue,s+o,s+n));const c=[t.elt(e.PlaceholderMark,s+n,s+n+1),t.elt(e.VariableName,s+n+1,s+n+1+l.length),t.elt(e.PlaceholderMark,s+r-1,s+r)];i.push(t.elt(e.Placeholder,s+n,s+r,c)),o=r}return i.length>0&&o<n.length&&i.push(t.elt(e.AttributeValue,s+o,s+n.length)),i}function Et(t,n,s){const i=[];let r=0;const a=n.length;for(;r<a;){for(;r<a&&/\s/.test(n[r]);)r++;if(r>=a)break;const o=r;for(;r<a&&/[^\/\s>"'`=]/.test(n[r]);)r++;if(r===o){r++;continue}const l=r;for(;r<a&&/\s/.test(n[r]);)r++;if(r>=a||"="!==n[r]){const r=[w(n.slice(o,l),s+o,s+l)];i.push(t.elt(e.Attribute,s+o,s+l,r));continue}for(r++;r<a&&/\s/.test(n[r]);)r++;if(r>=a){const a=[w(n.slice(o,l),s+o,s+l)];i.push(t.elt(e.Attribute,s+o,s+r,a));continue}const c=r;let d=r,f=e.AttributeValue;const u=n[r];if('"'===u&&'"""'===n.slice(r,r+3)){const f=r;r+=3;const u=r;for(;r<a&&'"""'!==n.slice(r,r+3);)r++;const h=r,p=r;'"""'===n.slice(r,r+3)&&(r+=3),d=r;const m=n.slice(u,h);let g=[t.elt(e.Mark,s+f,s+u)];if(m.trim()){const r=t.parser.parseContent(m,s+u);g.push(...r),g.push(t.elt(e.Mark,s+p,s+d));const a=[w(n.slice(o,l),s+o,s+l),t.elt(e.AttributeWikitext,s+c,s+d,g)];i.push(t.elt(e.Attribute,s+o,s+d,a))}else{const r=[w(n.slice(o,l),s+o,s+l),t.elt(e.AttributeString,s+c,s+d)];i.push(t.elt(e.Attribute,s+o,s+d,r))}continue}if('"'===u||"'"===u){const h=u,p=r+1;for(r++;r<a&&n[r]!==h;)"\\"===n[r]&&r+1<a&&r++,r++;const m=r;r<a&&r++,d=r,f=e.AttributeString;const g=n.slice(o,l).toLowerCase();if("filter"===g||"$filter"===g||"$names"===g||"$values"===g){const r=v(n.slice(p,m),s+p),a=[t.elt(e.Mark,s+c,s+p),t.elt(e.FilterExpression,s+p,s+m,r),t.elt(e.Mark,s+m,s+d)],f=[w(n.slice(o,l),s+o,s+l),t.elt(e.AttributeFiltered,s+c,s+d,a)];i.push(t.elt(e.Attribute,s+o,s+d,f));continue}if(Pt.has(g)){const r=n.slice(p,m);if(r.trim()){const a=t.parser.parseContent(r,s+p),f=[t.elt(e.Mark,s+c,s+p),...a,t.elt(e.Mark,s+m,s+d)],u=[w(n.slice(o,l),s+o,s+l),t.elt(e.AttributeWikitext,s+c,s+d,f)];i.push(t.elt(e.Attribute,s+o,s+d,u));continue}}const b=n.slice(p,m);if(b.includes("$")){const r=At(t,b,s+p);if(r.length>0){const a=[t.elt(e.Mark,s+c,s+p),...r,t.elt(e.Mark,s+m,s+d)],f=[w(n.slice(o,l),s+o,s+l),t.elt(e.AttributeString,s+c,s+d,a)];i.push(t.elt(e.Attribute,s+o,s+d,f));continue}}}else if("{"===u){if("{{{"===n.slice(r,r+3)){const u=r;r+=3;const h=r;for(;r<a&&"}}}"!==n.slice(r,r+3);)r++;const p=r;"}}}"===n.slice(r,r+3)&&(r+=3),d=r,f=e.AttributeFiltered;const m=v(n.slice(h,p),s+h),g=[t.elt(e.FilteredTransclusionMark,s+u,s+u+3),t.elt(e.FilterExpression,s+h,s+p,m),t.elt(e.FilteredTransclusionMark,s+p,s+d)],b=[w(n.slice(o,l),s+o,s+l),t.elt(f,s+c,s+d,g)];i.push(t.elt(e.Attribute,s+o,s+d,b));continue}if("{{"===n.slice(r,r+2)){const u=r;r+=2;const h=r;for(;r<a&&"}}"!==n.slice(r,r+2);)r++;const p=r;"}}"===n.slice(r,r+2)&&(r+=2),d=r,f=e.AttributeIndirect;const m=P(n.slice(h,p),s+h),g=[t.elt(e.TransclusionMark,s+u,s+u+2),...m,t.elt(e.TransclusionMark,s+p,s+d)],b=[w(n.slice(o,l),s+o,s+l),t.elt(f,s+c,s+d,g)];i.push(t.elt(e.Attribute,s+o,s+d,b));continue}for(;r<a&&!/[\s>]/.test(n[r]);)r++;d=r}else{if("<"===u&&"<"===n[r+1]){const u=r;r+=2;const h=r;for(;r<a&&/[^\s>"'=]/.test(n[r]);)r++;const p=r;let m=1;for(;r<a&&m>0;)if("<<"===n.slice(r,r+2))m++,r+=2;else if(">>"===n.slice(r,r+2)){if(m--,0===m)break;r+=2}else r++;const g=r;">>"===n.slice(r,r+2)&&(r+=2),d=r,f=e.AttributeMacro;const b=n.slice(h,p),k=[t.elt(e.MacroCallMark,s+u,s+u+2)],x=/^__(.+)__$/.exec(b);if(x){const n=x[1],i=s+h,r=[t.elt(e.SubstitutedParamMark,i,i+2),t.elt(e.SubstitutedParamName,i+2,i+2+n.length),t.elt(e.SubstitutedParamMark,i+2+n.length,i+b.length)];k.push(t.elt(e.SubstitutedParam,i,i+b.length,r))}else k.push(t.elt(e.MacroName,s+h,s+p));k.push(t.elt(e.MacroCallMark,s+g,s+d));const $=[w(n.slice(o,l),s+o,s+l),t.elt(f,s+c,s+d,k)];i.push(t.elt(e.Attribute,s+o,s+d,$));continue}if("`"===u){let u,h;if("```"===n.slice(r,r+3)){for(u=r+3,r+=3;r<a&&"```"!==n.slice(r,r+3);)r++;h=r,"```"===n.slice(r,r+3)&&(r+=3)}else{for(u=r+1,r++;r<a&&"`"!==n[r];)r++;h=r,r<a&&r++}d=r,f=e.AttributeSubstituted;const p=[t.elt(e.Mark,s+c,s+u)],m=n.slice(u,h);let g=0;const b=s+u;for(;g<m.length;){if("${"===m.slice(g,g+2)){let n=-1;for(let e=g+2;e<m.length-1;e++)if("}"===m[e]&&"$"===m[e+1]){n=e;break}if(-1!==n){const s=[m.slice(g,n+2),m.slice(g+2,n)],i=b+g,r=i+s[0].length,a=i+2,o=r-2,l=v(s[1].trim(),a+(s[1].length-s[1].trimStart().length));p.push(t.elt(e.FilterSubstitution,i,r,[t.elt(e.FilterSubstitutionMark,i,i+2),t.elt(e.FilterExpression,a,o,l),t.elt(e.FilterSubstitutionMark,r-2,r)])),g+=s[0].length;continue}}const n=m.slice(g).match(/^\$\(([^)]+)\)\$/);if(n){const s=b+g,i=s+n[0].length,r=s+2,a=r+n[1].length;p.push(t.elt(e.Variable,s,i,[t.elt(e.VariableMark,s,s+2),t.elt(e.VariableName,r,a),t.elt(e.VariableMark,a,i)])),g+=n[0].length}else g++}p.push(t.elt(e.Mark,s+h,s+d));const k=[w(n.slice(o,l),s+o,s+l),t.elt(f,s+c,s+d,p)];i.push(t.elt(e.Attribute,s+o,s+d,k));continue}{for(;r<a&&!/[\s>\/]/.test(n[r]);)r++;d=r;const u=n.slice(c,d),h=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(u);if(h){const r=h[1],a=[t.elt(e.PlaceholderMark,s+c,s+c+1),t.elt(e.VariableName,s+c+1,s+c+1+r.length),t.elt(e.PlaceholderMark,s+d-1,s+d)],f=[w(n.slice(o,l),s+o,s+l),t.elt(e.Placeholder,s+c,s+d,a)];i.push(t.elt(e.Attribute,s+o,s+d,f));continue}f=/^-?\d+(\.\d+)?$/.test(u)?e.AttributeNumber:/^@[a-zA-Z][a-zA-Z0-9\-_]*$/.test(u)?e.AttributeParamRef:e.AttributeString}}const h=[w(n.slice(o,l),s+o,s+l),t.elt(f,s+c,s+d)];i.push(t.elt(e.Attribute,s+o,s+d,h))}return i}const Bt=/^<(\$[a-zA-Z0-9\-\$\.]*)/,It=/^<\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/,Wt={name:"Widget",parse(n,s,i){if(s!==t.LessThan)return-1;if(n.char(i+1)!==t.Dollar)return-1;const r=n.slice(i,n.end),a=It.exec(r);if(a){const t=a[1],s=a[0].length,o=r.slice(s).match(/^(\s*[^>]*)?>/);if(o){const a=o[1]||"",l=i+s+o[0].length,c=o[0].endsWith("/>"),d=i+1,f=i+s,u=[n.elt(e.PlaceholderMark,d,d+1),n.elt(e.VariableName,d+1,d+1+t.length),n.elt(e.PlaceholderMark,f-1,f)],h=[n.elt(e.TagMark,i,i+1),n.elt(e.Placeholder,d,f,u)];if(a.trim()){const e=Et(n,a.trim(),i+s);h.push(...e)}if(c)h.push(n.elt(e.SelfClosingMarker,l-2,l-1)),h.push(n.elt(e.TagMark,l-1,l));else{h.push(n.elt(e.TagMark,l-1,l));const s=`</$${t}$>`,a=r.slice(l-i).indexOf(s);if(-1!==a){const r=l,o=l+a,c=n.slice(r,o);if(c.length>0){const e=n.parser.parseInline(c,r);h.push(...e)}const d=o,f=d+s.length,u=d+2,p=f-1,m=[n.elt(e.PlaceholderMark,u,u+1),n.elt(e.VariableName,u+1,u+1+t.length),n.elt(e.PlaceholderMark,p-1,p)],g=[n.elt(e.TagMark,d,d+2),n.elt(e.Placeholder,u,p,m),n.elt(e.TagMark,f-1,f)];return h.push(n.elt(e.WidgetEnd,d,f,g)),n.addElement(n.elt(e.InlineWidget,i,f,h))}}return n.addElement(n.elt(e.InlineWidget,i,l,h))}const l=i+1,c=i+s,d=[n.elt(e.PlaceholderMark,l,l+1),n.elt(e.VariableName,l+1,l+1+t.length),n.elt(e.PlaceholderMark,c-1,c)],f=[n.elt(e.TagMark,i,i+1),n.elt(e.Placeholder,l,c,d)];return n.addElement(n.elt(e.InlineWidget,i,c,f))}const o=Bt.exec(r);if(!o)return-1;const l=o[1],c=o[0].length;if("$"===l){const t=r[c];if(">"===t){const t=[n.elt(e.TagMark,i,i+1),n.elt(e.WidgetName,i+1,i+2),n.elt(e.TagMark,i+2,i+3)];return n.addElement(n.elt(e.InlineWidget,i,i+3,t))}if("/"===t&&">"===r[c+1]){const t=[n.elt(e.TagMark,i,i+1),n.elt(e.WidgetName,i+1,i+2),n.elt(e.SelfClosingMarker,i+2,i+3),n.elt(e.TagMark,i+3,i+4)];return n.addElement(n.elt(e.InlineWidget,i,i+4,t))}return n.addElement(n.elt(e.InvalidWidget,i,i+2))}const d=Mt(r.slice(c));if(!d){const t=Lt(r,c),s=i+t,a=r.slice(c,t),o=[n.elt(e.TagMark,i,i+1),n.elt(e.WidgetName,i+1,i+1+l.length)];if(a.trim()){const e=Et(n,a,i+c);o.push(...e)}return n.addElement(n.elt(e.IncompleteWidget,i,s,o))}const f=i+c+d.end,u=r.slice(c,c+d.end-(d.selfClose?2:1)),h=[n.elt(e.TagMark,i,i+1),n.elt(e.WidgetName,i+1,i+1+l.length)];if(u.trim()){const e=Et(n,u,i+c);h.push(...e)}if(d.selfClose)return h.push(n.elt(e.SelfClosingMarker,f-2,f-1)),h.push(n.elt(e.TagMark,f-1,f)),n.addElement(n.elt(e.InlineWidget,i,f,h));h.push(n.elt(e.TagMark,f-1,f));const p=`</${l}>`,m=(e=>{const t=[];let n=0,s=0,i=0,r=0,a=0,o=0;for(;n<e.length;){const l=e[n],c=e.slice(n,n+2),d=e.slice(n,n+3);if("<%"===c){const t=e.slice(n).match(/^<%\s*(if|endif)\b/);if(t){"if"===t[1]?o++:"endif"===t[1]&&o>0&&o--,n+=2;continue}}if("{{{"!==d)if("}}}"===d&&i>0)i--,n+=3;else if("{{"!==c||"{{{"===d)if("}}"===c&&"}}}"!==d&&r>0)r--,n+=2;else if("<<"!==c)if(">>"===c&&a>0)a--,n+=2;else if("["!==l)if("]"===l&&s>0)s--,n++;else{if('"'===l||"'"===l){const t=l;for(n++;n<e.length&&e[n]!==t;)"\\"===e[n]&&n++,n++;n++;continue}if(0===s&&0===i&&0===r&&0===a&&0===o){const s=e.slice(n).match(/^<\/([a-zA-Z\$][a-zA-Z0-9\-\$\.]*)>/);if(s){t.push({pos:n,name:s[1],isClose:!0,isSelfClosing:!1}),n+=s[0].length;continue}const i=e.slice(n).match(/^<([a-zA-Z\$][a-zA-Z0-9\-\$\.]*)(?=[\s>\/])/);if(i){const s=i[1].toLowerCase();let r=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"].includes(s);if(!r){let t=n+i[0].length,s=0,a=0,o=0;for(;t<e.length;){const n=e[t],i=e.slice(t,t+2),l=e.slice(t,t+3);if("{{{"!==l)if("}}}"===l&&o>0)o--,t+=3;else if("{{"!==i||"{{{"===l)if("}}"===i&&"}}}"!==l&&a>0)a--,t+=2;else if("<<"!==i)if(">>"===i&&s>0)s--,t+=2;else{if('"'===n||"'"===n){const s=n;for(t++;t<e.length&&e[t]!==s;)"\\"===e[t]&&t++,t++;t++;continue}if(0===s&&0===a&&0===o){if("/>"===i){r=!0;break}if(">"===n){r=!1;break}}t++}else s++,t+=2;else a++,t+=2;else o++,t+=3}}t.push({pos:n,name:i[1],isClose:!1,isSelfClosing:r}),n+=i[0].length;continue}}n++}else s++,n++;else a++,n+=2;else r++,n+=2;else i++,n+=3}return t})(r.slice(c+d.end));let g=-1,b=1,k=0;for(const e of m)if(e.name===l)if(e.isClose){if(1===b&&0===k){b--,g=e.pos;break}b>1&&b--}else e.isSelfClosing||b++;else e.isClose?k>0&&k--:e.isSelfClosing||k++;if(-1===g)return n.addElement(n.elt(e.InlineWidget,i,f,h));const x=f,$=f+g,y=n.slice(x,$);if(y.length>0){const e=n.parser.parseInline(y,x);h.push(...e)}const w=$,T=w+p.length,S=[n.elt(e.TagMark,w,w+2),n.elt(e.WidgetName,w+2,T-1),n.elt(e.TagMark,T-1,T)];return h.push(n.elt(e.WidgetEnd,w,T,S)),n.addElement(n.elt(e.InlineWidget,i,T,h))}},Dt=/^<\/(\$[a-zA-Z0-9\-\$\.]*)(>)?/,Ft=/^<\/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$>/,Nt={name:"WidgetCloseTag",after:"Widget",parse(n,s,i){if(s!==t.LessThan)return-1;if(n.char(i+1)!==t.Slash)return-1;if(n.char(i+2)!==t.Dollar)return-1;const r=n.slice(i,n.end),a=Ft.exec(r);if(a){const t=a[1],s=i+a[0].length,r=i+2,o=s-1,l=[n.elt(e.TagMark,i,i+2),n.elt(e.Placeholder,r,o,[n.elt(e.PlaceholderMark,r,r+1),n.elt(e.VariableName,r+1,r+1+t.length),n.elt(e.PlaceholderMark,o-1,o)]),n.elt(e.TagMark,s-1,s)];return n.addElement(n.elt(e.WidgetEnd,i,s,l))}const o=Dt.exec(r);if(!o){if(r.startsWith("</$")){const t=[n.elt(e.TagMark,i,i+2)],s=/^<\/(\$[a-zA-Z0-9\-\$\.]+)/.exec(r);return s&&s[1].length>1?(t.push(n.elt(e.WidgetName,i+2,i+2+s[1].length)),n.addElement(n.elt(e.WidgetEnd,i,i+2+s[1].length,t))):n.addElement(n.elt(e.WidgetEnd,i,i+3,t))}return-1}const l=o[1],c=!!o[2],d=i+o[0].length;if("$"===l){if(!c)return-1;const t=[n.elt(e.TagMark,i,i+2),n.elt(e.WidgetName,i+2,i+3),n.elt(e.TagMark,d-1,d)];return n.addElement(n.elt(e.WidgetEnd,i,d,t))}const f=[n.elt(e.TagMark,i,i+2),n.elt(e.WidgetName,i+2,i+2+l.length)];return c&&f.push(n.elt(e.TagMark,d-1,d)),n.addElement(n.elt(e.WidgetEnd,i,d,f))}},Ot=/^<([a-zA-Z][a-zA-Z0-9\-]*)/,Ht={name:"HTMLTag",parse(n,s,i){if(s!==t.LessThan)return-1;if(n.char(i+1)===t.Dollar)return-1;const r=n.slice(i,n.end),a=Ot.exec(r);if(!a)return-1;const o=a[1],l=a[0].length,c=Mt(r.slice(l));if(!c){const t=Lt(r,l),s=i+t,a=r.slice(l,t),c=[n.elt(e.TagMark,i,i+1),n.elt(e.TagName,i+1,i+1+o.length)];if(a.trim()){const e=Et(n,a,i+l);c.push(...e)}return n.addElement(n.elt(e.IncompleteHTMLTag,i,s,c))}const d=i+l+c.end,f=r.slice(l,l+c.end-(c.selfClose?2:1)),u=[n.elt(e.TagMark,i,i+1),n.elt(e.TagName,i+1,i+1+o.length)];if(f.trim()){const e=Et(n,f,i+l);u.push(...e)}if(c.selfClose)return u.push(n.elt(e.SelfClosingMarker,d-2,d-1)),u.push(n.elt(e.TagMark,d-1,d)),n.addElement(n.elt(e.HTMLTag,i,d,u));u.push(n.elt(e.TagMark,d-1,d));const h=`</${o}>`,p=r.slice(l+c.end).indexOf(h);if(-1===p)return n.addElement(n.elt(e.HTMLTag,i,d,u));const m=d,g=d+p,b=n.slice(m,g);if(b.length>0){const e=n.parser.parseInline(b,m);u.push(...e)}const k=g,x=k+h.length,$=[n.elt(e.TagMark,k,k+2),n.elt(e.TagName,k+2,x-1),n.elt(e.TagMark,x-1,x)];return u.push(n.elt(e.HTMLEndTag,k,x,$)),n.addElement(n.elt(e.HTMLTag,i,x,u))}},_t=/^<\/([a-zA-Z][a-zA-Z0-9\-]*)(>)?/,zt={name:"HTMLCloseTag",after:"HTMLTag",parse(n,s,i){if(s!==t.LessThan)return-1;if(n.char(i+1)!==t.Slash)return-1;if(n.char(i+2)===t.Dollar)return-1;const r=n.slice(i,n.end),a=_t.exec(r);if(!a){if(r.startsWith("</")){const t=[n.elt(e.TagMark,i,i+2)];return n.addElement(n.elt(e.HTMLEndTag,i,i+2,t))}return-1}const o=a[1],l=!!a[2],c=i+a[0].length,d=[n.elt(e.TagMark,i,i+2),n.elt(e.TagName,i+2,i+2+o.length)];return l&&d.push(n.elt(e.TagMark,c-1,c)),n.addElement(n.elt(e.HTMLEndTag,i,c,d))}},Rt={name:"InlineComment",parse(n,s,i){if(s!==t.LessThan)return-1;if(33!==n.char(i+1))return-1;if(n.char(i+2)!==t.Dash)return-1;if(n.char(i+3)!==t.Dash)return-1;let r=i+4;for(;r<n.end-2;){if(n.char(r)===t.Dash&&n.char(r+1)===t.Dash&&62===n.char(r+2)){const t=r+3;return n.addElement(n.elt(e.CommentBlock,i,t,[n.elt(e.CommentMarker,i,i+4),n.elt(e.CommentMarker,t-3,t)]))}r++}return-1}},Zt={name:"Dash",parse(n,s,i){if(s!==t.Dash)return-1;let r=1;for(;n.char(i+r)===t.Dash;)r++;return 2===r?n.addElement(n.elt(e.Dash,i,i+2)):r>=3?n.addElement(n.elt(e.Dash,i,i+3)):-1}},Vt=/^\$\(([^)]+)\)\$/,Kt={name:"VariableSubstitution",parse(n,s,i){if(s!==t.Dollar)return-1;if(40!==n.char(i+1))return-1;const r=n.slice(i,n.end),a=Vt.exec(r);if(!a)return-1;const o=i+a[0].length,l=i+2,c=l+a[1].length,d=[n.elt(e.VariableMark,i,i+2),n.elt(e.VariableName,l,c),n.elt(e.VariableMark,c,o)];return n.addElement(n.elt(e.Variable,i,o,d))}},Xt=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/,jt={name:"PlaceholderParam",parse(n,s,i){if(s!==t.Dollar)return-1;const r=n.slice(i,n.end),a=Xt.exec(r);if(!a)return-1;const o=i+a[0].length,l=i+1,c=l+a[1].length,d=[n.elt(e.PlaceholderMark,i,i+1),n.elt(e.VariableName,l,c),n.elt(e.PlaceholderMark,c,o)];return n.addElement(n.elt(e.Placeholder,i,o,d))}},qt=/^[A-Z\u00c0-\u00d6\u00d8-\u00de\u0150\u0170]+[a-z\u00df-\u00f6\u00f8-\u00ff\u0151\u0171]+[A-Z\u00c0-\u00d6\u00d8-\u00de\u0150\u0170][A-Za-z0-9\u00c0-\u00d6\u00d8-\u00de\u00df-\u00f6\u00f8-\u00ff\u0150\u0170\u0151\u0171]*/;const Ut={name:"CamelCaseLink",parse(n,s,i){if(!(s>=65&&s<=90||s>=192&&s<=214||s>=216&&s<=222||336===s||368===s))return-1;if(i>n.offset){const e=n.char(i-1);if((r=e)>=65&&r<=90||r>=97&&r<=122||r>=48&&r<=57||45===r||95===r||r>=192&&r<=214||r>=216&&r<=222||r>=223&&r<=246||r>=248&&r<=255||336===r||368===r||337===r||369===r)return-1;if(e===t.Tilde)return-1}var r;const a=n.slice(i,n.end),o=qt.exec(a);return o?n.addElement(n.elt(e.CamelCaseLink,i,i+o[0].length)):-1}},Qt=/^\$:\/[A-Za-z0-9\u00c0-\u00d6\u00d8-\u00de\u00df-\u00f6\u00f8-\u00ff\u0150\u0170\u0151\u0171\/._-]+/,Gt={name:"SystemLink",parse(n,s,i){if(s!==t.Dollar)return-1;const r=n.slice(i,n.end),a=Qt.exec(r);return a?n.addElement(n.elt(e.SystemLink,i,i+a[0].length)):-1}},Yt=/^(?:https?|ftp|file):\/\/[^\s\[\]{}|<>]*/i,Jt=/^(?:mailto|tel|geo|data|javascript):[^\s\[\]{}|<>]+/i,en=/[.,;:!?)\]]+$/,tn={name:"URLAutoLink",parse(t,n,s){if(104!==n&&102!==n&&109!==n&&116!==n&&103!==n&&100!==n&&106!==n)return-1;const i=t.slice(s,t.end);let r=Yt.exec(i),a=8;if(r||(r=Jt.exec(i),a=7),!r)return-1;let o=r[0];return o=o.replace(en,""),o.length<=a?-1:t.addElement(t.elt(e.URLLink,s,s+o.length))}},nn=[st,{name:"ConditionalSyntax",parse(n,s,i){if(s!==t.LessThan)return-1;if(n.char(i+1)!==t.Percent)return-1;const r=n.slice(i,n.end),a=[];a.push(n.elt(e.ConditionalMark,i,i+2));const o=/^<%\s*(if|elseif|else|endif)\b/.exec(r);if(o){const t=o[1],s=i+r.indexOf(t,2),l=s+t.length;if(a.push(n.elt(e.ConditionalKeyword,s,l)),"if"===t||"elseif"===t){const t=r.slice(l-i),s=/^\s+(.+?)(?:\s*%>|$)/.exec(t);if(s){const i=s[1],r=l+t.indexOf(i),o=r+i.length,c=v(i,r);a.push(n.elt(e.FilterExpression,r,o,c))}}const c=r.indexOf("%>");return-1!==c?(a.push(n.elt(e.ConditionalMark,i+c,i+c+2)),n.addElement(n.elt(e.Conditional,i,i+c+2,a))):n.addElement(n.elt(e.Conditional,i,l,a))}const l=r.indexOf("%>");return-1!==l&&l>2?(a.push(n.elt(e.ConditionalMark,i+l,i+l+2)),n.addElement(n.elt(e.Conditional,i,i+l+2,a))):n.addElement(n.elt(e.ConditionalMark,i,i+2))}},et,nt,rt,at,ot,lt,ct,dt,ut,gt,kt,$t,yt,Ct,St,vt,Wt,Nt,Rt,Ht,zt,Zt,Kt,Gt,jt,Ut,tn],sn={twTransclusion:r.Tag.define(),twMacro:r.Tag.define(),twWidget:r.Tag.define(),twFilter:r.Tag.define(),twPragma:r.Tag.define(),twVariable:r.Tag.define(),twSuperscript:r.Tag.define(),twSubscript:r.Tag.define()},rn=r.styleTags({"Heading1/...":r.tags.heading1,"Heading2/...":r.tags.heading2,"Heading3/...":r.tags.heading3,"Heading4/...":r.tags.heading4,"Heading5/...":r.tags.heading5,"Heading6/...":r.tags.heading6,HeadingMark:r.tags.processingInstruction,"Bold/...":r.tags.strong,"Italic/...":r.tags.emphasis,"Underline/...":r.tags.special(r.tags.emphasis),"Strikethrough/...":r.tags.strikethrough,"Superscript/...":sn.twSuperscript,"Subscript/...":sn.twSubscript,"Highlight/...":r.tags.special(r.tags.content),HighlightStyles:r.tags.string,"BoldMark ItalicMark UnderlineMark StrikethroughMark SuperscriptMark SubscriptMark HighlightMark":r.tags.processingInstruction,"InlineCode FencedCode TypedBlock CodeText":r.tags.monospace,"CodeMark TypedBlockMark InlineCodeMark":r.tags.processingInstruction,CodeInfo:r.tags.labelName,TypedBlockType:r.tags.labelName,KaTeXBlock:r.tags.monospace,LaTeXContent:r.tags.monospace,KaTeXMark:r.tags.processingInstruction,"WikiLink ExternalLink CamelCaseLink":r.tags.link,"WikiLinkMark ExtLinkMark":r.tags.processingInstruction,LinkText:r.tags.string,LinkTarget:r.tags.link,LinkSeparator:r.tags.processingInstruction,ImageLink:r.tags.link,ImageMark:r.tags.processingInstruction,ImageSource:r.tags.url,ImageTooltip:r.tags.string,"URLLink SystemLink":r.tags.url,"Transclusion TransclusionBlock":r.tags.special(r.tags.link),TransclusionMark:r.tags.processingInstruction,TransclusionTarget:r.tags.special(r.tags.string),TransclusionTemplate:r.tags.special(r.tags.string),"TransclusionFieldMark TransclusionIndexMark":r.tags.processingInstruction,TransclusionField:r.tags.propertyName,TransclusionIndex:r.tags.propertyName,"FilteredTransclusion FilteredTransclusionBlock":r.tags.special(r.tags.link),FilteredTransclusionMark:r.tags.processingInstruction,FilterExpression:r.tags.special(r.tags.string),"MacroCall MacroCallBlock":r.tags.macroName,MacroCallMark:r.tags.processingInstruction,MacroName:r.tags.macroName,MacroParam:r.tags.attributeValue,MacroParamName:r.tags.attributeName,MacroParamValue:r.tags.attributeValue,WidgetName:r.tags.tagName,TagName:r.tags.tagName,InvalidWidget:r.tags.invalid,IncompleteWidget:r.tags.invalid,IncompleteHTMLTag:r.tags.invalid,IncompleteHTMLBlock:r.tags.invalid,Attribute:r.tags.attributeName,AttributeName:r.tags.attributeName,"AttributeValue AttributeString":r.tags.attributeValue,AttributeNumber:r.tags.number,AttributeIndirect:r.tags.special(r.tags.link),AttributeFiltered:r.tags.special(r.tags.link),AttributeMacro:r.tags.macroName,AttributeSubstituted:r.tags.special(r.tags.string),AttributeParamRef:r.tags.special(r.tags.variableName),AttributeWikitext:r.tags.attributeValue,SelfClosingMarker:r.tags.processingInstruction,"BulletList OrderedList DefinitionList":r.tags.list,"ListItem DefinitionTerm DefinitionDescription":r.tags.list,ListMark:r.tags.processingInstruction,BlockQuote:r.tags.quote,QuoteMark:r.tags.processingInstruction,BlockQuoteClass:r.tags.className,"Table TableRow":r.tags.content,"TableHeader TableHeaderCell":r.tags.heading,TableCell:r.tags.content,TableDelimiter:r.tags.processingInstruction,HorizontalRule:r.tags.contentSeparator,HardLineBreaks:r.tags.content,HardLineBreaksMark:r.tags.processingInstruction,"CommentBlock CommentMarker":r.tags.comment,PragmaMark:r.tags.processingInstruction,PragmaKeyword:r.tags.keyword,PragmaName:r.tags.definition(r.tags.macroName),PragmaParams:r.tags.definition(r.tags.variableName),PragmaBody:r.tags.content,PragmaEnd:r.tags.keyword,Escape:r.tags.escape,Entity:r.tags.character,Dash:r.tags.punctuation,Variable:r.tags.special(r.tags.variableName),VariableMark:r.tags.processingInstruction,VariableName:r.tags.variableName,FilterSubstitution:r.tags.special(r.tags.string),FilterSubstitutionMark:r.tags.processingInstruction,Placeholder:r.tags.special(r.tags.variableName),PlaceholderMark:r.tags.processingInstruction,SubstitutedParam:r.tags.special(r.tags.variableName),SubstitutedParamMark:r.tags.processingInstruction,SubstitutedParamName:r.tags.variableName,HardBreak:r.tags.processingInstruction,FilterRun:r.tags.content,FilterOperator:r.tags.operator,FilterOperatorName:r.tags.operatorKeyword,FilterOperand:r.tags.string,FilterVariable:r.tags.variableName,FilterTextRef:r.tags.special(r.tags.string),FilterRegexp:r.tags.regexp,IncompleteFilterRun:r.tags.content,StyledBlock:r.tags.content,StyledBlockMark:r.tags.processingInstruction,StyledBlockClass:r.tags.className,ConditionalBlock:r.tags.content,Conditional:r.tags.content,ConditionalMark:r.tags.processingInstruction,ConditionalKeyword:r.tags.controlKeyword,ConditionalBranch:r.tags.content,Paragraph:r.tags.content,Text:r.tags.content,Mark:r.tags.processingInstruction,ProcessingInstruction:r.tags.processingInstruction});class an extends i.Parser{constructor(t,n,s,r,a){super(),this.nodeSet=t||function(){const t=[],n=Object.keys(e).filter(e=>isNaN(Number(e)));for(const s of n){const n=e[s];if("number"==typeof n){for(;t.length<=n;)t.push(i.NodeType.none);t[n]=i.NodeType.define({id:n,name:s,props:[]})}}return new i.NodeSet(t).extend(rn)}(),this.pragmaParsers=n||oe,this.blockParsers=s||Ye,this.inlineParsers=r||nn,this.wrapFn=a}createParse(e,t,n){const s=new b(this,e,t,n);return this.wrapFn?this.wrapFn(s,e,t,n):s}configure(e){let t=this.nodeSet,n=[...this.pragmaParsers],s=[...this.blockParsers],r=[...this.inlineParsers],a=e.wrap||this.wrapFn;if(e.remove){const t=new Set(e.remove);n=n.filter(e=>!t.has(e.name)),s=s.filter(e=>!t.has(e.name)),r=r.filter(e=>!t.has(e.name))}if(e.parsePragma)for(const t of e.parsePragma)n=on(n,t);if(e.parseBlock)for(const t of e.parseBlock)s=on(s,t);if(e.parseInline)for(const t of e.parseInline)r=on(r,t);if(e.defineNodes){const n=[...t.types];for(const t of e.defineNodes){const e="string"==typeof t?t:t.name,s=n.length;n.push(i.NodeType.define({id:s,name:e,props:[]}))}t=new i.NodeSet(n)}if(e.props)for(const n of e.props)t=t.extend(n);return new an(t,n,s,r,a)}parseInline(e,t){return function(e,t,n){return new k(e,t,n).parse()}(this,e,t)}parseContent(e,t){if(!e.trim())return[];const n=this.parse(e);return this.extractElementsFromTree(n,t)}extractElementsFromTree(e,t){const n=[],s=e.cursor();if(s.firstChild())do{const e=this.nodeToElement(s,t);e&&n.push(e)}while(s.nextSibling());return n}nodeToElement(t,n){const s=t.type.name,i=t.from+n,r=t.to+n,a=e[s];if(void 0===a||"number"!=typeof a)return"LaTeX"===s?new f(e.LaTeXContent,i,r,[]):"JavaScript"===s||"CSS"===s||"Script"===s?new f(e.CodeText,i,r,[]):null;const o=[];if(t.firstChild()){do{const e=this.nodeToElement(t,n);e&&o.push(e)}while(t.nextSibling());t.parent()}return new f(a,i,r,o)}}function on(e,t){const n=[...e];if(t.before){const e=n.findIndex(e=>e.name===t.before);if(e>=0)return n.splice(e,0,t),n}if(t.after){const e=n.findIndex(e=>e.name===t.after);if(e>=0)return n.splice(e+1,0,t),n}return n.push(t),n}const ln=new an,cn=a.defineLanguageFacet({commentTokens:{block:{open:"\x3c!--",close:"--\x3e"}}}),dn=new i.NodeProp;function fn(e){const t=/^Heading(\d)$/.exec(e.name);return t?+t[1]:void 0}function un(e,t){const n=e.state.doc.lineAt(t);let s=0;for(let t=0;t<n.text.length;t++){const i=n.text.charCodeAt(t);if(32===i)s++;else{if(9!==i)break;s+=e.unit}}return s}function hn(e){const t=e.node,n=e.state.doc.lineAt(t.from),s=e.state.doc.lineAt(t.to),i=un(e,t.from),r=e.state.doc.lineAt(e.pos);if(pn(t.name)){let a=null;for(let e=t.lastChild;e;e=e.prevSibling)if("PragmaEnd"===e.name){a=e;break}if(r.number===n.number){const t=r.text;return e.pos>=r.from+t.trimEnd().length&&/^\s*\\(?:define|procedure|function|widget)\s+\S+\s*\([^)]*\)\s*$/.test(t)?i+e.unit:null}if(a){const t=e.state.doc.lineAt(a.from);return r.number===t.number||r.number>t.number?i:i+e.unit}if(n.number===s.number){const t=n.text.trim();return/^\\(?:define|procedure|function|widget)\s+\S+\s*\([^)]*\)\s*$/.test(t)?i+e.unit:i}return i+e.unit}if(n.number===s.number){if(!/^(ConditionalBlock|Widget|HTMLBlock)$/.test(t.name))return null}if(r.number===n.number){const t=r.text;if(e.pos>=r.from+t.trimEnd().length){if(/<%\s*(if|elseif)\s+.+%>\s*$/.test(t)||/<%\s*else\s*%>\s*$/.test(t))return i+e.unit;if(/<%\s*endif\s*%>\s*$/.test(t))return i;if(/<[$a-zA-Z][^>]*>\s*$/.test(t)&&!/<\//.test(t)&&!/\/>\s*$/.test(t))return i+e.unit;if(/\/>\s*$/.test(t))return i;if(/<\/[$a-zA-Z][^>]*>\s*$/.test(t))return i}return null}if(r.number>1){const t=e.state.doc.line(r.number-1).text.trim();if(/<%\s*(if|elseif)\s+.+%>\s*$/.test(t)||/<%\s*else\s*%>\s*$/.test(t))return i+e.unit}const a=r.text.trim();return/^<\/[$a-zA-Z]|^<%\s*endif\s*%>/.test(a)||/^<%\s*(else|elseif)\s/.test(a)||/^<%\s*else\s*%>/.test(a)?i:i+e.unit}function pn(e){return/^(MacroDefinition|ProcedureDefinition|FunctionDefinition|WidgetDefinition)$/.test(e)}const mn=ln.configure({props:[a.foldNodeProp.add(e=>{const t="InlineWidget"===e.name||"HTMLTag"===e.name;if((function(e){return/^(Paragraph|Heading\d|BulletList|OrderedList|DefinitionList|BlockQuote|Table|FencedCode|TypedBlock|Widget|HTMLBlock|TransclusionBlock|FilteredTransclusionBlock|MacroCallBlock|CommentBlock|HorizontalRule|HardLineBreaks|ConditionalBlock|MacroDefinition|ProcedureDefinition|FunctionDefinition|WidgetDefinition|StyledBlock)$/.test(e.name)}(e)||t)&&"Document"!==e.name&&null==fn(e)&&!function(e){return"BulletList"===e.name||"OrderedList"===e.name||"DefinitionList"===e.name}(e)&&"Paragraph"!==e.name)return pn(e.name)?(e,t)=>{const n=t.doc.lineAt(e.from).to;if(e.to<=n)return null;let s=e.lastChild;if(s&&"PragmaEnd"===s.name){const e=t.doc.lineAt(s.from);return e.from>n?{from:n,to:e.from-1}:null}return{from:n,to:e.to}}:"Widget"===e.name||"HTMLBlock"===e.name?(t,n)=>{const s=n.doc.lineAt(t.from).to;if(t.to<=s)return null;const i="Widget"===e.name?t.getChild("WidgetEnd"):t.getChild("HTMLEndTag");if(i){const e=n.doc.lineAt(i.from);return e.from>s?{from:s,to:e.from-1}:null}return{from:s,to:t.to}}:"InlineWidget"===e.name||"HTMLTag"===e.name?(t,n)=>{const s=n.doc.lineAt(t.from).to;if(t.to<=s)return null;const i="InlineWidget"===e.name?t.getChild("WidgetEnd"):t.getChild("CloseTag");if(i){const e=n.doc.lineAt(i.from);if(e.from>s)return{from:s,to:e.from-1}}return{from:s,to:t.to}}:"ConditionalBlock"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;if(e.to<=n)return null;let s=e.lastChild;for(;s&&"ConditionalMark"!==s.name;)s=s.prevSibling;if(s){const e=t.doc.lineAt(s.from);return e.from>n?{from:n,to:e.from-1}:null}return{from:n,to:e.to}}:"BlockQuote"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;if(e.to<=n)return null;let s=e.lastChild;for(;s&&"QuoteMark"!==s.name;)s=s.prevSibling;if(s&&s.from>e.from){const e=t.doc.lineAt(s.from);return e.from>n?{from:n,to:e.from-1}:null}return{from:n,to:e.to}}:"FencedCode"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;if(e.to<=n)return null;let s=e.lastChild;for(;s&&"CodeMark"!==s.name;)s=s.prevSibling;if(s&&s.from>e.from){const e=t.doc.lineAt(s.from);return e.from>n?{from:n,to:e.from-1}:null}return{from:n,to:e.to}}:"TypedBlock"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;if(e.to<=n)return null;let s=e.lastChild;for(;s&&"TypedBlockMark"!==s.name;)s=s.prevSibling;if(s&&s.from>e.from){const e=t.doc.lineAt(s.from);return e.from>n?{from:n,to:e.from-1}:null}return{from:n,to:e.to}}:"Table"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;if(e.to<=n)return null;const s=e.getChild("TableHeader")||e.getChild("TableRow");if(s){const n=t.doc.lineAt(s.to).to;if(n<e.to)return{from:n,to:e.to}}return null}:(e,t)=>{const n=t.doc.lineAt(e.from).to;return e.to<=n?null:{from:n,to:e.to}}}),dn.add(fn),a.indentNodeProp.add({Document:e=>{const t=e.state.doc.lineAt(e.pos);if(t.number>1){const n=e.state.doc.line(t.number-1),s=n.text;if(/^\s*\\(?:define|procedure|function|widget)\s+\S+\s*\([^)]*\)\s*$/.test(s)){return un(e,n.from)+e.unit}if(/<%\s*(if|elseif)\s+.+%>\s*$/.test(s)||/<%\s*else\s*%>\s*$/.test(s)){return un(e,n.from)+e.unit}if(/<[$a-zA-Z][^>]*>\s*$/.test(s)&&!/<\//.test(s)&&!/\/>\s*$/.test(s)){return un(e,n.from)+e.unit}const i=a.syntaxTree(e.state),r=n.to;let o=!1,l=0;for(let t=i.resolveInner(r,-1);t;t=t.parent)if("PragmaEnd"===t.name){o=!0,t.parent&&pn(t.parent.name)&&(l=un(e,t.parent.from));break}if(o)return l;if(/^\s*\\end(?:\s|$)/.test(s)){return un(e,n.from)}}return null},Widget:hn,HTMLBlock:hn,ConditionalBlock:hn,ConditionalBranch:hn,BlockQuote:hn,MacroDefinition:hn,ProcedureDefinition:hn,FunctionDefinition:hn,WidgetDefinition:hn})]});function gn(e,t){let n=e;for(;;){const e=n.nextSibling;if(!e)break;const s=fn(e.type);if(null!=s&&s<=t)break;n=e}return n.to}const bn=a.foldService.of((e,t,n)=>{for(let s=a.syntaxTree(e).resolveInner(n,-1);s&&!(s.from<t);s=s.parent){const e=s.type.prop(dn);if(null==e)continue;const t=gn(s,e);if(t>n)return{from:n,to:t}}return null}),kn=a.foldService.of((e,t,n)=>{const s=a.syntaxTree(e),i=e.doc,r=s.cursor();let o=null;for(;r.next()&&!(r.from>n);)if(!(r.from<t)){if("ConditionalBlock"===r.name){let e=r.nextSibling();if(!e)for(;r.parent();)if(r.nextSibling()){e=!0;break}if(!e)break;continue}if("Conditional"===r.name){const e=i.sliceString(r.from,r.to);if(/<%\s*if\b/.test(e)){o={from:r.from,to:r.to};break}}}if(!o)return null;const l=i.lineAt(o.to).to;let c=1;for(;r.next();){if("ConditionalBlock"===r.name){let e=r.nextSibling();if(!e)for(;r.parent();)if(r.nextSibling()){e=!0;break}if(!e)break;continue}if("Conditional"===r.name){const e=i.sliceString(r.from,r.to);if(/<%\s*if\b/.test(e))c++;else if(/<%\s*endif\s*%>/.test(e)&&(c--,0===c)){const e=i.lineAt(r.from);return e.from>l?{from:l,to:e.from-1}:null}}}return null});function xn(e){const t=e.configure({props:[a.languageDataProp.add({Document:cn})]});return new a.Language(cn,t,[],"tiddlywiki")}const $n=xn(mn);class yn{constructor(e,t,n,s,i,r,a){this.node=e,this.from=t,this.to=n,this.spaceBefore=s,this.spaceAfter=i,this.type=r,this.item=a}blank(e,t=!0){let n=this.spaceBefore;if("BlockQuote"==this.node.name&&(n+=">"),null!=e){for(;n.length<e;)n+=" ";return n}for(let e=this.to-this.from-n.length-this.spaceAfter.length;e>0;e--)n+=" ";return n+(t?this.spaceAfter:"")}marker(e,t){let n="";if("OrderedList"==this.node.name||"BulletList"==this.node.name){let t=e.sliceString(this.item.from,this.item.from+30),s=/^\s*([*#]+)/.exec(t);s&&(n=s[1])}else if("DefinitionList"==this.node.name){let t=e.sliceString(this.item.from,this.item.from+30),s=/^\s*([;:*#]+)/.exec(t);n=s?s[1]:this.type}else if("BlockQuote"==this.node.name)if("<<<"==this.type)n="<<<";else{let t=e.sliceString(this.item.from,this.item.from+30),s=/^\s*([>*#]+)/.exec(t);n=s?s[1]:">"}return this.spaceBefore+n+this.spaceAfter}}function wn(e,t){let n=[],s=[];for(let t=e;t;t=t.parent){if("FencedCode"==t.name||"CodeBlock"==t.name)return s;"ListItem"!=t.name&&"BlockQuote"!=t.name&&"DefinitionTerm"!=t.name&&"DefinitionDescription"!=t.name||n.push(t)}for(let e=n.length-1;e>=0;e--){let i,r=n[e],a=t.lineAt(r.from);r.from,a.from,"BlockQuote"==r.name?(i=/^(\s*)(<<<)(\s*)/.exec(a.text),i&&s.push(new yn(r,0,i[0].length,i[1],i[3],"<<<",null))):"ListItem"!=r.name||"OrderedList"!=r.parent?.name&&"BulletList"!=r.parent?.name?"ListItem"==r.name&&"BlockQuote"==r.parent?.name?(i=/^(\s*)([>*#]+)(\s*)/.exec(a.text),i&&s.push(new yn(r.parent,0,i[0].length,i[1],i[3],i[2],r))):("DefinitionTerm"==r.name||"DefinitionDescription"==r.name)&&(i=/^(\s*)([;:*#]+)(\s*)/.exec(a.text),i&&s.push(new yn(r.parent,0,i[0].length,i[1],i[3],i[2],r))):(i=/^(\s*)([*#]+)(\s+)/.exec(a.text),i&&s.push(new yn(r.parent,0,i[0].length,i[1],i[3],i[2],r)))}return s}function Tn(e,t){let s=/^[ \t]*/.exec(e)[0].length;if(!s||"\t"!=t.facet(a.indentUnit))return e;let i="";for(let t=n.countColumn(e,4,s);t>0;)t>=4?(i+="\t",t-=4):(i+=" ",t--);return i+e.slice(s)}const Sn=(e={})=>({state:t,dispatch:s})=>{const i=e.fallbackBehavior||"smart";let r=a.syntaxTree(t),{doc:o}=t,l=null,c=t.changeByRange(e=>{if(!e.empty||!$n.isActiveAt(t,e.from,-1)&&!$n.isActiveAt(t,e.from,1))return l={range:e};let s=e.from,c=o.lineAt(s),d=r.resolveInner(s,-1);"Document"===d.name&&s>0&&(d=r.resolveInner(s-1,-1));let f=wn(d,o);for(;f.length&&f[f.length-1].from>s-c.from;)f.pop();if(!f.length){const e=c.text;if("none"===i){const e=t.lineBreak;return{range:n.EditorSelection.cursor(s+e.length),changes:{from:s,insert:e}}}if("indent"===i){let i="";for(let t=0;t<e.length;t++){const n=e.charAt(t);if(" "!==n&&"\t"!==n)break;i+=n}const r=t.lineBreak+i;return{range:n.EditorSelection.cursor(s+r.length),changes:{from:s,insert:r}}}const r=t.facet(a.indentUnit),l="\t"===r?t.tabSize:r.length;let f=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);if(32===s)f++;else{if(9!==s)break;f+=t.tabSize}}const u=s-c.from,h=e.slice(0,u),p=e.slice(u);if(/>$/.test(h)&&/^<\//.test(p)){let e="",i="";if("\t"===r){e="\t".repeat(Math.floor(f/t.tabSize));const n=f%t.tabSize;n>0&&(e+=" ".repeat(n)),i=e+"\t"}else e=" ".repeat(f),i=" ".repeat(f+l);const a=t.lineBreak+i+t.lineBreak+e,o=s+t.lineBreak.length+i.length;return{range:n.EditorSelection.cursor(o),changes:{from:s,insert:a}}}let m=a.getIndentation(t,s);const g=e.trim(),b=p.trim(),k=e=>/^(MacroDefinition|ProcedureDefinition|FunctionDefinition|WidgetDefinition)$/.test(e);let x=null,$=null;for(let e=d;e;e=e.parent)if(k(e.name)){x=e;for(let t=e.lastChild;t;t=t.prevSibling)if("PragmaEnd"===t.name){$=t;break}break}if(x){const n=(()=>{const e=o.lineAt(x.from);let n=0;for(let s=0;s<e.text.length;s++){const i=e.text.charCodeAt(s);if(32===i)n++;else{if(9!==i)break;n+=t.tabSize}}return n})(),s=o.lineAt(x.from);if($){const t=o.lineAt($.from);c.number===t.number||c.number>t.number?m=n:c.number===s.number&&/^\s*\\(?:define|procedure|function|widget)\s+\S+\s*\([^)]*\)\s*$/.test(e)&&(m=n+l)}else c.number===s.number&&/^\s*\\(?:define|procedure|function|widget)\s+\S+\s*\([^)]*\)\s*$/.test(e)&&(m=n+l)}else/^\\end(?:\s|$)/.test(g)&&""===b?m=f:null!=m&&0!==m||(""===g||/^<[$a-zA-Z\/]/.test(b)||/^<%/.test(b)||/^\\end\b/.test(b)?m=f:/<%\s*(if|elseif)\s+.+%>\s*$/.test(g)||/<%\s*else\s*%>\s*$/.test(g)?m=f+l:!/<[$a-zA-Z][^>]*>\s*$/.test(g)||/<\//.test(g)||g.endsWith("/>")?(/<%\s*endif\s*%>\s*$/.test(g)||/<\/[$a-zA-Z][^>]*>\s*$/.test(g))&&(m=f):m=f+l);null!=m&&0!==m||(m=f);let y="";if(null!=m&&m>0)if("\t"===r){y="\t".repeat(Math.floor(m/t.tabSize));const e=m%t.tabSize;e>0&&(y+=" ".repeat(e))}else y=" ".repeat(m);const w=t.lineBreak+y;return{range:n.EditorSelection.cursor(s+w.length),changes:{from:s,insert:w}}}let u=f[f.length-1];if(u.to-u.spaceAfter.length>s-c.from)return l={range:e};let h=s>=u.to-u.spaceAfter.length&&!/\S/.test(c.text.slice(u.to));if(u.item&&h){let e,t=f.length>1?f[f.length-2]:null,i="";t&&t.item?(e=c.from+t.from,i=t.marker(o,1)):e=c.from+(t?t.to:0);let r=[{from:e,to:s,insert:i}];return{range:n.EditorSelection.cursor(e+i.length),changes:r}}let p=[],m=u.item&&u.item.from<c.from,g="";if(!m||/^[\s\*#;:>]*/.exec(c.text)[0].length>=u.to)for(let e=0,t=f.length-1;e<=t;e++)g+=e!=t||m?f[e].blank(e<t?n.countColumn(c.text,4,f[e+1].from)-g.length:null):f[e].marker(o,1);let b=s;for(;b>c.from&&/\s/.test(c.text.charAt(b-c.from-1));)b--;return g=Tn(g,t),p.push({from:b,to:s,insert:t.lineBreak+g}),{range:n.EditorSelection.cursor(b+g.length+1),changes:p}});return!l&&(s(t.update(c,{scrollIntoView:!0,userEvent:"input"})),!0)},Cn=Sn();function vn(e){return"QuoteMark"==e.name||"ListMark"==e.name||"HeadingMark"==e.name}const Mn=({state:e,dispatch:t})=>{let s=a.syntaxTree(e),i=null,r=e.changeByRange(t=>{let r=t.from,{doc:a}=e;if(t.empty&&$n.isActiveAt(e,t.from)){let t=a.lineAt(r),i=wn(function(e,t){let n=e.resolveInner(t,-1),s=t;vn(n)&&(s=n.from,n=n.parent);for(let e;e=n.childBefore(s);)if(vn(e))s=e.from;else{if("OrderedList"!=e.name&&"BulletList"!=e.name&&"DefinitionList"!=e.name)break;n=e.lastChild,s=n.to}return n}(s,r),a);if(i.length){let s=i[i.length-1],a=s.to-s.spaceAfter.length+(s.spaceAfter?1:0);if(r-t.from>a&&!/\S/.test(t.text.slice(a,r-t.from)))return{range:n.EditorSelection.cursor(t.from+a),changes:{from:t.from+a,to:r}};if(r-t.from==a&&(!s.item||t.from<=s.item.from||!/\S/.test(t.text.slice(0,s.to)))){let i=t.from+s.from;if(s.item&&s.node.from<s.item.from&&/\S/.test(t.text.slice(s.from,s.to))){let r=s.blank(n.countColumn(t.text,4,s.to)-n.countColumn(t.text,4,s.from));return i==t.from&&(r=Tn(r,e)),{range:n.EditorSelection.cursor(i+r.length),changes:{from:i,to:t.from+s.to,insert:r}}}if(i<r)return{range:n.EditorSelection.cursor(i),changes:{from:i,to:r}}}}}return i={range:t}});return!i&&(t(e.update(r,{scrollIntoView:!0,userEvent:"delete"})),!0)},Ln={'"':'"',"'":"'","`":"`","(":")","[":"]","{":"}"},Pn=({state:e,dispatch:t})=>{let s=[],i=[];for(let t of e.selection.ranges){if(!t.empty)return!1;const n=t.from;if(0===n)return!1;const r=e.doc.sliceString(n-1,n),a=e.doc.sliceString(n,n+1),o=Ln[r];if(!o||a!==o)return!1;s.push({from:n-1,to:n+1}),i.push({anchor:n-1})}return 0!==s.length&&(t(e.update({changes:s,selection:n.EditorSelection.create(i.map(e=>n.EditorSelection.cursor(e.anchor))),scrollIntoView:!0,userEvent:"delete"})),!0)};function An(e,t,s){let i=e.changeByRange(t=>{if(t.empty)return{range:n.EditorSelection.cursor(t.from+s.length),changes:{from:t.from,insert:s+s}};{let i=e.doc.sliceString(t.from,t.to);if(i.startsWith(s)&&i.endsWith(s)&&i.length>=2*s.length){let e=i.slice(s.length,-s.length);return{range:n.EditorSelection.range(t.from,t.from+e.length),changes:{from:t.from,to:t.to,insert:e}}}return{range:n.EditorSelection.range(t.from,t.to+2*s.length),changes:[{from:t.from,insert:s},{from:t.to,insert:s}]}}});return t(e.update(i,{scrollIntoView:!0,userEvent:"input"})),!0}const En=({state:e,dispatch:t})=>An(e,t,"''"),Bn=({state:e,dispatch:t})=>An(e,t,"//"),In=({state:e,dispatch:t})=>An(e,t,"__"),Wn=({state:e,dispatch:t})=>An(e,t,"~~"),Dn=({state:e,dispatch:t})=>An(e,t,"^^"),Fn=({state:e,dispatch:t})=>An(e,t,",,"),Nn=({state:e,dispatch:t})=>An(e,t,"`"),On=({state:e,dispatch:t})=>{let s=e.changeByRange(t=>{if(t.empty)return{range:n.EditorSelection.cursor(t.from+2),changes:{from:t.from,insert:"[[]]"}};{let s=e.doc.sliceString(t.from,t.to);return{range:n.EditorSelection.range(t.from+2,t.from+2+s.length),changes:{from:t.from,to:t.to,insert:`[[${s}]]`}}}});return t(e.update(s,{scrollIntoView:!0,userEvent:"input"})),!0},Hn=({state:e,dispatch:t})=>{let s=e.changeByRange(t=>{if(t.empty)return{range:n.EditorSelection.cursor(t.from+2),changes:{from:t.from,insert:"{{}}"}};{let s=e.doc.sliceString(t.from,t.to);return{range:n.EditorSelection.range(t.from+2,t.from+2+s.length),changes:{from:t.from,to:t.to,insert:`{{${s}}}`}}}});return t(e.update(s,{scrollIntoView:!0,userEvent:"input"})),!0};function _n(e,t,s){let{doc:i}=e,r=new Set,a=e.changeByRange(e=>{let t=i.lineAt(e.from);if(r.has(t.number))return{range:e};r.add(t.number);let a=t.text,o=/^(!+)\s*/.exec(a),l=o?o[0].length:0,c=s>0?"!".repeat(s)+" ":"",d=c.length-l,f=Math.max(t.from+c.length,e.anchor+d),u=e.empty?f:Math.max(t.from+c.length,e.head+d);return{range:n.EditorSelection.range(f,u),changes:{from:t.from,to:t.from+l,insert:c}}});return t(e.update(a,{scrollIntoView:!0,userEvent:"input"})),!0}const zn=({state:e,dispatch:t})=>_n(e,t,1),Rn=({state:e,dispatch:t})=>_n(e,t,2),Zn=({state:e,dispatch:t})=>_n(e,t,3),Vn=({state:e,dispatch:t})=>_n(e,t,4),Kn=({state:e,dispatch:t})=>_n(e,t,5),Xn=({state:e,dispatch:t})=>_n(e,t,6),jn=({state:e,dispatch:t})=>_n(e,t,0);function qn(e,t,s){let{doc:i}=e,r=new Set,a=e.changeByRange(e=>{let t=i.lineAt(e.from);if(r.has(t.number))return{range:e};r.add(t.number);let a=t.text,o=new RegExp(`^(${s.replace(/[*#]/g,"\\$&")}+)\\s*`).exec(a);if(o){let s=-o[0].length,i=Math.max(t.from,e.anchor+s),r=e.empty?i:Math.max(t.from,e.head+s);return{range:n.EditorSelection.range(i,r),changes:{from:t.from,to:t.from+o[0].length,insert:""}}}{let i=/^([*#;:]+)\s*/.exec(a),r=s+" ",o=i?i[0].length:0,l=r.length-o,c=Math.max(t.from+r.length,e.anchor+l),d=e.empty?c:Math.max(t.from+r.length,e.head+l);return i?{range:n.EditorSelection.range(c,d),changes:{from:t.from,to:t.from+i[0].length,insert:r}}:{range:n.EditorSelection.range(c,d),changes:{from:t.from,insert:r}}}});return t(e.update(a,{scrollIntoView:!0,userEvent:"input"})),!0}const Un=({state:e,dispatch:t})=>qn(e,t,"*"),Qn=({state:e,dispatch:t})=>qn(e,t,"#"),Gn=({state:e,dispatch:t})=>{let s=e.changeByRange(t=>{if(t.empty){let s=e.doc.lineAt(t.from),i="```\n\n```\n",r=s.from+4;return{range:n.EditorSelection.cursor(r),changes:{from:s.from,insert:i}}}{let s=e.doc.sliceString(t.from,t.to),i="```\n"+s+"\n```";return{range:n.EditorSelection.range(t.from+4,t.from+4+s.length),changes:{from:t.from,to:t.to,insert:i}}}});return t(e.update(s,{scrollIntoView:!0,userEvent:"input"})),!0},Yn=s.EditorView.inputHandler.of((e,t,n,s)=>{if(!/^[*#>;:]$/.test(s))return!1;if(t!==n)return!1;let i=e.state.doc.lineAt(t),r=i.from,a=t-r,o=i.text,l=/^([*#>;:]+) $/.exec(o.slice(0,a));if(l){let n=l[1]+s+" ";return e.dispatch({changes:{from:r,to:t,insert:n},selection:{anchor:r+n.length}}),!0}return!1}),Jn=({state:e,dispatch:t})=>{let{doc:s,selection:i}=e,r=i.main;if(!r.empty)return!1;let a=r.from,o=s.lineAt(a),l=a-o.from,c=o.text,d=/^(\*{2,}) $/.exec(c.slice(0,l));if(d&&l===d[0].length){let s=d[1].slice(0,-1)+" ";return t(e.update({changes:{from:o.from,to:a,insert:s},selection:n.EditorSelection.cursor(o.from+s.length)})),!0}let f=/^(#{2,}) $/.exec(c.slice(0,l));if(f&&l===f[0].length){let s=f[1].slice(0,-1)+" ";return t(e.update({changes:{from:o.from,to:a,insert:s},selection:n.EditorSelection.cursor(o.from+s.length)})),!0}return!1},es=({state:e,dispatch:t})=>{let{doc:n,selection:s}=e,i=[],r=new Set,a=!1;for(let e of s.ranges){let t=n.lineAt(e.from),s=n.lineAt(e.to);for(let e=t.number;e<=s.number;e++){if(r.has(e))continue;r.add(e);let t=n.line(e),s=t.text,o=/^([*#>]+)( )/.exec(s);if(o){let e=o[1],n=e[e.length-1],s=t.from+e.length;i.push({from:s,to:s,insert:n}),a=!0;continue}let l=/^([;:]+)(\s*)/.exec(s);if(l){let e=l[1],n=e[e.length-1],s=t.from+e.length;i.push({from:s,to:s,insert:n}),a=!0;continue}}}return!(!a||0===i.length)&&(t(e.update({changes:i,scrollIntoView:!0,userEvent:"input"})),!0)},ts=({state:e,dispatch:t})=>{let{doc:n,selection:s}=e,i=[],r=new Set,a=!1;for(let e of s.ranges){let t=n.lineAt(e.from),s=n.lineAt(e.to);for(let e=t.number;e<=s.number;e++){if(r.has(e))continue;r.add(e);let t=n.line(e),s=t.text,o=/^([*#>]{2,})( )/.exec(s);if(o){let e=o[1],n=t.from+e.length-1;i.push({from:n,to:n+1}),a=!0;continue}let l=/^([;:]{2,})(\s*)/.exec(s);if(l){let e=l[1],n=t.from+e.length-1;i.push({from:n,to:n+1}),a=!0;continue}/^([*#>]) /.exec(s)?(i.push({from:t.from,to:t.from+2}),a=!0):/^([;:]) /.exec(s)&&(i.push({from:t.from,to:t.from+2}),a=!0)}}return!!a&&(0===i.length||t(e.update({changes:i,scrollIntoView:!0,userEvent:"input"})),!0)},ns=a.HighlightStyle.define([{tag:r.tags.heading1,class:"cm-tw-heading1"},{tag:r.tags.heading2,class:"cm-tw-heading2"},{tag:r.tags.heading3,class:"cm-tw-heading3"},{tag:r.tags.heading4,class:"cm-tw-heading4"},{tag:r.tags.heading5,class:"cm-tw-heading5"},{tag:r.tags.heading6,class:"cm-tw-heading6"},{tag:r.tags.heading,class:"cm-tw-tableheader"},{tag:r.tags.strong,class:"cm-tw-bold"},{tag:r.tags.emphasis,class:"cm-tw-italic"},{tag:r.tags.strikethrough,class:"cm-tw-strikethrough"},{tag:r.tags.link,class:"cm-tw-wikilink"},{tag:r.tags.url,class:"cm-tw-url"},{tag:r.tags.string,class:"cm-tw-linktext"},{tag:r.tags.special(r.tags.link),class:"cm-tw-transclusion"},{tag:r.tags.macroName,class:"cm-tw-macrocall"},{tag:r.tags.variableName,class:"cm-tw-variable"},{tag:r.tags.tagName,class:"cm-tw-widget"},{tag:r.tags.monospace,class:"cm-tw-code"},{tag:r.tags.labelName,class:"cm-tw-codeinfo"},{tag:r.tags.definitionKeyword,class:"cm-tw-pragma"},{tag:r.tags.keyword,class:"cm-tw-pragma-keyword"},{tag:r.tags.controlKeyword,class:"cm-tw-conditional"},{tag:r.tags.list,class:"cm-tw-list"},{tag:r.tags.quote,class:"cm-tw-blockquote"},{tag:r.tags.contentSeparator,class:"cm-tw-hr"},{tag:r.tags.comment,class:"cm-tw-comment"},{tag:r.tags.escape,class:"cm-tw-escape"},{tag:r.tags.character,class:"cm-tw-entity"},{tag:r.tags.processingInstruction,class:"cm-tw-mark"},{tag:r.tags.special(r.tags.string),class:"cm-tw-filter"},{tag:r.tags.regexp,class:"cm-tw-regexp"},{tag:r.tags.attributeValue,class:"cm-tw-attribute-value"},{tag:r.tags.attributeName,class:"cm-tw-attribute"},{tag:r.tags.special(r.tags.variableName),class:"cm-tw-param-ref"},{tag:r.tags.propertyName,class:"cm-tw-field-ref"},{tag:r.tags.special(r.tags.emphasis),class:"cm-tw-underline"},{tag:sn.twSuperscript,class:"cm-tw-superscript"},{tag:sn.twSubscript,class:"cm-tw-subscript"},{tag:r.tags.special(r.tags.content),class:"cm-tw-highlight"},{tag:r.tags.invalid,class:"cm-tw-invalid"}]);function ss(e={}){const{getTabOutsideListBehavior:t,getShiftTabOutsideListBehavior:n,getEnterIndentBehavior:s}=e,i=Sn({fallbackBehavior:"smart"}),r=Sn({fallbackBehavior:"indent"}),a=Sn({fallbackBehavior:"none"});return[{key:"Enter",run:function(e){switch(s?s():"smart"){case"smart":default:return i(e);case"indent":return r(e);case"none":return a(e)}}},{key:"Backspace",run:e=>Pn(e)||Jn(e)||Mn(e)},{key:"Tab",run:function(e){if("active"===o.completionStatus(e.state))return o.acceptCompletion(e);if(es(e))return!0;switch(t?t():"indent"){case"indent":return c.indentMore(e);case"insertTab":return c.insertTab(e);default:return!1}}},{key:"Shift-Tab",run:function(e){return!!ts(e)||"indent"===(n?n():"indent")&&c.indentLess(e)}}]}function is(e,t,n,s){const r=function(e,t,n){const s=["tiddlywiki","wikitext","tw","tw5"];return i=>{if(i&&e){let r=null;if(i=/\S*/.exec(i)[0],s.includes(i.toLowerCase()))return n??t?.parser??null;if(r="function"==typeof e?e(i):a.LanguageDescription.matchLanguageName(e,i,!0),r instanceof a.LanguageDescription){const e=r.name?.toLowerCase()||"",i=r.alias?.map(e=>e.toLowerCase())||[];return"tiddlywiki"===e||s.some(e=>i.includes(e))?n??t?.parser??null:r.support?r.support.language.parser:a.ParseContext.getSkippingParser(r.load())}if(r)return r.parser}return t?t.parser:null}}(e,t,n);return i.parseMixed((t,i)=>{if("CodeText"===t.name){const s=t.node.parent;if("FencedCode"===s?.name){const e=s.getChild("CodeInfo"),t=e?i.read(e.from,e.to):"",n=r(t);if(n)return{parser:n,bracketed:!0}}if("TypedBlock"===s?.name){const t=s.getChild("TypedBlockType"),o=t?i.read(t.from,t.to):"";if(("text/vnd.tiddlywiki"===o||"text/x-tiddlywiki"===o)&&n)return{parser:n,bracketed:!0};if("text/plain"===o)return null;if(o.startsWith(".")){const t=function(e,t){if(!e.startsWith("."))return"";const n=e.slice(1).toLowerCase();if(t&&Array.isArray(t))for(const e of t)if(e.extensions&&e.extensions.some(e=>e.toLowerCase()===n))return e.name.toLowerCase();return""}(o,Array.isArray(e)?e:void 0);if(t){const e=r(t);if(e)return{parser:e,bracketed:!0}}}const l={"text/javascript":"javascript","application/javascript":"javascript","text/typescript":"typescript","application/typescript":"typescript","text/css":"css","text/html":"html","application/json":"json","text/x-markdown":"markdown","text/x-tiddlywiki":"","text/vnd.tiddlywiki":"","text/plain":""}[a=o]??a.replace(/^text\/x-/,"").replace(/^application\//,"").replace(/^text\//,"");if(l){const e=r(l);if(e)return{parser:e,bracketed:!0}}}}var a;if("HTMLBlock"===t.name){const e=t.node.getChild("TagName");if(e){const n=i.read(e.from,e.to).toLowerCase();if("style"===n||"script"===n){const e=r("style"===n?"css":"javascript");if(e){let n=-1,s=-1;const r=t.node.cursor();r.firstChild();do{if("TagMark"===r.name&&-1===n){">"===i.read(r.from,r.to)&&(n=r.to)}if("HTMLEndTag"===r.name){s=r.from;break}}while(r.nextSibling());if(n>0&&s>n)return{parser:e,overlay:[{from:n,to:s}]}}}}}if("LaTeXContent"===t.name){const e=r("latex");if(e)return{parser:e,bracketed:!0}}if("HighlightStyles"===t.name){const e=r("css");if(e&&e.configure){return{parser:e.configure({top:"Styles"}),bracketed:!0}}}if("AttributeString"===t.name){const e=t.node.parent;if("Attribute"===e?.name){const n=e.getChild("AttributeName");if(n){if("style"===i.read(n.from,n.to)){const n=e.parent;if(n&&("Widget"===n.name||"InlineWidget"===n.name)&&s){const e=n.getChild("WidgetName");if(e){const t=i.read(e.from,e.to),n=s(t);if(n&&!n.includes("style"))return null}}const a=r("css");if(a&&a.configure){const e=a.configure({top:"Styles"}),n=t.from+1,s=t.to-1;if(s>n)return{parser:e,overlay:[{from:n,to:s}],bracketed:!0}}}}}}if("AttributeString"===t.name){const e=t.node.parent;if("Attribute"===e?.name){const n=e.getChild("AttributeName");if(n){if("text"===i.read(n.from,n.to)){const n=e.parent;if(n&&("Widget"===n.name||"InlineWidget"===n.name)){const e=n.getChild("WidgetName");if(e){const n=i.read(e.from,e.to);if("$latex"===n||"$katex"===n){const e=r("latex");if(e){const n=t.from+1,s=t.to-1;if(s>n)return{parser:e,overlay:[{from:n,to:s}],bracketed:!0}}}}}}}}}return null})}ss();const rs=n.StateEffect.define(),as=s.EditorView.updateListener.of(e=>{for(const t of e.transactions)for(const n of t.effects)if(n.is(rs))return void requestAnimationFrame(()=>{setTimeout(()=>{o.startCompletion(e.view)},1)})}),os=new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]),ls=new Set(["$action-confirm","$action-createtiddler","$action-deletetiddler","$action-deletefield","$action-listops","$action-log","$action-navigate","$action-popup","$action-sendmessage","$action-setfield","$action-setmultiplefields","$audio","$codeblock","$count","$data","$edit-text","$encrypt","$entity","$error","$image","$jsontiddler","$raw","$text"]),cs=["transclusion","currentTiddler","storyTiddler","tv-story-list","tv-history-list","tv-config-toolbar-icons","tv-config-toolbar-text","tv-config-toolbar-class","tv-wikilinks","tv-show-missing-links","revealedTitle","tv-tiddler-preview"],ds=["title","text","tags","modified","created","creator","modifier","type","caption","description","list","list-before","list-after","draft.of","draft.title","plugin-type","plugin-priority","color","icon","library","source","code-body","throttle.refresh"];function fs(e,t,n,s,i){const r=e.state.selection.ranges,a=e.state.selection.mainIndex;return r.map((e,r)=>r===a?{from:t,to:n,insert:s}:{from:e.from-i,to:e.from,insert:s})}function us(e,t){return t&&t(e)?-100:e.startsWith("$:/")?-1:1}function hs(e,t){return t&&t(e)?"2_"+e:e.startsWith("$:/")?"1_"+e:"0_"+e}let ps={text:"",result:null};function ms(e){let t=0,n=!1;for(;t<e.length;){const s=t;for(;t<e.length&&(" "===e[t]||"\t"===e[t]);)t++;if(t>=e.length)return e.length;if("\n"!==e[t]&&"\r"!==e[t]){if("\\"!==e[t]){if(n){for(;t<e.length&&"\n"!==e[t]&&"\r"!==e[t];)t++;"\r"===e[t]&&t++,"\n"===e[t]&&t++;continue}return s}{const i=e.slice(t);if(/^\\end\b/.test(i)){for(n=!1;t<e.length&&"\n"!==e[t]&&"\r"!==e[t];)t++;"\r"===e[t]&&t++,"\n"===e[t]&&t++;continue}const r=/^\\(define|procedure|function|widget)\s+([^\s(]+)(?:\(([^)]*)\))?/.exec(i);if(r){const s=i.slice(r[0].length);for(/^\s*\S/.test(s)&&!/^\s*[\r\n]/.test(s)||(n=!0);t<e.length&&"\n"!==e[t]&&"\r"!==e[t];)t++;"\r"===e[t]&&t++,"\n"===e[t]&&t++;continue}if(/^\\(rules|whitespace|import|parameters|parsermode)\b/.test(i)){for(;t<e.length&&"\n"!==e[t]&&"\r"!==e[t];)t++;"\r"===e[t]&&t++,"\n"===e[t]&&t++;continue}if(!n)return s}for(;t<e.length&&"\n"!==e[t]&&"\r"!==e[t];)t++;"\r"===e[t]&&t++,"\n"===e[t]&&t++}else t++,"\r"===e[t-1]&&"\n"===e[t]&&t++}return e.length}function gs(e){if(ps.text===e&&ps.result)return ps.result;const t=[],n=[],s=[],i=[],r={},a={},o=ms(e),l=e.slice(0,o),c=/(?:^|[\r\n])[ \t]*\\(define|procedure|function|widget)\s+([^\s(]+)(?:\(([^)]*)\))?/gm;let d;for(;null!==(d=c.exec(l));){const o=d[1],l=d[2],c=d[3];if(!r[l]){switch(r[l]=!0,o){case"function":t.push(l);break;case"procedure":n.push(l);break;case"define":s.push(l);break;case"widget":i.push(l)}if(void 0!==c&&c.trim()){const e=c.split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0);e.length>0&&(a[l]=e)}else{const t=e.slice(d.index+d[0].length),n=/^\s*\n?\s*\\parameters\s*\(([^)]*)\)/.exec(t);if(n){const e=n[1].split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0);e.length>0&&(a[l]=e)}}}}const f=[],u=/<\$set\s+[^>]*name\s*=\s*["']([^"']+)["']/gi;for(;null!==(d=u.exec(e));){const e=d[1];r[e]||(r[e]=!0,f.push(e))}const h=/<\$vars\s+([^>]+)>/gi;for(;null!==(d=h.exec(e));){const e=d[1],t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];r[e]||(r[e]=!0,f.push(e))}}const p=/<\$let\s+([^>]+)>/gi;for(;null!==(d=p.exec(e));){const e=d[1],t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];r[e]||(r[e]=!0,f.push(e))}}const m=/<\$parameters\s+([^>]+)>/gi;for(;null!==(d=m.exec(e));){const e=d[1],t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];r[e]||(r[e]=!0,f.push(e))}}const g=/<\$list\s+[^>]*variable\s*=\s*["']([^"']+)["']/gi;for(;null!==(d=g.exec(e));){const e=d[1];r[e]||(r[e]=!0,f.push(e))}const b=/<\$list\s+[^>]*counter\s*=\s*["']([^"']+)["']/gi;for(;null!==(d=b.exec(e));){const e=d[1];r[e]||(r[e]=!0,f.push(e));const t=e+"-first";r[t]||(r[t]=!0,f.push(t));const n=e+"-last";r[n]||(r[n]=!0,f.push(n))}const k=/<\$range\s+[^>]*variable\s*=\s*["']([^"']+)["']/gi;for(;null!==(d=k.exec(e));){const e=d[1];r[e]||(r[e]=!0,f.push(e))}const x=/<\$wikify\s+[^>]*name\s*=\s*["']([^"']+)["']/gi;for(;null!==(d=x.exec(e));){const e=d[1];r[e]||(r[e]=!0,f.push(e))}const $=[...cs,...t,...n,...s,...i,...f],y={functions:t,procedures:n,macros:s,widgets:i,widgetVars:f,builtIns:cs,variables:$,definitionParams:a};return ps={text:e,result:y},y}function bs(){var e=arguments[0];"string"==typeof e&&(e=document.createElement(e));var t=1,n=arguments[1];if(n&&"object"==typeof n&&null==n.nodeType&&!Array.isArray(n)){for(var s in n)if(Object.prototype.hasOwnProperty.call(n,s)){var i=n[s];"string"==typeof i?e.setAttribute(s,i):null!=i&&(e[s]=i)}t++}for(;t<arguments.length;t++)ks(e,arguments[t]);return e}function ks(e,t){if("string"==typeof t)e.appendChild(document.createTextNode(t));else if(null==t);else if(null!=t.nodeType)e.appendChild(t);else{if(!Array.isArray(t))throw new RangeError("Unsupported child node: "+t);for(var n=0;n<t.length;n++)ks(e,t[n])}}class xs{constructor(e,t,n){this.from=e,this.to=t,this.diagnostic=n}}class $s{constructor(e,t,n){this.diagnostics=e,this.panel=t,this.selected=n}static init(e,t,i){let r=i.facet(Bs).markerFilter;r&&(e=r(e,i));let a=e.slice().sort((e,t)=>e.from-t.from||e.to-t.to),o=new n.RangeSetBuilder,l=[],c=0,d=i.doc.iter(),f=0,u=i.doc.length;for(let e=0;;){let t,n,i=e==a.length?null:a[e];if(!i&&!l.length)break;if(l.length)t=c,n=l.reduce((e,t)=>Math.min(e,t.to),i&&i.from>t?i.from:1e8);else{if(t=i.from,t>u)break;n=i.to,l.push(i),e++}for(;e<a.length;){let s=a[e];if(s.from!=t||!(s.to>s.from||s.to==t)){n=Math.min(s.from,n);break}l.push(s),e++,n=Math.min(s.to,n)}n=Math.min(n,u);let r=!1;if(l.some(e=>e.from==t&&(e.to==n||n==u))&&(r=t==n,!r&&n-t<10)){let e=t-(f+d.value.length);e>0&&(d.next(e),f=t);for(let e=t;;){if(e>=n){r=!0;break}if(!d.lineBreak&&f+d.value.length>e)break;e=f+d.value.length,f+=d.value.length,d.next()}}let h=Zs(l);if(r)o.add(t,t,s.Decoration.widget({widget:new Ns(h),diagnostics:l.slice()}));else{let e=l.reduce((e,t)=>t.markClass?e+" "+t.markClass:e,"");o.add(t,n,s.Decoration.mark({class:"cm-lintRange cm-lintRange-"+h+e,diagnostics:l.slice(),inclusiveEnd:l.some(e=>e.to>n)}))}if(c=n,c==u)break;for(let e=0;e<l.length;e++)l[e].to<=c&&l.splice(e--,1)}let h=o.finish();return new $s(h,t,ys(h))}}function ys(e,t=null,n=0){let s=null;return e.between(n,1e9,(e,n,{spec:i})=>{if(!(t&&i.diagnostics.indexOf(t)<0))if(s){if(i.diagnostics.indexOf(s.diagnostic)<0)return!1;s=new xs(s.from,n,s.diagnostic)}else s=new xs(e,n,t||i.diagnostics[0])}),s}function ws(e,t){return e.field(vs,!1)?t:t.concat(n.StateEffect.appendConfig.of(Vs))}const Ts=n.StateEffect.define(),Ss=n.StateEffect.define(),Cs=n.StateEffect.define(),vs=n.StateField.define({create:()=>new $s(s.Decoration.none,null,null),update(e,t){if(t.docChanged&&e.diagnostics.size){let n=e.diagnostics.map(t.changes),s=null,i=e.panel;if(e.selected){let i=t.changes.mapPos(e.selected.from,1);s=ys(n,e.selected.diagnostic,i)||ys(n,null,i)}!n.size&&i&&t.state.facet(Bs).autoPanel&&(i=null),e=new $s(n,i,s)}for(let n of t.effects)if(n.is(Ts)){let s=t.state.facet(Bs).autoPanel?n.value.length?Hs.open:null:e.panel;e=$s.init(n.value,s,t.state)}else n.is(Ss)?e=new $s(e.diagnostics,n.value?Hs.open:null,e.selected):n.is(Cs)&&(e=new $s(e.diagnostics,e.panel,n.value));return e},provide:e=>[s.showPanel.from(e,e=>e.panel),s.EditorView.decorations.from(e,e=>e.diagnostics)]}),Ms=s.Decoration.mark({class:"cm-lintRange cm-lintRange-active"});function Ls(e,t,n){let s,{diagnostics:i}=e.state.field(vs),r=-1,a=-1;i.between(t-(n<0?1:0),t+(n>0?1:0),(e,i,{spec:o})=>{if(t>=e&&t<=i&&(e==i||(t>e||n>0)&&(t<i||n<0)))return s=o.diagnostics,r=e,a=i,!1});let o=e.state.facet(Bs).tooltipFilter;return s&&o&&(s=o(s,e.state)),s?{pos:r,end:a,above:e.state.doc.lineAt(r).to<a,create:()=>({dom:Ps(e,s)})}:null}function Ps(e,t){return bs("ul",{class:"cm-tooltip-lint"},t.map(t=>Fs(e,t,!1)))}const As=e=>{let t=e.state.field(vs,!1);return!(!t||!t.panel)&&(e.dispatch({effects:Ss.of(!1)}),!0)},Es=s.ViewPlugin.fromClass(class{constructor(e){this.view=e,this.timeout=-1,this.set=!0;let{delay:t}=e.state.facet(Bs);this.lintTime=Date.now()+t,this.run=this.run.bind(this),this.timeout=setTimeout(this.run,t)}run(){clearTimeout(this.timeout);let e=Date.now();if(e<this.lintTime-10)this.timeout=setTimeout(this.run,this.lintTime-e);else{this.set=!1;let{state:e}=this.view,{sources:t}=e.facet(Bs);t.length&&function(e,t,n){let s=[],i=-1;for(let r of e)r.then(n=>{s.push(n),clearTimeout(i),s.length==e.length?t(s):i=setTimeout(()=>t(s),200)},n)}(t.map(e=>Promise.resolve(e(this.view))),t=>{this.view.state.doc==e.doc&&this.view.dispatch(function(e,t){return{effects:ws(e,[Ts.of(t)])}}(this.view.state,t.reduce((e,t)=>e.concat(t))))},e=>{s.logException(this.view.state,e)})}}update(e){let t=e.state.facet(Bs);(e.docChanged||t!=e.startState.facet(Bs)||t.needsRefresh&&t.needsRefresh(e))&&(this.lintTime=Date.now()+t.delay,this.set||(this.set=!0,this.timeout=setTimeout(this.run,t.delay)))}force(){this.set&&(this.lintTime=Date.now(),this.run())}destroy(){clearTimeout(this.timeout)}});const Bs=n.Facet.define({combine:e=>({sources:e.map(e=>e.source).filter(e=>null!=e),...n.combineConfig(e.map(e=>e.config),{delay:750,markerFilter:null,tooltipFilter:null,needsRefresh:null,hideOn:()=>null},{delay:Math.max,markerFilter:Is,tooltipFilter:Is,needsRefresh:(e,t)=>e?t?n=>e(n)||t(n):e:t,hideOn:(e,t)=>e?t?(n,s,i)=>e(n,s,i)||t(n,s,i):e:t,autoPanel:(e,t)=>e||t})})});function Is(e,t){return e?t?(n,s)=>t(e(n,s),s):e:t}function Ws(e,t={}){return[Bs.of({source:e,config:t}),Es,Vs]}function Ds(e){let t=[];if(e)e:for(let{name:n}of e){for(let e=0;e<n.length;e++){let s=n[e];if(/[a-zA-Z]/.test(s)&&!t.some(e=>e.toLowerCase()==s.toLowerCase())){t.push(s);continue e}}t.push("")}return t}function Fs(e,t,n){var s;let i=n?Ds(t.actions):[];return bs("li",{class:"cm-diagnostic cm-diagnostic-"+t.severity},bs("span",{class:"cm-diagnosticText"},t.renderMessage?t.renderMessage(e):t.message),null===(s=t.actions)||void 0===s?void 0:s.map((n,s)=>{let r=!1,a=s=>{if(s.preventDefault(),r)return;r=!0;let i=ys(e.state.field(vs).diagnostics,t);i&&n.apply(e,i.from,i.to)},{name:o}=n,l=i[s]?o.indexOf(i[s]):-1,c=l<0?o:[o.slice(0,l),bs("u",o.slice(l,l+1)),o.slice(l+1)];return bs("button",{type:"button",class:"cm-diagnosticAction"+(n.markClass?" "+n.markClass:""),onclick:a,onmousedown:a,"aria-label":` Action: ${o}${l<0?"":` (access key "${i[s]})"`}.`},c)}),t.source&&bs("div",{class:"cm-diagnosticSource"},t.source))}class Ns extends s.WidgetType{constructor(e){super(),this.sev=e}eq(e){return e.sev==this.sev}toDOM(){return bs("span",{class:"cm-lintPoint cm-lintPoint-"+this.sev})}}class Os{constructor(e,t){this.diagnostic=t,this.id="item_"+Math.floor(4294967295*Math.random()).toString(16),this.dom=Fs(e,t,!0),this.dom.id=this.id,this.dom.setAttribute("role","option")}}class Hs{constructor(e){this.view=e,this.items=[];this.list=bs("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:t=>{if(27==t.keyCode)As(this.view),this.view.focus();else if(38==t.keyCode||33==t.keyCode)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(40==t.keyCode||34==t.keyCode)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(36==t.keyCode)this.moveSelection(0);else if(35==t.keyCode)this.moveSelection(this.items.length-1);else if(13==t.keyCode)this.view.focus();else{if(!(t.keyCode>=65&&t.keyCode<=90&&this.selectedIndex>=0))return;{let{diagnostic:n}=this.items[this.selectedIndex],s=Ds(n.actions);for(let i=0;i<s.length;i++)if(s[i].toUpperCase().charCodeAt(0)==t.keyCode){let t=ys(this.view.state.field(vs).diagnostics,n);t&&n.actions[i].apply(e,t.from,t.to)}}}t.preventDefault()},onclick:e=>{for(let t=0;t<this.items.length;t++)this.items[t].dom.contains(e.target)&&this.moveSelection(t)}}),this.dom=bs("div",{class:"cm-panel-lint"},this.list,bs("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>As(this.view)},"")),this.update()}get selectedIndex(){let e=this.view.state.field(vs).selected;if(!e)return-1;for(let t=0;t<this.items.length;t++)if(this.items[t].diagnostic==e.diagnostic)return t;return-1}update(){let{diagnostics:e,selected:t}=this.view.state.field(vs),n=0,s=!1,i=null,r=new Set;for(e.between(0,this.view.state.doc.length,(e,a,{spec:o})=>{for(let e of o.diagnostics){if(r.has(e))continue;r.add(e);let a,o=-1;for(let t=n;t<this.items.length;t++)if(this.items[t].diagnostic==e){o=t;break}o<0?(a=new Os(this.view,e),this.items.splice(n,0,a),s=!0):(a=this.items[o],o>n&&(this.items.splice(n,o-n),s=!0)),t&&a.diagnostic==t.diagnostic?a.dom.hasAttribute("aria-selected")||(a.dom.setAttribute("aria-selected","true"),i=a):a.dom.hasAttribute("aria-selected")&&a.dom.removeAttribute("aria-selected"),n++}});n<this.items.length&&!(1==this.items.length&&this.items[0].diagnostic.from<0);)s=!0,this.items.pop();0==this.items.length&&(this.items.push(new Os(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")})),s=!0),i?(this.list.setAttribute("aria-activedescendant",i.id),this.view.requestMeasure({key:this,read:()=>({sel:i.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:e,panel:t})=>{let n=t.height/this.list.offsetHeight;e.top<t.top?this.list.scrollTop-=(t.top-e.top)/n:e.bottom>t.bottom&&(this.list.scrollTop+=(e.bottom-t.bottom)/n)}})):this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant"),s&&this.sync()}sync(){let e=this.list.firstChild;function t(){let t=e;e=t.nextSibling,t.remove()}for(let n of this.items)if(n.dom.parentNode==this.list){for(;e!=n.dom;)t();e=n.dom.nextSibling}else this.list.insertBefore(n.dom,e);for(;e;)t()}moveSelection(e){if(this.selectedIndex<0)return;let t=ys(this.view.state.field(vs).diagnostics,this.items[e].diagnostic);t&&this.view.dispatch({selection:{anchor:t.from,head:t.to},scrollIntoView:!0,effects:Cs.of(t)})}static open(e){return new Hs(e)}}function _s(e){return function(e,t='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${t}>${encodeURIComponent(e)}</svg>')`}(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${e}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const zs=s.EditorView.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnostic-hint":{borderLeft:"5px solid #66d"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px",cursor:"pointer"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:_s("#d11")},".cm-lintRange-warning":{backgroundImage:_s("orange")},".cm-lintRange-info":{backgroundImage:_s("#999")},".cm-lintRange-hint":{backgroundImage:_s("#66d")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-lintPoint-hint":{"&:after":{borderBottomColor:"#66d"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}});function Rs(e){return"error"==e?4:"warning"==e?3:"info"==e?2:1}function Zs(e){let t="hint",n=1;for(let s of e){let e=Rs(s.severity);e>n&&(n=e,t=s.severity)}return t}const Vs=[vs,s.EditorView.decorations.compute([vs],e=>{let{selected:t,panel:n}=e.field(vs);return t&&n&&t.from!=t.to?s.Decoration.set([Ms.range(t.from,t.to)]):s.Decoration.none}),s.hoverTooltip(Ls,{hideOn:function(e,t){let n=t.pos,s=t.end||n,i=e.state.facet(Bs).hideOn(e,n,s);if(null!=i)return i;let r=e.startState.doc.lineAt(t.pos);return!(!e.effects.some(e=>e.is(Ts))&&!e.changes.touchesRange(r.from,Math.max(r.to,s)))}}),zs],Ks=new Set(["MacroDefinition","ProcedureDefinition","FunctionDefinition","WidgetDefinition"]),Xs=new Set(["MacroDefinition"]),js=new Set(["MacroDefinition"]),qs=new Set(["currentTiddler","storyTiddler","transclusion"]),Us={$droppable:["actionTiddler","actionTiddlerList","modifier"],$dropzone:["actionTiddler","actionTiddlerList","modifier"],$draggable:["actionTiddler"],$button:["modifier"],$radio:["actionValue"],$range:["actionValue","actionValueHasChanged"],$linkcatcher:["navigateTo","modifier"],$messagecatcher:["modifier","event-*","event-paramObject-*","list-event","list-event-paramObject"],$eventcatcher:["dom-*","modifier","event-mousebutton","event-type","event-detail-*","tv-popup-coords","tv-popup-abs-coords","tv-widgetnode-width","tv-widgetnode-height","tv-selectednode-posx","tv-selectednode-posy","tv-selectednode-width","tv-selectednode-height","event-fromselected-posx","event-fromselected-posy","event-fromcatcher-posx","event-fromcatcher-posy","event-fromviewport-posx","event-fromviewport-posy"],$keyboard:["modifier","event-key-descriptor"]},Qs={$droppable:["actions"],$dropzone:["actions"],$draggable:["startactions","endactions"],$button:["actions"],$radio:["actions"],$range:["actions","actionsStart","actionsStop"],$linkcatcher:["actions"],$messagecatcher:["actions"],$eventcatcher:["$click","$dblclick","$contextmenu","$mousedown","$mouseup","$mouseover","$mouseout","$mouseenter","$mouseleave","$mousemove","$pointerdown","$pointerup","$pointermove","$pointerover","$pointerout","$pointerenter","$pointerleave","$pointercancel","$dragstart","$dragend","$dragenter","$dragleave","$dragover","$drop","$drag","$focusin","$focusout","$focus","$blur","$keydown","$keyup","$keypress","$input","$change","$submit","$touchstart","$touchend","$touchmove","$touchcancel","$wheel","$scroll","actions-click","actions-dblclick","actions-contextmenu","actions-mousedown","actions-mouseup","actions-mouseover","actions-mouseout","actions-focusin","actions-focusout","actions-keydown","actions-keyup","actions-input","actions-change","actions-dragstart","actions-dragend","actions-dragenter","actions-dragleave","actions-dragover","actions-drop","actions-pointerdown","actions-pointerup","actions-pointermove","actions-pointerover","actions-pointerout","actions-pointerenter","actions-pointerleave","actions-pointercancel"],$keyboard:["actions"]};function Gs(e,t){let n=e.firstChild;for(;n;){if("WidgetName"===n.name)return t.slice(n.from,n.to);n=n.nextSibling}return null}function Ys(e,t){let n=e.firstChild;for(;n;){if("AttributeName"===n.name)return t.slice(n.from,n.to);n=n.nextSibling}return null}function Js(e,t){const n=new Set;let s=e.firstChild;for(;s;){if("PragmaParams"===s.name){const e=t.slice(s.from,s.to).trim(),i=e.indexOf(":"),r=i>=0?e.slice(0,i).trim():e;r&&n.add(r)}else if("MacroParamName"===s.name){const e=t.slice(s.from,s.to);n.add(e)}else if("MacroParam"===s.name){let e=s.firstChild;for(;e;){if("MacroParamName"===e.name){const s=t.slice(e.from,e.to);n.add(s)}e=e.nextSibling}}s=s.nextSibling}return n}function ei(e){const t=[],n=a.syntaxTree(e.state),s=e.state.doc.toString(),i=[],r=[];return n.iterate({enter:e=>{if(Ks.has(e.name)){const n=e.node,a=function(e,t){const n=new Set,s=Js(e,t);for(const e of s)n.add(e);let i=e.parent;for(;i;){if(Ks.has(i.name)){const e=Js(i,t);for(const t of e)n.add(t)}i=i.parent}return n}(n,s);Xs.has(e.name)?(i.push({from:n.from,to:n.to}),function(e,t,n,s){const i=[];let r=e.firstChild;for(;r;)if(Ks.has(r.name))if(r.nextSibling)r=r.nextSibling;else for(r=null;i.length>0;){const e=i.pop();if(e.nextSibling){r=e.nextSibling;break}}else{if("SubstitutedParam"===r.name){let e=r.firstChild;for(;e;){if("SubstitutedParamName"===e.name){const i=n.slice(e.from,e.to);t.has(i)||qs.has(i)||s.push({from:r.from,to:r.to,severity:"error",message:`Unknown parameter "${i}". Available parameters: ${t.size>0?Array.from(t).join(", "):"(none)"}`});break}e=e.nextSibling}}if(r.firstChild)i.push(r),r=r.firstChild;else if(r.nextSibling)r=r.nextSibling;else for(r=null;i.length>0;){const e=i.pop();if(e.nextSibling){r=e.nextSibling;break}}}}(n,a,s,t)):function(e,t,n,s){const i=[];let r=e.firstChild;const a="ProcedureDefinition"===t?"\\procedure":"FunctionDefinition"===t?"\\function":"\\widget";for(;r;)if(Ks.has(r.name))if(r.nextSibling)r=r.nextSibling;else for(r=null;i.length>0;){const e=i.pop();if(e.nextSibling){r=e.nextSibling;break}}else{if("SubstitutedParam"===r.name){let e="?",t=r.firstChild;for(;t;){if("SubstitutedParamName"===t.name){e=n.slice(t.from,t.to);break}t=t.nextSibling}s.push({from:r.from,to:r.to,severity:"warning",message:`Parameter substitution "__${e}__" is not recommended in ${a}. Use <<${e}>> instead.`})}if(r.firstChild)i.push(r),r=r.firstChild;else if(r.nextSibling)r=r.nextSibling;else for(r=null;i.length>0;){const e=i.pop();if(e.nextSibling){r=e.nextSibling;break}}}}(n,e.name,s,t),"MacroDefinition"===e.name&&(r.push({from:n.from,to:n.to}),function(e,t,n,s){const i=[];let r=e.firstChild;for(;r;)if(Ks.has(r.name))if(r.nextSibling)r=r.nextSibling;else for(r=null;i.length>0;){const e=i.pop();if(e.nextSibling){r=e.nextSibling;break}}else{if("Placeholder"===r.name){let e=r.firstChild;for(;e;){if("VariableName"===e.name){const i=n.slice(e.from,e.to);t.has(i)||qs.has(i)||s.push({from:r.from,to:r.to,severity:"error",message:`Unknown parameter "$${i}$". Available parameters: ${t.size>0?Array.from(t).join(", "):"(none)"}`});break}e=e.nextSibling}}if(r.firstChild)i.push(r),r=r.firstChild;else if(r.nextSibling)r=r.nextSibling;else for(r=null;i.length>0;){const e=i.pop();if(e.nextSibling){r=e.nextSibling;break}}}}(n,a,s,t))}}}),function(e,t,n,s){const i=[];let r=e.firstChild;for(;r;){if("SubstitutedParam"===r.name&&!t.some(e=>r.from>=e.from&&r.to<=e.to)){let e="?",t=r.firstChild;for(;t;){if("SubstitutedParamName"===t.name){e=n.slice(t.from,t.to);break}t=t.nextSibling}s.push({from:r.from,to:r.to,severity:"error",message:`Parameter substitution "__${e}__" is only valid inside \\define macros`})}if(r.firstChild&&!Ks.has(r.name))i.push(r),r=r.firstChild;else if(r.nextSibling)r=r.nextSibling;else for(r=null;i.length>0;){const e=i.pop();if(e.nextSibling){r=e.nextSibling;break}}}}(n.topNode,i,s,t),function(e,t,n,s){const i=[];let r=e.firstChild;for(;r;){if("Placeholder"===r.name&&!t.some(e=>r.from>=e.from&&r.to<=e.to)){let e="?",t=r.firstChild;for(;t;){if("VariableName"===t.name){e=n.slice(t.from,t.to);break}t=t.nextSibling}s.push({from:r.from,to:r.to,severity:"error",message:`Parameter placeholder "$${e}$" is only valid inside \\define macros (not \\procedure, \\function, or \\widget)`})}if(r.firstChild&&!js.has(r.name))i.push(r),r=r.firstChild;else if(r.nextSibling)r=r.nextSibling;else for(r=null;i.length>0;){const e=i.pop();if(e.nextSibling){r=e.nextSibling;break}}}}(n.topNode,r,s,t),t}Ws(ei),Ws(ei);const ti=["now","tag","tabs","timeline","toc","toc-hierarchical","toc-selective-expandable","list-links","list-links-draggable","list-tagged-draggable","copy-to-clipboard","colour-picker","image-picker","keyboard-shortcut","dumpvariables","qualify","csvtiddlers","jsontiddlers","datauri","makedatauri","translink"];function ni(e,t,n){return s=>{const{state:i,pos:r}=s,o=i.sliceDoc(r-50,r),l=/<<[\w\-\.]*$/.exec(o);if(l&&l.index>0&&"<"===o[l.index-1])return null;if(l&&/<<__/.test(l[0]))return null;const c=/[\[\]}>][\w\-:!]*<[\w\-\.]*$/.exec(o);if(c&&/<__/.test(c[0]))return null;const d=a.syntaxTree(i).resolveInner(r,-1);if(c&&!l){let e=!1,t=d;for(;t&&!t.type.isTop;){if("FilterExpression"===t.name||"FilterRun"===t.name||"FilterOperator"===t.name||"AttributeFiltered"===t.name||"FilteredTransclusion"===t.name||"FilteredTransclusionBlock"===t.name){e=!0;break}if("AttributeString"===t.name||"AttributeValue"===t.name){let n=t.parent;for(;n&&"Attribute"!==n.name&&!n.type.isTop;)n=n.parent;if(n&&"Attribute"===n.name){const t=n.getChild("AttributeName");if(t){const n=i.sliceDoc(t.from,t.to);if("filter"===n||"$filter"===n||n.endsWith("Filter")||n.endsWith("filter")){e=!0;break}}}}t=t.parent}if(!e)return null}const f=l||c;if(!f)return null;let u=d;for(;u&&!u.type.isTop;){if("FencedCode"===u.name||"CodeBlock"===u.name||"TypedBlock"===u.name||"CommentBlock"===u.name||"KaTeXBlock"===u.name||"LaTeXContent"===u.name)return null;u=u.parent}const h=new Set,p=[],m=i.doc.toString(),g=gs(m),b=ii(m,r);if(b&&b.params.length>0)for(const e of b.params)h.has(e)||(h.add(e),p.push({name:e,detail:"parameter",type:"variable",boost:10}));for(const e of g.macros)h.has(e)||(h.add(e),p.push({name:e,detail:"macro (local)",type:"function"}));for(const e of g.procedures)h.has(e)||(h.add(e),p.push({name:e,detail:"procedure (local)",type:"function"}));for(const e of g.functions)h.has(e)||(h.add(e),p.push({name:e,detail:"function (local)",type:"function"}));const k=function(e,t){const n=a.syntaxTree(e),s=e.doc.toString(),i=[],r=new Set;function o(e,t){let n=e.firstChild;for(;n;){if("Attribute"===n.name){let e=null,i=null,r=n.firstChild;for(;r;)"AttributeName"===r.name?e=r:"AttributeString"!==r.name&&"AttributeValue"!==r.name||(i=r),r=r.nextSibling;if(e&&i&&s.slice(e.from,e.to)===t){let e=s.slice(i.from,i.to);return(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))&&(e=e.slice(1,-1)),e}}n=n.nextSibling}return null}function l(e){const t=[];let n=e.firstChild;for(;n;){if("Attribute"===n.name){let e=n.firstChild;for(;e;)"AttributeName"===e.name&&t.push(s.slice(e.from,e.to)),e=e.nextSibling}n=n.nextSibling}return t}function c(e){let t=e.firstChild;for(;t;){if("WidgetName"===t.name)return s.slice(t.from,t.to);t=t.nextSibling}return null}function d(e){r.has(e)||(r.add(e),i.push(e))}let f=n.resolveInner(t,-1);for(;f&&!f.type.isTop;){if("Widget"===f.name||"InlineWidget"===f.name){const e=c(f);if(e)switch(e){case"$set":{const e=o(f,"name");e&&d(e);break}case"$let":case"$vars":case"$parameters":{const e=l(f);for(const t of e)d(t);break}case"$list":{const e=o(f,"variable");e&&d(e);const t=o(f,"counter");t&&(d(t),d(t+"-first"),d(t+"-last"));break}case"$range":{const e=o(f,"variable");e&&d(e);break}case"$wikify":{const e=o(f,"name");e&&d(e);break}}}f=f.parent}return i}(i,r);for(const e of k)h.has(e)||(h.add(e),p.push({name:e,detail:"variable (scoped)",type:"variable",boost:8}));for(const e of g.builtIns)h.has(e)||(h.add(e),p.push({name:e,detail:"variable (built-in)",type:"keyword"}));const x=function(e,t){const n={variables:[],patterns:[]},s=new Set,i=new Set;let r=e;for(;r;){if("Attribute"===r.name){const e=Ys(r,t);if(e){let a=r.parent;for(;a;){if("Widget"===a.name||"InlineWidget"===a.name){const r=Gs(a,t);if(r){const t=Qs[r];if(t&&t.includes(e)){const e=Us[r];if(e)for(const t of e)t.includes("*")?i.has(t)||(i.add(t),n.patterns.push(t)):s.has(t)||(s.add(t),n.variables.push(t))}}break}a=a.parent}}}r=r.parent}return n}(a.syntaxTree(i).resolveInner(r,-1),m),$=x.variables.length>0||x.patterns.length>0;if($)for(const e of x.variables)h.has(e)||(h.add(e),p.push({name:e,detail:"variable (action)",type:"variable",boost:5}));if(b&&!$){const e=function(e,t,n,s,i){const r={variables:[],patterns:[]},a=new Set,o=new Set;function l(e){let t=e.firstChild;for(;t;){if("WidgetName"===t.name)return n.slice(t.from,t.to);t=t.nextSibling}return null}function c(e){let t=e.firstChild;for(;t;){if("AttributeName"===t.name)return n.slice(t.from,t.to);t=t.nextSibling}return null}function d(e){let t=e;for(;t;){if("Attribute"===t.name){const e=c(t);if(e){let n=t.parent;for(;n;){if("Widget"===n.name||"InlineWidget"===n.name){const t=l(n);if(t){const n=Qs[t];if(n&&n.includes(e)){const e=Us[t];if(e){const t=[],n=[];for(const s of e)s.includes("*")?n.push(s):t.push(s);return{variables:t,patterns:n}}}}break}n=n.parent}}}t=t.parent}return null}const f=new RegExp(`<<\\s*${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(?:\\s|>|$)`,"g");let u;for(;null!==(u=f.exec(n));){const e=u.index;if(e>=s&&e<=i)continue;const n=d(t.resolveInner(e+2,1));if(n){for(const e of n.variables)a.has(e)||(a.add(e),r.variables.push(e));for(const e of n.patterns)o.has(e)||(o.add(e),r.patterns.push(e))}}const h=/<\$transclude\s+[^>]*\$variable\s*=\s*["']([^"']+)["']/gi;for(;null!==(u=h.exec(n));)if(u[1]===e){const e=u.index;if(e>=s&&e<=i)continue;const n=d(t.resolveInner(e+2,1));if(n){for(const e of n.variables)a.has(e)||(a.add(e),r.variables.push(e));for(const e of n.patterns)o.has(e)||(o.add(e),r.patterns.push(e))}}const p=/<\$macrocall\s+[^>]*\$name\s*=\s*["']([^"']+)["']/gi;for(;null!==(u=p.exec(n));)if(u[1]===e){const e=u.index;if(e>=s&&e<=i)continue;const n=d(t.resolveInner(e+2,1));if(n){for(const e of n.variables)a.has(e)||(a.add(e),r.variables.push(e));for(const e of n.patterns)o.has(e)||(o.add(e),r.patterns.push(e))}}return r}(b.name,a.syntaxTree(i).topNode,m,b.from,b.to);for(const t of e.variables)h.has(t)||(h.add(t),p.push({name:t,detail:"variable (action context)",type:"variable",boost:3}));for(const t of e.patterns)x.patterns.includes(t)||x.patterns.push(t)}if(x.patterns.includes("dom-*")){const e=["dom-x","dom-y","dom-clientX","dom-clientY","dom-offsetX","dom-offsetY","dom-pageX","dom-pageY","dom-screenX","dom-screenY","dom-movementX","dom-movementY","dom-width","dom-height","dom-top","dom-left","dom-right","dom-bottom","dom-target","dom-currentTarget","dom-relatedTarget","dom-type","dom-button","dom-buttons","dom-altKey","dom-ctrlKey","dom-metaKey","dom-shiftKey","dom-key","dom-code","dom-touches","dom-targetTouches","dom-changedTouches","dom-deltaX","dom-deltaY","dom-deltaZ","dom-deltaMode","dom-pointerId","dom-pointerType","dom-pressure","dom-tiltX","dom-tiltY","dom-isPrimary","dom-twist","dom-tangentialPressure","dom-dataTransfer-types","dom-dataTransfer-files","dom-dataTransfer-dropEffect","dom-dataTransfer-effectAllowed"];for(const t of e)h.has(t)||(h.add(t),p.push({name:t,detail:"variable (dom)",type:"variable",boost:5}))}x.patterns.includes("event-detail-*")&&(h.has("event-detail-")||(h.add("event-detail-"),p.push({name:"event-detail-",detail:"variable (event detail prefix)",type:"variable",boost:4})));const y=e?e():[],w=y.length>0?y:ti;for(const e of w)h.has(e)||(h.add(e),p.push({name:e,detail:"macro",type:"function"}));const T=t?t():[];for(const e of T)h.has(e)||(h.add(e),p.push({name:e,detail:"function",type:"function"}));const S=n?n():[];for(const e of S)h.has(e)||(h.add(e),p.push({name:e,detail:"variable",type:"variable"}));if(!h.has("condition")&&function(e,t){const n=a.syntaxTree(e).resolveInner(t,-1);let s=n;for(;s&&!s.type.isTop;){if("ConditionalBlock"===s.name)return!0;s=s.parent}for(s=n;s&&!s.type.isTop;){const n=s.parent;if(n){const s=[];let i=n.firstChild;for(;i;){if("Conditional"===i.name){const t=e.sliceDoc(i.from,i.to);let n=null;/<%\s*if\b/.test(t)?n="if":/<%\s*endif\s*%>/.test(t)&&(n="endif"),n&&s.push({type:n,from:i.from,to:i.to})}i=i.nextSibling}if(s.length>=2){s.sort((e,t)=>e.from-t.from);let e=0,n=-1;for(const i of s)if("if"===i.type)0===e&&(n=i.to),e++;else if("endif"===i.type&&(e--,0===e&&-1!==n)){if(t>n&&t<i.from)return!0;n=-1}if(e>0&&-1!==n&&t>n)return!0}}s=n}return!1}(i,r)&&(h.add("condition"),p.push({name:"condition",detail:"conditional result",type:"variable"})),c){const e=f[0].slice(0,f[0].lastIndexOf("<")+1),t=c[0].length,n=p.map(({name:n,detail:s,type:i,boost:r})=>({label:e+n,type:i,detail:s,boost:r,apply:(s,i,r,a)=>{const o=">"===s.state.sliceDoc(a,a+2)[0],l=e+n+(o?"":">"),c=r+e.length+n.length+(o?0:1),d=fs(s,r,a,l,t);s.dispatch({changes:d,selection:{anchor:c}})}}));return{from:r-c[0].length,to:r,options:n,validFor:/^[\[\]}>][\w\-:!]*<[\w\-\.]*$/}}const C=p.map(({name:e,detail:t,type:n,boost:s})=>({label:"<<"+e,type:n,detail:t,boost:s,apply:"<<"+e+">>"}));return{from:r-f[0].length,to:r,options:C,validFor:/^<<[\w\-\.]*$/}}}function si(e){return t=>{const{state:n,pos:s}=t,i=n.sliceDoc(Math.max(0,s-200),s),r=/<<([\w\-\.]+)\s+[^>]*$/.exec(i),o=/<\$macrocall\s+[^>]*\$name=(?:"([^"]+)"|'([^']+)'|<<([^>]+)>>)[^>]*$/.exec(i);let l=null;if(r?l=r[1]:o&&(l=o[1]||o[2]||o[3]),!l)return null;const c=r?i.slice(i.lastIndexOf("<<")):i.slice(i.lastIndexOf("<$macrocall"));let d=!1,f="";for(const e of c)d||'"'!==e&&"'"!==e?d&&e===f&&(d=!1):(d=!0,f=e);if(d)return null;const u=/\s([$\w\-]*)$/.exec(i);if(!u)return null;const h=s-u[1].length;let p=a.syntaxTree(n).resolveInner(s,-1);for(;p&&!p.type.isTop;){if("FencedCode"===p.name||"CodeBlock"===p.name||"TypedBlock"===p.name||"CommentBlock"===p.name||"KaTeXBlock"===p.name||"LaTeXContent"===p.name)return null;p=p.parent}const m=gs(n.doc.toString());let g=null;if(m.definitionParams[l]?g=m.definitionParams[l]:e&&(g=e(l)),!g||0===g.length)return null;const b=g.map(e=>({label:e,type:"property",detail:"parameter",apply:(t,n,s,i)=>{const r=":"===t.state.sliceDoc(i,i+1)?"":":";t.dispatch({changes:{from:s,to:i,insert:e+r},selection:{anchor:s+e.length+1}})}}));return{from:h,to:s,options:b,validFor:/^[$\w\-]*$/}}}function ii(e,t){const n=ms(e);if(t>n)return null;const s=e.slice(0,t),i=/(?:^|[\r\n])[ \t]*\\(define|procedure|function|widget)\s+([^\s(]+)(?:\(([^)]*)\))?/gm;let r,a=null;for(;null!==(r=i.exec(s));){const t=r[1],n=r[2],s=r[3];let i=[];const o=r[0].indexOf("\\"),l=r.index+o;if(void 0!==s&&s.trim())i=s.split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0);else{const t=e.slice(r.index+r[0].length),n=/^\s*\n?\s*\\parameters\s*\(([^)]*)\)/.exec(t);n&&(i=n[1].split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0))}a={name:n,type:t,params:i,startPos:l}}if(!a)return null;const o=e.slice(a.startPos),l=/[\r\n][ \t]*\\end\b/.exec(o),c=/[\r\n][ \t]*\\(define|procedure|function|widget)\s+/.exec(o);let d=n;if(l){const e=l[0].indexOf("\\"),t=a.startPos+l.index+e+4;t<d&&(d=t)}if(c){const e=c[0].indexOf("\\"),t=a.startPos+c.index+e;t<d&&(d=t)}return t<=d?{name:a.name,type:a.type,params:a.params,from:a.startPos,to:d}:null}function ri(){return e=>{const{state:t,pos:n}=e,s=t.sliceDoc(Math.max(0,n-50),n),i=/<<__[\w]*$/.exec(s);let r=null;i||(r=/<__[\w]*$/.exec(s));let o=null;i||r||(o=/\$\([\w]*$/.exec(s));let l=null;i||r||o||(l=/\$[\w]+$/.exec(s));const c=i||r||o||l;if(!c)return null;const d=i?"macroSubst":r?"filterSubst":o?"varsubst":"placeholder";let f=a.syntaxTree(t).resolveInner(n,-1);for(;f&&!f.type.isTop;){if("FencedCode"===f.name||"CodeBlock"===f.name||"TypedBlock"===f.name||"CommentBlock"===f.name||"KaTeXBlock"===f.name||"LaTeXContent"===f.name)return null;f=f.parent}const u=t.doc.toString(),h=ii(u,n);if("varsubst"===d&&(!h||"define"!==h.type))return null;if("placeholder"===d&&(!h||"define"!==h.type))return null;if(!("macroSubst"!==d&&"filterSubst"!==d||h&&0!==h.params.length))return null;let p;if("macroSubst"===d)p=h.params.map(e=>({label:"<<__"+e+"__>>",type:"variable",detail:"parameter",boost:10}));else if("filterSubst"===d)p=h.params.map(e=>({label:"<__"+e+"__>",type:"variable",detail:"parameter",boost:10}));else if("varsubst"===d){p=[];const e=new Set,t=h.name;e.add(t);for(const t of h.params)e.add(t);const n=(e,t,n)=>({label:"$("+e+")$",type:"variable",detail:t,boost:n,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+2);let a=i;")$"===r?a=i+2:")"===r[0]&&(a=i+1),t.dispatch({changes:{from:s,to:a,insert:"$("+e+")$"},selection:{anchor:s+e.length+4}})}}),s=gs(u);for(const t of s.procedures)e.has(t)||(e.add(t),p.push(n(t,"procedure",10)));for(const t of s.functions)e.has(t)||(e.add(t),p.push(n(t,"function",10)));for(const t of s.macros)e.has(t)||(e.add(t),p.push(n(t,"macro",10)));for(const t of cs)e.has(t)||(e.add(t),p.push(n(t,"built-in",5)));const i=function(e,t,n,s){const i=[],r=new Set;function a(e){const n=t.slice(0,e),s=/<\$set\s+[^>]*name\s*=\s*["']([^"']+)["'][^>]*>/gi;let a;for(;null!==(a=s.exec(n));){const e=a[1],t=a.index,s=/<\/\$set\s*>/gi;s.lastIndex=t+a[0].length;let o=!1;for(;null!==s.exec(n);){o=!0;break}o||r.has(e)||(r.add(e),i.push(e))}const o=/<\$let\s+([^>]+)>/gi;for(;null!==(a=o.exec(n));){const e=a[1],t=a.index,s=/<\/\$let\s*>/gi;s.lastIndex=t+a[0].length;let o=!1;for(;null!==s.exec(n);){o=!0;break}if(!o){const t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];r.has(e)||(r.add(e),i.push(e))}}}const l=/<\$vars\s+([^>]+)>/gi;for(;null!==(a=l.exec(n));){const e=a[1],t=a.index,s=/<\/\$vars\s*>/gi;s.lastIndex=t+a[0].length;let o=!1;for(;null!==s.exec(n);){o=!0;break}if(!o){const t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];r.has(e)||(r.add(e),i.push(e))}}}}const o=new RegExp(`<<\\s*${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(?:\\s|>|$)`,"g");let l;for(;null!==(l=o.exec(t));){const e=l.index;e>=n&&e<=s||a(e)}const c=/<\$transclude\s+[^>]*\$variable\s*=\s*["']([^"']+)["']/gi;for(;null!==(l=c.exec(t));)if(l[1]===e){const e=l.index;if(e>=n&&e<=s)continue;a(e)}const d=/<\$macrocall\s+[^>]*\$name\s*=\s*["']([^"']+)["']/gi;for(;null!==(l=d.exec(t));)if(l[1]===e){const e=l.index;if(e>=n&&e<=s)continue;a(e)}return i}(h.name,u,h.from,h.to);for(const t of i)e.has(t)||(e.add(t),p.push(n(t,"inherited",8)))}else{if(!h||0===h.params.length)return null;p=h.params.map(e=>({label:"$"+e+"$",type:"variable",detail:"parameter",boost:10}))}if(0===p.length)return null;const m="macroSubst"===d?/^<<__[\w]*$/:"filterSubst"===d?/^<__[\w]*$/:"varsubst"===d?/^\$\([\w]*$/:/^\$[\w]*$/;return{from:n-c[0].length,to:n,options:p,validFor:m}}}const ai=["classic","pop","zoomin"],oi=["application/javascript","application/json","application/x-tiddler","application/x-tiddler-html-div","application/x-tiddlers","text/css","text/html","text/plain","text/vnd.tiddlywiki"],li=["tm-add-field","tm-add-tag","tm-auto-save-wiki","tm-browser-refresh","tm-cancel-tiddler","tm-clear-password","tm-close-all-tiddlers","tm-close-all-windows","tm-close-other-tiddlers","tm-close-tiddler","tm-close-window","tm-copy-to-clipboard","tm-delete-tiddler","tm-download-file","tm-edit-bitmap-operation","tm-edit-text-operation","tm-edit-tiddler","tm-focus-selector","tm-fold-all-tiddlers","tm-fold-other-tiddlers","tm-fold-tiddler","tm-full-screen","tm-home","tm-http-cancel-all-requests","tm-http-request","tm-import-tiddlers","tm-load-plugin-from-library","tm-load-plugin-library","tm-login","tm-logout","tm-modal","tm-navigate","tm-new-tiddler","tm-notify","tm-open-external-window","tm-open-window","tm-perform-import","tm-permalink","tm-permaview","tm-print","tm-relink-tiddler","tm-remove-field","tm-remove-tag","tm-rename-tiddler","tm-save-tiddler","tm-save-wiki","tm-scroll","tm-server-refresh","tm-set-password","tm-unfold-all-tiddlers","tm-unload-plugin-library"],ci=["div","span","p","a","img","br","hr","table","tr","td","th","ul","ol","li","h1","h2","h3","h4","h5","h6","pre","code","blockquote","form","input","button","select","option","textarea","label","fieldset","legend","section","article","header","footer","nav","aside","main","figure","figcaption","video","audio","source","canvas","svg","iframe","embed","object","strong","em","b","i","u","s","sub","sup","small","mark","del","ins","abbr","cite","details","summary"],di=new Set(["$action-confirm","$action-createtiddler","$action-deletefield","$action-deletetiddler","$action-listops","$action-log","$action-navigate","$action-popup","$action-sendmessage","$action-setfield","$action-setmultiplefields","$browse","$button","$checkbox","$codeblock","$count","$draggable","$droppable","$dropzone","$edit","$edit-bitmap","$edit-text","$element","$encrypt","$eventcatcher","$fieldmangler","$fill","$genesis","$image","$importvariables","$keyboard","$let","$link","$linkcatcher","$list","$log","$macrocall","$messagecatcher","$navigator","$password","$qualify","$radio","$range","$raw","$reveal","$scrollable","$select","$set","$setvariable","$slot","$text","$tiddler","$transclude","$type","$vars","$view","$wikify"]);let fi=null;function ui(e){const t=e.length;let n=0,s=-1;for(;n<t;){const i=e[n];if('"'!==i||'"'!==e[n+1]||'"'!==e[n+2]){if(('"'===i||"'"===i)&&-1!==s){const s=i;for(n++;n<t&&e[n]!==s;)"\\"===e[n]&&n++,n++;n++;continue}if("<"===i&&"<"===e[n+1]){n+=2;let s=1;for(;n<t&&s>0;)"<"===e[n]&&"<"===e[n+1]?(s++,n+=2):">"===e[n]&&">"===e[n+1]?(s--,n+=2):n++;continue}if("{"!==i||"{"!==e[n+1]||"{"!==e[n+2])if("{"!==i||"{"!==e[n+1])if("`"!==i){if("<"===i&&e[n+1]&&/[a-zA-Z$]/.test(e[n+1])){const i=n;for(n++;n<t&&/[a-zA-Z0-9\-_$.]/.test(e[n]);)n++;const r=e[n];if(">"===r){s=-1,n++;continue}if("/"===r&&">"===e[n+1]){s=-1,n+=2;continue}if(r&&(/\s/.test(r)||"="===r)){s=i;continue}continue}">"!==i||-1===s?"/"!==i||">"!==e[n+1]||-1===s?n++:(s=-1,n+=2):(s=-1,n++)}else if("```"===e.slice(n,n+3)){for(n+=3;n<t&&"```"!==e.slice(n,n+3);)n++;n+=3}else{for(n++;n<t&&"`"!==e[n];)n++;n++}else{for(n+=2;n<t&&("}"!==e[n]||"}"!==e[n+1]);)n++;n+=2}else{for(n+=3;n<t&&("}"!==e[n]||"}"!==e[n+1]||"}"!==e[n+2]);)n++;n+=3}}else{for(n+=3;n<t&&('"'!==e[n]||'"'!==e[n+1]||'"'!==e[n+2]);)n++;n+=3}}return s}function hi(e,t,n,s,i,r,o,l,c,d,f,u){return h=>{const{state:p,pos:m}=h,g=p.sliceDoc(Math.max(0,m-200),m),b=/([$a-zA-Z][\w\-\.]*)\s*=\s*(["'])([^"']*)$/.exec(g);if(!b)return null;const k=b[1],x=b[2],$=b[3],y=m-$.length,w=$.length;let T=a.syntaxTree(p).resolveInner(m,-1),S=!1;for(;T&&!T.type.isTop;){if("FencedCode"===T.name||"CodeBlock"===T.name||"TypedBlock"===T.name||"CommentBlock"===T.name||"KaTeXBlock"===T.name||"LaTeXContent"===T.name)return null;"Widget"!==T.name&&"InlineWidget"!==T.name&&"HTMLTag"!==T.name&&"HTMLBlock"!==T.name&&"IncompleteWidget"!==T.name&&"IncompleteHTMLTag"!==T.name&&"IncompleteHTMLBlock"!==T.name||(S=!0),T=T.parent}if(!S)return null;let C=[];if(k.startsWith("style.")){const e=k.slice(6),t=u?u(e):c?c():null;if(t&&t.length>0){const e=$.toLowerCase();C=t.filter(t=>t.toLowerCase().startsWith(e)).map(e=>({label:e,type:"keyword",detail:"CSS value",boost:2,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}}else if("$variable"===k){const t=new Set,i=[],r=gs(p.doc.toString());for(const e of r.macros)t.has(e)||(t.add(e),i.push({name:e,detail:"macro (local)",type:"function"}));for(const e of r.procedures)t.has(e)||(t.add(e),i.push({name:e,detail:"procedure (local)",type:"function"}));for(const e of r.functions)t.has(e)||(t.add(e),i.push({name:e,detail:"function (local)",type:"function"}));for(const e of r.widgetVars)t.has(e)||(t.add(e),i.push({name:e,detail:"variable (local)",type:"variable"}));for(const e of r.builtIns)t.has(e)||(t.add(e),i.push({name:e,detail:"variable (built-in)",type:"keyword"}));const a=e?e():[],o=a.length>0?a:ti;for(const e of o)t.has(e)||(t.add(e),i.push({name:e,detail:"macro",type:"function"}));const l=n?n():[];for(const e of l)t.has(e)||(t.add(e),i.push({name:e,detail:"function",type:"function"}));const c=s?s():[];for(const e of c)t.has(e)||(t.add(e),i.push({name:e,detail:"variable",type:"variable"}));const d=$.toLowerCase();C=i.filter(({name:e})=>e.toLowerCase().startsWith(d)).map(({name:e,detail:t,type:n})=>({label:e,type:n,detail:t,boost:2,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}else if("tiddler"===k||"$tiddler"===k){const e=t?t():[];if(0===e.length)return null;C=e.map(e=>({label:e,type:"variable",detail:"tiddler",boost:us(e,d),sortText:hs(e,d),apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}else if("to"===k||"$to"===k){const e=t?t():[];if(0===e.length)return null;C=e.map(e=>({label:e,type:"variable",detail:"tiddler",boost:us(e,d),sortText:hs(e,d),apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}else if("$message"===k||"message"===k){const e=ui(g),t=["action-confirm","action-sendmessage"],n=["button","browse","linkcatcher"];let s=!1;if(e>=0){const i=/^<\$([a-zA-Z][a-zA-Z0-9\-\.]*)/.exec(g.slice(e));if(i){const e=i[1];("$message"===k&&t.includes(e)||"message"===k&&n.includes(e))&&(s=!0)}}if(s){const e=$.toLowerCase();C=li.filter(t=>t.toLowerCase().startsWith(e)).map(e=>({label:e,type:"keyword",detail:"message",boost:2,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}}else if("$field"===k||"field"===k){const e=i?i():ds,t=$.toLowerCase();C=e.filter(e=>e.toLowerCase().startsWith(t)).map(e=>({label:e,type:"property",detail:"field",boost:2,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}else if("$index"===k||"index"===k){if(r){const e=ui(g),t=e>=0?g.slice(e):g,n=/(?:\$tiddler|tiddler)\s*=\s*(["'])([^"']*)\1/.exec(t);if(n){const e=n[2],t=r(e);if(t.length>0){const e=$.toLowerCase();C=t.filter(t=>t.toLowerCase().startsWith(e)).map(e=>({label:e,type:"property",detail:"index",boost:2,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}}}}else if("storyview"===k){const e=o?o():ai,t=$.toLowerCase();C=e.filter(e=>e.toLowerCase().startsWith(t)).map(e=>({label:e,type:"keyword",detail:"storyview",boost:2,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}else if("deserializer"===k){const e=l?l():oi,t=$.toLowerCase();C=e.filter(e=>e.toLowerCase().startsWith(t)).map(e=>({label:e,type:"keyword",detail:"deserializer",boost:2,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}else if("class"===k){if(f){const e=f();if(e&&e.length>0){const t=$.lastIndexOf(" "),n=t>=0?$.slice(t+1):$,s=y+(t>=0?$.slice(0,t+1):"").length,i=new Set($.split(/\s+/).filter(e=>e)),r=n.toLowerCase();if(C=e.filter(e=>e.toLowerCase().startsWith(r)&&!i.has(e)).map(e=>({label:e,type:"class",detail:"class",boost:2,apply:(t,i,r,a)=>{const o=t.state.sliceDoc(a,a+1)===x,l=e+(o?"":" "),c=fs(t,s,a,l,n.length);t.dispatch({changes:c,selection:{anchor:s+l.length},effects:o?void 0:rs.of(null)})}})),C.length>0)return{from:s,to:m,options:C,validFor:/^[\w\-]*$/}}}}else if("$name"===k){const t=new Set,n=[],s=gs(p.doc.toString());for(const e of s.macros)t.has(e)||(t.add(e),n.push({name:e,detail:"macro (local)"}));for(const e of s.procedures)t.has(e)||(t.add(e),n.push({name:e,detail:"procedure (local)"}));for(const e of s.functions)t.has(e)||(t.add(e),n.push({name:e,detail:"function (local)"}));for(const e of s.widgets)t.has(e)||(t.add(e),n.push({name:e,detail:"widget (local)"}));const i=e?e():ti;for(const e of i)t.has(e)||(t.add(e),n.push({name:e,detail:"macro"}));const r=$.toLowerCase();C=n.filter(({name:e})=>e.toLowerCase().startsWith(r)).map(({name:e,detail:t})=>({label:e,type:"function",detail:t,boost:2,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a=e+(r===x?"":x),o=fs(t,s,i,a,w);t.dispatch({changes:o,selection:{anchor:s+a.length}})}}))}return 0===C.length?null:{from:y,to:m,options:C,validFor:/^[\w\-$:\/. ]*$/}}}const pi=new Set(["emptymessage","template","caption","tooltip","placeholder","default","alt","description","message","content","actions","startactions","endactions","checkactions","uncheckactions","inputactions","src","text"]);function mi(e,t,n,s,i,r,o){const l=ci;return c=>{const{state:d,pos:f}=c,u=d.sliceDoc(Math.max(0,f-500),f);let h=a.syntaxTree(d).resolveInner(f,-1),p=!1;for(;h&&!h.type.isTop;){if("FencedCode"===h.name||"CodeBlock"===h.name||"TypedBlock"===h.name||"CommentBlock"===h.name||"KaTeXBlock"===h.name||"LaTeXContent"===h.name)return null;"Widget"!==h.name&&"InlineWidget"!==h.name&&"HTMLTag"!==h.name&&"HTMLBlock"!==h.name&&"IncompleteWidget"!==h.name&&"IncompleteHTMLTag"!==h.name&&"IncompleteHTMLBlock"!==h.name||(p=!0),h=h.parent}if(!p)return null;const m=function(e){const t=/([$a-zA-Z][\w\-\.]*)\s*=\s*"""([^"]*)$/.exec(e);if(t)return{isWikitext:!0,quoteType:'"""',contentStart:e.length-t[2].length,attrName:t[1]};const n=/([$a-zA-Z][\w\-\.]*)\s*=\s*"([^"]*)$/.exec(e);if(n){const t=n[1].toLowerCase();return{isWikitext:pi.has(t),quoteType:'"',contentStart:e.length-n[2].length,attrName:n[1]}}const s=/([$a-zA-Z][\w\-\.]*)\s*=\s*'([^']*)$/.exec(e);if(s){const t=s[1].toLowerCase();return{isWikitext:pi.has(t),quoteType:"'",contentStart:e.length-s[2].length,attrName:s[1]}}return null}(u);if(!m||!m.isWikitext)return null;const g=u.slice(m.contentStart),b=[],k=function(e,t){const n=e.slice(0,t),s=/(?:^|[\r\n])[ \t]*\\(define|procedure|function|widget)\s+([^\s(]+)(?:\(([^)]*)\))?/gm;let i,r=null;for(;null!==(i=s.exec(n));){const t=i[1],n=i[2],s=i[3];let a=[];const o=i[0].indexOf("\\"),l=i.index+o;if(void 0!==s&&s.trim())a=s.split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0);else{const t=e.slice(i.index+i[0].length),n=/^\s*\n?\s*\\parameters\s*\(([^)]*)\)/.exec(t);n&&(a=n[1].split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0))}r={name:n,type:t,params:a,startPos:l}}if(!r)return null;const a=e.slice(r.startPos),o=/[\r\n][ \t]*\\end\b/.exec(a),l=/[\r\n][ \t]*\\(define|procedure|function|widget)\s+/.exec(a);let c=e.length;if(o){const e=o[0].indexOf("\\"),t=r.startPos+o.index+e+4;t<c&&(c=t)}if(l){const e=l[0].indexOf("\\"),t=r.startPos+l.index+e;t<c&&(c=t)}return t<=c?{name:r.name,type:r.type,params:r.params}:null}(g,g.length),x=function(e){const t=[],n=[],s=[],i=[],r=[],a={},o={},l=/(?:^|[\r\n])[ \t]*\\(define|procedure|function|widget)\s+([^\s(]+)(?:\(([^)]*)\))?/gm;let c;for(;null!==(c=l.exec(e));){const e=c[1],r=c[2],l=c[3];if(!o[r]){switch(o[r]=!0,e){case"function":s.push(r);break;case"procedure":n.push(r);break;case"define":t.push(r);break;case"widget":i.push(r)}if(void 0!==l&&l.trim()){const e=l.split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0);e.length>0&&(a[r]=e)}}}const d=/<\$set\s+[^>]*name\s*=\s*["']([^"']+)["']/gi;for(;null!==(c=d.exec(e));){const e=c[1];o[e]||(o[e]=!0,r.push(e))}const f=/<\$(let|vars)\s+([^>]+)>/gi;for(;null!==(c=f.exec(e));){const e=c[2],t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];o[e]||(o[e]=!0,r.push(e))}}return{macros:t,procedures:n,functions:s,widgets:i,widgetVars:r,definitionParams:a}}(g),$=/<<__[\w]*$/.exec(g);if($&&k&&k.params.length>0){const e=$[0].slice(4),t=f-$[0].length,n=k.params.filter(t=>t.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)b.push({label:`<<__${e}__>>`,type:"variable",detail:"parameter",boost:10});if(b.length>0)return{from:t,to:f,options:b,validFor:/^<<__[\w]*$/}}const y=$?null:/<__[\w]*$/.exec(g);if(y&&k&&k.params.length>0){const e=y[0].slice(3),t=f-y[0].length,n=k.params.filter(t=>t.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)b.push({label:`<__${e}__>`,type:"variable",detail:"parameter",boost:10});if(b.length>0)return{from:t,to:f,options:b,validFor:/^<__[\w]*$/}}const w=$||y?null:/\$\([\w]*$/.exec(g);if(w&&k&&"define"===k.type){const e=w[0].slice(2),n=f-w[0].length,r=new Set;r.add(k.name);for(const e of k.params)r.add(e);const a=[];for(const e of x.procedures)r.has(e)||(r.add(e),a.push({name:e,detail:"procedure"}));for(const e of x.functions)r.has(e)||(r.add(e),a.push({name:e,detail:"function"}));for(const e of x.macros)r.has(e)||(r.add(e),a.push({name:e,detail:"macro"}));for(const e of x.widgetVars)r.has(e)||(r.add(e),a.push({name:e,detail:"variable"}));if(t)for(const e of t())r.has(e)||(r.add(e),a.push({name:e,detail:"macro"}));if(s)for(const e of s())r.has(e)||(r.add(e),a.push({name:e,detail:"function"}));if(i)for(const e of i())r.has(e)||(r.add(e),a.push({name:e,detail:"variable"}));const o=a.filter(t=>t.name.toLowerCase().startsWith(e.toLowerCase()));for(const e of o)b.push({label:`$(${e.name})$`,type:"variable",detail:e.detail,boost:5,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+2);let a=i;")$"===r?a=i+2:")"===r[0]&&(a=i+1),t.dispatch({changes:{from:s,to:a,insert:`$(${e.name})$`},selection:{anchor:s+e.name.length+4}})}});if(b.length>0)return{from:n,to:f,options:b,validFor:/^\$\([\w]*$/}}const T=$||y||w?null:/\$[\w]+$/.exec(g);if(T&&k&&"define"===k.type&&k.params.length>0){const e=T[0].slice(1),t=f-T[0].length,n=k.params.filter(t=>t.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)b.push({label:`$${e}$`,type:"variable",detail:"parameter",boost:10});if(b.length>0)return{from:t,to:f,options:b,validFor:/^\$[\w]+$/}}const S=/<<([\w\-\.]+)\s+[^>]*$/.exec(g);if(S){const e=S[1],t=g.slice(g.lastIndexOf("<<"));let n=!1,s="";for(const e of t)n||'"'!==e&&"'"!==e?n&&e===s&&(n=!1):(n=!0,s=e);if(!n){const t=/\s([$\w\-]*)$/.exec(g);if(t){const n=t[1],s=f-n.length;let i=x.definitionParams[e]||[];if(0===i.length&&o&&(i=o(e)||[]),i.length>0){const e=i.filter(e=>e.toLowerCase().startsWith(n.toLowerCase()));for(const t of e)b.push({label:t,type:"property",detail:"parameter",apply:(e,n,s,i)=>{const r=":"===e.state.sliceDoc(i,i+1)?"":":";e.dispatch({changes:{from:s,to:i,insert:t+r},selection:{anchor:s+t.length+1}})}});if(b.length>0)return{from:s,to:f,options:b,validFor:/^[$\w\-]*$/}}}}}const C=/[\[\]}>][\w\-:!]*<[\w\-\.]*$/.exec(g);if(C&&!g.endsWith("<$")&&!g.endsWith("<<")){const e=C[0].slice(0,C[0].lastIndexOf("<")+1),n=C[0].slice(C[0].lastIndexOf("<")+1),r=f-C[0].length,a=[],o=new Set;if(k&&k.params.length>0)for(const e of k.params)o.has(e)||(o.add(e),a.push({name:e,detail:"parameter",boost:10}));for(const e of x.macros)o.has(e)||(o.add(e),a.push({name:e,detail:"macro",boost:2}));for(const e of x.procedures)o.has(e)||(o.add(e),a.push({name:e,detail:"procedure",boost:2}));for(const e of x.functions)o.has(e)||(o.add(e),a.push({name:e,detail:"function",boost:2}));for(const e of x.widgetVars)o.has(e)||(o.add(e),a.push({name:e,detail:"variable",boost:2}));const l=gs(d.doc.toString());for(const e of l.macros)o.has(e)||(o.add(e),a.push({name:e,detail:"macro",boost:1}));for(const e of l.procedures)o.has(e)||(o.add(e),a.push({name:e,detail:"procedure",boost:1}));for(const e of l.functions)o.has(e)||(o.add(e),a.push({name:e,detail:"function",boost:1}));if(t)for(const e of t())o.has(e)||(o.add(e),a.push({name:e,detail:"macro",boost:0}));if(s)for(const e of s())o.has(e)||(o.add(e),a.push({name:e,detail:"function",boost:0}));if(i)for(const e of i())o.has(e)||(o.add(e),a.push({name:e,detail:"variable",boost:0}));const c=a.filter(e=>e.name.toLowerCase().startsWith(n.toLowerCase()));for(const t of c)b.push({label:e+t.name,type:"parameter"===t.detail?"variable":"function",detail:t.detail,boost:t.boost,apply:(n,s,i,r)=>{const a=">"===n.state.sliceDoc(r,r+1),o=a?"":">",l=e+t.name+o,c=i+e.length+t.name.length+(a?0:1);n.dispatch({changes:{from:i,to:r,insert:l},selection:{anchor:c}})}});if(b.length>0)return{from:r,to:f,options:b,validFor:/^[\[\]}>][\w\-:!]*<[\w\-\.]*$/}}const v=/<\$[\w\-\.]*$/.exec(g);if(v){const e=v[0].slice(2),t=f-v[0].length,s=new Set(di);if(n)for(const e of n())s.add(e);const i=gs(d.doc.toString());for(const e of i.widgets)s.add(e);const r=Array.from(s).filter(t=>(t.startsWith("$")?t.slice(1):t).toLowerCase().startsWith(e.toLowerCase()));for(const e of r){const t=e.startsWith("$")?e.slice(1):e;b.push({label:`<$${t}`,type:"type",detail:"widget",boost:2,apply:(e,n,s,i)=>{const r=`<$${t}></$${t}>`,a=s+t.length+3;e.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:a}})}})}if(b.length>0)return{from:t,to:f,options:b,validFor:/^<\$[\w\-\.]*$/}}const M=/<([a-zA-Z][\w\-]*)$/.exec(g);if(M&&!g.endsWith("<$")&&!g.endsWith("<<")){const e=M[1],t=f-M[0].length,n=l.filter(t=>t.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)b.push({label:`<${e}`,type:"keyword",detail:"html",boost:1,apply:(t,n,s,i)=>{const r=`<${e}></${e}>`,a=s+e.length+2;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:a}})}});if(b.length>0)return{from:t,to:f,options:b,validFor:/^<[a-zA-Z][\w\-]*$/}}const L=/<<[\w\-]*$/.exec(g);if(L){const e=L[0].slice(2),n=f-L[0].length;if(k&&k.params.length>0){const t=k.params.filter(t=>t.toLowerCase().startsWith(e.toLowerCase()));for(const e of t)b.push({label:`<<${e}`,type:"variable",detail:"parameter",boost:10,apply:(t,n,s,i)=>{const r=`<<${e}>>`;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length-2}})}})}const r=new Set((fi||(fi=new Set(ti)),fi)),a=gs(d.doc.toString());for(const e of a.macros)r.add(e);for(const e of a.procedures)r.add(e);for(const e of a.functions)r.add(e);for(const e of x.macros)r.add(e);for(const e of x.procedures)r.add(e);for(const e of x.functions)r.add(e);for(const e of x.widgetVars)r.add(e);if(t)for(const e of t())r.add(e);if(s)for(const e of s())r.add(e);if(i)for(const e of i())r.add(e);const o=Array.from(r).filter(t=>t.toLowerCase().startsWith(e.toLowerCase()));for(const e of o)b.push({label:`<<${e}`,type:"function",detail:"macro",boost:2,apply:(t,n,s,i)=>{const r=`<<${e}>>`,a=s+r.length-2;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:a}})}});if(b.length>0)return{from:n,to:f,options:b,validFor:/^<<[\w\-]*$/}}const P=/\[\[[^\]|]*$/.exec(g);if(P){const t=P[0].slice(2),n=f-P[0].length,s=(e?e():[]).filter(e=>e.toLowerCase().startsWith(t.toLowerCase()));for(const e of s)b.push({label:`[[${e}`,type:"variable",detail:"tiddler",boost:us(e,r),sortText:hs(e,r),apply:(t,n,s,i)=>{const r=`[[${e}]]`;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length}})}});if(b.length>0)return{from:n,to:f,options:b,validFor:/^\[\[[^\]|]*$/}}const A=/(?<!\{)\{\{[^{}|]*$/.exec(g);if(A&&!g.endsWith("{{{")){const t=A[0].slice(2),n=f-A[0].length,s=(e?e():[]).filter(e=>e.toLowerCase().startsWith(t.toLowerCase()));for(const e of s)b.push({label:`{{${e}`,type:"variable",detail:"transclusion",boost:us(e,r),sortText:hs(e,r),apply:(t,n,s,i)=>{const r=`{{${e}}}`;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length}})}});if(b.length>0)return{from:n,to:f,options:b,validFor:/^(?<!\{)\{\{[^{}|]*$/}}const E=/<%[\w]*$/.exec(g);if(E){const e=E[0].slice(2),t=f-E[0].length,n=["if","elseif","else","endif"].filter(t=>t.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)"if"===e||"elseif"===e?b.push({label:`<%${e}`,type:"keyword",detail:"conditional",boost:2,apply:(t,n,s,i)=>{const r=`<%${e} %>`,a=s+e.length+3;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:a}})}}):b.push({label:`<%${e}`,type:"keyword",detail:"conditional",boost:2,apply:(t,n,s,i)=>{const r=`<%${e}%>`;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length}})}});if(b.length>0)return{from:t,to:f,options:b,validFor:/^<%[\w]*$/}}const B=/(?:^|[\r\n])[ \t]*\\(\w*)$/.exec(g);if(B){const e=B[1],t=f-e.length,n=[{label:"define",detail:"Define a macro"},{label:"procedure",detail:"Define a procedure"},{label:"function",detail:"Define a function"},{label:"widget",detail:"Define a widget"},{label:"import",detail:"Import tiddlers"},{label:"rules",detail:"Set parser rules"},{label:"parameters",detail:"Declare parameters"},{label:"whitespace",detail:"Whitespace handling"},{label:"parsermode",detail:"Set parser mode"},{label:"end",detail:"End a definition"}].filter(t=>t.label.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)b.push({label:e.label,type:"keyword",detail:e.detail,boost:2,apply:(t,n,s,i)=>{const r="end"===e.label?e.label:e.label+" ";t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length}})}});if(b.length>0)return{from:t,to:f,options:b,validFor:/^\w*$/}}const I=/(?:^|[\r\n])[ \t]*\\rules\s+(\w*)$/.exec(g);if(I){const e=I[1],t=f-e.length,n=[{label:"only",detail:"Only enable specified rules"},{label:"except",detail:"Disable specified rules"}].filter(t=>t.label.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)b.push({label:e.label,type:"keyword",detail:e.detail,boost:2});if(b.length>0)return{from:t,to:f,options:b,validFor:/^\w*$/}}const W=/(?:^|[\r\n])[ \t]*\\whitespace\s+(\w*)$/.exec(g);if(W){const e=W[1],t=f-e.length,n=[{label:"trim",detail:"Remove leading/trailing whitespace"},{label:"notrim",detail:"Preserve whitespace"}].filter(t=>t.label.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)b.push({label:e.label,type:"keyword",detail:e.detail,boost:2});if(b.length>0)return{from:t,to:f,options:b,validFor:/^\w*$/}}const D=/(?:^|[\r\n])[ \t]*\\parsermode\s+(\w*)$/.exec(g);if(D){const e=D[1],t=f-e.length,n=[{label:"block",detail:"Parse as block content"},{label:"inline",detail:"Parse as inline content"}].filter(t=>t.label.toLowerCase().startsWith(e.toLowerCase()));for(const e of n)b.push({label:e.label,type:"keyword",detail:e.detail,boost:2});if(b.length>0)return{from:t,to:f,options:b,validFor:/^\w*$/}}if(c.explicit){const e=f;return b.push({label:"<$",type:"type",detail:"widget",boost:5,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"<$"},selection:{anchor:n+2},effects:rs.of(null)})}}),b.push({label:"<<",type:"function",detail:"macro",boost:4,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"<<"},selection:{anchor:n+2},effects:rs.of(null)})}}),b.push({label:"[[",type:"variable",detail:"link",boost:3,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"[["},selection:{anchor:n+2},effects:rs.of(null)})}}),b.push({label:"{{",type:"variable",detail:"transclusion",boost:2,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"{{"},selection:{anchor:n+2},effects:rs.of(null)})}}),b.push({label:"{{{",type:"variable",detail:"filtered transclusion",boost:1,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"{{{"},selection:{anchor:n+3},effects:rs.of(null)})}}),b.push({label:"<%if",type:"keyword",detail:"conditional",boost:1,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"<%if %>"},selection:{anchor:n+5}})}}),b.push({label:"\\procedure",type:"keyword",detail:"pragma",boost:1,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"\\procedure "},selection:{anchor:n+11}})}}),b.push({label:"\\function",type:"keyword",detail:"pragma",boost:1,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"\\function "},selection:{anchor:n+10}})}}),b.push({label:"\\define",type:"keyword",detail:"pragma",boost:1,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"\\define "},selection:{anchor:n+8}})}}),b.push({label:"\\widget",type:"keyword",detail:"pragma",boost:1,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"\\widget "},selection:{anchor:n+8}})}}),{from:e,to:f,options:b,validFor:/^$/}}return null}}const gi=["html","head","body","title","base","div","span","p","br","hr","h1","h2","h3","h4","h5","h6","a","strong","em","b","i","u","s","small","mark","del","ins","sub","sup","abbr","cite","q","blockquote","code","pre","kbd","samp","var","dfn","ul","ol","li","dl","dt","dd","menu","table","tr","td","th","thead","tbody","tfoot","caption","colgroup","col","form","input","button","select","option","optgroup","textarea","label","fieldset","legend","datalist","output","progress","meter","details","summary","dialog","img","video","audio","source","track","picture","iframe","embed","object","param","canvas","svg","figure","figcaption","map","area","header","footer","nav","main","section","article","aside","address","time","data","template","slot","script","style","link","meta","noscript","ruby","rt","rp","bdi","bdo","wbr","center"],bi=["class","id","style","title","lang","dir","hidden","tabindex","accesskey","contenteditable","draggable","spellcheck","translate","data-","aria-","role"],ki={a:["href","target","rel","download","hreflang","type"],img:["src","alt","width","height","loading","srcset","sizes","usemap"],input:["type","name","value","placeholder","required","disabled","readonly","checked","maxlength","minlength","pattern","min","max","step","list","form","autocomplete"],button:["type","disabled","name","value","form"],form:["action","method","enctype","target","autocomplete","novalidate","accept-charset"],label:["for"],select:["name","multiple","required","disabled","size","form","autocomplete"],option:["value","selected","disabled","label"],optgroup:["label","disabled"],textarea:["name","rows","cols","placeholder","required","disabled","readonly","maxlength","minlength","wrap","form","autocomplete"],fieldset:["disabled","form","name"],datalist:[],output:["for","form","name"],progress:["value","max"],meter:["value","min","max","low","high","optimum"],link:["href","rel","type","media","sizes","crossorigin","integrity"],script:["src","type","async","defer","crossorigin","integrity","nomodule"],meta:["name","content","charset","http-equiv"],base:["href","target"],style:["media","type"],iframe:["src","width","height","frameborder","allowfullscreen","sandbox","srcdoc","loading","allow","name"],video:["src","width","height","controls","autoplay","loop","muted","poster","preload","crossorigin","playsinline"],audio:["src","controls","autoplay","loop","muted","preload","crossorigin"],source:["src","type","media","srcset","sizes"],track:["src","kind","srclang","label","default"],picture:[],embed:["src","type","width","height"],object:["data","type","width","height","name","usemap","form"],param:["name","value"],canvas:["width","height"],table:["border","cellpadding","cellspacing"],td:["colspan","rowspan","headers"],th:["colspan","rowspan","headers","scope","abbr"],col:["span"],colgroup:["span"],map:["name"],area:["href","alt","shape","coords","target","download","rel"],details:["open"],dialog:["open"],time:["datetime"],data:["value"],abbr:["title"],q:["cite"],blockquote:["cite"],del:["cite","datetime"],ins:["cite","datetime"],bdo:["dir"],div:[],span:[],p:[]},xi={};function $i(e){const{state:t,pos:n}=e,s=/<[:\-\.\w\u00b7-\uffff!]*$/.exec(t.sliceDoc(n-25,n));if(!s)return null;if(s[0].startsWith("<$"))return null;let i=a.syntaxTree(t).resolveInner(n,-1);for(;i&&!i.type.isTop;){if("FencedCode"===i.name||"CodeBlock"===i.name||"TypedBlock"===i.name||"CommentBlock"===i.name||"KaTeXBlock"===i.name||"LaTeXContent"===i.name)return null;if("AttributeValue"===i.name||"AttributeString"===i.name)return null;i=i.parent}const r=s[0].length,o=[];("<!"===s[0]||"<"===s[0])&&o.push({label:"\x3c!--",displayLabel:"\x3c!-- comment --\x3e",type:"keyword",detail:"comment",boost:"<!"===s[0]?10:0,apply:(e,t,n,s)=>{const i=n+5,a=n+12,o=fs(e,n,s,"\x3c!-- comment --\x3e",r);e.dispatch({changes:o,selection:{anchor:i,head:a}})}});for(const e of gi){const t=os.has(e);o.push({label:"<"+e,type:"type",detail:t?"self-closing":"tag",apply:(n,s,i,a)=>{const o="<"+e,l=">"===n.state.sliceDoc(a,a+1)?a+1:a;let c,d;if(t)c=o+">",d=c.length;else{c=o+" >"+("</"+e+">"),d=o.length+1}const f=fs(n,i,l,c,r);n.dispatch({changes:f,selection:{anchor:i+d},effects:t?void 0:rs.of(null)})}})}return{from:n-s[0].length,to:n,options:o,validFor:/^<[:\-\.\w\u00b7-\uffff!]*$/}}function yi(e){return t=>{const{state:n,pos:s}=t,i=n.sliceDoc(Math.max(0,s-500),s),r=function(e){const t=e.length;let n=0,s=-1,i="";for(;n<t;){const r=e[n];if('"'!==r||'"'!==e[n+1]||'"'!==e[n+2]){if(('"'===r||"'"===r)&&-1!==s){const s=r;for(n++;n<t&&e[n]!==s;)"\\"===e[n]&&n++,n++;n++;continue}if("<"===r&&"<"===e[n+1]){n+=2;let s=1;for(;n<t&&s>0;)"<"===e[n]&&"<"===e[n+1]?(s++,n+=2):">"===e[n]&&">"===e[n+1]?(s--,n+=2):n++;continue}if("{"!==r||"{"!==e[n+1]||"{"!==e[n+2])if("{"!==r||"{"!==e[n+1])if("`"!==r){if("<"===r&&e[n+1]&&/[a-zA-Z]/.test(e[n+1])&&"$"!==e[n+1]){const r=n;n++;let a="";for(;n<t&&/[a-zA-Z0-9]/.test(e[n]);)a+=e[n],n++;if(a){const t=e[n];if(">"===t){s=-1,i="",n++;continue}if("/"===t&&">"===e[n+1]){s=-1,i="",n+=2;continue}if(t&&(/\s/.test(t)||"="===t)){s=r,i=a;continue}continue}continue}">"!==r||-1===s?"/"!==r||">"!==e[n+1]||-1===s?n++:(s=-1,i="",n+=2):(s=-1,i="",n++)}else if("```"===e.slice(n,n+3)){for(n+=3;n<t&&"```"!==e.slice(n,n+3);)n++;n+=3}else{for(n++;n<t&&"`"!==e[n];)n++;n++}else{for(n+=2;n<t&&("}"!==e[n]||"}"!==e[n+1]);)n++;n+=2}else{for(n+=3;n<t&&("}"!==e[n]||"}"!==e[n+1]||"}"!==e[n+2]);)n++;n+=3}}else{for(n+=3;n<t&&('"'!==e[n]||'"'!==e[n+1]||'"'!==e[n+2]);)n++;n+=3}}return-1!==s&&i?{name:i,start:s}:null}(i);if(!r)return null;const o=r.name,l=i.slice(r.start);let c=!1,d="",f=0,u=0;for(let e=0;e<l.length;e++){const t=l[e];c?t===d&&(c=!1):'"'===t||"'"===t?(c=!0,d=t):"{"===t&&"{"===l[e+1]&&"{"===l[e+2]?(f++,e+=2):"}"===t&&"}"===l[e+1]&&"}"===l[e+2]?(f--,e+=2):"<"===t&&"<"===l[e+1]?(u++,e+=1):">"===t&&">"===l[e+1]&&(u--,e+=1)}if(c||f>0||u>0)return null;const h=/\s([a-zA-Z][a-zA-Z0-9\-\.]*)?$/.exec(i);if(!h)return null;const p=h[1]||"",m=s-p.length;let g=a.syntaxTree(n).resolveInner(s,-1);for(;g&&!g.type.isTop;){if("FencedCode"===g.name||"CodeBlock"===g.name||"TypedBlock"===g.name||"CommentBlock"===g.name||"KaTeXBlock"===g.name||"LaTeXContent"===g.name)return null;g=g.parent}if(p.startsWith("style.")&&e){const t=e();if(!t||0===t.length)return null;const n=p.slice(6).toLowerCase(),i=t.filter(e=>e.toLowerCase().startsWith(n));if(0===i.length)return null;const r=i.map(e=>({label:"style."+e,type:"property",detail:"CSS property",apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+2),a="="===r[0];let o,l,c=i;const d="style."+e;'="'===r?(o=d,c=i+2,l=s+d.length+2):a?(o=d+'="',c=i+1,l=s+d.length+2):(o=d+'=""',l=s+d.length+2);const f=fs(t,s,c,o,p.length);t.dispatch({changes:f,selection:{anchor:l},effects:rs.of(null)})}}));return{from:m,to:s,options:r,validFor:/^style\.[a-zA-Z\-]*$/}}const b=function(e){if(!xi[e]){const t=ki[e]||[];xi[e]=[...new Set([...t,...bi])]}return xi[e]}(o),k=p.length,x=b.map(e=>({label:e,type:"property",apply:(t,n,s,i)=>{if(e.endsWith("-")){const n=fs(t,s,i,e,k);return void t.dispatch({changes:n,selection:{anchor:s+e.length}})}const r=t.state.sliceDoc(i,i+2),a="="===r[0];let o,l,c=i;'="'===r?(o=e,c=i+2,l=s+e.length+2):a?(o=e+'="',c=i+1,l=s+e.length+2):(o=e+'=""',l=s+e.length+2);const d=fs(t,s,c,o,k);t.dispatch({changes:d,selection:{anchor:l}})}}));return{from:m,to:s,options:x,validFor:/^[a-zA-Z][a-zA-Z0-9\-\.]*$/}}}const wi=new Set(["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","contextmenu","keydown","keyup","keypress","focus","blur","focusin","focusout","input","change","submit","reset","invalid","dragstart","drag","dragend","dragenter","dragleave","dragover","drop","touchstart","touchmove","touchend","touchcancel","pointerdown","pointerup","pointermove","pointerenter","pointerleave","pointerover","pointerout","pointercancel","wheel","scroll","copy","cut","paste","load","error","resize","select"]);let Ti=null;function Si(e,t){if(ls.has(e))return!0;if(t){const n=t();for(const t of n)if(t===e)return!0}return!1}const Ci=["$action-confirm","$action-createtiddler","$action-deletefield","$action-deletetiddler","$action-listops","$action-log","$action-navigate","$action-popup","$action-sendmessage","$action-setfield","$action-setmultiplefields","$browse","$button","$checkbox","$codeblock","$count","$draggable","$droppable","$dropzone","$edit","$edit-bitmap","$edit-text","$element","$encrypt","$eventcatcher","$fieldmangler","$fill","$genesis","$image","$importvariables","$keyboard","$let","$link","$linkcatcher","$list","$log","$macrocall","$messagecatcher","$navigator","$password","$qualify","$radio","$range","$raw","$reveal","$scrollable","$select","$set","$setvariable","$slot","$text","$tiddler","$transclude","$type","$vars","$view","$wikify"],vi={"$action-confirm":["$message","$prompt"],"$action-createtiddler":["$basetitle","$savetitle","$saveoriginal","$template","$overwrite","$timestamp"],"$action-deletefield":["$tiddler","$field"],"$action-deletetiddler":["$tiddler","$filter"],"$action-listops":["$tiddler","$field","$index","$filter","$subfilter","$tags"],"$action-log":["$$filter","$$message","$$all"],"$action-navigate":["$to","$scroll"],"$action-popup":["$state","$coords","$floating","$absolute"],"$action-sendmessage":["$message","$param","$name","$value"],"$action-setfield":["$tiddler","$field","$index","$value","$timestamp"],"$action-setmultiplefields":["$tiddler","$fields","$values","$indexes"],$browse:["multiple","accept","message","param","tooltip","deserializer","class"],$button:["message","param","set","setTo","actions","to","tooltip","aria-label","popup","popupAbsolute","hoverpopup","selectedClass","default","disabled","tag","dragTiddler","dragFilter","class","style"],$checkbox:["tiddler","field","index","tag","invertTag","checked","unchecked","default","indeterminate","disabled","actions","uncheckactions","checkactions","class"],$codeblock:["code","language","class"],$count:["filter"],$draggable:["tiddler","filter","tag","enable","startactions","endactions","class"],$droppable:["actions","effect","tag","enable","disabledClass","class"],$dropzone:["deserializer","enable","autoOpenOnImport","importTitle","actions","contentTypesFilter","filesOnly","class"],$edit:["tiddler","field","index","default","placeholder","tabindex","focus","cancelPopups","inputActions","refreshTitle","autocomplete","class"],"$edit-bitmap":["tiddler","class"],"$edit-text":["tiddler","field","index","default","tag","type","placeholder","focusPopup","focus","tabindex","autocomplete","cancelPopups","inputActions","refreshTitle","disabled","fileDrop","rows","minHeight","size","class"],$element:["tag","attributes"],$encrypt:["filter"],$eventcatcher:["selector","matchSelector","stopPropagation","tag","class","events"],$fieldmangler:["tiddler"],$fill:["$name"],$genesis:["$type","$tag","$names","$values","$mode"],$image:["source","width","height","tooltip","alt","loading","usemap","class"],$importvariables:["filter"],$keyboard:["key","actions","tag","class"],$let:[],$link:["to","tooltip","aria-label","tabindex","draggable","tag","overrideClass","class"],$linkcatcher:["to","message","set","setTo","actions"],$list:["filter","variable","counter","emptyMessage","storyview","history","template","editTemplate","join"],$log:["$$filter","$$message","$$all"],$macrocall:["$name","$type","$output"],$messagecatcher:["type","actions"],$navigator:["story","history","openLinkFromInsideRiver","openLinkFromOutsideRiver","relinkOnRename"],$password:["name","class"],$qualify:["name"],$radio:["tiddler","field","index","value","default","disabled","actions","class"],$range:["tiddler","field","index","min","max","increment","default","disabled","actions","actionsStart","actionsStop","class"],$raw:[],$reveal:["type","text","state","tag","retain","default","popup","popupAbsolute","animate","stateTitle","stateIndex","stateField","class","style"],$scrollable:["tag","fallthrough","class"],$select:["tiddler","field","index","default","multiple","size","actions","class"],$set:["name","value","filter","select","tiddler","field","index","emptyValue"],$setvariable:["name","value","filter","select","tiddler","field","index","emptyValue"],$slot:["$name","$depth"],$text:["text"],$tiddler:["tiddler"],$transclude:["$tiddler","$field","$index","$subtiddler","$mode","$type","$output","$recursionMarker","$variable","$fillignore"],$type:["type","text","tiddler","field","index","mode"],$vars:[],$view:["tiddler","field","index","format","template","subtiddler","mode"],$wikify:["name","text","type","mode","output"]};function Mi(e,t){return n=>{const{state:s,pos:i}=n,r=/<\$[\w\-\.]*$/.exec(s.sliceDoc(i-50,i));if(!r)return null;let o=a.syntaxTree(s).resolveInner(i,-1);for(;o&&!o.type.isTop;){if("FencedCode"===o.name||"CodeBlock"===o.name||"TypedBlock"===o.name||"CommentBlock"===o.name||"KaTeXBlock"===o.name||"LaTeXContent"===o.name)return null;o=o.parent}const l=new Set,c=[],d=gs(s.doc.toString());for(const e of d.widgets)l.has(e)||(l.add(e),c.push({name:e,detail:"widget (local)"}));const f=e?e():[],u=f.length>0?f:Ci;for(const e of u)if(!l.has(e)){l.add(e);const n=Si(e,t);c.push({name:e,detail:n?"action":"widget"})}const h=r[0].length,p=c.map(({name:e,detail:n})=>{const s=Si(e,t);return{label:"<"+e,type:"keyword",detail:n,apply:(t,n,i,r)=>{const a="<"+e,o=t.state.sliceDoc(r,r+1);let l,c;if(s)l=a+" />",c=a.length+1;else{l=a+" >"+("</"+e+">"),c=a.length+1}const d=fs(t,i,">"===o?r+1:r,l,h);t.dispatch({changes:d,selection:{anchor:i+c},effects:rs.of(null)})}}});return{from:i-r[0].length,to:i,options:p,validFor:/^<\$[\w\-\.]*$/}}}function Li(e,t,n){return s=>{const{state:i,pos:r}=s,o=i.sliceDoc(Math.max(0,r-500),r),l=function(e){let t=-1,n="";const s=/<\$([a-zA-Z][a-zA-Z0-9\-\.]*)/g;let i;for(;null!==(i=s.exec(e));)t=i.index,n=i[1];if(-1===t)return null;const r=e.slice(t+2+n.length);let a=0;const o=r.length;for(;a<o;){const e=r[a];if(">"===e)return null;if("/"===e&&">"===r[a+1])return null;if('"'!==e||'"'!==r[a+1]||'"'!==r[a+2]){if('"'===e||"'"===e){const t=e;for(a++;a<o&&r[a]!==t;)"\\"===r[a]&&a++,a++;a++;continue}if("<"===e&&"<"===r[a+1]){a+=2;let e=1;for(;a<o&&e>0;)"<"===r[a]&&"<"===r[a+1]?(e++,a+=2):">"===r[a]&&">"===r[a+1]?(e--,a+=2):a++;continue}if("{"!==e||"{"!==r[a+1]||"{"!==r[a+2])if("{"!==e||"{"!==r[a+1])if("`"!==e){if("<"===e){const e=r[a+1];if("/"===e)return{name:"$"+n,start:t};if(e&&/[a-zA-Z$]/.test(e)){let e=a+2;for(;e<o&&/[a-zA-Z0-9\-_$.]/.test(r[e]);)e++;const s=r[e];if(">"===s){a=e+1;continue}if("/"===s&&">"===r[e+1])return{name:"$"+n,start:t};if(s&&(/\s/.test(s)||"="===s))return{name:"$"+n,start:t};a=e;continue}a++;continue}a++}else if("```"===r.slice(a,a+3)){for(a+=3;a<o&&"```"!==r.slice(a,a+3);)a++;a+=3}else{for(a++;a<o&&"`"!==r[a];)a++;a++}else{for(a+=2;a<o&&("}"!==r[a]||"}"!==r[a+1]);)a++;a+=2}else{for(a+=3;a<o&&("}"!==r[a]||"}"!==r[a+1]||"}"!==r[a+2]);)a++;a+=3}}else{for(a+=3;a<o&&('"'!==r[a]||'"'!==r[a+1]||'"'!==r[a+2]);)a++;a+=3}}return{name:"$"+n,start:t}}(o);if(!l)return null;const c=l.name,d=o.slice(l.start);let f=!1,u="",h=0,p=0;for(let e=0;e<d.length;e++){const t=d[e];f?t===u&&(f=!1):'"'===t||"'"===t?(f=!0,u=t):"{"===t&&"{"===d[e+1]&&"{"===d[e+2]?(h++,e+=2):"}"===t&&"}"===d[e+1]&&"}"===d[e+2]?(h--,e+=2):"<"===t&&"<"===d[e+1]?(p++,e+=1):">"===t&&">"===d[e+1]&&(p--,e+=1)}if(f||h>0||p>0)return null;const m=/\s([$a-zA-Z][a-zA-Z0-9\-\.]*)?$/.exec(o);if(!m)return null;const g=m[1]||"",b=r-g.length;let k=a.syntaxTree(i).resolveInner(r,-1);for(;k&&!k.type.isTop;){if("FencedCode"===k.name||"CodeBlock"===k.name||"TypedBlock"===k.name||"CommentBlock"===k.name||"KaTeXBlock"===k.name||"LaTeXContent"===k.name)return null;k=k.parent}if(g.startsWith("style.")&&n){const e=t?t(c):null;if(!(null!==e?e:vi[c]||[]).includes("style"))return null;const s=n();if(!s||0===s.length)return null;const i=g.slice(6).toLowerCase(),a=s.filter(e=>e.toLowerCase().startsWith(i));if(0===a.length)return null;const o=a.map(e=>({label:"style."+e,type:"property",detail:"CSS property",apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+2),a="="===r[0];let o,l,c=i;const d="style."+e;'="'===r?(o=d,c=i+2,l=s+d.length+2):a?(o=d+'="',c=i+1,l=s+d.length+2):(o=d+'=""',l=s+d.length+2);const f=fs(t,s,c,o,g.length);t.dispatch({changes:f,selection:{anchor:l},effects:rs.of(null)})}}));return{from:b,to:r,options:o,validFor:/^style\.[a-zA-Z\-]*$/}}const x=gs(i.doc.toString()).definitionParams[c];let $;if(x&&x.length>0)$=[...x];else{const e=t?t(c):null,n=vi[c]||[];$=null!==e?[...e]:[...n]}if("$macrocall"===c||"$transclude"===c){const t=new RegExp(("$macrocall"===c?"\\$name":"\\$variable")+"\\s*=\\s*(?:\"([^\"]+)\"|'([^']+)'|<<([^>]+)>>)").exec(d);if(t){const n=t[1]||t[2]||t[3];if(n){const t=gs(i.doc.toString());let s=null;if(t.definitionParams[n]?s=t.definitionParams[n]:e&&(s=e(n)),s&&s.length>0){const e=new Set($);for(const t of s)e.has(t)||$.push(t)}}}}if("$messagecatcher"===c){const e=new Set($),t=(Ti||(Ti=new Set(li)),Ti);for(const n of t){const t="$"+n;e.has(t)||$.push(t)}}if("$eventcatcher"===c){const e=new Set($);for(const t of wi){const n="$"+t;e.has(n)||$.push(n)}}const y=g.length,w=$.map(e=>({label:e,type:"property",detail:e.startsWith("$")?"widget attr":"parameter",apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+2),a="="===r[0];let o,l,c=i;'="'===r?(o=e,c=i+2,l=s+e.length+2):a?(o=e+'="',c=i+1,l=s+e.length+2):(o=e+'=""',l=s+e.length+2);const d=fs(t,s,c,o,y);t.dispatch({changes:d,selection:{anchor:l},effects:rs.of(null)})}}));return{from:b,to:r,options:w,validFor:/^[$a-zA-Z][a-zA-Z0-9\-\.]*$/}}}function Pi(e){return t=>{const{state:n,pos:s}=t,i=n.sliceDoc(Math.max(0,s-50),s),r=/<\/\$[\w\-\.]*$/.exec(i),o=/<\/[\w\-\.]*$/.exec(i);if(!r&&!o)return null;const l=!!r,c=r||o,d=a.syntaxTree(n).resolveInner(s,-1);let f=d;for(;f&&!f.type.isTop;){if("FencedCode"===f.name||"CodeBlock"===f.name||"TypedBlock"===f.name||"CommentBlock"===f.name||"KaTeXBlock"===f.name||"LaTeXContent"===f.name)return null;f=f.parent}let u=null;for(f=d;f&&!f.type.isTop;){if("Widget"===f.name||"InlineWidget"===f.name){let e=f.firstChild;for(;e;){if("WidgetName"===e.name){const t=n.sliceDoc(e.from,e.to),s=n.sliceDoc(f.from,f.to);new RegExp(`</${t.replace(/\$/g,"\\$")}\\s*>`).test(s)||(u=t);break}e=e.nextSibling}if(u)break}else if(!l&&("HtmlElement"===f.name||"InlineHtml"===f.name)){let e=f.firstChild;for(;e;){if("TagName"===e.name){const t=n.sliceDoc(e.from,e.to),s=n.sliceDoc(f.from,f.to);new RegExp(`</${t}\\s*>`).test(s)||(u=t);break}e=e.nextSibling}if(u)break}f=f.parent}const h=[],p=new Set;if(u&&(p.add(u),h.push({label:"</"+u+">",type:"keyword",detail:"close tag",boost:100,apply:(e,t,n,s)=>{const i=e.state.sliceDoc(s,s+1),r="</"+u+(">"===i?"":">");e.dispatch({changes:{from:n,to:s,insert:r},selection:{anchor:n+r.length}})}})),l){const t=gs(n.doc.toString()),s=new Set;if(e)for(const t of e())s.add(t);for(const e of Ci)s.add(e);for(const e of t.widgets)s.add("$"+e);for(const e of s)p.has(e)||(p.add(e),h.push({label:"</"+e+">",type:"type",detail:"widget",apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a="</"+e+(">"===r?"":">");t.dispatch({changes:{from:s,to:i,insert:a},selection:{anchor:s+a.length}})}}))}else{const t=gs(n.doc.toString()),s=new Set;if(e)for(const t of e())s.add(t);for(const e of Ci)s.add(e);for(const e of t.widgets)s.add("$"+e);for(const e of s)p.has(e)||(p.add(e),h.push({label:"</"+e+">",type:"type",detail:"widget",apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a="</"+e+(">"===r?"":">");t.dispatch({changes:{from:s,to:i,insert:a},selection:{anchor:s+a.length}})}}));for(const e of gi)p.has(e)||(p.add(e),h.push({label:"</"+e+">",type:"keyword",detail:"html",apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+1),a="</"+e+(">"===r?"":">");t.dispatch({changes:{from:s,to:i,insert:a},selection:{anchor:s+a.length}})}}))}return 0===h.length?null:{from:s-c[0].length,to:s,options:h,validFor:/^<\/\$?[\w\-\.]*$/}}}const Ai=["all","title","field","tag","has","is","indexes","fields","tags","links","backlinks","list","listed","tagging","untagged","prefix","suffix","contains","match","regexp","search","trim","lowercase","uppercase","titlecase","sentencecase","splitbefore","split","join","stringify","compare","minlength","maxlength","first","last","nth","limit","rest","butlast","range","sort","nsort","sortby","nsortby","reverse","count","unique","duplicates","allafter","allbefore","after","before","prepend","append","insertbefore","move","putafter","putbefore","putfirst","putlast","remove","replace","toggle","cycle","add","subtract","multiply","divide","negate","abs","ceil","floor","round","trunc","sign","min","max","average","sum","product","log","power","sqrt","exp","fixed","precision","remainder","random","sin","cos","tan","asin","acos","atan","atan2","now","format","days","weeks","months","years","hours","minutes","seconds","milliseconds","adddays","subtractdays","year","month","day","hour","minute","second","get","getindex","getvariable","lookup","jsonget","jsonindexes","jsontype","jsonextract","jsonstringify","encodehtml","decodehtml","encodeuri","encodeuricomponent","decodeuri","decodeuricomponent","escaperegexp","escapecss","base64encode","base64decode","each","eachday","filter","reduce","map","subfilter","else","then","variables","modules","plugintiddlers","shadowsource","storyviews","editions","lengths","commands","sha256hash","md5hash","encryptbase64","decryptbase64","draft.of","draft.for","draft","draftof","draftfor"],Ei=new Set(Ai.map(e=>e.toLowerCase()));let Bi=null;const Ii=[{label:"+",detail:"intersection - filter the input (same as :and)"},{label:"-",detail:"subtraction - remove from results (same as :except)"},{label:"~",detail:"else - use if previous was empty (same as :else)"},{label:"=",detail:"literal - add title literally (same as :all)"},{label:":and",detail:"intersection - same as +"},{label:":except",detail:"subtraction - same as -"},{label:":else",detail:"else - same as ~"},{label:":all",detail:"literal - same as ="},{label:":filter",detail:"filter each title through subfilter"},{label:":map",detail:"transform each title via subfilter"},{label:":reduce",detail:"reduce to single value"},{label:":intersection",detail:"keep titles common to all runs"},{label:":cascade",detail:"cascade through filters"},{label:":some",detail:"pass to any matching run"},{label:":sort",detail:"sort by subfilter result"},{label:":flat",detail:"flatten list output"}],Wi={all:{operands:["current","missing","orphans","shadows","tags","tiddlers"],allowPlus:!0},is:{operands:["binary","blank","current","draft","image","missing","orphan","shadow","system","tag","tiddler","variable"]},has:{dynamicOperands:"fields",suffixes:["field","index","tag"]},get:{dynamicOperands:"fields"},getindex:{dynamicOperands:"fields"},field:{dynamicOperands:"fields"},fields:{operands:[]},type:{dynamicOperands:"types"},indexes:{operands:[]},tag:{dynamicOperands:"tags"},tagging:{operands:[]},tags:{operands:[]},untagged:{operands:[]},function:{dynamicOperands:"functions"},subfilter:{dynamicOperands:"functions"},contains:{flags:["casesensitive"],suffixes:["field","index"]},match:{flags:["casesensitive"]},regexp:{flags:["casesensitive"]},search:{flags:["casesensitive","anchored","literal","whitespace","regexp","words","some","all"],suffixes:["field"]},prefix:{flags:["casesensitive"]},suffix:{flags:["casesensitive"]},sort:{dynamicOperands:"fields",flags:["reverse","casesensitive"],suffixes:["alphanumeric","number","string","date","naturaldate"]},nsort:{dynamicOperands:"fields",flags:["reverse"]},sortan:{dynamicOperands:"fields",flags:["reverse"]},sortcs:{dynamicOperands:"fields",flags:["reverse"]},sortby:{dynamicOperands:"fields",flags:["reverse"]},nsortby:{dynamicOperands:"fields",flags:["reverse"]},compare:{suffixes:["number","string","integer","date","version"],flags:["casesensitive"]},limit:{operands:[]},first:{operands:[]},last:{operands:[]},nth:{operands:[]},range:{operands:[]},format:{operands:["date","relativedate","json","timestamp","titlelist"]},jsonget:{operands:[]},jsontype:{operands:[]},jsonindexes:{operands:[]},jsonextract:{operands:[]},lookup:{dynamicOperands:"fields"},getvariable:{dynamicOperands:"variables"},list:{dynamicOperands:"tiddlers"},listed:{dynamicOperands:"fields"},enlist:{operands:[]},split:{operands:[]},"draft.of":{operands:[]},"draft.for":{operands:[]},each:{dynamicOperands:"fields"},eachday:{dynamicOperands:"fields"},backlinks:{operands:[]},backtranscludes:{operands:[]},commands:{operands:[]},count:{operands:[]},deserializers:{operands:[]},duplicateslugs:{operands:[]},editions:{operands:[]},haschanged:{operands:[]},links:{operands:[]},moduletypes:{operands:[]},plugintiddlers:{operands:[]},shadowsource:{operands:[]},slugify:{operands:[]},storyviews:{operands:[]},title:{operands:[]},transcludes:{operands:[]},variables:{operands:[]}};function Di(e,t,n){return s=>{const{state:i,pos:r}=s,o=i.sliceDoc(Math.max(0,r-100),r);if(/[\[\]}>][\w\-:!.]+\[[^\]]*$/.test(o)||/[\[\]}>][\w\-:!.]+\{[^}]*$/.test(o)||/[\[\]}>][\w\-:!.]+<[^>]*$/.test(o)||/\],\[[^\]]*$/.test(o)||/\],\{[^}]*$/.test(o)||/\],<[^>]*$/.test(o)||/\},\[[^\]]*$/.test(o)||/\},\{[^}]*$/.test(o)||/\},<[^>]*$/.test(o)||/>,\[[^\]]*$/.test(o)||/>,\{[^}]*$/.test(o)||/>,<[^>]*$/.test(o))return null;if(/\]\](?::\w+)*\w*$/.test(o))return null;let l="",c="",d=0;const f=/\[(!?)([\w.]*)$/.exec(o),u=/\](?::\w+)*([\w.]*)$/.exec(o),h=/[>}](?::\w+)*(!?)([\w.]*)$/.exec(o);if(f)l=f[1],c=f[2],d=c.length+l.length+1;else if(u)c=u[1],d=c.length;else{if(!h)return null;l=h[1],c=h[2],d=c.length+l.length}const p=a.syntaxTree(i).resolveInner(r,-1);let m=p,g=!1;for(;m&&!m.type.isTop;){if("FencedCode"===m.name||"CodeBlock"===m.name||"TypedBlock"===m.name||"CommentBlock"===m.name||"KaTeXBlock"===m.name||"LaTeXContent"===m.name)return null;"FilterExpression"!==m.name&&"FilteredTransclusion"!==m.name&&"FilteredTransclusionBlock"!==m.name&&"ConditionalBlock"!==m.name&&"Conditional"!==m.name&&"FilterRun"!==m.name&&"FilterOperator"!==m.name&&"FilterOperatorName"!==m.name&&"IncompleteFilterRun"!==m.name||(g=!0),m=m.parent}const b=g||/\{\{\{[^}]*$/.test(o)||/<%(?:if|elseif)\s+[^%]*$/.test(o)||/filter\s*=\s*["'][^"']*$/.test(o);if(!b){let e=!1,t=p;for(;t&&!t.type.isTop;){if("Widget"===t.name||"WidgetBlock"===t.name||"MacroCall"===t.name||"MacroCallBlock"===t.name||"HTMLTag"===t.name||"HTMLBlock"===t.name||"Attribute"===t.name||"AttributeName"===t.name||"AttributeValue"===t.name||"AttributeString"===t.name||"PragmaImport"===t.name||"PragmaDefine"===t.name||"PragmaProcedure"===t.name||"PragmaFunction"===t.name||"PragmaWidget"===t.name||"PragmaParameters"===t.name||"Transclusion"===t.name||"TransclusionBlock"===t.name){e=!0;break}t=t.parent}if(e)return null}const k=/\[[^\]]*[>}][\w.]*$/.test(o);return f||g||k?function(e,t,n,s,i,r,a){const{pos:o,state:l}=e,c=l.sliceDoc(Math.max(0,o-50),o),d=/\[([\w.]*)$/.test(c)&&!/\][\w.]*$/.test(c),f=i?i():[],u=f.length>0?f:Ai,h=l.doc.toString(),p=gs(h),m=p.functions,g=p.definitionParams,b=[];if(d&&!s){const e=0===t.length||"img".toLowerCase().startsWith(t.toLowerCase()),n=0===t.length||"ext".toLowerCase().startsWith(t.toLowerCase());e&&b.push({label:"img",type:"keyword",detail:"[img[...]] - embed image",boost:"img".startsWith(t.toLowerCase())?100:10,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"img["},selection:{anchor:n+4}})}}),n&&b.push({label:"ext",type:"keyword",detail:"[ext[...]] - external link",boost:"ext".startsWith(t.toLowerCase())?100:10,apply:(e,t,n,s)=>{e.dispatch({changes:{from:n,to:s,insert:"ext["},selection:{anchor:n+4}})}})}u.forEach(e=>{const t=Wi[e],n=t&&Array.isArray(t.operands)&&0===t.operands.length;b.push({label:e,type:"function",detail:"filter operator",apply:(t,s,i,a)=>{const o=r?r():"always",l=t.state.sliceDoc(a,a+2),c=l.charAt(0);if("["===c||"<"===c||"{"===c)return void t.dispatch({changes:{from:i,to:a,insert:e},selection:{anchor:i+e.length}});if("none"===o)return void t.dispatch({changes:{from:i,to:a,insert:e},selection:{anchor:i+e.length}});const d=l.startsWith("]"),f="]]"===l;"smart"!==o?n?f?t.dispatch({changes:{from:i,to:a,insert:e+"["},selection:{anchor:i+e.length+1}}):t.dispatch({changes:{from:i,to:a,insert:e+"[]"},selection:{anchor:i+e.length+1}}):t.dispatch({changes:{from:i,to:a,insert:e+"["},selection:{anchor:i+e.length+1}}):n?t.dispatch({changes:{from:i,to:a,insert:e+"[]"},selection:{anchor:i+e.length+1}}):d?t.dispatch({changes:{from:i,to:a,insert:e+"["},selection:{anchor:i+e.length+1}}):t.dispatch({changes:{from:i,to:a,insert:e+"[]"},selection:{anchor:i+e.length+1}})}})});const k=new Set(function(e){if(e===Ai)return Ei;Bi||(Bi=new WeakMap);let t=Bi.get(e);return t||(t=new Set(e.map(e=>e.toLowerCase())),Bi.set(e,t)),t}(u));if(m.forEach(e=>{if(k.has(e.toLowerCase()))return;k.add(e.toLowerCase());const t=(g[e]||[]).length;b.push({label:e,type:"function",detail:t>0?`function (${t} param${t>1?"s":""})`:"function",boost:5,apply:(n,s,i,a)=>{const o=r?r():"always",l=n.state.sliceDoc(a,a+2),c=l.charAt(0);if("["===c||"<"===c||"{"===c)return void n.dispatch({changes:{from:i,to:a,insert:e},selection:{anchor:i+e.length}});if("none"===o)return void n.dispatch({changes:{from:i,to:a,insert:e},selection:{anchor:i+e.length}});let d="[]";t>1&&(d="[]"+",[]".repeat(t-1));const f=l.startsWith("]");"smart"===o&&f&&t<=1?n.dispatch({changes:{from:i,to:a,insert:e+"["},selection:{anchor:i+e.length+1}}):n.dispatch({changes:{from:i,to:a,insert:e+d},selection:{anchor:i+e.length+1}})}})}),a){f.filter(e=>!Ai.includes(e)&&!k.has(e.toLowerCase())).forEach(e=>{if(k.has(e.toLowerCase()))return;k.add(e.toLowerCase());const t=a(e),n=t?t.length:0;if(n>0){const t=b.findIndex(t=>t.label===e);t>=0&&b.splice(t,1),b.push({label:e,type:"function",detail:`function (${n} param${n>1?"s":""})`,boost:3,apply:(t,s,i,a)=>{const o=r?r():"always",l=t.state.sliceDoc(a,a+2),c=l.charAt(0);if("["===c||"<"===c||"{"===c)return void t.dispatch({changes:{from:i,to:a,insert:e},selection:{anchor:i+e.length}});if("none"===o)return void t.dispatch({changes:{from:i,to:a,insert:e},selection:{anchor:i+e.length}});let d="[]";n>1&&(d="[]"+",[]".repeat(n-1));const f=l.startsWith("]");"smart"===o&&f&&n<=1?t.dispatch({changes:{from:i,to:a,insert:e+"["},selection:{anchor:i+e.length+1}}):t.dispatch({changes:{from:i,to:a,insert:e+d},selection:{anchor:i+e.length+1}})}})}})}return{from:o-t.length,to:o,options:b,validFor:/^[\w.]*$/}}(s,c,0,b,e,t,n):null}}function Fi(e){const{state:t,pos:n}=e,s=t.sliceDoc(Math.max(0,n-100),n),i=/(?:\{\{\{|[\]\s])\s*([:+\-~=][\w]*)$/.exec(s);if(!i)return null;let r=a.syntaxTree(t).resolveInner(n,-1),o=!1;for(;r&&!r.type.isTop;){if("FencedCode"===r.name||"CodeBlock"===r.name||"TypedBlock"===r.name||"CommentBlock"===r.name||"KaTeXBlock"===r.name||"LaTeXContent"===r.name)return null;"FilterExpression"!==r.name&&"FilteredTransclusion"!==r.name&&"FilteredTransclusionBlock"!==r.name&&"AttributeFiltered"!==r.name&&"ConditionalBlock"!==r.name||(o=!0),r=r.parent}if(!(o||/\{\{\{[^}]*$/.test(s)||/<%(?:if|elseif)\s+[^%]*$/.test(s)||/filter\s*=\s*["'][^"']*$/.test(s)))return null;const l=i[1],c=Ii.map(e=>({label:e.label,type:"keyword",detail:e.detail,apply:e.label.startsWith(":")?(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+10),a=/^\s*\]/.test(r)?e.label+"[":e.label+"[]",o=s+e.label.length+1;t.dispatch({changes:{from:s,to:i,insert:a},selection:{anchor:o}})}:e.label}));return{from:n-l.length,to:n,options:c,validFor:/^[:+\-~=][\w]*$/}}function Ni(e){return t=>{const{state:n,pos:s}=t,i=n.sliceDoc(Math.max(0,s-100),s),r=/[\[\]}>](!?)([\w.]+)((?::[\w]*)*)$/.exec(i);if(!r)return null;const a=r[2],o=r[3];if(!o||!o.includes(":"))return null;const l=/:(\w*)$/.exec(o);if(!l)return null;const c=l[1],d=Wi[a];if(!d)return null;if(!d.flags&&!d.suffixes)return null;const f=o.split(":").filter(e=>e&&e!==c),u=[];if(d.flags)for(const e of d.flags)f.includes(e)||u.push({label:e,type:"keyword",detail:"flag"});if(d.suffixes)for(const e of d.suffixes)f.includes(e)||("field"===e?u.push({label:e,type:"property",detail:"use field suffix"}):u.push({label:e,type:"property",detail:"type"}));if(f.includes("field")){const t=e?e():ds;for(const e of t)f.includes(e)||u.push({label:e,type:"variable",detail:"field name"})}if(0===u.length)return null;const h=c.length>0?u.filter(e=>e.label.toLowerCase().startsWith(c.toLowerCase())):u;return 0===h.length?null:{from:s-c.length,to:s,options:h,validFor:/^[\w.]*$/}}}function Oi(e,t,n,s,i,r){return o=>{const{state:l,pos:c}=o,d=l.sliceDoc(Math.max(0,c-100),c),f=/[\[\]}>](!?)([\w.]+)((?::[\w]+)*)([\[{<])([^\]}>]*)$/.exec(d),u=/[\]}>],([\[{<])([^\]}>]*)$/.exec(d);let h,p,m=null;if(f)m=f[2],p=f[4],h=f[5];else{if(!u)return null;{p=u[1],h=u[2];const e=/\[(!?)([\w.]+)/.exec(d);e&&(m=e[2])}}if("<"===p){const e=i?i():[],t=gs(l.doc.toString()),n=[...new Set([...e,...t.variables,...t.functions,...t.procedures,...t.macros])];if(function(e,t){const n=a.syntaxTree(e).resolveInner(t,-1);let s=n;for(;s&&!s.type.isTop;){if("ConditionalBlock"===s.name)return!0;s=s.parent}for(s=n;s&&!s.type.isTop;){const n=s.parent;if(n){const s=[];let i=n.firstChild;for(;i;){if("Conditional"===i.name){const t=e.sliceDoc(i.from,i.to);let n=null;/<%\s*if\b/.test(t)?n="if":/<%\s*endif\s*%>/.test(t)&&(n="endif"),n&&s.push({type:n,from:i.from,to:i.to})}i=i.nextSibling}if(s.length>=2){s.sort((e,t)=>e.from-t.from);let e=0,n=-1;for(const i of s)if("if"===i.type)0===e&&(n=i.to),e++;else if("endif"===i.type&&(e--,0===e&&-1!==n)){if(t>n&&t<i.from)return!0;n=-1}if(e>0&&-1!==n&&t>n)return!0}}s=n}return!1}(l,c)&&!n.includes("condition")&&n.push("condition"),0===n.length)return null;const s=h,r=s.length>0?n.filter(e=>e.toLowerCase().startsWith(s.toLowerCase())):n;return 0===r.length?null:{from:c-s.length,to:c,options:r.map(e=>({label:e,type:"variable",detail:"variable"})),validFor:/^[\w.]*$/}}if("{"===p)return null;if(!m)return null;const g=Wi[m];if(!g)return null;if(g.operands&&0===g.operands.length&&!g.dynamicOperands)return null;let b,k;if(g.allowPlus&&h.includes("+")){const e=h.split("+");b=e[e.length-1],k=e.slice(0,-1)}else b=h,k=[];let x=[];if(g.operands&&g.operands.length>0&&(x=g.operands.filter(e=>!k.includes(e)).map(e=>({label:e,type:"constant",detail:`${m}[] value`}))),g.dynamicOperands){const a=gs(l.doc.toString());let o=[],c=[],d="";switch(g.dynamicOperands){case"fields":o=n?n():ds,d="field";break;case"tags":o=t?t():[],d="tag";break;case"tiddlers":o=e?e():[],d="tiddler";break;case"functions":o=s?s():[],c=a.functions,d="function";break;case"variables":o=i?i():[],c=a.variables,d="variable";break;case"types":o=r?r():[],d="type"}const f=new Set(k),u="tags"===g.dynamicOperands||"tiddlers"===g.dynamicOperands;if(x.push(...o.filter(e=>!f.has(e)&&(f.add(e),!0)).map(e=>({label:e,type:"fields"===g.dynamicOperands?"variable":"functions"===g.dynamicOperands?"function":"text",detail:d,...u?{boost:us(e)}:{}}))),c.length>0)if("variables"===g.dynamicOperands){x.push(...a.builtIns.filter(e=>!f.has(e)&&(f.add(e),!0)).map(e=>({label:e,type:"keyword",detail:`${d} (built-in)`})));const e=[...a.functions,...a.procedures,...a.macros,...a.widgets,...a.widgetVars];x.push(...e.filter(e=>!f.has(e)&&(f.add(e),!0)).map(e=>({label:e,type:"function",detail:`${d} (local)`})))}else x.push(...c.filter(e=>!f.has(e)&&(f.add(e),!0)).map(e=>({label:e,type:"function",detail:`${d} (local)`})))}if(0===x.length)return null;const $=b.length>0?x.filter(e=>e.label.toLowerCase().startsWith(b.toLowerCase())):x;return 0===$.length?null:{from:c-b.length,to:c,options:$,validFor:/^[^\]]*$/}}}function Hi(e,t,n){return s=>{const{state:i,pos:r}=s,o=i.sliceDoc(Math.max(0,r-100),r),l=/\[\[[^\]|]*$/.exec(o),c=/\[\[.*?\|[^\]]*$/.exec(o);let d=/(?<!\{)\{\{[^{}|]*$/.exec(o);d&&(d[0].includes("!!")||d[0].includes("##"))&&(d=null);const f=/\[img(?:\s+[^\[]*)?\[[^\]|]*$/.exec(o),u=/\[ext\[[^\]|]*$/.exec(o),h=/[\[\]}>][\w\-:!]*\[[^\]]*$/.exec(o);let p=/[\[\]}>][\w\-:!]*\{[^}]*$/.exec(o);p&&(p[0].includes("!!")||p[0].includes("##"))&&(p=null);const m=/\{\{\{[^}]*$/.test(o)||/\bfilter\s*=\s*(?:"[^"]*|'[^']*|"""[^"]*)$/.test(o)||/<\$\w+[^>]*\bfilter\s*=\s*(?:"[^"]*|'[^']*|"""[^"]*)$/.test(o);let g;if(f)g=f;else{if(u)return null;g=m&&l&&h?h:l||c||d||h||p}if(!g)return null;let b=a.syntaxTree(i).resolveInner(r,-1),k=!1,x=!1;for(;b&&!b.type.isTop;){if("FencedCode"===b.name||"CodeBlock"===b.name||"TypedBlock"===b.name||"CommentBlock"===b.name||"KaTeXBlock"===b.name||"LaTeXContent"===b.name)return null;"ImageLink"!==b.name&&"ImageSource"!==b.name||(k=!0),"ExternalLink"!==b.name&&"URLLink"!==b.name||(x=!0),b=b.parent}if(x)return null;k&&f&&(g=f);let $,y,w,T,S=e?e():[];if(0===S.length)return null;if(g===p){$=g[0].slice(0,g[0].lastIndexOf("{")+1),w=/^[\[\]}>][\w\-:!]*\{[^}]*$/,T="text reference";const e=g[0].length,t=S.map(t=>({label:$+t,type:"variable",detail:T,boost:us(t,n),sortText:hs(t,n),apply:(n,s,i,r)=>{const a=n.state.sliceDoc(r,r+2),o="}"===a[0],l=!("]"===a[1]||"]"===a[0]||o&&"]"===a[1]),c=$+t+(o?"":"}")+(l?"]":""),d=i+$.length+t.length+1,f=fs(n,i,r,c,e);n.dispatch({changes:f,selection:{anchor:d}})}}));return{from:r-g[0].length,to:r,options:t,validFor:w}}if(g===f){const e=g[0].lastIndexOf("[");if($=g[0].slice(0,e+1),y="]]",w=/^\[img(?:\s+[^\[]*)?\[[^\]|]*$/,T="image",t){const e=t();e.length>0&&(S=e)}}else{if(g===h){const e=/[\[\]}>](!?)([\w.]+)(?::[\w]+)*\[[^\]]*$/.exec(g[0]);if(e){const t=e[2];if(Wi[t])return null}$=g[0].slice(0,g[0].lastIndexOf("[")+1),w=/^[\[\]}>][\w\-:!]*\[[^\]]*$/,T="filter operand";const t=g[0].length,s=S.map(e=>({label:$+e,type:"variable",detail:T,boost:us(e,n),sortText:hs(e,n),apply:(n,s,i,r)=>{const a=n.state.sliceDoc(r,r+2),o="]"===a[0],l="]"===a[1];let c="]]";o&&l?c="":o&&(c="]");const d=$+e+c,f=i+$.length+e.length+1,u=fs(n,i,r,d,t);n.dispatch({changes:u,selection:{anchor:f}})}}));return{from:r-g[0].length,to:r,options:s,validFor:w}}if(g===l)$="[[",y="]]",w=/^\[\[[^\]|]*$/,T="tiddler";else if(g===c){const e=g[0].lastIndexOf("|");$=g[0].slice(0,e+1),y="]]",w=/^\[\[.*?\|[^\]]*$/,T="tiddler"}else{if(g!==d)return null;$="{{",y="}}",w=/^(?<!\{)\{\{[^{}|]*$/,T="tiddler"}}const C=g[0].length,v=S.map(e=>({label:$+e,type:"variable",detail:T,boost:us(e,n),sortText:hs(e,n),apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+y.length);let a=y,o=0;r===y?(a="",o=y.length):"]]"===y&&r.startsWith("]")?(a="]",o=1):"}}"===y&&r.startsWith("}")&&(a="}",o=1);const l=$+e+a,c=s+l.length+o,d=fs(t,s,i,l,C);t.dispatch({changes:d,selection:{anchor:c}})}}));return{from:r-g[0].length,to:r,options:v,validFor:w}}}function _i(e,t){return n=>{const{state:s,pos:i}=n,r=s.sliceDoc(Math.max(0,i-200),i),o=/\$:\/[\w\-\/\.]*$/.exec(r);if(!o)return null;const l=r.slice(0,r.length-o[0].length);if(/\[\[[^\]]*$/.test(l))return null;if(/\{\{[^}]*$/.test(l))return null;if(/\[img[^\]]*\[[^\]]*$/.test(l))return null;let c=a.syntaxTree(s).resolveInner(i,-1);for(;c&&!c.type.isTop;){if("FencedCode"===c.name||"CodeBlock"===c.name||"TypedBlock"===c.name||"CommentBlock"===c.name||"KaTeXBlock"===c.name||"LaTeXContent"===c.name)return null;c=c.parent}const d=(e?e():[]).filter(e=>e.startsWith("$:/"));if(0===d.length)return null;return{from:i-o[0].length,to:i,options:d.map(e=>({label:e,type:"variable",detail:"system tiddler",boost:us(e,t),sortText:hs(e,t)})),validFor:/^\$:\/[\w\-\/\.]*$/}}}function zi(e,t){return n=>{const{state:s,pos:i}=n,r=s.sliceDoc(Math.max(0,i-200),i),o=/(?<!\{)\{\{([^{}|]*?)!![^{}|!]*$/.exec(r),l=/(?<!\{)\{\{([^{}|]*?)##[^{}|#]*$/.exec(r);let c=null,d=null;(/\[[^\]]*\{[^{}]*$/.test(r)||/\{\{\{[^}]*\{[^{}]*$/.test(r)||/\bfilter\s*=\s*(?:"[^"]*|'[^']*|"""[^"]*)\{[^{}]*$/.test(r))&&(c=/(?<!\{)\{(?!\{)([^{}]*?)!![^{}!]*$/.exec(r),d=/(?<!\{)\{(?!\{)([^{}]*?)##[^{}#]*$/.exec(r));const f=!(!o&&!l),u=!(!o&&!c),h=o||l||c||d;if(!h)return null;let p=a.syntaxTree(s).resolveInner(i,-1);for(;p&&!p.type.isTop;){if("FencedCode"===p.name||"CodeBlock"===p.name||"TypedBlock"===p.name||"CommentBlock"===p.name||"KaTeXBlock"===p.name||"LaTeXContent"===p.name)return null;p=p.parent}const m=u?"!!":"##",g=h[1]||"",b=h[0].lastIndexOf(m),k=h[0].slice(0,b+2),x=h[0].slice(b+2);let $,y;u?($=e&&g?e(g):[],y="field"):($=t&&g?t(g):[],y="index");const w=$.filter(e=>e.toLowerCase().startsWith(x.toLowerCase()));if(0===w.length)return null;const T=h[0].length,S=f?"}}":"}",C=w.map(e=>({label:k+e,type:"property",detail:y,apply:(t,n,s,i)=>{const r=t.state.sliceDoc(i,i+2);let a=S;f?"}}"===r?a="":r.startsWith("}")&&(a="}"):r.startsWith("}")&&(a="");const o=k+e+a,l=s+o.length,c=fs(t,s,i,o,T);t.dispatch({changes:c,selection:{anchor:l}})}}));let v;return v=f?u?/^(?<!\{)\{\{[^{}|]*!![^{}|!]*$/:/^(?<!\{)\{\{[^{}|]*##[^{}|#]*$/:u?/^(?<!\{)\{(?!\{)[^{}]*!![^{}!]*$/:/^(?<!\{)\{(?!\{)[^{}]*##[^{}#]*$/,{from:i-h[0].length,to:i,options:C,validFor:v}}}const Ri=[{label:"if",detail:"Conditional if",insert:" if [] %>",outdent:!1},{label:"elseif",detail:"Conditional else-if",insert:" elseif [] %>",outdent:!0},{label:"else",detail:"Conditional else",insert:" else %>",outdent:!0},{label:"endif",detail:"End conditional",insert:" endif %>",outdent:!0}];function Zi(e){const t=e.pos,n=e.state.doc,s=n.lineAt(t),i=n.sliceString(s.from,t),r=/<%(\s*)(\w*)$/.exec(i);if(!r)return null;const o=r[1],l=r[2],c=o.length>0,d=t-l.length,f=l.length,u=i.lastIndexOf("<%"),h=Ri.map(e=>{const t=c?e.insert.trimStart():e.insert;return{label:e.label,type:"keyword",detail:e.detail,apply:(n,r,o,l)=>{if(e.outdent&&u>0&&1===n.state.selection.ranges.length){const t=a.getIndentUnit(n.state),r=i.slice(0,u);let o=0;for(const e of r)" "===e?o++:"\t"===e&&(o+=t);const c=Math.max(0,o-t),d=" ".repeat(c)+"<%"+e.insert,f="elseif"===e.label?d.indexOf("[")+1:d.length;n.dispatch({changes:{from:s.from,to:l,insert:d},selection:{anchor:s.from+f}})}else{const s="if"===e.label||"elseif"===e.label?t.indexOf("[")+1:t.length,i=fs(n,o,l,t,f);n.dispatch({changes:i,selection:{anchor:o+s}})}}}});return{from:d,to:t,options:h,validFor:/^\w*$/}}const Vi=[{label:"define",detail:"Define a macro"},{label:"procedure",detail:"Define a procedure"},{label:"function",detail:"Define a function"},{label:"widget",detail:"Define a widget"},{label:"import",detail:"Import tiddlers"},{label:"rules",detail:"Set parser rules"},{label:"parameters",detail:"Declare parameters"},{label:"whitespace",detail:"Whitespace handling"},{label:"parsermode",detail:"Set parser mode"},{label:"end",detail:"End a definition"}];function Ki(e){const t=e.pos,n=e.state.doc,s=n.lineAt(t),i=n.sliceString(s.from,t),r=/^(\s*)\\(\w*)$/.exec(i);if(!r)return null;const a=s.from+r[1].length+1,o=n.sliceString(t,s.to),l=/^\s/.test(o),c=new Set(["whitespace","rules"]),d=Vi.map(e=>{const t=l||"end"===e.label?e.label:e.label+" ",n=c.has(e.label)&&!l;return{label:e.label,type:"keyword",detail:e.detail,apply:n?(e,n,s,i)=>{e.dispatch({changes:{from:s,to:i,insert:t},selection:{anchor:s+t.length},effects:rs.of(null)})}:t}});return{from:a,to:t,options:d,validFor:/^\w*$/}}function Xi(e){const t=e.pos,n=e.state.doc,s=n.lineAt(t),i=n.sliceString(s.from,t),r=/^(\s*)\\rules\s+(\w*)$/.exec(i);if(!r)return null;return{from:t-r[2].length,to:t,options:[{label:"only",type:"keyword",detail:"Only enable specified rules"},{label:"except",type:"keyword",detail:"Disable specified rules"}],validFor:/^\w*$/}}function ji(e){const t=e.pos,n=e.state.doc,s=n.lineAt(t),i=n.sliceString(s.from,t),r=/^(\s*)\\whitespace\s+(\w*)$/.exec(i);if(!r)return null;return{from:t-r[2].length,to:t,options:[{label:"trim",type:"keyword",detail:"Remove leading/trailing whitespace"},{label:"notrim",type:"keyword",detail:"Preserve whitespace"}],validFor:/^\w*$/}}function qi(e){const t=e.pos,n=e.state.doc,s=n.lineAt(t),i=n.sliceString(s.from,t),r=/^(\s*)\\parsermode\s+(\w*)$/.exec(i);if(!r)return null;return{from:t-r[2].length,to:t,options:[{label:"block",type:"keyword",detail:"Parse as block content"},{label:"inline",type:"keyword",detail:"Parse as inline content"}],validFor:/^\w*$/}}function Ui(e){const t=e.pos,n=e.state.doc,s=n.lineAt(t),i=n.sliceString(s.from,t),r=/^(\s*)\\end\s+(\S*)$/.exec(i);if(!r)return null;const o=s.from+i.length-r[2].length,l=a.syntaxTree(e.state),c=[];if(l.iterate({enter:e=>{const s=e.name;if(("MacroDefinition"===s||"ProcedureDefinition"===s||"FunctionDefinition"===s||"WidgetDefinition"===s)&&e.from<=t&&e.to>=t){let t=null;const i=e.node.cursor();i.firstChild();do{if("PragmaName"===i.name){t=n.sliceString(i.from,i.to);break}}while(i.nextSibling());t&&c.push({name:t,type:s.replace("Definition","")})}}}),0===c.length)return null;const d=c.reverse().map((e,t)=>({label:e.name,type:"variable",detail:`Close ${e.type.toLowerCase()}`,boost:c.length-t}));return{from:o,to:t,options:d,validFor:/^\S*$/}}const Qi=[{name:"commentblock",types:"block, pragma"},{name:"fnprocdef",types:"pragma"},{name:"import",types:"pragma"},{name:"macrodef",types:"pragma"},{name:"parameters",types:"pragma"},{name:"parsermode",types:"pragma"},{name:"rules",types:"pragma"},{name:"whitespace",types:"pragma"},{name:"codeblock",types:"block"},{name:"filteredtranscludeblock",types:"block"},{name:"heading",types:"block"},{name:"horizrule",types:"block"},{name:"list",types:"block"},{name:"macrocallblock",types:"block"},{name:"quoteblock",types:"block"},{name:"styleblock",types:"block"},{name:"table",types:"block"},{name:"transcludeblock",types:"block"},{name:"typedblock",types:"block"},{name:"codeinline",types:"inline"},{name:"commentinline",types:"inline"},{name:"dash",types:"inline"},{name:"entity",types:"inline"},{name:"extlink",types:"inline"},{name:"filteredtranscludeinline",types:"inline"},{name:"hardlinebreaks",types:"inline"},{name:"image",types:"inline"},{name:"macrocallinline",types:"inline"},{name:"prettyextlink",types:"inline"},{name:"prettylink",types:"inline"},{name:"styleinline",types:"inline"},{name:"syslink",types:"inline"},{name:"transcludeinline",types:"inline"},{name:"wikilink",types:"inline"},{name:"wikilinkprefix",types:"inline"},{name:"conditional",types:"block, inline"},{name:"html",types:"block, inline"},{name:"bold",types:"inline"},{name:"italic",types:"inline"},{name:"strikethrough",types:"inline"},{name:"subscript",types:"inline"},{name:"superscript",types:"inline"},{name:"underscore",types:"inline"}];function Gi(e){return t=>{const n=t.pos,s=t.state.doc,i=s.lineAt(n),r=s.sliceString(i.from,n),a=/^(\s*)\\rules\s+(only|except)\s+/.exec(r);if(!a)return null;const o=r.slice(a[0].length),l=/(\S*)$/.exec(o);return{from:n-(l?l[1]:"").length,to:n,options:(e?e():Qi).map(e=>({label:e.name,type:"constant",detail:e.types})),validFor:/^\S*$/}}}function Yi(e,t,n,s,i,r){return o=>{if(!o.explicit)return null;const l=o.pos,c=o.state.doc,d=c.lineAt(l),f=c.sliceString(d.from,l);if(function(e){return[/<[a-zA-Z$][^>]*$/,/<<[^>]*$/,/\[\[[^\]]*$/,/\{\{[^}]*$/,/\[img\[[^\]]*$/,/\[[^\[\]]*$/,/^\s*\\[\w]*$/,/^\s*\\rules\s+(only|except)\s+/,/<%([ \t]*\w*)?$/].some(t=>t.test(e))}(f))return null;let u=a.syntaxTree(o.state).resolveInner(l,-1);for(;u&&!u.type.isTop;){if("FencedCode"===u.name||"CodeBlock"===u.name||"TypedBlock"===u.name||"CommentBlock"===u.name||"KaTeXBlock"===u.name||"LaTeXContent"===u.name)return null;u=u.parent}const h=/(\w*)$/.exec(f),p=l-(h?h[1]:"").length,m=[];if(e){const t=e();for(const e of t)m.push({label:e,type:"text",detail:"tiddler",boost:us(e,r),sortText:hs(e,r),apply:(t,n,s,i)=>{const r=`[[${e}]]`;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length}})}})}const g=new Set;if(t)for(const e of t())g.add(e);for(const e of ti)g.add(e);const b=gs(o.state.doc.toString());for(const e of b.macros)g.add(e);for(const e of g)m.push({label:e,type:"function",detail:"macro",boost:2,apply:(t,n,s,i)=>{const r=`<<${e}>>`;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length-2}})}});const k=new Set;if(n)for(const e of n())k.add(e);for(const e of Ci)k.add(e);for(const e of b.widgets)k.add(e);for(const e of k)m.push({label:e,type:"type",detail:"widget",boost:1,apply:(t,n,s,i)=>{const r=`<$${e}></$${e}>`,a=s+e.length+3;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:a}})}});const x=new Set;if(s)for(const e of s())x.add(e);for(const e of b.functions)x.add(e);for(const e of x)g.has(e)||m.push({label:e,type:"function",detail:"function",boost:2,apply:(t,n,s,i)=>{const r=`<<${e}>>`;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length-2}})}});const $=new Set;if(i)for(const e of i())$.add(e);for(const e of cs)$.add(e);for(const e of b.procedures)$.add(e);for(const e of $)g.has(e)||x.has(e)||m.push({label:e,type:"variable",detail:"variable",boost:1,apply:(t,n,s,i)=>{const r=`<<${e}>>`;t.dispatch({changes:{from:s,to:i,insert:r},selection:{anchor:s+r.length-2}})}});for(const e of gi){const t=os.has(e);m.push({label:e,type:"keyword",detail:t?"html (self-closing)":"html",boost:0,apply:(n,s,i,r)=>{let a,o;t?(a=`<${e}>`,o=i+a.length):(a=`<${e}></${e}>`,o=i+e.length+2),n.dispatch({changes:{from:i,to:r,insert:a},selection:{anchor:o}})}})}return 0===m.length?null:{from:p,to:l,options:m,validFor:/^\w*$/}}}function Ji(e,t,n){let s=0;const i="```"===n?/^(\s*)```/:/^(\s*)\$\$\$/;for(let n=1;n<t;n++){const t=e.line(n);i.test(t.text)&&s++}return s%2==1}function er(e){let t=a.syntaxTree(e.state).resolveInner(e.pos,-1);for(;t&&!t.type.isTop;){if("Highlight"===t.name||"StyledBlock"===t.name){const n=e.state.doc.sliceString(t.from,e.pos);return n.startsWith("@@")?n.slice(2):null}t=t.parent}const n=e.state.doc.lineAt(e.pos),s=e.state.doc.sliceString(n.from,e.pos);if(s.startsWith("@@")){if(e.state.doc.sliceString(e.pos,n.to).includes("@@")){const t=e.state.doc.sliceString(n.from,n.to),i=t.indexOf("@@"),r=t.indexOf("@@",i+2);if(-1!==r){const t=e.pos-n.from;return t>i+2&&t<=r?s.slice(2):null}}return s.slice(2)}let i=n.number-1;for(;i>=1;){const t=e.state.doc.line(i).text;if("@@"===t.trim())return null;if(t.startsWith("@@")){return t.slice(2).includes("@@")?null:s}i--}return null}function tr(e,t){return function(n){if(!e)return null;let s=er(n);const i=null!==s;if(null===s&&(s=function(e,t){let n=a.syntaxTree(e.state).resolveInner(e.pos,-1);for(;n&&!n.type.isTop;){if("AttributeString"===n.name){const s=n.parent;if("Attribute"===s?.name){const i=s.getChild("AttributeName");if(i&&"style"===e.state.doc.sliceString(i.from,i.to)){const i=s.parent;if(i&&("Widget"===i.name||"InlineWidget"===i.name)){const n=i.getChild("WidgetName");if(n&&t){const s=t(e.state.doc.sliceString(n.from,n.to));if(s&&!s.includes("style"))return null}}return e.state.doc.sliceString(n.from+1,e.pos)}}return null}n=n.parent}const s=e.state.doc.lineAt(e.pos),i=e.state.doc.sliceString(s.from,e.pos),r=/style=["']([^"']*)$/.exec(i);if(r){const e=/<(\$[a-zA-Z][a-zA-Z0-9-]*)[^>]*style=["'][^"']*$/.exec(i);if(e&&t){const n=t(e[1]);if(n&&!n.includes("style"))return null}return r[1]}return null}(n,t)),null===s)return null;if(i&&/\.[a-zA-Z_-]*$/.test(s))return null;if(/:[^;]*$/.test(s))return null;const r=/(?:^|;)\s*([a-zA-Z-]*)$/.exec(s);if(!r)return null;const o=r[1],l=n.pos-o.length,c=e();if(!c||0===c.length)return null;const d=o.toLowerCase(),f=c.filter(e=>e.toLowerCase().startsWith(d));if(0===f.length)return null;const u=f.map(e=>({label:e,type:"property",detail:"CSS property",apply:(t,n,s,i)=>{const r=":"===t.state.sliceDoc(i,i+1)?"":":";t.dispatch({changes:{from:s,to:i,insert:e+r},selection:{anchor:s+e.length+1}})}}));return{from:l,to:n.pos,options:u,validFor:/^[a-zA-Z-]*$/}}}const nr=l.html({matchClosingTags:!1});function sr(e={}){const{codeLanguages:t,defaultCodeLanguage:i,addKeymap:r=!0,base:{parser:c}=$n,completeHTMLTags:d=!0,completeWidgets:f=!0,completeMacros:u=!0,completeTiddlers:h=!0,completeFilterOperators:p=!0,completeFilterRunPrefixes:m=!0,getTiddlerTitles:g,isDraftTiddler:b,getImageTiddlerTitles:k,getMacroNames:x,getMacroParams:$,getWidgetNames:y,getWidgetAttributes:w,getFilterOperators:T,getFieldNames:S,getTagNames:C,getTypeNames:v,getFileExtensions:M,getFunctionNames:L,getVariableNames:P,getTiddlerIndexes:A,getTiddlerFields:E,getStoryViews:B,getDeserializers:I,getPageClasses:W,getCSSProperties:D,getCSSValues:F,getCSSValuesForProperty:N,htmlTagLanguage:O=nr,getSelfClosingWidgets:H,getWikiRules:_,disableCamelCaseLinks:z=!1,enableKaTeX:R=!1,getTabOutsideListBehavior:Z,getShiftTabOutsideListBehavior:V,getEnterIndentBehavior:K,getFilterBracketMode:X,skipNestedLanguageExtensions:j=!1,nestedLanguageExtensions:q,nestedLanguageCompletionSources:U,nestedLanguageCompletions:Q}=e;if(!(c instanceof an))throw new RangeError("Base parser provided to `tiddlywiki` should be a TiddlyWiki parser");const G=e.extensions?[e.extensions]:[];z&&G.push({remove:["CamelCaseLink"]}),R&&G.push({parseBlock:[ye],parseInline:[it]});let Y=null;Q&&Q.length>0?Y=e=>{for(const t of Q)if(t.language&&"function"==typeof t.language.isActiveAt&&t.language.isActiveAt(e.state,e.pos))return t.source(e);return null}:U&&Object.keys(U).length>0&&(Y=e=>{const t=a.syntaxTree(e.state).resolveInner(e.pos,-1).type.name;if(U.javascript){if(["Script","VariableDeclaration","FunctionDeclaration","ExpressionStatement","CallExpression","Identifier","String","Number","PropertyName","Statement","Expression","Block","ArrowFunction","ClassDeclaration","VariableName","PropertyDefinition","MemberExpression","BinaryExpression"].some(e=>t===e||t.includes(e)))return U.javascript(e)}if(U.python){if(["Script","FunctionDefinition","ClassDefinition","ImportStatement","Name"].some(e=>t===e||t.includes(e)))return U.python(e)}if(U.css){if(["StyleSheet","RuleSet","Declaration","Selector","PropertyName","Block"].some(e=>t===e||t.includes(e)))return U.css(e)}if(U.html){if(["Document","Element","OpenTag","CloseTag","TagName","Attribute"].some(e=>t===e||t.includes(e)))return U.html(e)}if(U.go){if(["SourceFile","FunctionDecl","VarDecl","TypeDecl","PackageClause","ImportDecl"].some(e=>t===e||t.includes(e)))return U.go(e)}if(U.sql){if(["Script","Statement","Keyword","Identifier","String","Number"].some(e=>t===e||t.includes(e)))return U.sql(e)}if(U.latex){if(["Document","Command","Environment","Group","Text"].some(e=>t===e||t.includes(e)))return U.latex(e)}if(U.sass||U.scss){if(["StyleSheet","RuleSet","Declaration","Selector","Mixin","Include"].some(e=>t===e||t.includes(e))){return(U.sass||U.scss)(e)}}return null});const J=function(e){return t=>{const n=t.pos,s=t.state.doc.lineAt(n),i=t.state.doc.sliceString(s.from,n),r=/^(\s*)```(\w*)$/.exec(i);if(!r)return null;if(Ji(t.state.doc,s.number,"```"))return null;const a=r[1],o=r[2],l=s.from+a.length+3,c=new Set,d=[];if(e&&Array.isArray(e))for(const t of e){const e=t.name.toLowerCase();if(c.has(e)||(c.add(e),d.push({label:e,type:"keyword",detail:"language",boost:10})),t.alias)for(const n of t.alias){const t=n.toLowerCase();c.has(t)||(c.add(t),d.push({label:t,type:"keyword",detail:`language (${e})`,boost:8}))}}if(0===d.length)return null;const f=o.toLowerCase(),u=f?d.filter(e=>e.label.toLowerCase().startsWith(f)):d;return 0===u.length?null:{from:l,to:n,options:u,validFor:/^\w*$/}}}(t),ee=function(e,t){return n=>{const s=n.pos,i=n.state.doc.lineAt(s),r=n.state.doc.sliceString(i.from,s),a=/^(\s*)\$\$\$([\w\/\-\.\+]*)$/.exec(r);if(!a)return null;if(Ji(n.state.doc,i.number,"$$$"))return null;const o=a[1],l=i.from+o.length+3,c=[],d=new Set;if(e){const t=e();for(const e of t)d.has(e)||(d.add(e),c.push({label:e,type:"type",detail:"content type",boost:10}))}if(t){const e=t();for(const t of e){const e=t.startsWith(".")?t:"."+t;d.has(e)||(d.add(e),c.push({label:e,type:"type",detail:"file extension",boost:8}))}}return 0===c.length?null:{from:l,to:s,options:c,validFor:/^[\w\/\-\.\+]*$/}}}(v,M),te=function(e){return function(t){if(!e)return null;const n=er(t);if(null===n)return null;const s=/\.([a-zA-Z_-][a-zA-Z0-9_-]*)?$/.exec(n);if(!s)return null;const i=s[1]||"",r=t.pos-i.length,a=e();if(!a||0===a.length)return null;const o=i.toLowerCase(),l=a.filter(e=>e.toLowerCase().startsWith(o));if(0===l.length)return null;const c=l.map(e=>({label:e,type:"class",detail:"CSS class"}));return{from:r,to:t.pos,options:c,validFor:/^[a-zA-Z_-][a-zA-Z0-9_-]*$/}}}(W),ne=tr(D,w),se=e=>e?.options?.length>0,ie=[bn,kn,a.indentOnInput(),a.syntaxHighlighting(ns),o.autocompletion({activateOnTyping:!0,override:[e=>{const t=J(e);if(se(t))return t;const n=ee(e);if(se(n))return n;const s=te(e);if(se(s))return s;const i=ne(e);if(se(i))return i;if(Y){const t=Y(e);if(se(t))return t}const r=e.state.languageDataAt("autocomplete",e.pos);for(const t of r){const n=t(e);if(se(n))return n}return null}]}),s.keymap.of(o.completionKeymap),Yn,as];let re;i instanceof a.LanguageSupport?re=i.language:i&&(re=i);const ae=is(t,re,c,w);if(G.push({wrap:ae}),r){const e=ss({getTabOutsideListBehavior:Z,getShiftTabOutsideListBehavior:V,getEnterIndentBehavior:K});ie.push(n.Prec.highest(s.keymap.of(e)))}let oe=c;if(G.length>0)for(const e of G)oe=oe.configure(e);const le=xn(oe);return ie.push(le.data.of({indentOnInput:/^\s*(<\/[a-zA-Z$][^>]*>|<%\s*(else|elseif|endif)[^%]*%>|\\end\s*)$/})),f&&(ie.push(le.data.of({autocomplete:Mi(y,H)})),ie.push(le.data.of({autocomplete:Li($,w,D)})),ie.push(le.data.of({autocomplete:hi(x,g,L,P,S,A,B,I,F,b,W,N)})),ie.push(le.data.of({autocomplete:mi(g,x,y,L,P,b,$)})),ie.push(le.data.of({autocomplete:Pi(y)})),ie.push(s.EditorView.inputHandler.of((e,t,n,s)=>{if('"'!==s&&"'"!==s)return!1;return"="!==e.state.sliceDoc(Math.max(0,t-1),t)||setTimeout(()=>{null===o.completionStatus(e.state)&&o.startCompletion(e)},10),!1})),ie.push(s.EditorView.inputHandler.of((e,t,n,s)=>{if("_"!==s)return!1;const i=e.state.sliceDoc(Math.max(0,t-3),t);return(i.endsWith("<_")||i.endsWith("<<_"))&&setTimeout(()=>{null===o.completionStatus(e.state)&&o.startCompletion(e)},10),!1})),ie.push(s.EditorView.inputHandler.of((e,t,n,s)=>{if("."!==s)return!1;return"style"===e.state.sliceDoc(Math.max(0,t-5),t).toLowerCase()&&setTimeout(()=>{null===o.completionStatus(e.state)&&o.startCompletion(e)},10),!1})),ie.push(s.EditorView.inputHandler.of((e,t,n,s)=>{if(">"!==s)return!1;if("/"===e.state.sliceDoc(Math.max(0,t-1),t))return!1;const i=e.state.sliceDoc(Math.max(0,t-50),t);if(/<\/(\$[a-zA-Z0-9\-\$\.]*|[a-zA-Z][a-zA-Z0-9\-]*)\s*$/.test(i))return!1;let r=a.syntaxTree(e.state).resolveInner(t,-1),o=null,l="",c=!1;for(;r&&!r.type.isTop;){const n=r.name;if("MacroCall"===n||"MacroName"===n)return!1;if(("AttributeValue"===n||"AttributeString"===n)&&t<r.to)return!1;if("InlineWidget"===n||"Widget"===n||"HTMLBlock"===n||"HTMLTag"===n||"IncompleteWidget"===n||"IncompleteHTMLTag"===n||"IncompleteHTMLBlock"===n){let t=!1,s=null;const i=r.cursor();if(i.firstChild())do{"WidgetName"!==i.name&&"TagName"!==i.name||(s=i.node),"TagMark"===i.name&&i.from>r.from&&(t=!0)}while(i.nextSibling());if(!t&&s){o=r,l=e.state.sliceDoc(s.from,s.to),c="InlineWidget"===n||"Widget"===n||"IncompleteWidget"===n;break}}r=r.parent}if(!o||!l)return!1;if(c){const e=new Set(ls);if(H)for(const t of H())e.add(t);if(e.has(l))return!1}else if(os.has(l.toLowerCase()))return!1;const d=`</${l}>`,f=e.state.sliceDoc(t+1,e.state.doc.length),u=c,h=e=>u?e===l:e.toLowerCase()===l.toLowerCase(),p=(()=>{let e=0;const t=f.length;let n=0;for(;e<t;){const s=f[e];if("`"!==s||"`"!==f[e+1]||"`"!==f[e+2])if("$"!==s||"$"!==f[e+1]||"$"!==f[e+2])if("<"!==s||"!"!==f[e+1]||"-"!==f[e+2]||"-"!==f[e+3])if('"'!==s||'"'!==f[e+1]||'"'!==f[e+2]){if("<"===s&&"<"===f[e+1]){e+=2;let n=1;for(;e<t&&n>0;)"<"===f[e]&&"<"===f[e+1]?(n++,e+=2):">"===f[e]&&">"===f[e+1]?(n--,e+=2):e++;continue}if("{"!==s||"{"!==f[e+1]||"{"!==f[e+2])if("{"!==s||"{"!==f[e+1])if("`"!==s||"`"===f[e+1]){if("<"===s&&"/"===f[e+1]){e+=2;let s="";for(;e<t&&/[a-zA-Z0-9\-_$.]/.test(f[e]);)s+=f[e],e++;for(;e<t&&/\s/.test(f[e]);)e++;if(">"===f[e]&&h(s)){if(0===n)return!0;n--}e++;continue}if("<"===s&&/[a-zA-Z$]/.test(f[e+1])){e++;let s="";for(;e<t&&/[a-zA-Z0-9\-_$.]/.test(f[e]);)s+=f[e],e++;if(h(s)){let s=!1,i=!1;for(;e<t&&!i;){const n=f[e];if('"'!==n||'"'!==f[e+1]||'"'!==f[e+2]){if('"'===n||"'"===n){const s=n;for(e++;e<t&&f[e]!==s;)"\\"===f[e]&&e++,e++;e++;continue}if("<"===n&&"<"===f[e+1]){e+=2;let n=1;for(;e<t&&n>0;)"<"===f[e]&&"<"===f[e+1]?(n++,e+=2):">"===f[e]&&">"===f[e+1]?(n--,e+=2):e++;continue}if("{"!==n||"{"!==f[e+1]||"{"!==f[e+2])if("{"!==n||"{"!==f[e+1])if("`"!==n)"/"===n&&">"===f[e+1]?(s=!0,i=!0,e+=2):">"===n?(i=!0,e++):e++;else if("`"===f[e+1]&&"`"===f[e+2]){for(e+=3;e<t&&("`"!==f[e]||"`"!==f[e+1]||"`"!==f[e+2]);)e++;e+=3}else{for(e++;e<t&&"`"!==f[e];)e++;e++}else{for(e+=2;e<t&&("}"!==f[e]||"}"!==f[e+1]);)e++;e+=2}else{for(e+=3;e<t&&("}"!==f[e]||"}"!==f[e+1]||"}"!==f[e+2]);)e++;e+=3}}else{for(e+=3;e<t&&('"'!==f[e]||'"'!==f[e+1]||'"'!==f[e+2]);)e++;e+=3}}i&&!s&&n++}continue}e++}else{for(e++;e<t&&"`"!==f[e];)e++;e++}else{for(e+=2;e<t&&("}"!==f[e]||"}"!==f[e+1]);)e++;e+=2}else{for(e+=3;e<t&&("}"!==f[e]||"}"!==f[e+1]||"}"!==f[e+2]);)e++;e+=3}}else{for(e+=3;e<t&&('"'!==f[e]||'"'!==f[e+1]||'"'!==f[e+2]);)e++;e+=3}else{for(e+=4;e<t&&("-"!==f[e]||"-"!==f[e+1]||">"!==f[e+2]);)e++;e+=3}else{for(e+=3;e<t&&("$"!==f[e]||"$"!==f[e+1]||"$"!==f[e+2]);)e++;e+=3}else{for(e+=3;e<t&&("`"!==f[e]||"`"!==f[e+1]||"`"!==f[e+2]);)e++;e+=3}}return!1})();return p?(e.dispatch({changes:{from:t,to:t,insert:">"},selection:{anchor:t+1}}),!0):(e.dispatch({changes:{from:t,to:t,insert:">"+d},selection:{anchor:t+1}}),!0)}))),u&&(ie.push(le.data.of({autocomplete:ri()})),ie.push(le.data.of({autocomplete:ni(x,L,P)})),$&&ie.push(le.data.of({autocomplete:si($)}))),h&&(ie.push(le.data.of({autocomplete:Hi(g,k,b)})),ie.push(le.data.of({autocomplete:_i(g,b)})),ie.push(le.data.of({autocomplete:zi(E,A)}))),d&&(ie.push(le.data.of({autocomplete:$i})),ie.push(le.data.of({autocomplete:yi(D)})),ie.push(le.data.of({autocomplete:e=>{const t=e.state.sliceDoc(Math.max(0,e.pos-100),e.pos);return/<[a-zA-Z][^>]*$/.test(t)?/<\$[\w\-\.]*$/.test(t)||/<\$[\w\-\.]+\s+[^>]*$/.test(t)?null:l.htmlCompletionSource(e):null}}))),p&&ie.push(le.data.of({autocomplete:Di(T,X,$)})),m&&ie.push(le.data.of({autocomplete:Fi})),p&&ie.push(le.data.of({autocomplete:Ni(S)})),p&&ie.push(le.data.of({autocomplete:Oi(g,C,S,L,P,v)})),ie.push(le.data.of({autocomplete:Zi})),ie.push(le.data.of({autocomplete:Ki})),ie.push(le.data.of({autocomplete:Ui})),ie.push(le.data.of({autocomplete:ji})),ie.push(le.data.of({autocomplete:qi})),ie.push(le.data.of({autocomplete:Xi})),ie.push(le.data.of({autocomplete:Gi(_)})),ie.push(le.data.of({autocomplete:Yi(g,x,y,L,P,b)})),new a.LanguageSupport(le,ie)}const ir=$n,rr=$n;let ar=null,or=null;const lr=["","text/vnd.tiddlywiki","text/x-tiddlywiki","application/x-tiddler-dictionary"],cr="tiddlywikiLanguage",dr=n.Prec.high(s.keymap.of([{key:"Enter",run:Cn},{key:"Backspace",run:Mn}]));function fr(e){return{state:e.state,dispatch:e.dispatch.bind(e)}}const ur={tiddlerTitles:null,imageTiddlerTitles:null,tagNames:null,macroNames:null,widgetNames:null,globalWidgetDefs:null,filterOperators:null,wikiRules:null};let hr=!1;function pr(){hr||"undefined"!=typeof $tw&&$tw.wiki&&(hr=!0,$tw.wiki.addEventListener("change",e=>{if(!e)return;let t=!1,n=!1,s=!1,i=!1;for(const r of Object.keys(e)){const a=e[r];if((a.deleted||a.created)&&(t=!0,r.startsWith("$:/")&&(s=!0),i=!0,n=!0),a.modified){const e=$tw.wiki.getTiddler(r);if(e){e.fields.tags&&(n=!0),(e.hasTag("$:/tags/Macro")||e.hasTag("$:/tags/Global"))&&(s=!0);(e.fields.type||"").startsWith("image/")&&(i=!0)}}}t&&ur.tiddlerTitles&&(ur.tiddlerTitles.valid=!1),n&&ur.tagNames&&(ur.tagNames.valid=!1),s&&ur.macroNames&&(ur.macroNames.valid=!1),s&&ur.globalWidgetDefs&&(ur.globalWidgetDefs.valid=!1),s&&ur.widgetNames&&(ur.widgetNames.valid=!1),i&&ur.imageTiddlerTitles&&(ur.imageTiddlerTitles.valid=!1)}))}function mr(e,t){const n=ur[e];if(n&&n.valid)return n.data;const s=t();return ur[e]={data:s,valid:!0},s}function gr(){return"undefined"==typeof $tw?[]:(pr(),mr("tiddlerTitles",()=>{try{const e=or?.widget?.wiki||$tw.wiki;if(!e)return[];const t=[];if(e.eachShadowPlusTiddlers)e.eachShadowPlusTiddlers((e,n)=>{t.push(n)});else{const n=e.allTitles?e.allTitles():[],s=e.allShadowTitles?e.allShadowTitles():[];t.push(...n,...s)}const n=[...new Set(t)],s=new Set;for(const t of n){const n=e.getTiddler(t);n&&n.fields["draft.of"]&&s.add(t)}return n.sort((e,t)=>{const n=s.has(e);if(n!==s.has(t))return n?1:-1;const i=e.startsWith("$:/");return i!==t.startsWith("$:/")?i?1:-1:e.localeCompare(t)})}catch(e){return[]}}))}function br(){return"undefined"==typeof $tw?[]:(pr(),mr("imageTiddlerTitles",()=>{try{const e=or?.widget?.wiki||$tw.wiki;if(!e)return[];const t=or?.widget;return(t?e.filterTiddlers("[all[tiddlers+shadows]is[image]]",t):e.filterTiddlers("[all[tiddlers+shadows]is[image]]"))||[]}catch(e){return[]}}))}function kr(e){if("undefined"==typeof $tw)return!1;try{const t=or?.widget?.wiki||$tw.wiki;if(!t)return!1;const n=t.getTiddler(e);return!(!n||!n.fields["draft.of"])}catch(e){return!1}}function xr(){return"undefined"==typeof $tw?[]:(pr(),mr("macroNames",()=>{try{const e=[];$tw.macros&&e.push(...Object.keys($tw.macros));const t=or?.widget?.wiki||$tw.wiki;if(t){const n=t.filterTiddlers("[all[tiddlers+shadows]tag[$:/tags/Macro]] [all[tiddlers+shadows]tag[$:/tags/Global]]")||[];for(const s of n){const n=t.getTiddler(s);if(n){const t=(n.fields.text||"").matchAll(/\\(?:define|procedure|function)\s+([^\s(]+)/g);for(const n of t)e.push(n[1])}}}return[...new Set(e)]}catch(e){return[]}}))}function $r(e){const t=[];if(e&&e.trim()){const n=e.split(",");for(const e of n){const n=e.trim().split(":")[0].trim();n&&t.push(n)}}return t}function yr(){return"undefined"==typeof $tw?{}:(pr(),mr("globalWidgetDefs",()=>{try{const e={},t=or?.widget?.wiki||$tw.wiki;if(t){const n=t.filterTiddlers("[all[tiddlers+shadows]tag[$:/tags/Macro]] [all[tiddlers+shadows]tag[$:/tags/Global]]")||[];for(const s of n){const n=t.getTiddler(s);if(n){const t=n.fields.text||"",s=/\\widget\s+(\$[^\s(]+)(?:\(([^)]*)\))?/g;let i;for(;null!==(i=s.exec(t));){const n=i[1],s=i[2];if(!e[n]){let r=$r(s);if(0===r.length){const e=t.slice(i.index+i[0].length),n=/^\s*\n?\s*\\parameters\s*\(([^)]*)\)/.exec(e);n&&(r=$r(n[1]))}e[n]=r}}}}}return e}catch(e){return{}}}))}function wr(){return"undefined"==typeof $tw?[]:(pr(),mr("widgetNames",()=>{try{const e=[],t=new Set;if($tw.widgets)for(const n of Object.keys($tw.widgets)){const s="$"+n;t.has(s)||(t.add(s),e.push(s))}$tw.modules?.forEachModuleOfType&&($tw.modules.forEachModuleOfType("widget",(n,s)=>{if(s)for(const n of Object.keys(s))if(n&&"string"==typeof n){const s="$"+n;t.has(s)||(t.add(s),e.push(s))}}),$tw.modules.forEachModuleOfType("widget-subclass",(n,s)=>{if(s){const n=s.name||s.baseClass;if(n&&"string"==typeof n){const s="$"+n;t.has(s)||(t.add(s),e.push(s))}}}));const n=yr();for(const s of Object.keys(n))t.has(s)||(t.add(s),e.push(s));return e}catch(e){return[]}}))}function Tr(){return"undefined"==typeof $tw?[]:mr("filterOperators",()=>{try{const e=or?.widget?.wiki||$tw.wiki;return e?.filterOperators?Object.keys(e.filterOperators).sort():[]}catch(e){return[]}})}function Sr(){return"undefined"==typeof $tw?[]:(pr(),mr("tagNames",()=>{try{const e=or?.widget?.wiki||$tw.wiki;if(!e)return[];const t=or?.widget;return(t?e.filterTiddlers("[all[tiddlers+shadows]is[tag]]",t):e.filterTiddlers("[all[tiddlers+shadows]is[tag]]"))||[]}catch(e){return[]}}))}function Cr(e){if("undefined"==typeof $tw||!e)return[];try{const t=or?.widget?.wiki||$tw.wiki;if(!t)return[];const n=t.getTiddler(e);return n&&n.fields?Object.keys(n.fields).sort():[]}catch(e){return[]}}function vr(e){if("undefined"==typeof $tw||!e)return[];try{const t=or?.widget?.wiki||$tw.wiki;if(!t)return[];const n=t.getTiddlerDataCached(e);return n&&"object"==typeof n?Object.keys(n).sort():[]}catch(e){return[]}}function Mr(e){if("undefined"==typeof $tw)return null;try{if($tw.macros&&$tw.macros[e]&&$tw.macros[e].params){const t=$tw.macros[e].params;if(Array.isArray(t))return t.map(e=>e.name)}const t=or?.widget;if(t?.getVariableInfo){const n=t.getVariableInfo(e);if(n&&n.params&&Array.isArray(n.params))return n.params.map(e=>e.name)}return null}catch(e){return null}}function Lr(e){if("undefined"==typeof $tw)return null;try{const t=or?.widget;if(t?.getVariableInfo){const n=t.getVariableInfo(e);if(n&&n.params&&Array.isArray(n.params))return n.params.map(e=>e.name)}const n=yr();return n[e]&&n[e].length>0?n[e]:null}catch(e){return null}}function Pr(){const e=or;return e?.options?.codeLanguages?e.options.codeLanguages:[]}function Ar(){return"undefined"==typeof $tw?[]:mr("wikiRules",()=>{try{const e=[],t=$tw.modules.getModulesByTypeAsHashmap("wikirule");if(!t)return[];for(const n of Object.keys(t)){const s=t[n];if(!s||!s.name)continue;const i=[];s.types&&(s.types.pragma&&i.push("pragma"),s.types.block&&i.push("block"),s.types.inline&&i.push("inline")),e.push({name:s.name,types:i.join(", ")||"unknown"})}return e.sort((e,t)=>e.name.localeCompare(t.name))}catch(e){return[]}})}const Er=(()=>{if("undefined"==typeof $tw)return!1;try{const e=$tw.wiki?.getTiddlerText("$:/config/WikiParserRules/Inline/wikilink","enable");return"disable"===e}catch(e){return!1}})();function Br(){if("undefined"==typeof $tw)return!1;try{if($tw.modules&&$tw.modules.forEachModuleOfType){let e=!1;return $tw.modules.forEachModuleOfType("widget",(t,n)=>{n&&(n.latex||n.katex)&&(e=!0)}),e}return!1}catch(e){return!1}}function Ir(e,t=!1){const n=e.options||{};return or=e.engine,sr({addKeymap:!1,codeLanguages:Pr(),completeHTMLTags:!1!==n.completeHTMLTags,completeWidgets:!1!==n.completeWidgets,completeMacros:!1!==n.completeMacros,completeTiddlers:!1!==n.completeTiddlers,completeFilterOperators:!1!==n.completeFilterOperators,completeFilterRunPrefixes:!1!==n.completeFilterRunPrefixes,disableCamelCaseLinks:Er,enableKaTeX:Br(),skipNestedLanguageExtensions:t,getTiddlerTitles:gr,isDraftTiddler:kr,getImageTiddlerTitles:br,getMacroNames:xr,getMacroParams:Mr,getWidgetNames:wr,getWidgetAttributes:Lr,getFilterOperators:Tr,getTagNames:Sr,getTiddlerFields:Cr,getTiddlerIndexes:vr,getWikiRules:Ar})}const Wr={name:"tiddlywiki-syntax",description:"TiddlyWiki5 Wikitext syntax highlighting and editing support",priority:100,init(e){ar=e},condition(e){const t=e.tiddlerType;return lr.includes(t||"")},registerCompartments(){if(!ar)return{};const e=ar.state.Compartment;return{[cr]:new e}},getExtensions(e){const t=[],n=e.engine,s=n?._compartments,i=Ir(e,!1);if(s?.[cr]?(t.push(s[cr].of(i.language)),i.support&&t.push(i.support)):t.push(i),!e.readOnly){const n=e.engine?.widget?.wiki||("undefined"!=typeof $tw?$tw.wiki:null);"default"===(n?.getTiddlerText?.("$:/config/codemirror-6/editor/keymap","default")??"default")&&t.push(dr)}return t},getCompartmentContent(e){const t=Ir(e,!0);return t&&"object"==typeof t&&"language"in t?[t.language]:[]},extendAPI:(e,t)=>({toggleBold:()=>!(e._destroyed||!e.view)&&En(fr(e.view)),toggleItalic:()=>!(e._destroyed||!e.view)&&Bn(fr(e.view)),toggleUnderline:()=>!(e._destroyed||!e.view)&&In(fr(e.view)),toggleStrikethrough:()=>!(e._destroyed||!e.view)&&Wn(fr(e.view)),toggleSuperscript:()=>!(e._destroyed||!e.view)&&Dn(fr(e.view)),toggleSubscript:()=>!(e._destroyed||!e.view)&&Fn(fr(e.view)),toggleInlineCode:()=>!(e._destroyed||!e.view)&&Nn(fr(e.view)),insertWikiLink:()=>!(e._destroyed||!e.view)&&On(fr(e.view)),insertTransclusion:()=>!(e._destroyed||!e.view)&&Hn(fr(e.view)),setHeading(t){if(e._destroyed||!e.view)return!1;const n=[null,zn,Rn,Zn,Vn,Kn,Xn][t];return!!n&&n(fr(e.view))},removeHeading:()=>!(e._destroyed||!e.view)&&jn(fr(e.view)),toggleBulletList:()=>!(e._destroyed||!e.view)&&Un(fr(e.view)),toggleNumberedList:()=>!(e._destroyed||!e.view)&&Qn(fr(e.view)),insertCodeBlock:()=>!(e._destroyed||!e.view)&&Gn(fr(e.view))}),registerEvents:(e,t)=>({textOperation(t){if(t&&!e._destroyed&&(null===t.replacement||void 0===t.replacement))switch(t.type){case"toggle-bold":e.toggleBold?.();break;case"toggle-italic":e.toggleItalic?.();break;case"toggle-underline":e.toggleUnderline?.();break;case"toggle-strikethrough":e.toggleStrikethrough?.();break;case"toggle-superscript":e.toggleSuperscript?.();break;case"toggle-subscript":e.toggleSubscript?.();break;case"toggle-code":e.toggleInlineCode?.();break;case"insert-link":e.insertWikiLink?.();break;case"insert-transclusion":e.insertTransclusion?.();break;case"set-heading":"number"==typeof t.level&&e.setHeading?.(t.level);break;case"remove-heading":e.removeHeading?.();break;case"toggle-bullet-list":e.toggleBulletList?.();break;case"toggle-numbered-list":e.toggleNumberedList?.();break;case"insert-code-block":e.insertCodeBlock?.()}}}),destroy(e){}};exports.TiddlyWikiLanguage=rr,exports.default=Wr,exports.deleteBracketPair=Pn,exports.deleteMarkupBackward=Mn,exports.indentList=es,exports.insertCodeBlock=Gn,exports.insertHorizontalRule=({state:e,dispatch:t})=>{let n=e.doc.lineAt(e.selection.main.from);return t(e.update({changes:{from:n.to,insert:"\n---\n"},scrollIntoView:!0,userEvent:"input"})),!0},exports.insertMacroCall=({state:e,dispatch:t})=>{let s=e.changeByRange(t=>{if(t.empty)return{range:n.EditorSelection.cursor(t.from+2),changes:{from:t.from,insert:"<<>>"}};{let s=e.doc.sliceString(t.from,t.to);return{range:n.EditorSelection.range(t.from+2,t.from+2+s.length),changes:{from:t.from,to:t.to,insert:`<<${s}>>`}}}});return t(e.update(s,{scrollIntoView:!0,userEvent:"input"})),!0},exports.insertNewlineContinueMarkup=Cn,exports.insertNewlineContinueMarkupCommand=Sn,exports.insertTransclusion=Hn,exports.insertWikiLink=On,exports.listMarkerDowngrade=Jn,exports.listMarkerUpgradeHandler=Yn,exports.outdentList=ts,exports.plugin=Wr,exports.removeHeading=jn,exports.setHeading1=zn,exports.setHeading2=Rn,exports.setHeading3=Zn,exports.setHeading4=Vn,exports.setHeading5=Kn,exports.setHeading6=Xn,exports.tiddlywiki=sr,exports.tiddlywikiBaseLanguage=ir,exports.tiddlywikiLanguage=$n,exports.toggleBold=En,exports.toggleBulletList=Un,exports.toggleInlineCode=Nn,exports.toggleItalic=Bn,exports.toggleNumberedList=Qn,exports.toggleStrikethrough=Wn,exports.toggleSubscript=Fn,exports.toggleSuperscript=Dn,exports.toggleUnderline=In;
