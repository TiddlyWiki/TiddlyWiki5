"use strict";var e=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-view.js"),t=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-state.js");function i(){var e=arguments[0];"string"==typeof e&&(e=document.createElement(e));var t=1,i=arguments[1];if(i&&"object"==typeof i&&null==i.nodeType&&!Array.isArray(i)){for(var n in i)if(Object.prototype.hasOwnProperty.call(i,n)){var s=i[n];"string"==typeof s?e.setAttribute(n,s):null!=s&&(e[n]=s)}t++}for(;t<arguments.length;t++)o(e,arguments[t]);return e}function o(e,t){if("string"==typeof t)e.appendChild(document.createTextNode(t));else if(null==t);else if(null!=t.nodeType)e.appendChild(t);else{if(!Array.isArray(t))throw new RangeError("Unsupported child node: "+t);for(var i=0;i<t.length;i++)o(e,t[i])}}class n{constructor(e,t,i){this.from=e,this.to=t,this.diagnostic=i}}class s{constructor(e,t,i){this.diagnostics=e,this.panel=t,this.selected=i}static init(i,o,n){let l=n.facet(y).markerFilter;l&&(i=l(i,n));let a=i.slice().sort((e,t)=>e.from-t.from||e.to-t.to),c=new t.RangeSetBuilder,d=[],f=0,u=n.doc.iter(),m=0,h=n.doc.length;for(let t=0;;){let i,o,n=t==a.length?null:a[t];if(!n&&!d.length)break;if(d.length)i=f,o=d.reduce((e,t)=>Math.min(e,t.to),n&&n.from>i?n.from:1e8);else{if(i=n.from,i>h)break;o=n.to,d.push(n),t++}for(;t<a.length;){let e=a[t];if(e.from!=i||!(e.to>e.from||e.to==i)){o=Math.min(e.from,o);break}d.push(e),t++,o=Math.min(e.to,o)}o=Math.min(o,h);let s=!1;if(d.some(e=>e.from==i&&(e.to==o||o==h))&&(s=i==o,!s&&o-i<10)){let e=i-(m+u.value.length);e>0&&(u.next(e),m=i);for(let e=i;;){if(e>=o){s=!0;break}if(!u.lineBreak&&m+u.value.length>e)break;e=m+u.value.length,m+=u.value.length,u.next()}}let r=F(d);if(s)c.add(i,i,e.Decoration.widget({widget:new R(r),diagnostics:d.slice()}));else{let t=d.reduce((e,t)=>t.markClass?e+" "+t.markClass:e,"");c.add(i,o,e.Decoration.mark({class:"cm-lintRange cm-lintRange-"+r+t,diagnostics:d.slice(),inclusiveEnd:d.some(e=>e.to>o)}))}if(f=o,f==h)break;for(let e=0;e<d.length;e++)d[e].to<=f&&d.splice(e--,1)}let g=c.finish();return new s(g,o,r(g))}}function r(e,t=null,i=0){let o=null;return e.between(i,1e9,(e,i,{spec:s})=>{if(!(t&&s.diagnostics.indexOf(t)<0))if(o){if(s.diagnostics.indexOf(o.diagnostic)<0)return!1;o=new n(o.from,i,o.diagnostic)}else o=new n(e,i,t||s.diagnostics[0])}),o}function l(e,t){let i=t.pos,o=t.end||i,n=e.state.facet(y).hideOn(e,i,o);if(null!=n)return n;let s=e.startState.doc.lineAt(t.pos);return!(!e.effects.some(e=>e.is(d))&&!e.changes.touchesRange(s.from,Math.max(s.to,o)))}function a(e,i){return e.field(m,!1)?i:i.concat(t.StateEffect.appendConfig.of(q))}function c(e,t){return{effects:a(e,[d.of(t)])}}const d=t.StateEffect.define(),f=t.StateEffect.define(),u=t.StateEffect.define(),m=t.StateField.define({create:()=>new s(e.Decoration.none,null,null),update(e,t){if(t.docChanged&&e.diagnostics.size){let i=e.diagnostics.map(t.changes),o=null,n=e.panel;if(e.selected){let n=t.changes.mapPos(e.selected.from,1);o=r(i,e.selected.diagnostic,n)||r(i,null,n)}!i.size&&n&&t.state.facet(y).autoPanel&&(n=null),e=new s(i,n,o)}for(let i of t.effects)if(i.is(d)){let o=t.state.facet(y).autoPanel?i.value.length?A.open:null:e.panel;e=s.init(i.value,o,t.state)}else i.is(f)?e=new s(e.diagnostics,i.value?A.open:null,e.selected):i.is(u)&&(e=new s(e.diagnostics,e.panel,i.value));return e},provide:t=>[e.showPanel.from(t,e=>e.panel),e.EditorView.decorations.from(t,e=>e.diagnostics)]});const h=e.Decoration.mark({class:"cm-lintRange cm-lintRange-active"});function g(e,t,i){let o,{diagnostics:n}=e.state.field(m),s=-1,r=-1;n.between(t-(i<0?1:0),t+(i>0?1:0),(e,n,{spec:l})=>{if(t>=e&&t<=n&&(e==n||(t>e||i>0)&&(t<n||i<0)))return o=l.diagnostics,s=e,r=n,!1});let l=e.state.facet(y).tooltipFilter;return o&&l&&(o=l(o,e.state)),o?{pos:s,end:r,above:e.state.doc.lineAt(s).to<r,create:()=>({dom:p(e,o)})}:null}function p(e,t){return i("ul",{class:"cm-tooltip-lint"},t.map(t=>S(e,t,!1)))}const v=t=>{let i=t.state.field(m,!1);i&&i.panel||t.dispatch({effects:a(t.state,[f.of(!0)])});let o=e.getPanel(t,A.open);return o&&o.dom.querySelector(".cm-panel-lint ul").focus(),!0},w=e=>{let t=e.state.field(m,!1);return!(!t||!t.panel)&&(e.dispatch({effects:f.of(!1)}),!0)},b=e=>{let t=e.state.field(m,!1);if(!t)return!1;let i=e.state.selection.main,o=t.diagnostics.iter(i.to+1);return!(!o.value&&(o=t.diagnostics.iter(0),!o.value||o.from==i.from&&o.to==i.to))&&(e.dispatch({selection:{anchor:o.from,head:o.to},scrollIntoView:!0}),!0)},k=[{key:"Mod-Shift-m",run:v,preventDefault:!0},{key:"F8",run:b}],x=e.ViewPlugin.fromClass(class{constructor(e){this.view=e,this.timeout=-1,this.set=!0;let{delay:t}=e.state.facet(y);this.lintTime=Date.now()+t,this.run=this.run.bind(this),this.timeout=setTimeout(this.run,t)}run(){clearTimeout(this.timeout);let t=Date.now();if(t<this.lintTime-10)this.timeout=setTimeout(this.run,this.lintTime-t);else{this.set=!1;let{state:t}=this.view,{sources:i}=t.facet(y);i.length&&function(e,t,i){let o=[],n=-1;for(let s of e)s.then(i=>{o.push(i),clearTimeout(n),o.length==e.length?t(o):n=setTimeout(()=>t(o),200)},i)}(i.map(e=>Promise.resolve(e(this.view))),e=>{this.view.state.doc==t.doc&&this.view.dispatch(c(this.view.state,e.reduce((e,t)=>e.concat(t))))},t=>{e.logException(this.view.state,t)})}}update(e){let t=e.state.facet(y);(e.docChanged||t!=e.startState.facet(y)||t.needsRefresh&&t.needsRefresh(e))&&(this.lintTime=Date.now()+t.delay,this.set||(this.set=!0,this.timeout=setTimeout(this.run,t.delay)))}force(){this.set&&(this.lintTime=Date.now(),this.run())}destroy(){clearTimeout(this.timeout)}});const y=t.Facet.define({combine:e=>({sources:e.map(e=>e.source).filter(e=>null!=e),...t.combineConfig(e.map(e=>e.config),{delay:750,markerFilter:null,tooltipFilter:null,needsRefresh:null,hideOn:()=>null},{delay:Math.max,markerFilter:C,tooltipFilter:C,needsRefresh:(e,t)=>e?t?i=>e(i)||t(i):e:t,hideOn:(e,t)=>e?t?(i,o,n)=>e(i,o,n)||t(i,o,n):e:t,autoPanel:(e,t)=>e||t})})});function C(e,t){return e?t?(i,o)=>t(e(i,o),o):e:t}function T(e){let t=[];if(e)e:for(let{name:i}of e){for(let e=0;e<i.length;e++){let o=i[e];if(/[a-zA-Z]/.test(o)&&!t.some(e=>e.toLowerCase()==o.toLowerCase())){t.push(o);continue e}}t.push("")}return t}function S(e,t,o){var n;let s=o?T(t.actions):[];return i("li",{class:"cm-diagnostic cm-diagnostic-"+t.severity},i("span",{class:"cm-diagnosticText"},t.renderMessage?t.renderMessage(e):t.message),null===(n=t.actions)||void 0===n?void 0:n.map((o,n)=>{let l=!1,a=i=>{if(i.preventDefault(),l)return;l=!0;let n=r(e.state.field(m).diagnostics,t);n&&o.apply(e,n.from,n.to)},{name:c}=o,d=s[n]?c.indexOf(s[n]):-1,f=d<0?c:[c.slice(0,d),i("u",c.slice(d,d+1)),c.slice(d+1)];return i("button",{type:"button",class:"cm-diagnosticAction"+(o.markClass?" "+o.markClass:""),onclick:a,onmousedown:a,"aria-label":` Action: ${c}${d<0?"":` (access key "${s[n]})"`}.`},f)}),t.source&&i("div",{class:"cm-diagnosticSource"},t.source))}class R extends e.WidgetType{constructor(e){super(),this.sev=e}eq(e){return e.sev==this.sev}toDOM(){return i("span",{class:"cm-lintPoint cm-lintPoint-"+this.sev})}}class D{constructor(e,t){this.diagnostic=t,this.id="item_"+Math.floor(4294967295*Math.random()).toString(16),this.dom=S(e,t,!0),this.dom.id=this.id,this.dom.setAttribute("role","option")}}class A{constructor(e){this.view=e,this.items=[];this.list=i("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:t=>{if(27==t.keyCode)w(this.view),this.view.focus();else if(38==t.keyCode||33==t.keyCode)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(40==t.keyCode||34==t.keyCode)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(36==t.keyCode)this.moveSelection(0);else if(35==t.keyCode)this.moveSelection(this.items.length-1);else if(13==t.keyCode)this.view.focus();else{if(!(t.keyCode>=65&&t.keyCode<=90&&this.selectedIndex>=0))return;{let{diagnostic:i}=this.items[this.selectedIndex],o=T(i.actions);for(let n=0;n<o.length;n++)if(o[n].toUpperCase().charCodeAt(0)==t.keyCode){let t=r(this.view.state.field(m).diagnostics,i);t&&i.actions[n].apply(e,t.from,t.to)}}}t.preventDefault()},onclick:e=>{for(let t=0;t<this.items.length;t++)this.items[t].dom.contains(e.target)&&this.moveSelection(t)}}),this.dom=i("div",{class:"cm-panel-lint"},this.list,i("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>w(this.view)},"Ã—")),this.update()}get selectedIndex(){let e=this.view.state.field(m).selected;if(!e)return-1;for(let t=0;t<this.items.length;t++)if(this.items[t].diagnostic==e.diagnostic)return t;return-1}update(){let{diagnostics:e,selected:t}=this.view.state.field(m),i=0,o=!1,n=null,s=new Set;for(e.between(0,this.view.state.doc.length,(e,r,{spec:l})=>{for(let e of l.diagnostics){if(s.has(e))continue;s.add(e);let r,l=-1;for(let t=i;t<this.items.length;t++)if(this.items[t].diagnostic==e){l=t;break}l<0?(r=new D(this.view,e),this.items.splice(i,0,r),o=!0):(r=this.items[l],l>i&&(this.items.splice(i,l-i),o=!0)),t&&r.diagnostic==t.diagnostic?r.dom.hasAttribute("aria-selected")||(r.dom.setAttribute("aria-selected","true"),n=r):r.dom.hasAttribute("aria-selected")&&r.dom.removeAttribute("aria-selected"),i++}});i<this.items.length&&!(1==this.items.length&&this.items[0].diagnostic.from<0);)o=!0,this.items.pop();0==this.items.length&&(this.items.push(new D(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")})),o=!0),n?(this.list.setAttribute("aria-activedescendant",n.id),this.view.requestMeasure({key:this,read:()=>({sel:n.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:e,panel:t})=>{let i=t.height/this.list.offsetHeight;e.top<t.top?this.list.scrollTop-=(t.top-e.top)/i:e.bottom>t.bottom&&(this.list.scrollTop+=(e.bottom-t.bottom)/i)}})):this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant"),o&&this.sync()}sync(){let e=this.list.firstChild;function t(){let t=e;e=t.nextSibling,t.remove()}for(let i of this.items)if(i.dom.parentNode==this.list){for(;e!=i.dom;)t();e=i.dom.nextSibling}else this.list.insertBefore(i.dom,e);for(;e;)t()}moveSelection(e){if(this.selectedIndex<0)return;let t=r(this.view.state.field(m).diagnostics,this.items[e].diagnostic);t&&this.view.dispatch({selection:{anchor:t.from,head:t.to},scrollIntoView:!0,effects:u.of(t)})}static open(e){return new A(e)}}function L(e,t='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${t}>${encodeURIComponent(e)}</svg>')`}function P(e){return L(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${e}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const E=e.EditorView.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnostic-hint":{borderLeft:"5px solid #66d"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px",cursor:"pointer"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:P("#d11")},".cm-lintRange-warning":{backgroundImage:P("orange")},".cm-lintRange-info":{backgroundImage:P("#999")},".cm-lintRange-hint":{backgroundImage:P("#66d")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-lintPoint-hint":{"&:after":{borderBottomColor:"#66d"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}});function M(e){return"error"==e?4:"warning"==e?3:"info"==e?2:1}function F(e){let t="hint",i=1;for(let o of e){let e=M(o.severity);e>i&&(i=e,t=o.severity)}return t}class I extends e.GutterMarker{constructor(e){super(),this.diagnostics=e,this.severity=F(e)}toDOM(e){let t=document.createElement("div");t.className="cm-lint-marker cm-lint-marker-"+this.severity;let i=this.diagnostics,o=e.state.facet(H).tooltipFilter;return o&&(i=o(i,e.state)),i.length&&(t.onmouseover=()=>function(e,t,i){function o(){let o=e.elementAtHeight(t.getBoundingClientRect().top+5-e.documentTop);e.coordsAtPos(o.from)&&e.dispatch({effects:$.of({pos:o.from,above:!1,clip:!1,create:()=>({dom:p(e,i),getCoords:()=>t.getBoundingClientRect()})})}),t.onmouseout=t.onmousemove=null,function(e,t){let i=o=>{let n=t.getBoundingClientRect();if(!(o.clientX>n.left-10&&o.clientX<n.right+10&&o.clientY>n.top-10&&o.clientY<n.bottom+10)){for(let e=o.target;e;e=e.parentNode)if(1==e.nodeType&&e.classList.contains("cm-tooltip-lint"))return;window.removeEventListener("mousemove",i),e.state.field(j)&&e.dispatch({effects:$.of(null)})}};window.addEventListener("mousemove",i)}(e,t)}let{hoverTime:n}=e.state.facet(H),s=setTimeout(o,n);t.onmouseout=()=>{clearTimeout(s),t.onmouseout=t.onmousemove=null},t.onmousemove=()=>{clearTimeout(s),s=setTimeout(o,n)}}(e,t,i)),t}}function B(e,i){let o=Object.create(null);for(let t of i){let i=e.lineAt(t.from);(o[i.from]||(o[i.from]=[])).push(t)}let n=[];for(let e in o)n.push(new I(o[e]).range(+e));return t.RangeSet.of(n,!0)}const O=e.gutter({class:"cm-gutter-lint",markers:e=>e.state.field(V),widgetMarker:(e,t,i)=>{let o=[];return e.state.field(V).between(i.from,i.to,(e,t,n)=>{e>i.from&&e<i.to&&o.push(...n.diagnostics)}),o.length?new I(o):null}}),V=t.StateField.define({create:()=>t.RangeSet.empty,update(e,t){e=e.map(t.changes);let i=t.state.facet(H).markerFilter;for(let o of t.effects)if(o.is(d)){let n=o.value;i&&(n=i(n||[],t.state)),e=B(t.state.doc,n.slice(0))}return e}}),$=t.StateEffect.define(),j=t.StateField.define({create:()=>null,update:(e,t)=>(e&&t.docChanged&&(e=l(t,e)?null:{...e,pos:t.changes.mapPos(e.pos)}),t.effects.reduce((e,t)=>t.is($)?t.value:e,e)),provide:t=>e.showTooltip.from(t)}),z=e.EditorView.baseTheme({".cm-gutter-lint":{width:"1.4em","& .cm-gutterElement":{padding:".2em"}},".cm-lint-marker":{width:"1em",height:"1em"},".cm-lint-marker-info":{content:L('<path fill="#aaf" stroke="#77e" stroke-width="6" stroke-linejoin="round" d="M5 5L35 5L35 35L5 35Z"/>')},".cm-lint-marker-warning":{content:L('<path fill="#fe8" stroke="#fd7" stroke-width="6" stroke-linejoin="round" d="M20 6L37 35L3 35Z"/>')},".cm-lint-marker-error":{content:L('<circle cx="20" cy="20" r="15" fill="#f87" stroke="#f43" stroke-width="6"/>')}}),q=[m,e.EditorView.decorations.compute([m],t=>{let{selected:i,panel:o}=t.field(m);return i&&o&&i.from!=i.to?e.Decoration.set([h.range(i.from,i.to)]):e.Decoration.none}),e.hoverTooltip(g,{hideOn:l}),E],H=t.Facet.define({combine:e=>t.combineConfig(e,{hoverTime:300,markerFilter:null,tooltipFilter:null})});exports.closeLintPanel=w,exports.diagnosticCount=function(e){let t=e.field(m,!1);return t?t.diagnostics.size:0},exports.forEachDiagnostic=function(e,i){let o=e.field(m,!1);if(o&&o.diagnostics.size){let e=[],n=[],s=-1;for(let r=t.RangeSet.iter([o.diagnostics]);;r.next()){for(let t=0;t<e.length;t++)(!r.value||r.value.spec.diagnostics.indexOf(e[t])<0)&&(i(e[t],n[t],s),e.splice(t,1),n.splice(t--,1));if(!r.value)break;for(let t of r.value.spec.diagnostics)e.indexOf(t)<0&&(e.push(t),n.push(r.from));s=r.to}}},exports.forceLinting=function(e){let t=e.plugin(x);t&&t.force()},exports.lintGutter=function(e={}){return[H.of(e),V,O,z,j]},exports.lintKeymap=k,exports.linter=function(e,t={}){return[y.of({source:e,config:t}),x,q]},exports.nextDiagnostic=b,exports.openLintPanel=v,exports.previousDiagnostic=e=>{let{state:t}=e,i=t.field(m,!1);if(!i)return!1;let o,n,s,r,l=t.selection.main;return i.diagnostics.between(0,t.doc.length,(e,t)=>{t<l.to&&(null==o||o<e)&&(o=e,n=t),(null==s||e>s)&&(s=e,r=t)}),null!=s&&(null!=o||s!=l.from)&&(e.dispatch({selection:{anchor:null!=o?o:s,head:null!=n?n:r},scrollIntoView:!0}),!0)},exports.setDiagnostics=c,exports.setDiagnosticsEffect=d;
