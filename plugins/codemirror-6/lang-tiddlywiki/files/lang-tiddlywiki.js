/*\
title: $:/plugins/tiddlywiki/codemirror-6/plugins/lang-tiddlywiki/lang-tiddlywiki.js
type: application/javascript
module-type: library

TiddlyWiki5 language support for CodeMirror 6 - library module
Built with Rollup - DO NOT EDIT DIRECTLY

Note: The plugin wrapper is in plugin.js, this is the library it uses.

@license MIT
\*/
"use strict";var e,t,n=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-state.js"),r=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-view.js"),s=require("$:/plugins/tiddlywiki/codemirror-6/lib/lezer-common.js"),a=require("$:/plugins/tiddlywiki/codemirror-6/lib/lezer-highlight.js"),i=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-language.js"),l=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-autocomplete.js"),o=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-lang-html.js"),c=require("$:/plugins/tiddlywiki/codemirror-6/lib/codemirror-commands.js");function d(e){return e===t.Space||e===t.Tab}!function(e){e[e.Document=1]="Document",e[e.Pragma=2]="Pragma",e[e.PragmaMark=3]="PragmaMark",e[e.PragmaKeyword=4]="PragmaKeyword",e[e.PragmaName=5]="PragmaName",e[e.PragmaParams=6]="PragmaParams",e[e.PragmaBody=7]="PragmaBody",e[e.PragmaEnd=8]="PragmaEnd",e[e.MacroDefinition=9]="MacroDefinition",e[e.ProcedureDefinition=10]="ProcedureDefinition",e[e.FunctionDefinition=11]="FunctionDefinition",e[e.WidgetDefinition=12]="WidgetDefinition",e[e.RulesPragma=13]="RulesPragma",e[e.ImportPragma=14]="ImportPragma",e[e.ParametersPragma=15]="ParametersPragma",e[e.WhitespacePragma=16]="WhitespacePragma",e[e.Paragraph=17]="Paragraph",e[e.Heading1=18]="Heading1",e[e.Heading2=19]="Heading2",e[e.Heading3=20]="Heading3",e[e.Heading4=21]="Heading4",e[e.Heading5=22]="Heading5",e[e.Heading6=23]="Heading6",e[e.HeadingMark=24]="HeadingMark",e[e.BulletList=25]="BulletList",e[e.OrderedList=26]="OrderedList",e[e.DefinitionList=27]="DefinitionList",e[e.ListItem=28]="ListItem",e[e.DefinitionTerm=29]="DefinitionTerm",e[e.DefinitionDescription=30]="DefinitionDescription",e[e.ListMark=31]="ListMark",e[e.BlockQuote=32]="BlockQuote",e[e.QuoteMark=33]="QuoteMark",e[e.BlockQuoteClass=34]="BlockQuoteClass",e[e.Table=35]="Table",e[e.TableHeader=36]="TableHeader",e[e.TableBody=37]="TableBody",e[e.TableFooter=38]="TableFooter",e[e.TableCaption=39]="TableCaption",e[e.TableRow=40]="TableRow",e[e.TableCell=41]="TableCell",e[e.TableHeaderCell=42]="TableHeaderCell",e[e.TableDelimiter=43]="TableDelimiter",e[e.TableClass=44]="TableClass",e[e.TableMarker=45]="TableMarker",e[e.FencedCode=46]="FencedCode",e[e.CodeMark=47]="CodeMark",e[e.CodeInfo=48]="CodeInfo",e[e.CodeText=49]="CodeText",e[e.PlainText=50]="PlainText",e[e.TypedBlock=51]="TypedBlock",e[e.TypedBlockMark=52]="TypedBlockMark",e[e.TypedBlockType=53]="TypedBlockType",e[e.HardLineBreaks=54]="HardLineBreaks",e[e.HardLineBreaksMark=55]="HardLineBreaksMark",e[e.KaTeXBlock=56]="KaTeXBlock",e[e.KaTeXMark=57]="KaTeXMark",e[e.LaTeXContent=58]="LaTeXContent",e[e.HorizontalRule=59]="HorizontalRule",e[e.CommentBlock=60]="CommentBlock",e[e.CommentMarker=61]="CommentMarker",e[e.HTMLBlock=62]="HTMLBlock",e[e.HTMLEndTag=63]="HTMLEndTag",e[e.Widget=64]="Widget",e[e.WidgetEnd=65]="WidgetEnd",e[e.WidgetName=66]="WidgetName",e[e.TagName=67]="TagName",e[e.TagMark=68]="TagMark",e[e.TagAttributes=69]="TagAttributes",e[e.Attribute=70]="Attribute",e[e.AttributeName=71]="AttributeName",e[e.AttributeValue=72]="AttributeValue",e[e.AttributeString=73]="AttributeString",e[e.AttributeNumber=74]="AttributeNumber",e[e.AttributeIndirect=75]="AttributeIndirect",e[e.AttributeFiltered=76]="AttributeFiltered",e[e.AttributeMacro=77]="AttributeMacro",e[e.AttributeSubstituted=78]="AttributeSubstituted",e[e.AttributeParamRef=79]="AttributeParamRef",e[e.AttributeWikitext=80]="AttributeWikitext",e[e.SelfClosingMarker=81]="SelfClosingMarker",e[e.TransclusionBlock=82]="TransclusionBlock",e[e.FilteredTransclusionBlock=83]="FilteredTransclusionBlock",e[e.MacroCallBlock=84]="MacroCallBlock",e[e.Bold=85]="Bold",e[e.BoldMark=86]="BoldMark",e[e.Italic=87]="Italic",e[e.ItalicMark=88]="ItalicMark",e[e.Underline=89]="Underline",e[e.UnderlineMark=90]="UnderlineMark",e[e.Strikethrough=91]="Strikethrough",e[e.StrikethroughMark=92]="StrikethroughMark",e[e.Superscript=93]="Superscript",e[e.SuperscriptMark=94]="SuperscriptMark",e[e.Subscript=95]="Subscript",e[e.SubscriptMark=96]="SubscriptMark",e[e.Highlight=97]="Highlight",e[e.HighlightMark=98]="HighlightMark",e[e.HighlightStyles=99]="HighlightStyles",e[e.InlineCode=100]="InlineCode",e[e.InlineCodeMark=101]="InlineCodeMark",e[e.WikiLink=102]="WikiLink",e[e.WikiLinkMark=103]="WikiLinkMark",e[e.LinkText=104]="LinkText",e[e.LinkSeparator=105]="LinkSeparator",e[e.LinkTarget=106]="LinkTarget",e[e.ExternalLink=107]="ExternalLink",e[e.ExtLinkMark=108]="ExtLinkMark",e[e.ImageLink=109]="ImageLink",e[e.ImageMark=110]="ImageMark",e[e.ImageSource=111]="ImageSource",e[e.ImageWidth=112]="ImageWidth",e[e.ImageHeight=113]="ImageHeight",e[e.ImageClass=114]="ImageClass",e[e.ImageAlt=115]="ImageAlt",e[e.ImageTooltip=116]="ImageTooltip",e[e.CamelCaseLink=117]="CamelCaseLink",e[e.SystemLink=118]="SystemLink",e[e.URLLink=119]="URLLink",e[e.Transclusion=120]="Transclusion",e[e.TransclusionMark=121]="TransclusionMark",e[e.TransclusionTarget=122]="TransclusionTarget",e[e.TransclusionField=123]="TransclusionField",e[e.TransclusionIndex=124]="TransclusionIndex",e[e.TransclusionTemplate=125]="TransclusionTemplate",e[e.FilteredTransclusion=126]="FilteredTransclusion",e[e.FilteredTransclusionMark=127]="FilteredTransclusionMark",e[e.FilterExpression=128]="FilterExpression",e[e.MacroCall=129]="MacroCall",e[e.MacroCallMark=130]="MacroCallMark",e[e.MacroName=131]="MacroName",e[e.MacroParam=132]="MacroParam",e[e.MacroParamName=133]="MacroParamName",e[e.MacroParamValue=134]="MacroParamValue",e[e.InlineWidget=135]="InlineWidget",e[e.HTMLTag=136]="HTMLTag",e[e.OpenTag=137]="OpenTag",e[e.CloseTag=138]="CloseTag",e[e.Escape=139]="Escape",e[e.Entity=140]="Entity",e[e.HardBreak=141]="HardBreak",e[e.Dash=142]="Dash",e[e.Variable=143]="Variable",e[e.VariableMark=144]="VariableMark",e[e.VariableName=145]="VariableName",e[e.FilterSubstitution=146]="FilterSubstitution",e[e.FilterSubstitutionMark=147]="FilterSubstitutionMark",e[e.Placeholder=148]="Placeholder",e[e.PlaceholderMark=149]="PlaceholderMark",e[e.SubstitutedParam=150]="SubstitutedParam",e[e.SubstitutedParamMark=151]="SubstitutedParamMark",e[e.SubstitutedParamName=152]="SubstitutedParamName",e[e.FilterRun=153]="FilterRun",e[e.FilterOperator=154]="FilterOperator",e[e.FilterOperatorName=155]="FilterOperatorName",e[e.FilterOperand=156]="FilterOperand",e[e.FilterVariable=157]="FilterVariable",e[e.FilterTextRef=158]="FilterTextRef",e[e.FilterRegexp=159]="FilterRegexp",e[e.StyledBlock=160]="StyledBlock",e[e.StyledBlockMark=161]="StyledBlockMark",e[e.StyledBlockClass=162]="StyledBlockClass",e[e.ConditionalBlock=163]="ConditionalBlock",e[e.Conditional=164]="Conditional",e[e.ConditionalMark=165]="ConditionalMark",e[e.ConditionalKeyword=166]="ConditionalKeyword",e[e.ConditionalBranch=167]="ConditionalBranch",e[e.Text=168]="Text",e[e.ProcessingInstruction=169]="ProcessingInstruction",e[e.Mark=170]="Mark"}(e||(e={})),new Set([e.Document,e.Pragma,e.MacroDefinition,e.ProcedureDefinition,e.FunctionDefinition,e.WidgetDefinition,e.RulesPragma,e.ImportPragma,e.ParametersPragma,e.WhitespacePragma,e.Paragraph,e.Heading1,e.Heading2,e.Heading3,e.Heading4,e.Heading5,e.Heading6,e.BulletList,e.OrderedList,e.DefinitionList,e.ListItem,e.DefinitionTerm,e.DefinitionDescription,e.BlockQuote,e.Table,e.TableHeader,e.TableBody,e.TableFooter,e.TableCaption,e.TableRow,e.FencedCode,e.TypedBlock,e.HardLineBreaks,e.HorizontalRule,e.CommentBlock,e.HTMLBlock,e.Widget,e.TransclusionBlock,e.FilteredTransclusionBlock,e.MacroCallBlock]),new Set([e.Document,e.MacroDefinition,e.ProcedureDefinition,e.FunctionDefinition,e.WidgetDefinition,e.BulletList,e.OrderedList,e.DefinitionList,e.BlockQuote,e.Table,e.TableHeader,e.TableBody,e.TableFooter,e.Widget,e.HTMLBlock]),function(e){e[e.Space=32]="Space",e[e.Tab=9]="Tab",e[e.Newline=10]="Newline",e[e.CarriageReturn=13]="CarriageReturn",e[e.Backslash=92]="Backslash",e[e.Exclamation=33]="Exclamation",e[e.Hash=35]="Hash",e[e.Dollar=36]="Dollar",e[e.Percent=37]="Percent",e[e.Ampersand=38]="Ampersand",e[e.Apostrophe=39]="Apostrophe",e[e.LeftParen=40]="LeftParen",e[e.RightParen=41]="RightParen",e[e.Asterisk=42]="Asterisk",e[e.Plus=43]="Plus",e[e.Comma=44]="Comma",e[e.Dash=45]="Dash",e[e.Dot=46]="Dot",e[e.Slash=47]="Slash",e[e.Colon=58]="Colon",e[e.Semicolon=59]="Semicolon",e[e.LessThan=60]="LessThan",e[e.Equals=61]="Equals",e[e.GreaterThan=62]="GreaterThan",e[e.Question=63]="Question",e[e.At=64]="At",e[e.LeftBracket=91]="LeftBracket",e[e.RightBracket=93]="RightBracket",e[e.Caret=94]="Caret",e[e.Underscore=95]="Underscore",e[e.Backtick=96]="Backtick",e[e.LeftBrace=123]="LeftBrace",e[e.Pipe=124]="Pipe",e[e.RightBrace=125]="RightBrace",e[e.Tilde=126]="Tilde"}(t||(t={}));class u{constructor(e,t,n,r=[]){this.type=e,this.from=t,this.to=n,this.children=r}}function f(e,t,n,r){return new u(e,t,n,r)}class p{constructor(){this.text="",this.baseIndent=0,this.basePos=0,this.depth=0,this.markers=[],this.pos=0,this.indent=0,this.next=-1}skipSpace(e){let t=e;for(;t<this.text.length;){if(!d(this.text.charCodeAt(t)))break;t++}return t}moveBase(e){this.basePos=e,this.baseIndent=this.countIndent(e,this.text.length)}moveBaseColumn(e){this.moveBase(this.findColumn(e))}addMarker(e){this.markers.push(e)}countIndent(e,n=0,r=0){for(let s=n;s<e;s++){const e=this.text.charCodeAt(s);if(e===t.Space)r++;else{if(e!==t.Tab)break;r+=4-r%4}}return r}findColumn(e){let n=0,r=0;for(;n<this.text.length&&r<e;){this.text.charCodeAt(n)===t.Tab?r+=4-r%4:r++,n++}return n}reset(e){this.text=e,this.baseIndent=this.basePos=this.pos=this.indent=0,this.depth=0,this.markers=[],this.next=e.length?e.charCodeAt(0):-1}scrub(){if(!this.basePos)return this.text;let e="";for(const t of this.markers)e+=this.text.slice(e.length,t.from)+" ".repeat(t.to-t.from);return e+this.text.slice(e.length)}}class h{static create(e,t,n,r,s){return new h(e,t,n,r+(r<<8)+e+(t<<4)|0,s,[],[])}constructor(e,t,n,r,s,a,i){this.type=e,this.value=t,this.from=n,this.hash=r,this.end=s,this.children=a,this.positions=i}addChild(e,t){e.prop(s.NodeProp.contextHash)!==this.hash&&(e=new s.Tree(e.type,e.children,e.positions,e.length,[[s.NodeProp.contextHash,this.hash]])),this.children.push(e),this.positions.push(t)}toTree(e,t=this.end){const n=this.children.length-1;return n>=0&&(t=Math.max(t,this.positions[n]+this.children[n].length+this.from)),new s.Tree(e.types[this.type],this.children,this.positions,t-this.from).balance({makeTree:(e,t,n)=>new s.Tree(s.NodeType.none,e,t,n,[[s.NodeProp.contextHash,this.hash]])})}}class m{constructor(e,t,n,r){this.type=e,this.from=t,this.to=n,this.side=r}}class g{constructor(){this.content=[],this.nodes=[]}write(e,t,n,r=0){this.content.push(e,t,n,4+4*r)}writeElements(e,t=0){for(const n of e)this.writeElement(n,t)}writeElement(e,t=0){const n=this.content.length;this.writeElements(e.children,t),this.content.push(e.type,e.from+t,e.to+t,this.content.length+4-n)}finish(e,t){return s.Tree.build({buffer:this.content,nodeSet:this.nodeSet,topID:e,length:t})}}class k{setMacroParams(e){this._macroParams=e?new Set(e):null}isValidMacroParam(e){return null!==this._macroParams&&this._macroParams.has(e)}get hasMacroParams(){return null!==this._macroParams}get atEnd(){return this._atEnd}savePosition(){return{lineStart:this.lineStart,lineEnd:this.lineEnd,lineText:this._line.text,atEnd:this._atEnd}}restorePosition(e){this.lineStart=e.lineStart,this.lineEnd=e.lineEnd,this._line.reset(e.lineText),this._atEnd=e.atEnd}constructor(t,n,r,s){this.parser=t,this.input=n,this.ranges=s,this.buf=new g,this.stack=[],this._atEnd=!1,this.dontInject=new Set,this.fragments=null,this.fragmentIndex=0,this.fragmentEnd=-1,this.lineStart=0,this.lineEnd=0,this.stoppedAt=null,this._macroParams=null,this.to=s[s.length-1].to,this.fragments=r.length?r:null,this.buf.nodeSet=t.nodeSet;const a=h.create(e.Document,0,s[0].from,0,0);this.stack.push(a),this._line=new p,this.lineStart=s[0].from,this.lineEnd=this.lineStart,this.moveToNextLine()}get line(){return this._line}get rangeEnd(){return this.to}get parsers(){return this.parser.blockParsers}get pragmaParsers(){return this.parser.pragmaParsers}get block(){return this.stack[this.stack.length-1]}prevLineEnd(){return this.lineStart<=0?0:this.atEnd&&this.lineStart===this.to?this.lineStart:this.lineStart-1}nextLine(){return this.lineStart=this.lineEnd,this.lineStart>=this.to?(this._atEnd=!0,!1):(this.lineEnd=this.findLineEnd(),this._line.reset(this.readLineText()),!0)}skipToPosition(e){return e>=this.to?(this.lineStart=this.to,this.lineEnd=this.to,this._atEnd=!0,this._line.reset(""),!1):(this.lineStart=e,this.lineEnd=this.findLineEnd(e),this._line.reset(this.readLineText()),!0)}peekLine(){const e=this.lineEnd;if(e>=this.to)return null;let n=this.findLineEnd(e);if(n>e){this.input.read(n-1,n).charCodeAt(0)===t.Newline&&(n--,n>e&&this.input.read(n-1,n).charCodeAt(0)===t.CarriageReturn&&n--)}return this.input.read(e,n)}findLineEnd(e=this.lineEnd){let n=e;for(;n<this.to;){const e=this.input.read(n,n+1).charCodeAt(0);if(e===t.Newline)return n+1;if(e===t.CarriageReturn)return n++,n<this.to&&this.input.read(n,n+1).charCodeAt(0)===t.Newline&&n++,n;n++}return n}readLineText(){let e=this.lineEnd;if(e>this.lineStart){this.input.read(e-1,e).charCodeAt(0)===t.Newline&&(e--,e>this.lineStart&&this.input.read(e-1,e).charCodeAt(0)===t.CarriageReturn&&e--)}return this.input.read(this.lineStart,e)}moveToNextLine(){this.nextLine()||this._line.reset("")}startContext(e,t,n=0){const r=h.create(e,n,t,this.block.hash,t);this.stack.push(r),this.addNode(e,t)}startComposite(e,t,n=0){const r=h.create(e,n,t,this.block.hash,t);this.stack.push(r)}addElement(e){this.buf.writeElement(e,-this.block.from)}addNode(e,t,n){"number"==typeof e?this.buf.write(e,t-this.block.from,(n??t)-this.block.from,0):this.block.addChild(e,t-this.block.from)}addLeafElement(e,t){this.addElement(this.elt(t.type,t.from,t.to,[...e.marks.map(e=>this.elt(e.type,e.from,e.to)),...t.children]))}finishContext(){const e=this.stack.pop(),t=e.toTree(this.parser.nodeSet);this.dontInject.has(t)||this.block.addChild(t,e.from-this.block.from)}elt(e,t,n,r){return new u(e,t,n,r)}advance(){if(null!==this.stoppedAt&&this.lineStart>this.stoppedAt)return this.finishDocument();for(this.lineStart===this.ranges[0].from&&this.parsePragmas();!this.atEnd;)this.parseBlock();return this.finishDocument()}parsePragmas(){let n=!1;for(;!this.atEnd;){const r=this._line.text,s=r.trim();if(""===s){this.nextLine();continue}if(s.startsWith("\x3c!--")){const t=this.lineStart,n=[],s=r.indexOf("--\x3e");if(-1!==s){const a=r.slice(s+3),i=t+s+3;if(n.push(f(e.CommentMarker,t,t+4)),n.push(f(e.CommentMarker,i-3,i)),this.addElement(f(e.CommentBlock,t,i,n)),a.trim()){const t=this.parser.parseInline(a,i),n=this.elt(e.Paragraph,i,i+a.length,t);this.addElement(n),this.nextLine();break}this.nextLine();continue}let a=!1,i=!1;for(;this.nextLine();){const n=this._line.text,r=n.indexOf("--\x3e");if(-1!==r){const s=n.slice(r+3),l=this.lineStart+r+3;if(this.addElement(f(e.CommentBlock,t,l)),a=!0,s.trim()){const t=this.parser.parseInline(s,l),n=this.elt(e.Paragraph,l,l+s.length,t);this.addElement(n),i=!0}this.nextLine();break}}if(a||this.addElement(f(e.CommentBlock,t,this.lineStart)),i)break;continue}if(r.charCodeAt(this._line.skipSpace(0))!==t.Backslash){if(n&&!this.looksLikeBlockStart(s)&&this.hasUpcomingPragma()){this.nextLine();continue}break}if("\\"===s){this.nextLine();continue}let a=!1;for(const e of this.pragmaParsers){const t=e.parse(this,this._line);if(null!==t){for(const e of t)this.addElement(e);a=!0,n=!0;break}}if(!a){if(n&&this.hasUpcomingPragma()){this.nextLine();continue}break}}}looksLikeBlockStart(e){if(!e)return!1;const n=e.charCodeAt(0);return!!e.startsWith("```")||(!!e.startsWith("$$$")||(n===t.Exclamation||(n===t.Asterisk||n===t.Hash||n===t.Semicolon||n===t.Colon||(!!e.startsWith("<<<")||(!!/^-{3,}\s*$/.test(e)||(n===t.Pipe||(n===t.LessThan||(!!e.startsWith("{{")||(!!e.startsWith("<<")||!!e.startsWith("<%"))))))))))}hasUpcomingPragma(){const e=this.savePosition();let n=!1;for(;this.nextLine();){const e=this._line.text.trim();if(""!==e)if(e.startsWith("```"))for(;this.nextLine()&&!this._line.text.trim().startsWith("```"););else if(e.startsWith("$$$"))for(;this.nextLine()&&!this._line.text.trim().startsWith("$$$"););else if(e.charCodeAt(0)===t.Backslash){n=!0;break}}return this.restorePosition(e),n}parseBlock(){if(""!==this._line.text.trim()){for(const e of this.parsers){const t=e.parse(this,this._line);if(!1!==t)return void(!0===t&&this.nextLine())}this.parseParagraph()}else this.nextLine()}parseParagraph(){const t=this.lineStart,n=[this._line.text];for(;this.nextLine();){const e=this._line.text;if(""===e.trim()){n.push(e);continue}let t=!1;for(const n of this.parsers){const n=e.charCodeAt(0);if(this.isBlockStarter(e,n)){t=!0;break}}if(t)break;n.push(e)}const r=n.join("\n"),s=this.parser.parseInline(r,t),a=this.elt(e.Paragraph,t,t+r.length,s);this.addElement(a)}isBlockStarter(e,n){if(n===t.Exclamation)return!0;if(n===t.Asterisk||n===t.Hash||n===t.Semicolon||n===t.Colon||n===t.GreaterThan)return!0;if(n===t.Pipe)return!0;if(n===t.Backtick&&e.startsWith("```"))return!0;if(n===t.Dollar&&e.startsWith("$$$"))return!0;if(n===t.Dollar&&e.startsWith("$$")&&!e.startsWith("$$$")&&this.parsers.some(e=>"KaTeXBlock"===e.name))return!0;if(n===t.Dash&&/^-{3,}$/.test(e.trim()))return!0;if(n===t.LessThan){if(e.startsWith("<<")&&!e.startsWith("<<<")){const t=e.indexOf(">>",2);return-1===t||!e.slice(t+2).trim()}if(e.startsWith("\x3c!--"))return!e.includes("--\x3e");const t=e.match(/^<(\$?[a-zA-Z][a-zA-Z0-9\-\.]*)/);if(!t)return!1;const n=t[1];if(/\/>\s*$/.test(e))return!1;const r=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");return!new RegExp(`</${r}>`).test(e)}return!(n!==t.LeftBrace||!e.startsWith("{{"))||n===t.Backslash}finishDocument(){for(;this.stack.length>1;)this.finishContext();const t=this.stack[0],n=this.buf.content;if(n.length>0){return s.Tree.build({buffer:n,nodeSet:this.parser.nodeSet,topID:e.Document,length:this.to-t.from})}return t.toTree(this.parser.nodeSet,this.to)}get parsedPos(){return this.lineStart}stopAt(e){this.stoppedAt=e}parseContentRange(e,t,n=!0){if(e>=t)return[];const r=this.input.read(e,t),s=this.parser.parse(r);return this.extractElements(s,e)}extractElements(e,t){const n=[],r=e.cursor();if(r.firstChild())do{const e=this.nodeToElement(r,t);e&&n.push(e)}while(r.nextSibling());return n}nodeToElement(e,t){const n=e.type.id,r=e.from+t,s=e.to+t,a=[];if(e.firstChild()){do{const n=this.nodeToElement(e,t);n&&a.push(n)}while(e.nextSibling());e.parent()}return new u(n,r,s,a)}}class b{constructor(e,t,n){this.parser=e,this.text=t,this.offset=n,this.parts=[]}get end(){return this.offset+this.text.length}char(e){const t=e-this.offset;return t<0||t>=this.text.length?-1:this.text.charCodeAt(t)}slice(e,t){const n=Math.max(0,e-this.offset),r=Math.min(this.text.length,t-this.offset);return this.text.slice(n,r)}get hasOpenLink(){for(let e=this.parts.length-1;e>=0;e--){const t=this.parts[e];if(t instanceof m&&t.type.isLink)return!0}return!1}skipSpace(e){let t=e-this.offset;for(;t<this.text.length&&d(this.text.charCodeAt(t));)t++;return t+this.offset}addElement(e){return this.parts.push(e),e.to}addDelimiter(e,t,n,r,s){const a=(r?1:0)|(s?2:0);return this.parts.push(new m(e,t,n,a)),n}append(e){return this.parts.push(e),e.to}elt(e,t,n,r){return new u(e,t,n,r)}findOpeningDelimiter(e){for(let t=this.parts.length-1;t>=0;t--){const n=this.parts[t];if(n instanceof m&&n.type===e&&1&n.side)return t}return null}takeContent(t){const n=[];for(let r=t;r<this.parts.length;r++){const t=this.parts[r];t instanceof u?n.push(t):t instanceof m&&n.push(this.elt(e.Text,t.from,t.to))}return this.parts.length=t,n}resolveDelimiters(){for(let t=0;t<this.parts.length;t++){const n=this.parts[t];if(!(n instanceof m&&2&n.side))continue;const r=n.type;if(!r.resolve)continue;let s=null;for(let e=t-1;e>=0;e--){const t=this.parts[e];if(t instanceof m&&t.type===r&&1&t.side){s=e;break}}if(null===s)continue;const a=this.parts[s],i=[];r.mark&&i.push(this.elt(this.getMarkType(r.mark),a.from,a.to));for(let n=s+1;n<t;n++){const t=this.parts[n];t instanceof u?i.push(t):t instanceof m&&i.push(this.elt(e.Text,t.from,t.to)),this.parts[n]=null}r.mark&&i.push(this.elt(this.getMarkType(r.mark),n.from,n.to));const l=this.getResolveType(r.resolve),o=this.elt(l,a.from,n.to,i);this.parts[s]=o,this.parts[t]=null}const t=[];for(const n of this.parts)n instanceof u?t.push(n):n instanceof m&&t.push(this.elt(e.Text,n.from,n.to));return t}getResolveType(t){return{Bold:e.Bold,Italic:e.Italic,Underline:e.Underline,Strikethrough:e.Strikethrough,Superscript:e.Superscript,Subscript:e.Subscript,Highlight:e.Highlight,InlineCode:e.InlineCode}[t]||e.Text}getMarkType(t){return{BoldMark:e.BoldMark,ItalicMark:e.ItalicMark,UnderlineMark:e.UnderlineMark,StrikethroughMark:e.StrikethroughMark,SuperscriptMark:e.SuperscriptMark,SubscriptMark:e.SubscriptMark,HighlightMark:e.HighlightMark,InlineCodeMark:e.InlineCodeMark}[t]||e.Mark}parse(){const e=this.parser.inlineParsers;let t=this.offset;for(;t<this.end;){const n=this.char(t);let r=!1;for(const s of e){const e=s.parse(this,n,t);if(e>=0){t=e,r=!0;break}}r||t++}return this.resolveDelimiters()}}const x={whitespaceOrStart:/\s|^$/,placeholder:/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/};function y(t,n,r){const s=x.placeholder.exec(t);if(s){const t=s[1];return f(e.Placeholder,n,r,[f(e.PlaceholderMark,n,n+1),f(e.VariableName,n+1,n+1+t.length),f(e.PlaceholderMark,r-1,r)])}return f(e.FilterTextRef,n,r)}function $(t,n,r){const s=x.placeholder.exec(t);if(s){const t=s[1];return f(e.Placeholder,n,r,[f(e.PlaceholderMark,n,n+1),f(e.VariableName,n+1,n+1+t.length),f(e.PlaceholderMark,r-1,r)])}return f(e.FilterVariable,n,r)}function w(e,t,n,r=2){let s=t;for(;e.char(s-1)===n;)s--;let a=t+r;for(;e.char(a)===n;)a++;const i=a-s,l=e.slice(s-1,s);e.slice(a,a+1);var o;let c;return c=!(o=l,x.whitespaceOrStart.test(o))&&i>r?a-r:s,e.slice(c-1,c),e.slice(c+r,c+r+1),{runStart:s,runEnd:a,runLength:i,matchStart:c,canOpen:!0,canClose:!0}}function T(e){const{charCode:t,delimType:n,delimLength:r=2,rejectOddRuns:s=!1}=e;return function(e,a,i){if(a!==t)return-1;for(let n=1;n<r;n++)if(e.char(i+n)!==t)return-1;const l=w(e,i,t,r);return l?s&&l.runLength%2==1||i!==l.matchStart?-1:e.addDelimiter(n,i,i+r,l.canOpen,l.canClose):-1}}function M(t,n){const r=[],s=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(t);if(s){const a=s[1];return r.push(f(e.Placeholder,n,n+t.length,[f(e.PlaceholderMark,n,n+1),f(e.VariableName,n+1,n+1+a.length),f(e.PlaceholderMark,n+t.length-1,n+t.length)])),r}const a=t.indexOf("!!");if(a>=0)return a>0&&r.push(f(e.TransclusionTarget,n,n+a)),r.push(f(e.TransclusionField,n+a,n+t.length)),r;const i=t.indexOf("##");return i>=0?(i>0&&r.push(f(e.TransclusionTarget,n,n+i)),r.push(f(e.TransclusionIndex,n+i,n+t.length)),r):(t.length>0&&r.push(f(e.TransclusionTarget,n,n+t.length)),r)}const S=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/;function C(t,n,r){const s=S.exec(t);if(s){const t=s[1];return f(e.Placeholder,n,r,[f(e.PlaceholderMark,n,n+1),f(e.VariableName,n+1,n+1+t.length),f(e.PlaceholderMark,r-1,r)])}return f(e.MacroParamName,n,r)}function P(t,n){const r=[],s=/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/g;let a,i=0;for(;null!==(a=s.exec(t));){a.index>i&&r.push(f(e.Text,n+i,n+a.index));const t=a[1],s=n+a.index,l=s+a[0].length;r.push(f(e.Placeholder,s,l,[f(e.PlaceholderMark,s,s+1),f(e.VariableName,s+1,s+1+t.length),f(e.PlaceholderMark,l-1,l)])),i=a.index+a[0].length}return i<t.length&&r.push(f(e.Text,n+i,n+t.length)),r}function L(t,n){const r=[];let s=0;const a=Math.min(t.length,5e3);let i=0;for(;s<a&&i<200;){for(i++;s<a&&/\s/.test(t[s]);)s++;if(s>=a)break;const l=s;let o=s;for(;o<a&&/[a-zA-Z0-9\-_$]/.test(t[o]);)o++;if(o>s&&":"===t[o]){const i=s;s=o+1;const c=s;let d=s;if('"'===t[s]||"'"===t[s]){const e=t[s];for(s++;s<a&&t[s]!==e;)"\\"===t[s]&&s++,s++;s<a&&s++,d=s}else if("[[["===t.slice(s,s+3)){for(s+=3;s<a&&"]]]"!==t.slice(s,s+3);)s++;s<a&&(s+=3),d=s}else if("[["===t.slice(s,s+2)){for(s+=2;s<a&&"]]"!==t.slice(s,s+2);)s++;s<a&&(s+=2),d=s}else{for(;s<a&&!/[\s>]/.test(t[s]);)s++;d=s}const u=C(t.slice(i,o),n+i,n+o);let p;const h=t.slice(c,d);if((h.startsWith('"')||h.startsWith("'"))&&h.length>=2){const t=h[0],r=P(h.slice(1,h.length-(h.endsWith(t)?1:0)),n+c+1);if(r.length>0&&r.some(t=>t.type===e.Placeholder)){const t=[f(e.Mark,n+c,n+c+1),...r,f(e.Mark,n+d-1,n+d)];p=f(e.MacroParamValue,n+c,n+d,t)}else p=f(e.MacroParamValue,n+c,n+d)}else p=f(e.MacroParamValue,n+c,n+d);const m=[u,p];r.push(f(e.MacroParam,n+l,n+d,m))}else{const i=s;let o,c=!1,d="";if('"'===t[s]||"'"===t[s]){for(c=!0,d=t[s],s++;s<a&&t[s]!==d;)"\\"===t[s]&&s++,s++;s<a&&s++}else if("[[["===t.slice(s,s+3)){for(s+=3;s<a&&"]]]"!==t.slice(s,s+3);)s++;s<a&&(s+=3)}else if("[["===t.slice(s,s+2)){for(s+=2;s<a&&"]]"!==t.slice(s,s+2);)s++;s<a&&(s+=2)}else for(;s<a&&!/[\s>]/.test(t[s]);)s++;const u=t.slice(i,s);if(c&&u.length>=2){const t=P(u.slice(1,u.length-(u.endsWith(d)?1:0)),n+i+1);if(t.length>0&&t.some(t=>t.type===e.Placeholder)){const r=[f(e.Mark,n+i,n+i+1),...t,f(e.Mark,n+s-1,n+s)];o=f(e.MacroParamValue,n+i,n+s,r)}else o=f(e.MacroParamValue,n+i,n+s)}else o=f(e.MacroParamValue,n+i,n+s);const p=[o];r.push(f(e.MacroParam,n+l,n+s,p))}}return r}const v=/^\s*\\define\s+([^(\s]+)\s*\(\s*([^)]*)\s*\)(.*)$/,A=/^\s*\\define\s+([^(\s]+)\s*\(\s*([^)]*)\s*\)\s*$/,E=/^\s*\\(function|procedure|widget)\s+([^(\s]+)\s*\(\s*([^)]*)\s*\)(.*)$/,B=/^\s*\\(function|procedure|widget)\s+([^(\s]+)\s*\(\s*([^)]*)\s*\)$/,I=/^\s*\\rules\s+(only|except)\s+(.*)$/,N=/^\s*\\import\s+(.*)$/,F=/^\s*\\parameters\s*\(\s*([^)]*)\s*\)$/,W=/^\s*\\whitespace\s+(trim|notrim)$/;function O(e,t){const n=/^\s*\\(define|procedure|function|widget)\s+([^(\s]+)\s*\([^)]*\)\s*$/,r=/^\s*\\end(?:\s+(\S+))?\s*$/,s=e.lineStart+e.line.text.length+1,a=[];for(;e.nextLine();){const i=e.line.text,l=n.exec(i);if(l){a.push(l[2]);continue}const o=r.exec(i);if(o){const n=o[1];if(0===a.length){if(!n||n===t)return{bodyStart:s,bodyEnd:e.lineStart-1,endStart:e.lineStart,endEnd:e.lineStart+i.length}}else if(n){if(n===a[a.length-1])a.pop();else if(n===t)return{bodyStart:s,bodyEnd:e.lineStart-1,endStart:e.lineStart,endEnd:e.lineStart+i.length}}else a.pop()}}return null}function D(t,n){const r=[];let s=0;const a=t.length;for(;s<a;){const i=t[s];if(/\s/.test(i))s++;else if("["===i){const i=s;s++;const l=[];for(;s<a&&"]"!==t[s];){"!"===t[s]&&s++;const r=t[s];if("["===r){s++;const r=s;let i=1;for(;s<a&&i>0;)"["===t[s]?i++:"]"===t[s]&&i--,i>0&&s++;l.push(f(e.FilterOperand,n+r,n+s)),s<a&&"]"===t[s]&&s++}else if("<"===r){s++;const r=s;for(;s<a&&">"!==t[s];)s++;const i=t.slice(r,s),o=s<a&&">"===t[s],c=/^__(.+)__$/.exec(i);if(c){const t=c[1],a=n+r-1,i=n+s+1,o=n+r,d=[f(e.SubstitutedParamMark,o,o+2),f(e.SubstitutedParamName,o+2,o+2+t.length),f(e.SubstitutedParamMark,o+2+t.length,n+s)];l.push(f(e.SubstitutedParam,a,i,d))}else{const t=i.search(/\s/);if(-1!==t){const a=n+r-1,c=o?n+s+1:n+s,d=[f(e.MacroCallMark,a,a+1)],u=i.slice(0,t),p=n+r,h=p+u.length,m=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(u);if(m){const t=m[1];d.push(f(e.Placeholder,p,h,[f(e.PlaceholderMark,p,p+1),f(e.VariableName,p+1,p+1+t.length),f(e.PlaceholderMark,h-1,h)]))}else d.push(f(e.MacroName,p,h));const g=i.slice(t),k=n+r+t,b=L(g.trim(),k+(g.length-g.trimStart().length));d.push(...b),o&&d.push(f(e.MacroCallMark,n+s,n+s+1)),l.push(f(e.MacroCall,a,c,d))}else l.push($(i,n+r,n+s))}s<a&&s++}else if("{"===r){s++;const e=s;for(;s<a&&"}"!==t[s];)s++;const r=t.slice(e,s);l.push(y(r,n+e,n+s)),s<a&&s++}else if("/"===r){s++;const r=s;for(;s<a&&"/"!==t[s];)"\\"===t[s]&&s++,s++;for(l.push(f(e.FilterRegexp,n+r,n+s)),s<a&&s++;s<a&&/[gimsuy]/.test(t[s]);)s++}else if(/[a-zA-Z]/.test(r)){const r=s;for(;s<a&&/[a-zA-Z0-9\-_:!]/.test(t[s]);)s++;l.push(f(e.FilterOperatorName,n+r,n+s))}else s++}s<a&&"]"===t[s]&&s++,r.push(f(e.FilterOperator,n+i,n+s,l))}else if("+"===i||"-"===i||"~"===i||"="===i)s++;else if(":"===i)for(s++;s<a&&/[a-zA-Z0-9\-_]/.test(t[s]);)s++;else s++}return r}function H(t,n){const r=[];if(!t.trim())return r;const s=/\s*([A-Za-z0-9\-_]+)(?:\s*:\s*(?:"""([\s\S]*?)"""|"([^"]*)"|'([^']*)'|\[\[([^\]]*)\]\]|([^,\s)]+)))?/g;let a;for(;null!==(a=s.exec(t));){const t=n+a.index,s=t+a[0].length;r.push(f(e.PragmaParams,t,s))}return r}const z=/^\s*\\define(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,_=/^\s*\\(d|de|def|defi|defin)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,Z=/^\s*\\(function|procedure|widget)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,V=/^\s*\\(f|fu|fun|func|funct|functi|functio)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,R=/^\s*\\(p|pr|pro|proc|proce|proced|procedu|procedur)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,K=/^\s*\\(w|wi|wid|widg|widge)(?:\s+([^(\s]+))?(?:\s*\(([^)]*)\)?)?\s*$/,X=/^\s*\\rules(?:\s+(only|except)?)?(?:\s+(.*))?$/,j=/^\s*\\(r|ru|rul|rule)\s*$/,U=/^\s*\\import\s*(.*)$/,q=/^\s*\\(i|im|imp|impo|impor)\s*$/,Q=/^\s*\\parameters(?:\s*\(([^)]*)?)?\s*$/,G=/^\s*\\(pa|par|para|param|parame|paramet|paramete|parameter)\s*$/,J=/^\s*\\whitespace(?:\s+(.*))?$/,Y=/^\s*\\(wh|whi|whit|white|whites|whitesp|whitespa|whitespac)\s*$/,ee=/^\s*\\(e|en|end)(?:\s+.*)?\s*$/,te=[{name:"macrodef",parse(t,n){const r=n.text,s=A.exec(r);if(s){const n=t.lineStart,a=s[1],i=s[2],l=r.indexOf("\\"),o=t.savePosition(),c=O(t,a);if(c){const s=[f(e.PragmaMark,n+l,n+l+1),f(e.PragmaKeyword,n+l+1,n+l+7),f(e.PragmaName,n+r.indexOf(a),n+r.indexOf(a)+a.length)];if(i){const e=n+r.indexOf("(")+1;s.push(...H(i,e))}if(c.bodyEnd>c.bodyStart){const e=t.parseContentRange(c.bodyStart,c.bodyEnd,!0);s.push(...e)}return s.push(f(e.PragmaEnd,c.endStart,c.endEnd)),t.nextLine(),[f(e.MacroDefinition,n,t.prevLineEnd(),s)]}t.restorePosition(o)}const a=v.exec(r);if(a){const n=t.lineStart,s=a[1],i=a[2],l=a[3],o=r.indexOf("\\");if(l){const a=t.savePosition(),c=O(t,s);if(c){const a=[f(e.PragmaMark,n+o,n+o+1),f(e.PragmaKeyword,n+o+1,n+o+7),f(e.PragmaName,n+r.indexOf(s),n+r.indexOf(s)+s.length)];if(i){const e=n+r.indexOf("(")+1;a.push(...H(i,e))}const d=n+r.length-l.length;if(c.bodyEnd>d){const e=t.parseContentRange(d,c.bodyEnd,!0);a.push(...e)}return a.push(f(e.PragmaEnd,c.endStart,c.endEnd)),t.nextLine(),[f(e.MacroDefinition,n,t.prevLineEnd(),a)]}t.restorePosition(a)}const c=[f(e.PragmaMark,n+o,n+o+1),f(e.PragmaKeyword,n+o+1,n+o+7),f(e.PragmaName,n+r.indexOf(s),n+r.indexOf(s)+s.length)];if(i){const e=n+r.indexOf("(")+1;c.push(...H(i,e))}if(l){const e=n+r.length-l.length,s=t.parser.parseInline(l,e);c.push(...s)}return t.nextLine(),[f(e.MacroDefinition,n,t.prevLineEnd(),c)]}return null}},{name:"fnprocdef",parse(t,n){const r=n.text,s=B.exec(r);if(s){const n=t.lineStart,a=s[1],i=s[2],l=s[3],o=r.indexOf("\\");let c;switch(a){case"function":c=e.FunctionDefinition;break;case"procedure":c=e.ProcedureDefinition;break;case"widget":c=e.WidgetDefinition;break;default:return null}const d=t.savePosition(),u=O(t,i);if(u){const s=[f(e.PragmaMark,n+o,n+o+1),f(e.PragmaKeyword,n+o+1,n+o+1+a.length),f(e.PragmaName,n+r.indexOf(i),n+r.indexOf(i)+i.length)];if(l){const e=n+r.indexOf("(")+1;s.push(...H(l,e))}if(u.bodyEnd>u.bodyStart)if("function"===a){const n=D(t.input.read(u.bodyStart,u.bodyEnd),u.bodyStart);s.push(f(e.FilterExpression,u.bodyStart,u.bodyEnd,n))}else{const e=t.parseContentRange(u.bodyStart,u.bodyEnd,!0);s.push(...e)}return s.push(f(e.PragmaEnd,u.endStart,u.endEnd)),t.nextLine(),[f(c,n,t.prevLineEnd(),s)]}t.restorePosition(d)}const a=E.exec(r);if(a){const n=t.lineStart,s=a[1],i=a[2],l=a[3],o=a[4],c=r.indexOf("\\");let d;switch(s){case"function":d=e.FunctionDefinition;break;case"procedure":d=e.ProcedureDefinition;break;case"widget":d=e.WidgetDefinition;break;default:return null}if(o){const a=t.savePosition(),u=O(t,i);if(u){const a=[f(e.PragmaMark,n+c,n+c+1),f(e.PragmaKeyword,n+c+1,n+c+1+s.length),f(e.PragmaName,n+r.indexOf(i),n+r.indexOf(i)+i.length)];if(l){const e=n+r.indexOf("(")+1;a.push(...H(l,e))}const p=n+r.length-o.length;if(u.bodyEnd>p)if("function"===s){const n=D(t.input.read(p,u.bodyEnd),p);a.push(f(e.FilterExpression,p,u.bodyEnd,n))}else{const e=t.parseContentRange(p,u.bodyEnd,!0);a.push(...e)}return a.push(f(e.PragmaEnd,u.endStart,u.endEnd)),t.nextLine(),[f(d,n,t.prevLineEnd(),a)]}t.restorePosition(a)}const u=[f(e.PragmaMark,n+c,n+c+1),f(e.PragmaKeyword,n+c+1,n+c+1+s.length),f(e.PragmaName,n+r.indexOf(i),n+r.indexOf(i)+i.length)];if(l){const e=n+r.indexOf("(")+1;u.push(...H(l,e))}if(o){const a=n+r.length-o.length;if("function"===s){const t=D(o,a);u.push(f(e.FilterExpression,a,n+r.length,t))}else{const e=t.parser.parseInline(o,a);u.push(...e)}}return t.nextLine(),[f(d,n,t.prevLineEnd(),u)]}return null}},{name:"rules",parse(t,n){const r=I.exec(n.text);if(!r)return null;const s=t.lineStart;r[1],r[2];const a=n.text.indexOf("\\"),i=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+6)];return t.nextLine(),[f(e.RulesPragma,s,t.prevLineEnd(),i)]}},{name:"import",parse(t,n){const r=N.exec(n.text);if(!r)return null;const s=t.lineStart,a=r[1],i=n.text.indexOf("\\"),l=s+n.text.indexOf(a),o=D(a,l),c=[f(e.PragmaMark,s+i,s+i+1),f(e.PragmaKeyword,s+i+1,s+i+7),f(e.FilterExpression,l,l+a.length,o)];return t.nextLine(),[f(e.ImportPragma,s,t.prevLineEnd(),c)]}},{name:"parameters",parse(t,n){const r=F.exec(n.text);if(!r)return null;const s=t.lineStart,a=r[1],i=n.text.indexOf("\\"),l=[f(e.PragmaMark,s+i,s+i+1),f(e.PragmaKeyword,s+i+1,s+i+11)];if(a){const e=s+n.text.indexOf("(")+1;l.push(...H(a,e))}return t.nextLine(),[f(e.ParametersPragma,s,t.prevLineEnd(),l)]}},{name:"whitespace",parse(t,n){if(!W.exec(n.text))return null;const r=t.lineStart,s=n.text.indexOf("\\"),a=[f(e.PragmaMark,r+s,r+s+1),f(e.PragmaKeyword,r+s+1,r+s+11)];return t.nextLine(),[f(e.WhitespacePragma,r,t.prevLineEnd(),a)]}},{name:"partial",parse(t,n){const r=n.text,s=t.lineStart,a=r.indexOf("\\");let i=z.exec(r);if(i){const n=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+7)],l=i[1];if(l){const t=s+r.indexOf(l);n.push(f(e.PragmaName,t,t+l.length))}const o=i[2];if(void 0!==o){const e=s+r.indexOf("(")+1;o&&n.push(...H(o,e))}return t.nextLine(),[f(e.MacroDefinition,s,t.prevLineEnd(),n)]}if(i=Z.exec(r),i){const n=i[1];let l;switch(n){case"function":l=e.FunctionDefinition;break;case"procedure":l=e.ProcedureDefinition;break;case"widget":l=e.WidgetDefinition;break;default:return null}const o=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)],c=i[2];if(c){const t=s+r.indexOf(c);o.push(f(e.PragmaName,t,t+c.length))}const d=i[3];if(void 0!==d){const e=s+r.indexOf("(")+1;d&&o.push(...H(d,e))}return t.nextLine(),[f(l,s,t.prevLineEnd(),o)]}if(i=X.exec(r),i){const n=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+6)];return t.nextLine(),[f(e.RulesPragma,s,t.prevLineEnd(),n)]}if(i=U.exec(r),i){const n=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+7)],l=i[1];if(l&&l.trim()){const t=s+r.indexOf(l);n.push(f(e.FilterExpression,t,t+l.length))}return t.nextLine(),[f(e.ImportPragma,s,t.prevLineEnd(),n)]}if(i=Q.exec(r),i){const n=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+11)],l=i[1];if(void 0!==l){const e=s+r.indexOf("(")+1;l&&n.push(...H(l,e))}return t.nextLine(),[f(e.ParametersPragma,s,t.prevLineEnd(),n)]}if(i=J.exec(r),i){const n=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+11)];return t.nextLine(),[f(e.WhitespacePragma,s,t.prevLineEnd(),n)]}if(i=_.exec(r),i){const n=i[1],l=i[2],o=i[3],c=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];if(l){const t=s+r.indexOf(l);c.push(f(e.PragmaName,t,t+l.length))}if(void 0!==o){const e=s+r.indexOf("(")+1;o&&c.push(...H(o,e))}return t.nextLine(),[f(e.MacroDefinition,s,t.prevLineEnd(),c)]}if(i=V.exec(r),i){const n=i[1],l=i[2],o=i[3],c=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];if(l){const t=s+r.indexOf(l);c.push(f(e.PragmaName,t,t+l.length))}if(void 0!==o){const e=s+r.indexOf("(")+1;o&&c.push(...H(o,e))}return t.nextLine(),[f(e.FunctionDefinition,s,t.prevLineEnd(),c)]}if(i=R.exec(r),i){const n=i[1],l=i[2],o=i[3],c=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];if(l){const t=s+r.indexOf(l);c.push(f(e.PragmaName,t,t+l.length))}if(void 0!==o){const e=s+r.indexOf("(")+1;o&&c.push(...H(o,e))}return t.nextLine(),[f(e.ProcedureDefinition,s,t.prevLineEnd(),c)]}if(i=K.exec(r),i){const n=i[1],l=i[2],o=i[3],c=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];if(l){const t=s+r.indexOf(l);c.push(f(e.PragmaName,t,t+l.length))}if(void 0!==o){const e=s+r.indexOf("(")+1;o&&c.push(...H(o,e))}return t.nextLine(),[f(e.WidgetDefinition,s,t.prevLineEnd(),c)]}if(i=j.exec(r),i){const n=i[1],r=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];return t.nextLine(),[f(e.RulesPragma,s,t.prevLineEnd(),r)]}if(i=q.exec(r),i){const n=i[1],r=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];return t.nextLine(),[f(e.ImportPragma,s,t.prevLineEnd(),r)]}if(i=G.exec(r),i){const n=i[1],r=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];return t.nextLine(),[f(e.ParametersPragma,s,t.prevLineEnd(),r)]}if(i=Y.exec(r),i){const n=i[1],r=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];return t.nextLine(),[f(e.WhitespacePragma,s,t.prevLineEnd(),r)]}if(i=ee.exec(r),i){const n=i[1],r=[f(e.PragmaMark,s+a,s+a+1),f(e.PragmaKeyword,s+a+1,s+a+1+n.length)];return t.nextLine(),[f(e.PragmaEnd,s,t.prevLineEnd(),r)]}return null}}];const ne={name:"Heading",parse(n,r){const s=function(e){if(e.next!==t.Exclamation)return-1;let n=1,r=1;for(;r<e.text.length&&e.text.charCodeAt(r)===t.Exclamation&&n<6;)n++,r++;return n}(r);if(s<0)return!1;const a=n.lineStart,i=a+s,l=i,o=r.text.slice(s),c=n.parser.parseInline(o,l),d=[e.Heading1,e.Heading2,e.Heading3,e.Heading4,e.Heading5,e.Heading6][s-1],u=[f(e.HeadingMark,a,i),...c];return n.addElement(f(d,a,a+r.text.length,u)),!0}},re=/^-{3,}\s*$/,se={name:"HorizontalRule",parse:(t,n)=>!!re.test(n.text)&&(t.addElement(f(e.HorizontalRule,t.lineStart,t.lineStart+n.text.length)),!0)},ae=/^```(\S*)/,ie=/^```\s*$/,le={name:"FencedCode",parse(t,n){const r=ae.exec(n.text);if(!r)return!1;const s=t.lineStart,a=r[1],i=[f(e.CodeMark,s,s+3)];a&&i.push(f(e.CodeInfo,s+3,s+3+a.length));let l="",o=t.lineStart+n.text.length+1,c=!1;for(;t.nextLine();){if(ie.test(t.line.text)){i.push(f(e.CodeText,o,t.prevLineEnd())),i.push(f(e.CodeMark,t.lineStart,t.lineStart+3)),c=!0;break}l&&(l+="\n"),l+=t.line.text}if(!c){const n=t.prevLineEnd();n>o&&i.push(f(e.CodeText,o,n))}const d=c?t.lineStart+t.line.text.length:t.prevLineEnd();return t.addElement(f(e.FencedCode,s,d,i)),!0}},oe=/^\$\$\$([\w\/\-\.\+]*)$/,ce=/^\$\$\$\s*$/,de={name:"TypedBlock",parse(t,n){const r=oe.exec(n.text);if(!r)return!1;const s=t.lineStart,a=r[1],i=[f(e.TypedBlockMark,s,s+3)];a&&i.push(f(e.TypedBlockType,s+3,s+3+a.length));const l="text/plain"===a?e.PlainText:e.CodeText;let o=t.lineStart+n.text.length+1,c=!1;for(;t.nextLine();)if(ce.test(t.line.text)){i.push(f(l,o,t.prevLineEnd())),i.push(f(e.TypedBlockMark,t.lineStart,t.lineStart+3)),c=!0;break}if(!c){const e=t.prevLineEnd();e>o&&i.push(f(l,o,e))}const d=c?t.lineStart+t.line.text.length:t.prevLineEnd();return t.addElement(f(e.TypedBlock,s,d,i)),!0}},ue=/^"""\s*$/,fe={name:"HardLineBreaks",parse(t,n){if(!ue.test(n.text))return!1;const r=t.lineStart,s=[f(e.HardLineBreaksMark,r,r+3)];let a=t.lineStart+n.text.length+1,i=!1;for(;t.nextLine();)if(ue.test(t.line.text)){if(t.lineStart-1>a){const e=t.input.read(a,t.lineStart-1),n=t.parser.parseInline(e,a);s.push(...n)}s.push(f(e.HardLineBreaksMark,t.lineStart,t.lineStart+3)),i=!0;break}if(!i&&t.lineStart>a){const e=t.input.read(a,t.lineStart),n=t.parser.parseInline(e,a);s.push(...n)}const l=i?t.lineStart+t.line.text.length:t.lineStart;return t.addElement(f(e.HardLineBreaks,r,l,s)),!0}},pe=/^\$\$(?!\$)/,he=/\$\$\s*$/,me={name:"KaTeXBlock",after:"TypedBlock",parse(t,n){if(!pe.test(n.text))return!1;const r=t.lineStart,s=[f(e.KaTeXMark,r,r+2)],a=n.text.slice(2),i=a.match(/^(.*)\$\$\s*$/);if(i){const a=i[1];return a.length>0&&s.push(f(e.LaTeXContent,r+2,r+2+a.length)),s.push(f(e.KaTeXMark,r+2+a.length,r+2+a.length+2)),t.addElement(f(e.KaTeXBlock,r,r+n.text.length,s)),!0}let l=r+2;l=a.trim()?r+2:t.lineStart+n.text.length+1;let o=!1;for(;t.nextLine();){if(he.exec(t.line.text)){const n=t.line.text.lastIndexOf("$$"),r=t.lineStart+n;r>l&&s.push(f(e.LaTeXContent,l,r)),s.push(f(e.KaTeXMark,t.lineStart+n,t.lineStart+n+2)),o=!0;break}}if(!o){const n=t.prevLineEnd();n>l&&s.push(f(e.LaTeXContent,l,n))}const c=o?t.lineStart+t.line.text.length:t.prevLineEnd();return t.addElement(f(e.KaTeXBlock,r,c,s)),!0}},ge=/^([*#;:>]+)/,ke={"*":{list:e.BulletList,item:e.ListItem},"#":{list:e.OrderedList,item:e.ListItem},";":{list:e.DefinitionList,item:e.DefinitionTerm},":":{list:e.DefinitionList,item:e.DefinitionDescription},">":{list:e.BlockQuote,item:e.ListItem}};function be(e,t){return e===t||!(";"!==e&&":"!==e||";"!==t&&":"!==t)}const xe={name:"List",parse(t,n){const r=ge.exec(n.text);if(!r)return!1;const s=r[1],a=s[0],i=ke[a];if(!i)return!1;if(">"===a&&/<[$a-zA-Z\/]/.test(n.text.slice(s.length)))return!1;const l=t.lineStart,o=[];for(;;){const n=ge.exec(t.line.text);if(!n||!be(a,n[1][0]))break;const r=n[1],s=t.lineStart,i=s+r.length,l=t.line.text.slice(r.length),c=t.parser.parseInline(l,i),d=[f(e.ListMark,s,i),...c],u=ke[r[r.length-1]]?.item||e.ListItem;o.push(f(u,s,s+t.line.text.length,d));const p=t.peekLine();if(null===p)break;const h=ge.exec(p);if(!h||!be(a,h[1][0]))break;t.nextLine()}return t.addElement(f(i.list,l,t.lineStart+t.line.text.length,o)),!0}},ye=/^<<<(.*)$/,$e={name:"MultiLineBlockQuote",parse(t,n){const r=ye.exec(n.text);if(!r)return!1;if(!n.text.startsWith("<<<")||n.text.startsWith("<<<<"))return!1;const s=t.lineStart,a=s+3,i=r[1].trim(),l=[f(e.QuoteMark,s,a)];if(i){const t=r[1],n=a+(t.length-t.trimStart().length);l.push(f(e.BlockQuoteClass,n,n+i.length))}const o=s+n.text.length+1;let c=o,d=-1,u=-1,p="",h="";for(;t.nextLine();){const e=t.line.text;if(e.startsWith("<<<")&&!e.startsWith("<<<<")){d=t.lineStart,u=t.lineStart+e.length,c=d-1,h=e,p=e.slice(3).trim();break}}if(c>o){const e=t.parseContentRange(o,c,!1);l.push(...e)}if(d>=0&&(l.push(f(e.QuoteMark,d,d+3)),p)){const e=h.slice(3),n=d+3+(e.length-e.trimStart().length),r=t.parser.parseInline(p,n);l.push(...r)}const m=u>=0?u:t.prevLineEnd();return t.addElement(f(e.BlockQuote,s,m,l)),!0}},we=/^\|.*\|([fhck])?\s*$/,Te={c:e.TableCaption,k:e.TableClass,h:e.TableHeader,f:e.TableFooter},Me={name:"Table",parse(t,n){if(!we.test(n.text))return!1;const r=t.lineStart,s=[];for(;;){const n=t.line.text,r=we.exec(n);if(!r)break;const a=t.lineStart,i=r[1],l=i?Te[i]:e.TableRow,o=Se(n,a,t,i);if(s.push(f(l,a,a+n.length,o)),!t.nextLine())break}return t.addElement(f(e.Table,r,t.prevLineEnd(),s)),!0}};function Se(n,r,s,a){const i=[];let l=0,o=-1;const c=a?n.length-1:n.length;for(;l<c;){if(n.charCodeAt(l)===t.Pipe){if(o>=0){const t=n.slice(o,l),a=t.length-t.trimStart().length,c=t.trim(),d=c.startsWith("!"),u=d?e.TableHeaderCell:e.TableCell,p=o+a+(d?1:0),h=d?c.slice(1):c,m=s.parser.parseInline(h,r+p);i.push(f(u,r+o,r+l,m))}i.push(f(e.TableDelimiter,r+l,r+l+1)),o=-1,l++}else o<0&&(o=l),l++}return a&&i.push(f(e.TableMarker,r+n.length-1,r+n.length)),i}const Ce=/^<!--/,Pe={name:"CommentBlock",parse(t,n){const r=n.text.trim();if(Ce.test(r)){const s=t.lineStart;if(r.match(/-->/)){const r=s+n.text.indexOf("--\x3e")+3;t.addElement(f(e.CommentBlock,s,r,[f(e.CommentMarker,s,s+4),f(e.CommentMarker,r-3,r)]));const a=n.text.slice(n.text.indexOf("--\x3e")+3);if(a.trim()){const n=t.parser.parseInline(a,r),s=t.elt(e.Paragraph,r,r+a.length,n);t.addElement(s)}return!0}for(;t.nextLine();){const n=t.line.text,r=n.indexOf("--\x3e");if(-1!==r){const a=t.lineStart+r+3;t.addElement(f(e.CommentBlock,s,a));const i=n.slice(r+3);if(i.trim()){const n=t.parser.parseInline(i,a),r=t.elt(e.Paragraph,a,a+i.length,n);t.addElement(r)}return!0}}return t.addElement(f(e.CommentBlock,s,t.lineStart)),!0}return!1}},Le=/^\{\{([^{}|]*)(?:\|\|([^{}|]+))?(?:\|([^{}]+))?\}\}\s*$/,ve={name:"TransclusionBlock",parse(t,n){const r=Le.exec(n.text);if(!r)return!1;const s=t.lineStart,a=r[1],i=r[2];r[3];const l=[f(e.TransclusionMark,s,s+2)],o=M(a,s+2);l.push(...o);let c=s+2+a.length;return i&&(l.push(f(e.TransclusionTemplate,c+2,c+2+i.length)),c+=2+i.length),l.push(f(e.TransclusionMark,s+n.text.length-2,s+n.text.length)),t.addElement(f(e.TransclusionBlock,s,s+n.text.length,l)),!0}};function Ae(t,n){const r=[],s=/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/g;let a;for(;null!==(a=s.exec(t));){const t=a.index,s=t+a[0].length,i=a[1],l=[f(e.PlaceholderMark,n+t,n+t+1),f(e.VariableName,n+t+1,n+t+1+i.length),f(e.PlaceholderMark,n+s-1,n+s)];r.push(f(e.Placeholder,n+t,n+s,l))}return r}function Ee(t,n){const r=[];let s=0;const a=t.length;for(;s<a;){const i=t[s];if(/\s/.test(i))s++;else{if("["===i){const i=s;s++;const l=[];for(;s<a&&"]"!==t[s];){"!"===t[s]&&s++;const r=t[s];if("["===r){s++;const r=s;let i=1;for(;s<a&&i>0;)"["===t[s]?i++:"]"===t[s]&&i--,i>0&&s++;const o=t.slice(r,s);if(o.includes("$")){const t=Ae(o,n+r);t.length>0?l.push(f(e.FilterOperand,n+r,n+s,t)):l.push(f(e.FilterOperand,n+r,n+s))}else l.push(f(e.FilterOperand,n+r,n+s));s<a&&"]"===t[s]&&s++}else if("<"===r){s++;const r=s;for(;s<a&&">"!==t[s];)s++;const i=t.slice(r,s),o=s<a&&">"===t[s],c=/^__(.+)__$/.exec(i),d=!c&&/^__(.*)$/.exec(i);if(c){const t=c[1],a=n+r-1,i=n+s+1,o=n+r,d=[f(e.SubstitutedParamMark,o,o+2),f(e.SubstitutedParamName,o+2,o+2+t.length),f(e.SubstitutedParamMark,o+2+t.length,n+s)];l.push(f(e.SubstitutedParam,a,i,d))}else if(d){const t=d[1],a=n+r-1,i=o?n+s+1:n+s,c=n+r,u=[f(e.SubstitutedParamMark,c,c+2)];t&&u.push(f(e.SubstitutedParamName,c+2,c+2+t.length)),l.push(f(e.SubstitutedParam,a,i,u))}else{const t=i.search(/\s/);if(-1!==t){const a=n+r-1,c=o?n+s+1:n+s,d=[f(e.MacroCallMark,a,a+1)],u=i.slice(0,t),p=n+r,h=p+u.length,m=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(u);if(m){const t=m[1];d.push(f(e.Placeholder,p,h,[f(e.PlaceholderMark,p,p+1),f(e.VariableName,p+1,p+1+t.length),f(e.PlaceholderMark,h-1,h)]))}else d.push(f(e.MacroName,p,h));const g=i.slice(t),k=n+r+t,b=L(g.trim(),k+(g.length-g.trimStart().length));d.push(...b),o&&d.push(f(e.MacroCallMark,n+s,n+s+1)),l.push(f(e.MacroCall,a,c,d))}else l.push($(i,n+r,n+s))}s<a&&s++}else if("{"===r){s++;const e=s;for(;s<a&&"}"!==t[s];)s++;const r=t.slice(e,s);l.push(y(r,n+e,n+s)),s<a&&s++}else if("/"===r){s++;const r=s;for(;s<a&&"/"!==t[s];)"\\"===t[s]&&s++,s++;for(l.push(f(e.FilterRegexp,n+r,n+s)),s<a&&s++;s<a&&/[gimsuy]/.test(t[s]);)s++}else if("$"===r){const r=t.slice(s).match(/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/);if(r){const t=r[1],a=s+r[0].length,i=[f(e.PlaceholderMark,n+s,n+s+1),f(e.VariableName,n+s+1,n+s+1+t.length),f(e.PlaceholderMark,n+a-1,n+a)];l.push(f(e.Placeholder,n+s,n+a,i)),s=a}else s++}else if(/[a-zA-Z]/.test(r)){const r=s;for(;s<a&&/[a-zA-Z0-9\-_:!]/.test(t[s]);)s++;l.push(f(e.FilterOperatorName,n+r,n+s))}else s++}s<a&&"]"===t[s]&&s++;const o=s;r.push(f(e.FilterOperator,n+i,n+o,l));continue}if("["===i&&"["===t[s+1]){const i=s;for(s+=2;s<a&&("]"!==t[s]||"]"!==t[s+1]);)s++;s+=2,r.push(f(e.FilterOperand,n+i,n+s));continue}if("+"!==i&&"-"!==i&&"~"!==i&&":"!==i){if("$"===i){const a=t.slice(s).match(/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/);if(a){const t=a[1],i=s+a[0].length,l=[f(e.PlaceholderMark,n+s,n+s+1),f(e.VariableName,n+s+1,n+s+1+t.length),f(e.PlaceholderMark,n+i-1,n+i)];r.push(f(e.Placeholder,n+s,n+i,l)),s=i;continue}}s++}else for(s++;s<a&&/[a-zA-Z]/.test(t[s]);)s++}}return r}const Be={name:"FilteredTransclusionBlock",parse(t,n){if(!n.text.startsWith("{{{"))return!1;const r=n.text.indexOf("}}}",3);if(-1===r)return!1;const s=n.text.slice(r+3).trim();let a="";if(s){if(!s.startsWith("||"))return!1;a=s.slice(2)}const i=t.lineStart,l=n.text.slice(3,r),o=Ee(l,i+3),c=[f(e.FilteredTransclusionMark,i,i+3),f(e.FilterExpression,i+3,i+3+l.length,o),f(e.FilteredTransclusionMark,i+3+l.length,i+6+l.length)];return a&&c.push(f(e.TransclusionTemplate,i+r+5,i+r+5+a.length)),t.addElement(f(e.FilteredTransclusionBlock,i,i+n.text.length,c)),!0}},Ie={name:"MacroCallBlock",parse(t,n){if(!n.text.startsWith("<<"))return!1;const r=t.lineStart;let s=2;for(;s<n.text.length&&!/[\s>]/.test(n.text[s]);)s++;const a=n.text.slice(2,s);if(!a)return!1;let i=n.text.indexOf(">>",2),l=n.text,o=t.lineStart+n.text.length;const c=-1===i?n.text.indexOf(">",s):-1,d=t=>{const n=/^__(.+)__$/.exec(a),s=!n&&/^__(.*)$/.exec(a);if(n){const s=n[1],i=r+2,l=[f(e.SubstitutedParamMark,i,i+2),f(e.SubstitutedParamName,i+2,i+2+s.length),f(e.SubstitutedParamMark,i+2+s.length,i+a.length)];t.push(f(e.SubstitutedParam,i,i+a.length,l))}else if(s){const n=s[1],i=r+2,l=[f(e.SubstitutedParamMark,i,i+2)];n&&l.push(f(e.SubstitutedParamName,i+2,i+2+n.length)),t.push(f(e.SubstitutedParam,i,i+a.length,l))}else{const n=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(a);if(n){const s=n[1],i=r+2,l=[f(e.PlaceholderMark,i,i+1),f(e.VariableName,i+1,i+1+s.length),f(e.PlaceholderMark,i+a.length-1,i+a.length)];t.push(f(e.Placeholder,i,i+a.length,l))}else t.push(f(e.MacroName,r+2,r+2+a.length))}};let u="",p=0;if(-1!==c){const a=[f(e.MacroCallMark,r,r+2)];d(a);const i=n.text.slice(s,c);if(i.trim()){const e=L(i,r+s);a.push(...e)}return t.addElement(f(e.MacroCallBlock,r,o,a)),!0}if(-1===i){for(;t.nextLine();){const e=t.line.text;l+="\n"+e;const n=e.indexOf(">>");if(-1!==n){i=l.length-(e.length-n);const r=t.lineStart+n+2;o=t.lineStart+e.length;const s=e.slice(n+2);s.trim()&&(u=s,p=r);break}o=t.lineStart+e.length}if(-1===i){const n=[f(e.MacroCallMark,r,r+2)];d(n);const a=l.slice(s);if(a.trim()){const e=L(a,r+s);n.push(...e)}return t.addElement(f(e.MacroCallBlock,r,o,n)),!0}}else if(n.text.slice(i+2).trim())return!1;const h=[f(e.MacroCallMark,r,r+2)];d(h);const m=l.slice(s,i);if(m.trim()){const e=L(m,r+s);h.push(...e)}const g=r+i;h.push(f(e.MacroCallMark,g,g+2));const k=u?p:o;if(t.addElement(f(e.MacroCallBlock,r,k,h)),u.trim()){const n=t.parser.parseInline(u,p),r=f(e.Paragraph,p,p+u.length,n);t.addElement(r)}return!0}},Ne=new Set(["emptymessage","template","caption","tooltip","placeholder","default","alt","description","message","content"]),Fe=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/;function We(t,n,r){const s=Fe.exec(t);if(s){const t=s[1],a=[f(e.PlaceholderMark,n,n+1),f(e.VariableName,n+1,n+1+t.length),f(e.PlaceholderMark,r-1,r)];return f(e.Placeholder,n,r,a)}return f(e.AttributeName,n,r)}function Oe(t,n,r,s){const a=[];let i=0;const l=t.length;for(;i<l;){for(;i<l&&/\s/.test(t[i]);)i++;if(i>=l)break;const r=i;for(;i<l&&/[a-zA-Z0-9\-_:.$]/.test(t[i]);)i++;if(i===r){i++;continue}const o=i;for(;i<l&&/\s/.test(t[i]);)i++;if(i>=l||"="!==t[i]){const s=[We(t.slice(r,o),n+r,n+o)];a.push(f(e.Attribute,n+r,n+o,s));continue}for(i++;i<l&&/\s/.test(t[i]);)i++;if(i>=l){const s=[We(t.slice(r,o),n+r,n+o)];a.push(f(e.Attribute,n+r,n+i,s));continue}const c=i;let d=i,u=e.AttributeValue;const p=t[i];if('"'===p&&'"""'===t.slice(i,i+3)){const u=i;i+=3;const p=i;for(;i<l&&'"""'!==t.slice(i,i+3);)i++;const h=i,m=i;'"""'===t.slice(i,i+3)&&(i+=3),d=i;const g=t.slice(p,h);let k=[f(e.Mark,n+u,n+p)];if(s&&g.trim()){const i=s(g,n+p);k.push(...i),k.push(f(e.Mark,n+m,n+d));const l=[We(t.slice(r,o),n+r,n+o),f(e.AttributeWikitext,n+c,n+d,k)];a.push(f(e.Attribute,n+r,n+d,l))}else{const s=[We(t.slice(r,o),n+r,n+o),f(e.AttributeString,n+c,n+d)];a.push(f(e.Attribute,n+r,n+d,s))}continue}if('"'===p||"'"===p){const h=p;i++;const m=i;for(;i<l&&t[i]!==h;)"\\"===t[i]&&i+1<l&&i++,i++;const g=i;i<l&&i++,d=i,u=e.AttributeString;const k=t.slice(r,o).toLowerCase();if("filter"===k||"$filter"===k||"$names"===k||"$values"===k){const s=Ee(t.slice(m,g),n+m),i=[f(e.Mark,n+c,n+m),f(e.FilterExpression,n+m,n+g,s),f(e.Mark,n+g,n+d)],l=[We(t.slice(r,o),n+r,n+o),f(e.AttributeFiltered,n+c,n+d,i)];a.push(f(e.Attribute,n+r,n+d,l));continue}if(s&&Ne.has(k)){const i=t.slice(m,g);if(i.trim()){const l=s(i,n+m),u=[f(e.Mark,n+c,n+m),...l,f(e.Mark,n+g,n+d)],p=[We(t.slice(r,o),n+r,n+o),f(e.AttributeWikitext,n+c,n+d,u)];a.push(f(e.Attribute,n+r,n+d,p));continue}}}else if("{"===p){if("{{{"===t.slice(i,i+3)){const s=i;i+=3;const p=i;for(;i<l&&"}}}"!==t.slice(i,i+3);)i++;const h=i;"}}}"===t.slice(i,i+3)&&(i+=3),d=i,u=e.AttributeFiltered;const m=Ee(t.slice(p,h),n+p),g=[f(e.FilteredTransclusionMark,n+s,n+s+3),f(e.FilterExpression,n+p,n+h,m),f(e.FilteredTransclusionMark,n+h,n+d)],k=[We(t.slice(r,o),n+r,n+o),f(u,n+c,n+d,g)];a.push(f(e.Attribute,n+r,n+d,k));continue}if("{{"===t.slice(i,i+2)){const s=i;i+=2;const p=i;for(;i<l&&"}}"!==t.slice(i,i+2);)i++;const h=i;"}}"===t.slice(i,i+2)&&(i+=2),d=i,u=e.AttributeIndirect;const m=M(t.slice(p,h),n+p),g=[f(e.TransclusionMark,n+s,n+s+2),...m,f(e.TransclusionMark,n+h,n+d)],k=[We(t.slice(r,o),n+r,n+o),f(u,n+c,n+d,g)];a.push(f(e.Attribute,n+r,n+d,k));continue}for(;i<l&&!/[\s>]/.test(t[i]);)i++;d=i}else{if("<"===p&&"<"===t[i+1]){const s=i;i+=2;const p=i;for(;i<l&&/[a-zA-Z0-9\-_.$]/.test(t[i]);)i++;const h=i;let m=1;for(;i<l&&m>0;)if("<<"===t.slice(i,i+2))m++,i+=2;else if(">>"===t.slice(i,i+2)){if(m--,0===m)break;i+=2}else i++;const g=i;">>"===t.slice(i,i+2)&&(i+=2),d=i,u=e.AttributeMacro;const k=t.slice(p,h),b=[f(e.MacroCallMark,n+s,n+s+2)],x=/^__(.+)__$/.exec(k);if(x){const t=x[1],r=n+p,s=[f(e.SubstitutedParamMark,r,r+2),f(e.SubstitutedParamName,r+2,r+2+t.length),f(e.SubstitutedParamMark,r+2+t.length,n+h)];b.push(f(e.SubstitutedParam,r,n+h,s))}else b.push(f(e.MacroName,n+p,n+h));b.push(f(e.MacroCallMark,n+g,n+d));const y=[We(t.slice(r,o),n+r,n+o),f(u,n+c,n+d,b)];a.push(f(e.Attribute,n+r,n+d,y));continue}if("`"===p){let s,p;if("```"===t.slice(i,i+3)){for(s=i+3,i+=3;i<l&&"```"!==t.slice(i,i+3);)i++;p=i,"```"===t.slice(i,i+3)&&(i+=3)}else{for(s=i+1,i++;i<l&&"`"!==t[i];)i++;p=i,i<l&&i++}d=i,u=e.AttributeSubstituted;const h=[f(e.Mark,n+c,n+s)],m=t.slice(s,p);let g=0;const k=n+s;for(;g<m.length;){if("${"===m.slice(g,g+2)){let t=-1;for(let e=g+2;e<m.length-1;e++)if("}"===m[e]&&"$"===m[e+1]){t=e;break}if(-1!==t){const n=[m.slice(g,t+2),m.slice(g+2,t)],r=k+g,s=r+n[0].length,a=r+2,i=s-2,l=Ee(n[1].trim(),a+(n[1].length-n[1].trimStart().length));h.push(f(e.FilterSubstitution,r,s,[f(e.FilterSubstitutionMark,r,r+2),f(e.FilterExpression,a,i,l),f(e.FilterSubstitutionMark,s-2,s)])),g+=n[0].length;continue}}const t=m.slice(g).match(/^\$\(([^)]+)\)\$/);if(t){const n=k+g,r=n+t[0].length,s=n+2,a=s+t[1].length;h.push(f(e.Variable,n,r,[f(e.VariableMark,n,n+2),f(e.VariableName,s,a),f(e.VariableMark,a,r)])),g+=t[0].length}else g++}h.push(f(e.Mark,n+p,n+d));const b=[We(t.slice(r,o),n+r,n+o),f(u,n+c,n+d,h)];a.push(f(e.Attribute,n+r,n+d,b));continue}{for(;i<l&&!/[\s>\/]/.test(t[i]);)i++;d=i;const s=t.slice(c,d),p=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(s);if(p){const s=p[1],i=[f(e.PlaceholderMark,n+c,n+c+1),f(e.VariableName,n+c+1,n+c+1+s.length),f(e.PlaceholderMark,n+d-1,n+d)],l=[We(t.slice(r,o),n+r,n+o),f(e.Placeholder,n+c,n+d,i)];a.push(f(e.Attribute,n+r,n+d,l));continue}u=/^-?\d+(\.\d+)?$/.test(s)?e.AttributeNumber:/^@[a-zA-Z][a-zA-Z0-9\-_]*$/.test(s)?e.AttributeParamRef:e.AttributeString}}const h=[We(t.slice(r,o),n+r,n+o),f(u,n+c,n+d)];a.push(f(e.Attribute,n+r,n+d,h))}return a}const De=/^(\s*)<([a-zA-Z$][a-zA-Z0-9\-\.]*)/,He=/^(\s*)<\/([a-zA-Z$][a-zA-Z0-9\-\.]*)>/,ze=/^(\s*)<\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/,_e=/^(\s*)<\/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$>/,Ze={name:"HTMLBlock",parse(t,n){const r=n.text;if(ze.exec(r)){const n=t.lineStart,s=n+r.length,a=t.parser.parseInline(r,n);return t.addElement(t.elt(e.Paragraph,n,s,a)),!0}if(_e.exec(r)){const n=t.lineStart,s=n+r.length,a=t.parser.parseInline(r,n);return t.addElement(t.elt(e.Paragraph,n,s,a)),!0}const s=He.exec(r);if(s){const n=s[1].length,a=s[2],i=a.startsWith("$"),l=t.lineStart,o=[],c=l+n;o.push(f(e.TagMark,c,c+1)),o.push(f(e.TagMark,c+1,c+2));const d=l+n+2;o.push(f(i?e.WidgetName:e.TagName,d,d+a.length));const u=l+s[0].length;o.push(f(e.TagMark,u-1,u)),t.addElement(f(i?e.WidgetEnd:e.HTMLEndTag,l,u,o));const p=r.slice(s[0].length);if(p.trim()){const n=t.parser.parseInline(p,u),r=t.elt(e.Paragraph,u,u+p.length,n);t.addElement(r)}return!0}const a=De.exec(r);if(!a)return!1;const i=a[1].length,l=a[2],o=l.startsWith("$"),c=t.lineStart,d=[],u=c+i;d.push(f(e.TagMark,u,u+1));const p=c+i+1;let h,m;d.push(f(o?e.WidgetName:e.TagName,p,p+l.length));let g,k=p+l.length;const b=e=>{let t=0;const n=e.length;for(;t<n;){const r=e[t];if(">"===r)return{pos:t+1,selfClose:!1};if("/"===r&&">"===e[t+1])return{pos:t+2,selfClose:!0};if('"'===r&&'"'===e[t+1]&&'"'===e[t+2]){for(t+=3;t<n&&('"'!==e[t]||'"'!==e[t+1]||'"'!==e[t+2]);)t++;t+=3}else if('"'===r||"'"===r){const s=r;for(t++;t<n&&e[t]!==s;)"\\"===e[t]&&t++,t++;t++}else if("<"===r&&"<"===e[t+1]){t+=2;let r=1;for(;t<n&&r>0;)"<"===e[t]&&"<"===e[t+1]?(r++,t+=2):">"===e[t]&&">"===e[t+1]?(r--,t+=2):t++}else if("<"===r){const n=e[t+1];if(n&&/[a-zA-Z$\/]/.test(n))return null;t++}else if("{"===r&&"{"===e[t+1]&&"{"===e[t+2]){for(t+=3;t<n&&("}"!==e[t]||"}"!==e[t+1]||"}"!==e[t+2]);)t++;t+=3}else if("{"===r&&"{"===e[t+1]){for(t+=2;t<n&&("}"!==e[t]||"}"!==e[t+1]);)t++;t+=2}else if("`"===r)if("```"===e.slice(t,t+3)){for(t+=3;t<n&&"```"!==e.slice(t,t+3);)t++;t+=3}else{for(t++;t<n&&"`"!==e[t];)t++;t++}else t++}return null},x=r.slice(i+1+l.length);let y=b(x),$=x;const w=t.savePosition();for(;!y&&t.nextLine();)$+="\n"+t.line.text,y=b($);if(y||t.restorePosition(w),!y){if(m=!1,h=c+r.length,g=h,x.trim()){const e=Oe(x,k,0,t.parser.parseInline.bind(t.parser));d.push(...e)}return t.addElement(f(o?e.Widget:e.HTMLBlock,c,h,d)),!0}{m=y.selfClose,h=c+i+1+l.length+y.pos,g=t.lineStart+t.line.text.length;let n=$.slice(0,y.pos-1);if(m&&n.endsWith("/")&&(n=n.slice(0,-1)),n.trim()){const e=Oe(n,k,0,t.parser.parseInline.bind(t.parser));d.push(...e)}m?(d.push(f(e.SelfClosingMarker,h-2,h-1)),d.push(f(e.TagMark,h-1,h))):d.push(f(e.TagMark,h-1,h))}if(!m){const n=new RegExp(`<${l.replace(/\$/g,"\\$")}(?:\\s|>|/>)`),r=new RegExp(`</${l.replace(/\$/g,"\\$")}>`);new RegExp(`^(\\s*)</${l.replace(/\$/g,"\\$")}>`);let s=g,a=!1;const i=t.input.read(h,g),u=r.exec(i);if(u){const c=i.slice(0,u.index),p=c.match(n)||[],m=c.match(new RegExp(r.source,"g"))||[];if(p.length===m.length){const n=h,r=h+u.index;if(r>n){const e=t.input.read(n,r),s=t.parser.parseInline(e,n);d.push(...s)}const c=h+u.index,p=h+u.index+u[0].length,m=[];m.push(f(e.TagMark,c,c+1)),m.push(f(e.TagMark,c+1,c+2));const k=h+u.index+2;m.push(f(o?e.WidgetName:e.TagName,k,k+l.length)),m.push(f(e.TagMark,p-1,p)),d.push(f(o?e.WidgetEnd:e.HTMLEndTag,c,p,m));const b=i.slice(u.index+u[0].length);if(b.trim()){const e=p,n=t.parser.parseInline(b,e);d.push(...n)}s=g,a=!0}}if(!a){const n=t.input.read(h,g),r=g+1;let i=r,u=1;const p=new RegExp(`<${l.replace(/\$/g,"\\$")}(?![a-zA-Z0-9\\-])`,"g");let m;for(;null!==(m=p.exec(n));){const e=n.slice(m.index);/^<[^>]*\/>/.test(e)||u++}const k=t.savePosition();for(new RegExp(`</${l.replace(/\$/g,"\\$")}>`);t.nextLine();){const p=t.line.text,m=new RegExp(`<${l.replace(/\$/g,"\\$")}(?![a-zA-Z0-9\\-])`,"g"),g=new RegExp(`</${l.replace(/\$/g,"\\$")}>`,"g"),k=[];let b,x;for(;null!==(b=m.exec(p));){const e=p.slice(b.index);/^<[^>]*\/>/.test(e)||k.push({pos:b.index,type:"open",match:b})}for(;null!==(x=g.exec(p));)k.push({pos:x.index,type:"close",match:x});k.sort((e,t)=>e.pos-t.pos);let y=-1,$=null;for(const e of k)if("open"===e.type)u++;else if(u--,0===u){y=e.pos,$=e.match;break}if(null!==$&&0===u){const u=t.lineStart+y,m=$[0].length,g=u+m;i=u-1;const k=n.trim(),b=k&&/<[$a-zA-Z]/.test(k);if(n.trim()&&!b){const e=t.parser.parseInline(n,h);d.push(...e)}const x=b?h:r;if(i>=x){const e=t.parseContentRange(x,i+1,!1);d.push(...e)}const w=[];w.push(f(e.TagMark,u,u+1)),w.push(f(e.TagMark,u+1,u+2));const T=u+2;w.push(f(o?e.WidgetName:e.TagName,T,T+l.length)),w.push(f(e.TagMark,g-1,g)),d.push(f(o?e.WidgetEnd:e.HTMLEndTag,u,g,w)),s=g;const M=p.slice(y+m);if(M.trim()&&/^<[$a-zA-Z]/.test(M.trim())){t.addElement(f(o?e.Widget:e.HTMLBlock,c,s,d));const n=g,r=t.rangeEnd;if(r>n){const e=t.parseContentRange(n,r,!1);for(const n of e)t.addElement(n);t.skipToPosition(r)}return!0}a=!0;break}}a||(t.restorePosition(k),s=g)}return t.addElement(f(o?e.Widget:e.HTMLBlock,c,s,d)),!0}if(t.input.read(h,g).trim()){t.addElement(f(o?e.Widget:e.HTMLBlock,c,h,d));const n=h,r=t.rangeEnd;if(r>n){const e=t.parseContentRange(n,r,!1);for(const n of e)t.addElement(n);t.skipToPosition(r)}return!0}return t.addElement(f(o?e.Widget:e.HTMLBlock,c,h,d)),!0}},Ve={name:"StyledBlock",parse(t,n){if(!n.text.startsWith("@@"))return!1;if(-1!==n.text.indexOf("@@",2))return!1;const r=t.lineStart,s=[f(e.HighlightMark,r,r+2)],a=n.text.slice(2);let i=-1;for(let e=0;e<a.length;e++)if("."===a[e]){const t=a[e+1];if(!t||/[a-zA-Z_\s\.]/.test(t)){i=e;break}}let l=-1!==i?i:a.trimEnd().length;l>0&&s.push(f(e.HighlightStyles,r+2,r+2+l));let o=-1!==i?2+i:n.text.length;for(;o<n.text.length;)if("."===n.text[o]){const t=o;o++;const a=o;for(;o<n.text.length&&/[a-zA-Z0-9_\-]/.test(n.text[o]);)o++;o>a&&(s.push(f(e.StyledBlockMark,r+t,r+t+1)),s.push(f(e.StyledBlockClass,r+a,r+o)))}else o++;const c=r+n.text.length;let d=t.lineStart+n.text.length+1,u=d;for(;d<t.input.length;){let n=d;for(;n<t.input.length&&"\n"!==t.input.read(n,n+1);)n++;const a=t.input.read(d,n);if("@@"===a.trim()){if(u=d,u>c+1){const e=t.parseContentRange(c+1,u);s.push(...e)}const i=d+a.indexOf("@@");for(s.push(f(e.HighlightMark,i,i+2)),t.addElement(f(e.Highlight,r,n,s));t.lineStart<d;)t.nextLine();return!0}d=n+1}return!1}},Re=/^\s*<%\s*if\s+(.+?)\s*%>/,Ke=/^\s*<%\s*elseif\s+(.+?)\s*%>/,Xe=/^\s*<%\s*else\s*%>/,je=/^\s*<%\s*endif\s*%>/,Ue=[le,de,{name:"ConditionalBlock",parse(t,n){const r=Re.exec(n.text);if(!r)return!1;const s=t.lineStart,a=r[1],i=[],l=s+n.text.indexOf("<%"),o=s+n.text.indexOf("if");i.push(f(e.ConditionalMark,l,l+2)),i.push(f(e.ConditionalKeyword,o,o+2));const c=s+n.text.indexOf(a),d=Ee(a,c);i.push(f(e.FilterExpression,c,c+a.length,d));const u=s+n.text.indexOf("%>");i.push(f(e.ConditionalMark,u,u+2));const p=s+n.text.length;let h=u+2,m=h,g=1,k=-1,b=-1;const x=n.text.slice(u+2-s),y=/<%\s*endif\s*%>/.exec(x);if(y){const n=x.slice(0,y.index);if(n.trim()){const r=u+2,s=u+2+y.index,a=t.parser.parseInline(n,r);i.push(f(e.ConditionalBranch,r,s,a))}const r=u+2+y.index,a=u+2+x.indexOf("endif",y.index),l=u+2+x.indexOf("%>",y.index);return i.push(f(e.ConditionalMark,r,r+2)),i.push(f(e.ConditionalKeyword,a,a+5)),i.push(f(e.ConditionalMark,l,l+2)),k=l+2,t.addElement(f(e.ConditionalBlock,s,k,i)),!0}for(m=p+1;m<t.input.length&&g>0;){let n=m;for(;n<t.input.length&&"\n"!==t.input.read(n,n+1);)n++;const r=t.input.read(m,n);if(Re.test(r))g++;else if(je.test(r)){if(g--,0===g){if(m>h){const n=t.parseContentRange(h,m);n.length>0&&i.push(f(e.ConditionalBranch,h,m,n))}const s=m+r.indexOf("<%"),a=m+r.indexOf("endif"),l=m+r.indexOf("%>");i.push(f(e.ConditionalMark,s,s+2)),i.push(f(e.ConditionalKeyword,a,a+5)),i.push(f(e.ConditionalMark,l,l+2)),b=m,k=n;break}}else if(1===g&&Ke.test(r)){if(m>h){const n=t.parseContentRange(h,m);n.length>0&&i.push(f(e.ConditionalBranch,h,m,n))}const s=Ke.exec(r);if(s){const t=m+r.indexOf("<%"),n=m+r.indexOf("elseif");i.push(f(e.ConditionalMark,t,t+2)),i.push(f(e.ConditionalKeyword,n,n+6));const a=s[1],l=m+r.indexOf(a),o=Ee(a,l);i.push(f(e.FilterExpression,l,l+a.length,o)),i.push(f(e.ConditionalMark,m+r.indexOf("%>"),m+r.indexOf("%>")+2))}h=n+1}else if(1===g&&Xe.test(r)){if(m>h){const n=t.parseContentRange(h,m);n.length>0&&i.push(f(e.ConditionalBranch,h,m,n))}const s=m+r.indexOf("<%"),a=m+r.indexOf("else"),l=m+r.indexOf("%>");i.push(f(e.ConditionalMark,s,s+2)),i.push(f(e.ConditionalKeyword,a,a+4)),i.push(f(e.ConditionalMark,l,l+2)),h=n+1}m=n+1}if(-1===k){if(h<=t.input.length){const n=t.parseContentRange(h,t.input.length);i.push(f(e.ConditionalBranch,h,t.input.length,n))}for(t.addElement(f(e.ConditionalBlock,s,t.input.length,i));!t.atEnd;)t.nextLine();return!0}for(t.addElement(f(e.ConditionalBlock,s,k,i));t.lineStart<b;)t.nextLine();return!0}},Ve,ne,se,fe,$e,xe,Me,Pe,ve,Be,Ie,Ze],qe={name:"Escape",parse(n,r,s){if(r!==t.Tilde&&r!==t.Backslash)return-1;const a=n.char(s+1);return a<0?-1:r===t.Tilde?a>=65&&a<=90?n.addElement(n.elt(e.Escape,s,s+1)):-1:n.addElement(n.elt(e.Escape,s,s+2))}},Qe=/^&(?:#x[0-9a-fA-F]+|#[0-9]+|[a-zA-Z]+);/,Ge={name:"Entity",parse(n,r,s){if(r!==t.Ampersand)return-1;const a=n.slice(s,n.end),i=Qe.exec(a);return i?n.addElement(n.elt(e.Entity,s,s+i[0].length)):-1}},Je={name:"InlineCode",parse(n,r,s){if(r!==t.Backtick)return-1;const a=n.char(s+1)===t.Backtick?2:1,i=s+a;let l=i;for(;l<n.end;){if(n.char(l)===t.Backtick){const r=l+1<n.end&&n.char(l+1)===t.Backtick?2:1;if(r===a){const t=l+r;return n.addElement(n.elt(e.InlineCode,s,t,[n.elt(e.InlineCodeMark,s,i),n.elt(e.CodeText,i,l),n.elt(e.InlineCodeMark,l,t)]))}l+=r;continue}l++}const o=[n.elt(e.InlineCodeMark,s,i)];return n.end>i&&o.push(n.elt(e.CodeText,i,n.end)),n.addElement(n.elt(e.InlineCode,s,n.end,o))}},Ye={name:"InlineKaTeX",after:"InlineCode",parse(n,r,s){if(r!==t.Dollar)return-1;if(n.char(s+1)!==t.Dollar)return-1;if(n.char(s+2)===t.Dollar)return-1;const a=n.char(s+2);if(a>=0&&/[a-zA-Z_]/.test(String.fromCharCode(a)))return-1;const i=s+2;let l=i;for(;l<n.end-1;){if(n.char(l)===t.Dollar&&n.char(l+1)===t.Dollar){const t=l+2,r=[n.elt(e.KaTeXMark,s,i)];return l>i&&r.push(n.elt(e.LaTeXContent,i,l)),r.push(n.elt(e.KaTeXMark,l,t)),n.addElement(n.elt(e.KaTeXBlock,s,t,r))}l++}return-1}},et={name:"Bold",parse:T({charCode:t.Apostrophe,delimType:{resolve:"Bold",mark:"BoldMark"}})},tt={name:"Italic",parse:T({charCode:t.Slash,delimType:{resolve:"Italic",mark:"ItalicMark"}})},nt={name:"Underline",parse:T({charCode:t.Underscore,delimType:{resolve:"Underline",mark:"UnderlineMark"}})},rt={name:"Strikethrough",parse:T({charCode:t.Tilde,delimType:{resolve:"Strikethrough",mark:"StrikethroughMark"}})},st={name:"Superscript",parse:T({charCode:t.Caret,delimType:{resolve:"Superscript",mark:"SuperscriptMark"}})},at={name:"Subscript",parse:T({charCode:t.Comma,delimType:{resolve:"Subscript",mark:"SubscriptMark"}})},it=/^((?:[^\.\r\n\s:]+:[^\r\n;]+;)+)/,lt={name:"Highlight",parse(n,r,s){if(r!==t.At||n.char(s+1)!==t.At)return-1;const a=n.slice(s,n.end);let i=-1;for(let e=2;e<a.length-1;e++)if("@"===a[e]&&"@"===a[e+1]){i=e;break}if(-1===i)return-1;const l=s+i+2,o=a.slice(2,i),c=[n.elt(e.HighlightMark,s,s+2)];let d=0;const u=it.exec(o);if(u){const t=u[1].length;c.push(n.elt(e.HighlightStyles,s+2,s+2+t)),d=t}for(;d<o.length&&"."===o[d];){const t=d;d++;const r=d;for(;d<o.length&&/[a-zA-Z0-9_\-]/.test(o[d]);)d++;d>r&&(c.push(n.elt(e.StyledBlockMark,s+2+t,s+2+t+1)),c.push(n.elt(e.StyledBlockClass,s+2+r,s+2+d)))}if(d<o.length&&/\s/.test(o[d])&&d++,d<i){const e=o.slice(d),t=n.parser.parseInline(e,s+2+d);c.push(...t)}return c.push(n.elt(e.HighlightMark,l-2,l)),n.addElement(n.elt(e.Highlight,s,l,c))}},ot=/^\[\[([^\]|]*?)(?:\|([^\]]*?))?\]\]/,ct=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/;function dt(t,n,r,s){const a=ct.exec(n);if(a){const n=a[1];return t.elt(e.Placeholder,r,s,[t.elt(e.PlaceholderMark,r,r+1),t.elt(e.VariableName,r+1,r+1+n.length),t.elt(e.PlaceholderMark,s-1,s)])}return t.elt(e.LinkTarget,r,s)}const ut={name:"WikiLink",parse(n,r,s){if(r!==t.LeftBracket||n.char(s+1)!==t.LeftBracket)return-1;const a=n.slice(s,n.end),i=ot.exec(a);if(!i){const t=/^\[\[([^\]\n]*)$/.exec(a);if(t){const r=s+t[0].length,a=t[1],i=[n.elt(e.WikiLinkMark,s,s+2)],l=a.indexOf("|");if(-1!==l){if(i.push(n.elt(e.LinkText,s+2,s+2+l)),i.push(n.elt(e.LinkSeparator,s+2+l,s+3+l)),a.length>l+1){const e=a.slice(l+1);i.push(dt(n,e,s+3+l,r))}}else a&&i.push(dt(n,a,s+2,r));return n.addElement(n.elt(e.WikiLink,s,r,i))}return-1}const l=s+i[0].length,o=i[1],c=i[2],d=[n.elt(e.WikiLinkMark,s,s+2)];return void 0!==c?(d.push(n.elt(e.LinkText,s+2,s+2+o.length)),d.push(n.elt(e.LinkSeparator,s+2+o.length,s+3+o.length)),d.push(dt(n,c,s+3+o.length,l-2))):d.push(dt(n,o,s+2,l-2)),d.push(n.elt(e.WikiLinkMark,l-2,l)),n.addElement(n.elt(e.WikiLink,s,l,d))}},ft=/^\[ext\[([^\]|]*?)(?:\|([^\]]*?))?\]\]/,pt={name:"ExternalLink",parse(n,r,s){if(r!==t.LeftBracket)return-1;const a=n.slice(s,n.end),i=ft.exec(a);if(!i){const t=/^\[ext\[([^\]\n]*)$/.exec(a);if(t){const r=s+t[0].length,a=t[1],i=[n.elt(e.ExtLinkMark,s,s+5)],l=a.indexOf("|");if(-1!==l){if(i.push(n.elt(e.LinkText,s+5,s+5+l)),i.push(n.elt(e.LinkSeparator,s+5+l,s+6+l)),a.length>l+1){const e=a.slice(l+1);i.push(Lt(n,e,s+6+l,r))}}else a&&i.push(Lt(n,a,s+5,r));return n.addElement(n.elt(e.ExternalLink,s,r,i))}return-1}const l=s+i[0].length,o=i[1],c=i[2],d=[n.elt(e.ExtLinkMark,s,s+5)];return void 0!==c?(d.push(n.elt(e.LinkText,s+5,s+5+o.length)),d.push(n.elt(e.LinkSeparator,s+5+o.length,s+6+o.length)),d.push(Lt(n,c,s+6+o.length,l-2))):d.push(Lt(n,o,s+5,l-2)),d.push(n.elt(e.ExtLinkMark,l-2,l)),n.addElement(n.elt(e.ExternalLink,s,l,d))}},ht=/^\[img(\s+[^\[]+)?\[([^\]|]*?)(?:\|([^\]]*?))?\]\]/,mt={name:"ImageLink",parse(n,r,s){if(r!==t.LeftBracket)return-1;const a=n.slice(s,n.end),i=ht.exec(a);if(!i){const t=/^\[img(\s+[^\[\n]+)?\[([^\]\n]*)$/.exec(a);if(t){const r=s+t[0].length,a=t[1],i=t[2],l=[n.elt(e.ImageMark,s,s+4)];let o=s+4;if(a){const e=s+4;o=e+a.length;const t=vt(n,a.trim(),e+(a.length-a.trimStart().length));l.push(...t)}if(l.push(n.elt(e.ImageMark,o,o+1)),i){const t=o+1,s=i.indexOf("|");if(-1!==s){if(l.push(n.elt(e.ImageTooltip,t,t+s)),l.push(n.elt(e.LinkSeparator,t+s,t+s+1)),i.length>s+1){const e=i.slice(s+1);l.push(Pt(n,e,t+s+1,r))}}else l.push(Pt(n,i,t,r))}return n.addElement(n.elt(e.ImageLink,s,r,l))}return-1}const l=s+i[0].length,o=i[1],c=i[2],d=i[3],u=[n.elt(e.ImageMark,s,s+4)];let f=s+4;if(o){const e=s+4;f=e+o.length;const t=vt(n,o.trim(),e+(o.length-o.trimStart().length));u.push(...t)}const p=f;u.push(n.elt(e.ImageMark,p,p+1));const h=p+1;if(void 0!==d){const t=h+c.length;c&&u.push(n.elt(e.ImageTooltip,h,t)),u.push(n.elt(e.LinkSeparator,t,t+1));const r=t+1,s=r+d.length;d&&u.push(Pt(n,d,r,s))}else{const e=h+c.length;c&&u.push(Pt(n,c,h,e))}return u.push(n.elt(e.ImageMark,l-2,l)),n.addElement(n.elt(e.ImageLink,s,l,u))}},gt=/^\{\{([^{}|]*?)(?:\|\|([^{}|]+?))?(?:\|([^{}]+?))?\}\}/,kt={name:"Transclusion",parse(n,r,s){if(r!==t.LeftBrace||n.char(s+1)!==t.LeftBrace)return-1;if(n.char(s+2)===t.LeftBrace)return-1;const a=n.slice(s,n.end),i=gt.exec(a);if(!i){const t=/^\{\{([^{}\n~'^/_`<\[]*?)(?=~~|''|\/\/|^^|,,|``|<<|__|$)/.exec(a);if(t&&t[0].length>2){const r=s+t[0].length,a=t[1],i=[n.elt(e.TransclusionMark,s,s+2)];if(a){const e=M(a,s+2);i.push(...e)}return n.addElement(n.elt(e.Transclusion,s,r,i))}return-1}const l=s+i[0].length,o=i[1],c=i[2],d=[n.elt(e.TransclusionMark,s,s+2)],u=M(o,s+2);if(d.push(...u),c){const t=s+2+o.length+2;d.push(n.elt(e.TransclusionTemplate,t,t+c.length))}return d.push(n.elt(e.TransclusionMark,l-2,l)),n.addElement(n.elt(e.Transclusion,s,l,d))}};function bt(t,n,r){const s=[],a=/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/g;let i;for(;null!==(i=a.exec(n));){const n=i.index,a=n+i[0].length,l=i[1],o=[t.elt(e.PlaceholderMark,r+n,r+n+1),t.elt(e.VariableName,r+n+1,r+n+1+l.length),t.elt(e.PlaceholderMark,r+a-1,r+a)];s.push(t.elt(e.Placeholder,r+n,r+a,o))}return s}function xt(t,n,r){const s=[];let a=0;const i=n.length;for(;a<i;){const l=n[a];if(/\s/.test(l))a++;else{if("["===l){const l=a;a++;const o=[];for(;a<i&&"]"!==n[a];){"!"===n[a]&&a++;const s=n[a];if("["===s){a++;const s=a;let l=1;for(;a<i&&l>0;)"["===n[a]?l++:"]"===n[a]&&l--,l>0&&a++;const c=n.slice(s,a);if(c.includes("$")){const n=bt(t,c,r+s);n.length>0?o.push(t.elt(e.FilterOperand,r+s,r+a,n)):o.push(t.elt(e.FilterOperand,r+s,r+a))}else o.push(t.elt(e.FilterOperand,r+s,r+a));a<i&&"]"===n[a]&&a++}else if("<"===s){a++;const s=a;for(;a<i&&">"!==n[a];)a++;const l=n.slice(s,a),c=a<i&&">"===n[a],d=/^__(.+)__$/.exec(l),u=!d&&/^__(.*)$/.exec(l);if(d){const n=d[1],i=r+s-1,l=r+a+1,c=r+s,u=[t.elt(e.SubstitutedParamMark,c,c+2),t.elt(e.SubstitutedParamName,c+2,c+2+n.length),t.elt(e.SubstitutedParamMark,c+2+n.length,r+a)];o.push(t.elt(e.SubstitutedParam,i,l,u))}else if(u){const n=u[1],i=r+s-1,l=c?r+a+1:r+a,d=r+s,f=[t.elt(e.SubstitutedParamMark,d,d+2)];n&&f.push(t.elt(e.SubstitutedParamName,d+2,d+2+n.length)),o.push(t.elt(e.SubstitutedParam,i,l,f))}else{const n=l.search(/\s/);if(-1!==n){const i=r+s-1,d=c?r+a+1:r+a,u=[t.elt(e.MacroCallMark,i,i+1)],f=l.slice(0,n),p=r+s,h=p+f.length,m=St.exec(f);if(m){const n=m[1];u.push(t.elt(e.Placeholder,p,h,[t.elt(e.PlaceholderMark,p,p+1),t.elt(e.VariableName,p+1,p+1+n.length),t.elt(e.PlaceholderMark,h-1,h)]))}else u.push(t.elt(e.MacroName,p,h));const g=l.slice(n),k=r+s+n,b=parseMacroParams(g.trim(),k+(g.length-g.trimStart().length));u.push(...b),c&&u.push(t.elt(e.MacroCallMark,r+a,r+a+1)),o.push(t.elt(e.MacroCall,i,d,u))}else o.push($(l,r+s,r+a))}a<i&&a++}else if("{"===s){a++;const e=a;for(;a<i&&"}"!==n[a];)a++;const t=n.slice(e,a);o.push(y(t,r+e,r+a)),a<i&&a++}else if("/"===s){a++;const s=a;for(;a<i&&"/"!==n[a];)"\\"===n[a]&&a++,a++;for(o.push(t.elt(e.FilterRegexp,r+s,r+a)),a<i&&a++;a<i&&/[gimsuy]/.test(n[a]);)a++}else if("$"===s){const s=n.slice(a).match(/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/);if(s){const n=s[1],i=a+s[0].length,l=[t.elt(e.PlaceholderMark,r+a,r+a+1),t.elt(e.VariableName,r+a+1,r+a+1+n.length),t.elt(e.PlaceholderMark,r+i-1,r+i)];o.push(t.elt(e.Placeholder,r+a,r+i,l)),a=i}else a++}else if(/[a-zA-Z]/.test(s)){const s=a;for(;a<i&&/[a-zA-Z0-9\-_:!]/.test(n[a]);)a++;o.push(t.elt(e.FilterOperatorName,r+s,r+a))}else a++}a<i&&"]"===n[a]&&a++;const c=a;s.push(t.elt(e.FilterOperator,r+l,r+c,o));continue}if("["===l&&"["===n[a+1]){const l=a;for(a+=2;a<i&&("]"!==n[a]||"]"!==n[a+1]);)a++;a+=2,s.push(t.elt(e.FilterOperand,r+l,r+a));continue}if("+"!==l&&"-"!==l&&"~"!==l&&":"!==l){if("$"===l){const i=n.slice(a).match(/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/);if(i){const n=i[1],l=a+i[0].length,o=[t.elt(e.PlaceholderMark,r+a,r+a+1),t.elt(e.VariableName,r+a+1,r+a+1+n.length),t.elt(e.PlaceholderMark,r+l-1,r+l)];s.push(t.elt(e.Placeholder,r+a,r+l,o)),a=l;continue}}a++}else for(a++;a<i&&/[a-zA-Z]/.test(n[a]);)a++}}return s}const yt={name:"FilteredTransclusion",parse(n,r,s){if(r!==t.LeftBrace||n.char(s+1)!==t.LeftBrace||n.char(s+2)!==t.LeftBrace)return-1;const a=n.slice(s,n.end);let i=-1;for(let e=3;e<a.length-2;e++)if("}"===a[e]&&"}"===a[e+1]&&"}"===a[e+2]){i=e;break}if(-1===i){const t=/^\{\{\{([^\n~'^/_`<\[]*?)(?=~~|''|\/\/|^^|,,|``|<<|__|$)/.exec(a);if(t&&t[0].length>3){const r=s+t[0].length,a=t[1],i=xt(n,a,s+3),l=[n.elt(e.FilteredTransclusionMark,s,s+3)];return a&&l.push(n.elt(e.FilterExpression,s+3,r,i)),n.addElement(n.elt(e.FilteredTransclusion,s,r,l))}return-1}const l=a.slice(3,i);let o=s+i+3,c="";if("||"===a.slice(i+3,i+5)){const e=i+5;let t=e;for(;t<a.length&&!/[\s}]/.test(a[t]);)t++;c=a.slice(e,t),o=s+t}const d=xt(n,l,s+3),u=[n.elt(e.FilteredTransclusionMark,s,s+3),n.elt(e.FilterExpression,s+3,s+3+l.length,d),n.elt(e.FilteredTransclusionMark,s+3+l.length,s+i+3)];return c&&u.push(n.elt(e.TransclusionTemplate,s+i+5,o)),n.addElement(n.elt(e.FilteredTransclusion,s,o,u))}},$t={name:"MacroCall",parse(n,r,s){if(r!==t.LessThan||n.char(s+1)!==t.LessThan)return-1;if(n.char(s+2)===t.LessThan)return-1;const a=n.slice(s,n.end),i=a.length-1;let l=-1,o=1,c=-1;for(let e=2;e<i;e++)if(-1===c&&"\n"===a[e]&&(c=e),"<"===a[e]&&"<"===a[e+1])o++,e++;else if(">"===a[e]&&">"===a[e+1]){if(o--,0===o){l=e;break}e++}const d=-1===l;if(d){l=-1===c?a.length:c;let e=2;for(;e<l&&!/[\s\n>]/.test(a[e]);)e++;if(2===e)return-1}const u=s+l+(d?0:2);if(u<=s||u>n.end)return-1;let f=2;for(;f<l&&!/[\s>]/.test(a[f]);)f++;const p=a.slice(2,f);if(!p)return-1;const h=[n.elt(e.MacroCallMark,s,s+2)],m=/^__(.+)__$/.exec(p),g=!m&&/^__(.*)$/.exec(p);if(m){const t=m[1],r=s+2,a=[n.elt(e.SubstitutedParamMark,r,r+2),n.elt(e.SubstitutedParamName,r+2,r+2+t.length),n.elt(e.SubstitutedParamMark,r+2+t.length,r+p.length)];h.push(n.elt(e.SubstitutedParam,r,r+p.length,a))}else if(g){const t=g[1],r=s+2,a=[n.elt(e.SubstitutedParamMark,r,r+2)];t&&a.push(n.elt(e.SubstitutedParamName,r+2,r+2+t.length)),h.push(n.elt(e.SubstitutedParam,r,r+p.length,a))}else{const t=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(p);if(t){const r=t[1],a=s+2,i=[n.elt(e.PlaceholderMark,a,a+1),n.elt(e.VariableName,a+1,a+1+r.length),n.elt(e.PlaceholderMark,a+p.length-1,a+p.length)];h.push(n.elt(e.Placeholder,a,a+p.length,i))}else h.push(n.elt(e.MacroName,s+2,s+2+p.length))}if(f<l){const e=a.slice(f,l);if(e.trim()){const t=L(e,s+f);h.push(...t)}}return d||h.push(n.elt(e.MacroCallMark,u-2,u)),n.addElement(n.elt(e.MacroCall,s,u,h))}};function wt(e){let t=0;const n=e.length;for(;t<n;){const r=e[t];if(">"===r)return{end:t+1,selfClose:!1};if("/"===r&&">"===e[t+1])return{end:t+2,selfClose:!0};if('"'===r&&'"'===e[t+1]&&'"'===e[t+2]){for(t+=3;t<n&&('"'!==e[t]||'"'!==e[t+1]||'"'!==e[t+2]);)t++;t+=3}else if('"'===r||"'"===r){const s=r;for(t++;t<n&&e[t]!==s;)"\\"===e[t]&&t++,t++;t++}else if("<"===r&&"<"===e[t+1]){t+=2;let r=1;for(;t<n&&r>0;)"<"===e[t]&&"<"===e[t+1]?(r++,t+=2):">"===e[t]&&">"===e[t+1]?(r--,t+=2):t++}else if("{"===r&&"{"===e[t+1]&&"{"===e[t+2]){for(t+=3;t<n&&("}"!==e[t]||"}"!==e[t+1]||"}"!==e[t+2]);)t++;t+=3}else if("{"===r&&"{"===e[t+1]){for(t+=2;t<n&&("}"!==e[t]||"}"!==e[t+1]);)t++;t+=2}else if("`"===r)if("```"===e.slice(t,t+3)){for(t+=3;t<n&&"```"!==e.slice(t,t+3);)t++;t+=3}else{for(t++;t<n&&"`"!==e[t];)t++;t++}else t++}return null}const Tt=new Set(["emptymessage","template","caption","tooltip","placeholder","default","alt","description","message","content"]);function Mt(t,n,r){const s=[],a=/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/g;let i,l=0;for(;null!==(i=a.exec(n));){const n=i.index,a=n+i[0].length,o=i[1];n>l&&s.push(t.elt(e.AttributeValue,r+l,r+n));const c=[t.elt(e.PlaceholderMark,r+n,r+n+1),t.elt(e.VariableName,r+n+1,r+n+1+o.length),t.elt(e.PlaceholderMark,r+a-1,r+a)];s.push(t.elt(e.Placeholder,r+n,r+a,c)),l=a}return s.length>0&&l<n.length&&s.push(t.elt(e.AttributeValue,r+l,r+n.length)),s}const St=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/;function Ct(t,n,r,s){const a=St.exec(n);if(a){const n=a[1],i=[t.elt(e.PlaceholderMark,r,r+1),t.elt(e.VariableName,r+1,r+1+n.length),t.elt(e.PlaceholderMark,s-1,s)];return t.elt(e.Placeholder,r,s,i)}return t.elt(e.AttributeName,r,s)}function Pt(t,n,r,s){const a=St.exec(n);if(a){const n=a[1],i=[t.elt(e.PlaceholderMark,r,r+1),t.elt(e.VariableName,r+1,r+1+n.length),t.elt(e.PlaceholderMark,s-1,s)];return t.elt(e.Placeholder,r,s,i)}return t.elt(e.ImageSource,r,s)}function Lt(t,n,r,s){const a=St.exec(n);if(a){const n=a[1],i=[t.elt(e.PlaceholderMark,r,r+1),t.elt(e.VariableName,r+1,r+1+n.length),t.elt(e.PlaceholderMark,s-1,s)];return t.elt(e.Placeholder,r,s,i)}return t.elt(e.URLLink,r,s)}function vt(t,n,r){const s=[];let a=0;const i=n.length;for(;a<i;){for(;a<i&&/\s/.test(n[a]);)a++;if(a>=i)break;const l=a;for(;a<i&&/[a-zA-Z0-9\-_:.$]/.test(n[a]);)a++;if(a===l){a++;continue}const o=a;for(;a<i&&/\s/.test(n[a]);)a++;if(a>=i||"="!==n[a]){const a=[Ct(t,n.slice(l,o),r+l,r+o)];s.push(t.elt(e.Attribute,r+l,r+o,a));continue}for(a++;a<i&&/\s/.test(n[a]);)a++;if(a>=i){const i=[Ct(t,n.slice(l,o),r+l,r+o)];s.push(t.elt(e.Attribute,r+l,r+a,i));continue}const c=a;let d=a,u=e.AttributeValue;const f=n[a];if('"'===f&&'"""'===n.slice(a,a+3)){const u=a;a+=3;const f=a;for(;a<i&&'"""'!==n.slice(a,a+3);)a++;const p=a,h=a;'"""'===n.slice(a,a+3)&&(a+=3),d=a;const m=n.slice(f,p);let g=[t.elt(e.Mark,r+u,r+f)];if(m.trim()){const a=t.parser.parseInline(m,r+f);g.push(...a),g.push(t.elt(e.Mark,r+h,r+d));const i=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(e.AttributeWikitext,r+c,r+d,g)];s.push(t.elt(e.Attribute,r+l,r+d,i))}else{const a=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(e.AttributeString,r+c,r+d)];s.push(t.elt(e.Attribute,r+l,r+d,a))}continue}if('"'===f||"'"===f){const p=f,h=a+1;for(a++;a<i&&n[a]!==p;)"\\"===n[a]&&a+1<i&&a++,a++;const m=a;a<i&&a++,d=a,u=e.AttributeString;const g=n.slice(l,o).toLowerCase();if("filter"===g||"$filter"===g||"$names"===g||"$values"===g){const a=xt(t,n.slice(h,m),r+h),i=[t.elt(e.Mark,r+c,r+h),t.elt(e.FilterExpression,r+h,r+m,a),t.elt(e.Mark,r+m,r+d)],u=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(e.AttributeFiltered,r+c,r+d,i)];s.push(t.elt(e.Attribute,r+l,r+d,u));continue}if(Tt.has(g)){const a=n.slice(h,m);if(a.trim()){const i=t.parser.parseInline(a,r+h),u=[t.elt(e.Mark,r+c,r+h),...i,t.elt(e.Mark,r+m,r+d)],f=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(e.AttributeWikitext,r+c,r+d,u)];s.push(t.elt(e.Attribute,r+l,r+d,f));continue}}const k=n.slice(h,m);if(k.includes("$")){const a=Mt(t,k,r+h);if(a.length>0){const i=[t.elt(e.Mark,r+c,r+h),...a,t.elt(e.Mark,r+m,r+d)],u=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(e.AttributeString,r+c,r+d,i)];s.push(t.elt(e.Attribute,r+l,r+d,u));continue}}}else if("{"===f){if("{{{"===n.slice(a,a+3)){const f=a;a+=3;const p=a;for(;a<i&&"}}}"!==n.slice(a,a+3);)a++;const h=a;"}}}"===n.slice(a,a+3)&&(a+=3),d=a,u=e.AttributeFiltered;const m=xt(t,n.slice(p,h),r+p),g=[t.elt(e.FilteredTransclusionMark,r+f,r+f+3),t.elt(e.FilterExpression,r+p,r+h,m),t.elt(e.FilteredTransclusionMark,r+h,r+d)],k=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(u,r+c,r+d,g)];s.push(t.elt(e.Attribute,r+l,r+d,k));continue}if("{{"===n.slice(a,a+2)){const f=a;a+=2;const p=a;for(;a<i&&"}}"!==n.slice(a,a+2);)a++;const h=a;"}}"===n.slice(a,a+2)&&(a+=2),d=a,u=e.AttributeIndirect;const m=M(n.slice(p,h),r+p),g=[t.elt(e.TransclusionMark,r+f,r+f+2),...m,t.elt(e.TransclusionMark,r+h,r+d)],k=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(u,r+c,r+d,g)];s.push(t.elt(e.Attribute,r+l,r+d,k));continue}for(;a<i&&!/[\s>]/.test(n[a]);)a++;d=a}else{if("<"===f&&"<"===n[a+1]){const f=a;a+=2;const p=a;for(;a<i&&/[a-zA-Z0-9\-_.$]/.test(n[a]);)a++;const h=a;let m=1;for(;a<i&&m>0;)if("<<"===n.slice(a,a+2))m++,a+=2;else if(">>"===n.slice(a,a+2)){if(m--,0===m)break;a+=2}else a++;const g=a;">>"===n.slice(a,a+2)&&(a+=2),d=a,u=e.AttributeMacro;const k=n.slice(p,h),b=[t.elt(e.MacroCallMark,r+f,r+f+2)],x=/^__(.+)__$/.exec(k);if(x){const n=x[1],s=r+p,a=[t.elt(e.SubstitutedParamMark,s,s+2),t.elt(e.SubstitutedParamName,s+2,s+2+n.length),t.elt(e.SubstitutedParamMark,s+2+n.length,s+k.length)];b.push(t.elt(e.SubstitutedParam,s,s+k.length,a))}else b.push(t.elt(e.MacroName,r+p,r+h));b.push(t.elt(e.MacroCallMark,r+g,r+d));const y=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(u,r+c,r+d,b)];s.push(t.elt(e.Attribute,r+l,r+d,y));continue}if("`"===f){let f,p;if("```"===n.slice(a,a+3)){for(f=a+3,a+=3;a<i&&"```"!==n.slice(a,a+3);)a++;p=a,"```"===n.slice(a,a+3)&&(a+=3)}else{for(f=a+1,a++;a<i&&"`"!==n[a];)a++;p=a,a<i&&a++}d=a,u=e.AttributeSubstituted;const h=[t.elt(e.Mark,r+c,r+f)],m=n.slice(f,p);let g=0;const k=r+f;for(;g<m.length;){if("${"===m.slice(g,g+2)){let n=-1;for(let e=g+2;e<m.length-1;e++)if("}"===m[e]&&"$"===m[e+1]){n=e;break}if(-1!==n){const r=[m.slice(g,n+2),m.slice(g+2,n)],s=k+g,a=s+r[0].length,i=s+2,l=a-2,o=xt(t,r[1].trim(),i+(r[1].length-r[1].trimStart().length));h.push(t.elt(e.FilterSubstitution,s,a,[t.elt(e.FilterSubstitutionMark,s,s+2),t.elt(e.FilterExpression,i,l,o),t.elt(e.FilterSubstitutionMark,a-2,a)])),g+=r[0].length;continue}}const n=m.slice(g).match(/^\$\(([^)]+)\)\$/);if(n){const r=k+g,s=r+n[0].length,a=r+2,i=a+n[1].length;h.push(t.elt(e.Variable,r,s,[t.elt(e.VariableMark,r,r+2),t.elt(e.VariableName,a,i),t.elt(e.VariableMark,i,s)])),g+=n[0].length}else g++}h.push(t.elt(e.Mark,r+p,r+d));const b=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(u,r+c,r+d,h)];s.push(t.elt(e.Attribute,r+l,r+d,b));continue}{for(;a<i&&!/[\s>\/]/.test(n[a]);)a++;d=a;const f=n.slice(c,d),p=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$$/.exec(f);if(p){const a=p[1],i=[t.elt(e.PlaceholderMark,r+c,r+c+1),t.elt(e.VariableName,r+c+1,r+c+1+a.length),t.elt(e.PlaceholderMark,r+d-1,r+d)],u=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(e.Placeholder,r+c,r+d,i)];s.push(t.elt(e.Attribute,r+l,r+d,u));continue}u=/^-?\d+(\.\d+)?$/.test(f)?e.AttributeNumber:/^@[a-zA-Z][a-zA-Z0-9\-_]*$/.test(f)?e.AttributeParamRef:e.AttributeString}}const p=[Ct(t,n.slice(l,o),r+l,r+o),t.elt(u,r+c,r+d)];s.push(t.elt(e.Attribute,r+l,r+d,p))}return s}const At=/^<(\$[a-zA-Z0-9\-\.]*)/,Et=/^<\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/,Bt={name:"Widget",parse(n,r,s){if(r!==t.LessThan)return-1;if(n.char(s+1)!==t.Dollar)return-1;const a=n.slice(s,n.end),i=Et.exec(a);if(i){const t=i[1],r=i[0].length,l=a.slice(r).match(/^(\s*[^>]*)?>/);if(l){const i=l[1]||"",o=s+r+l[0].length,c=l[0].endsWith("/>"),d=s+1,u=s+r,f=[n.elt(e.PlaceholderMark,d,d+1),n.elt(e.VariableName,d+1,d+1+t.length),n.elt(e.PlaceholderMark,u-1,u)],p=[n.elt(e.TagMark,s,s+1),n.elt(e.Placeholder,d,u,f)];if(i.trim()){const e=vt(n,i.trim(),s+r);p.push(...e)}if(c)p.push(n.elt(e.SelfClosingMarker,o-2,o-1)),p.push(n.elt(e.TagMark,o-1,o));else{p.push(n.elt(e.TagMark,o-1,o));const r=`</$${t}$>`,i=a.slice(o-s).indexOf(r);if(-1!==i){const a=o,l=o+i,c=n.slice(a,l);if(c.length>0){const e=n.parser.parseInline(c,a);p.push(...e)}const d=l,u=d+r.length,f=d+2,h=u-1,m=[n.elt(e.PlaceholderMark,f,f+1),n.elt(e.VariableName,f+1,f+1+t.length),n.elt(e.PlaceholderMark,h-1,h)],g=[n.elt(e.TagMark,d,d+2),n.elt(e.Placeholder,f,h,m),n.elt(e.TagMark,u-1,u)];return p.push(n.elt(e.WidgetEnd,d,u,g)),n.addElement(n.elt(e.InlineWidget,s,u,p))}}return n.addElement(n.elt(e.InlineWidget,s,o,p))}}const l=At.exec(a);if(!l)return-1;const o=l[1],c=l[0].length,d=wt(a.slice(c));if(!d){const t=/^<\$[a-zA-Z0-9\-\.]*(?:\s+[^>\n~'^/_`]*?)?(?=~~|''|\/\/|^^|,,|``|<<|__|$|\n)/.exec(a);if(!t){const t=[n.elt(e.TagMark,s,s+1),n.elt(e.WidgetName,s+1,s+1+o.length)];return n.addElement(n.elt(e.InlineWidget,s,s+c,t))}const r=s+t[0].length,i=t[0].slice(c),l=[n.elt(e.TagMark,s,s+1),n.elt(e.WidgetName,s+1,s+1+o.length)];if(i.trim()){const e=vt(n,i,s+c);l.push(...e)}return n.addElement(n.elt(e.InlineWidget,s,r,l))}const u=s+c+d.end,f=a.slice(c,c+d.end-(d.selfClose?2:1)),p=[n.elt(e.TagMark,s,s+1),n.elt(e.WidgetName,s+1,s+1+o.length)];if(f.trim()){const e=vt(n,f,s+c);p.push(...e)}if(d.selfClose)return p.push(n.elt(e.SelfClosingMarker,u-2,u-1)),p.push(n.elt(e.TagMark,u-1,u)),n.addElement(n.elt(e.InlineWidget,s,u,p));p.push(n.elt(e.TagMark,u-1,u));const h=`</${o}>`,m=a.slice(c+d.end).indexOf(h);if(-1===m)return n.addElement(n.elt(e.InlineWidget,s,u,p));const g=u,k=u+m,b=n.slice(g,k);if(b.length>0){const e=n.parser.parseInline(b,g);p.push(...e)}const x=k,y=x+h.length,$=[n.elt(e.TagMark,x,x+2),n.elt(e.WidgetName,x+2,y-1),n.elt(e.TagMark,y-1,y)];return p.push(n.elt(e.WidgetEnd,x,y,$)),n.addElement(n.elt(e.InlineWidget,s,y,p))}},It=/^<\/(\$[a-zA-Z0-9\-\.]*\$?)(>)?/,Nt=/^<\/\$([a-zA-Z][a-zA-Z0-9\-_]*)\$>/,Ft={name:"WidgetCloseTag",after:"Widget",parse(n,r,s){if(r!==t.LessThan)return-1;if(n.char(s+1)!==t.Slash)return-1;if(n.char(s+2)!==t.Dollar)return-1;const a=n.slice(s,n.end),i=Nt.exec(a);if(i){const t=i[1],r=s+i[0].length,a=s+2,l=r-1,o=[n.elt(e.TagMark,s,s+2),n.elt(e.Placeholder,a,l,[n.elt(e.PlaceholderMark,a,a+1),n.elt(e.VariableName,a+1,a+1+t.length),n.elt(e.PlaceholderMark,l-1,l)]),n.elt(e.TagMark,r-1,r)];return n.addElement(n.elt(e.WidgetEnd,s,r,o))}const l=It.exec(a);if(!l){if(a.startsWith("</$")){const t=[n.elt(e.TagMark,s,s+2)],r=/^<\/(\$[a-zA-Z0-9\-\.]*)/.exec(a);return r&&r[1].length>1?(t.push(n.elt(e.WidgetName,s+2,s+2+r[1].length)),n.addElement(n.elt(e.WidgetEnd,s,s+2+r[1].length,t))):n.addElement(n.elt(e.WidgetEnd,s,s+3,t))}return-1}const o=l[1],c=!!l[2],d=s+l[0].length,u=[n.elt(e.TagMark,s,s+2),n.elt(e.WidgetName,s+2,s+2+o.length)];return c&&u.push(n.elt(e.TagMark,d-1,d)),n.addElement(n.elt(e.WidgetEnd,s,d,u))}},Wt=/^<([a-zA-Z][a-zA-Z0-9\-]*)/,Ot={name:"HTMLTag",parse(n,r,s){if(r!==t.LessThan)return-1;if(n.char(s+1)===t.Dollar)return-1;const a=n.slice(s,n.end),i=Wt.exec(a);if(!i)return-1;const l=i[1],o=i[0].length,c=wt(a.slice(o));if(!c){const t=/^<[a-zA-Z][a-zA-Z0-9\-]*(?:\s+[^>\n~'^/_`]*?)?(?=~~|''|\/\/|^^|,,|``|<<|__|$|\n)/.exec(a);if(!t){const t=[n.elt(e.TagMark,s,s+1),n.elt(e.TagName,s+1,s+1+l.length)];return n.addElement(n.elt(e.HTMLTag,s,s+o,t))}const r=s+t[0].length,i=t[0].slice(o),c=[n.elt(e.TagMark,s,s+1),n.elt(e.TagName,s+1,s+1+l.length)];if(i.trim()){const e=vt(n,i,s+o);c.push(...e)}return n.addElement(n.elt(e.HTMLTag,s,r,c))}const d=s+o+c.end,u=a.slice(o,o+c.end-(c.selfClose?2:1)),f=[n.elt(e.TagMark,s,s+1),n.elt(e.TagName,s+1,s+1+l.length)];if(u.trim()){const e=vt(n,u,s+o);f.push(...e)}if(c.selfClose)return f.push(n.elt(e.SelfClosingMarker,d-2,d-1)),f.push(n.elt(e.TagMark,d-1,d)),n.addElement(n.elt(e.HTMLTag,s,d,f));f.push(n.elt(e.TagMark,d-1,d));const p=`</${l}>`,h=a.slice(o+c.end).indexOf(p);if(-1===h)return n.addElement(n.elt(e.HTMLTag,s,d,f));const m=d,g=d+h,k=n.slice(m,g);if(k.length>0){const e=n.parser.parseInline(k,m);f.push(...e)}const b=g,x=b+p.length,y=[n.elt(e.TagMark,b,b+2),n.elt(e.TagName,b+2,x-1),n.elt(e.TagMark,x-1,x)];return f.push(n.elt(e.HTMLEndTag,b,x,y)),n.addElement(n.elt(e.HTMLTag,s,x,f))}},Dt=/^<\/([a-zA-Z][a-zA-Z0-9\-]*)(>)?/,Ht={name:"HTMLCloseTag",after:"HTMLTag",parse(n,r,s){if(r!==t.LessThan)return-1;if(n.char(s+1)!==t.Slash)return-1;if(n.char(s+2)===t.Dollar)return-1;const a=n.slice(s,n.end),i=Dt.exec(a);if(!i){if(a.startsWith("</")){const t=[n.elt(e.TagMark,s,s+2)];return n.addElement(n.elt(e.HTMLEndTag,s,s+2,t))}return-1}const l=i[1],o=!!i[2],c=s+i[0].length,d=[n.elt(e.TagMark,s,s+2),n.elt(e.TagName,s+2,s+2+l.length)];return o&&d.push(n.elt(e.TagMark,c-1,c)),n.addElement(n.elt(e.HTMLEndTag,s,c,d))}},zt={name:"InlineComment",parse(n,r,s){if(r!==t.LessThan)return-1;if(33!==n.char(s+1))return-1;if(n.char(s+2)!==t.Dash)return-1;if(n.char(s+3)!==t.Dash)return-1;let a=s+4;for(;a<n.end-2;){if(n.char(a)===t.Dash&&n.char(a+1)===t.Dash&&62===n.char(a+2)){const t=a+3;return n.addElement(n.elt(e.CommentBlock,s,t,[n.elt(e.CommentMarker,s,s+4),n.elt(e.CommentMarker,t-3,t)]))}a++}return-1}},_t={name:"Dash",parse(n,r,s){if(r!==t.Dash)return-1;let a=1;for(;n.char(s+a)===t.Dash;)a++;return 2===a?n.addElement(n.elt(e.Dash,s,s+2)):a>=3?n.addElement(n.elt(e.Dash,s,s+3)):-1}},Zt=/^\$\(([^)]+)\)\$/,Vt={name:"VariableSubstitution",parse(n,r,s){if(r!==t.Dollar)return-1;if(40!==n.char(s+1))return-1;const a=n.slice(s,n.end),i=Zt.exec(a);if(!i)return-1;const l=s+i[0].length,o=s+2,c=o+i[1].length,d=[n.elt(e.VariableMark,s,s+2),n.elt(e.VariableName,o,c),n.elt(e.VariableMark,c,l)];return n.addElement(n.elt(e.Variable,s,l,d))}},Rt=/^\$([a-zA-Z][a-zA-Z0-9\-_]*)\$/,Kt={name:"PlaceholderParam",parse(n,r,s){if(r!==t.Dollar)return-1;const a=n.slice(s,n.end),i=Rt.exec(a);if(!i)return-1;const l=s+i[0].length,o=s+1,c=o+i[1].length,d=[n.elt(e.PlaceholderMark,s,s+1),n.elt(e.VariableName,o,c),n.elt(e.PlaceholderMark,c,l)];return n.addElement(n.elt(e.Placeholder,s,l,d))}},Xt=/^[A-Z\u00c0-\u00d6\u00d8-\u00de\u0150\u0170]+[a-z\u00df-\u00f6\u00f8-\u00ff\u0151\u0171]+[A-Z\u00c0-\u00d6\u00d8-\u00de\u0150\u0170][A-Za-z0-9\u00c0-\u00d6\u00d8-\u00de\u00df-\u00f6\u00f8-\u00ff\u0150\u0170\u0151\u0171]*/;const jt={name:"CamelCaseLink",parse(n,r,s){if(!(r>=65&&r<=90||r>=192&&r<=214||r>=216&&r<=222||336===r||368===r))return-1;if(s>n.offset){const e=n.char(s-1);if((a=e)>=65&&a<=90||a>=97&&a<=122||a>=48&&a<=57||45===a||95===a||a>=192&&a<=214||a>=216&&a<=222||a>=223&&a<=246||a>=248&&a<=255||336===a||368===a||337===a||369===a)return-1;if(e===t.Tilde)return-1}var a;const i=n.slice(s,n.end),l=Xt.exec(i);return l?n.addElement(n.elt(e.CamelCaseLink,s,s+l[0].length)):-1}},Ut=/^\$:\/[A-Za-z0-9\u00c0-\u00d6\u00d8-\u00de\u00df-\u00f6\u00f8-\u00ff\u0150\u0170\u0151\u0171\/._-]+/,qt={name:"SystemLink",parse(n,r,s){if(r!==t.Dollar)return-1;const a=n.slice(s,n.end),i=Ut.exec(a);return i?n.addElement(n.elt(e.SystemLink,s,s+i[0].length)):-1}},Qt=/^(?:https?|ftp|file):\/\/[^\s\[\]{}|<>]*/i,Gt=/^(?:mailto|tel|geo|data|javascript):[^\s\[\]{}|<>]+/i,Jt=/[.,;:!?)\]]+$/,Yt={name:"URLAutoLink",parse(t,n,r){if(104!==n&&102!==n&&109!==n&&116!==n&&103!==n&&100!==n&&106!==n)return-1;const s=t.slice(r,t.end);let a=Qt.exec(s),i=8;if(a||(a=Gt.exec(s),i=7),!a)return-1;let l=a[0];return l=l.replace(Jt,""),l.length<=i?-1:t.addElement(t.elt(e.URLLink,r,r+l.length))}},en=[Je,{name:"ConditionalSyntax",parse(n,r,s){if(r!==t.LessThan)return-1;if(n.char(s+1)!==t.Percent)return-1;const a=n.slice(s,n.end),i=[];i.push(n.elt(e.ConditionalMark,s,s+2));const l=/^<%\s*(if|elseif|else|endif)\b/.exec(a);if(l){const t=l[1],r=s+a.indexOf(t,2),o=r+t.length;if(i.push(n.elt(e.ConditionalKeyword,r,o)),"if"===t||"elseif"===t){const t=a.slice(o-s),r=/^\s+(.+?)(?:\s*%>|$)/.exec(t);if(r){const s=r[1],a=o+t.indexOf(s),l=a+s.length,c=xt(n,s,a);i.push(n.elt(e.FilterExpression,a,l,c))}}const c=a.indexOf("%>");return-1!==c?(i.push(n.elt(e.ConditionalMark,s+c,s+c+2)),n.addElement(n.elt(e.Conditional,s,s+c+2,i))):n.addElement(n.elt(e.Conditional,s,o,i))}const o=a.indexOf("%>");return-1!==o&&o>2?(i.push(n.elt(e.ConditionalMark,s+o,s+o+2)),n.addElement(n.elt(e.Conditional,s,s+o+2,i))):n.addElement(n.elt(e.ConditionalMark,s,s+2))}},qe,Ge,et,tt,nt,rt,st,at,lt,ut,pt,mt,yt,kt,$t,Bt,Ft,zt,Ot,Ht,_t,Vt,qt,Kt,jt,Yt],tn={twTransclusion:a.Tag.define(),twMacro:a.Tag.define(),twWidget:a.Tag.define(),twFilter:a.Tag.define(),twPragma:a.Tag.define(),twVariable:a.Tag.define(),twSuperscript:a.Tag.define(),twSubscript:a.Tag.define()},nn=a.styleTags({"Heading1/...":a.tags.heading1,"Heading2/...":a.tags.heading2,"Heading3/...":a.tags.heading3,"Heading4/...":a.tags.heading4,"Heading5/...":a.tags.heading5,"Heading6/...":a.tags.heading6,HeadingMark:a.tags.processingInstruction,"Bold/...":a.tags.strong,"Italic/...":a.tags.emphasis,"Underline/...":a.tags.special(a.tags.emphasis),"Strikethrough/...":a.tags.strikethrough,"Superscript/...":tn.twSuperscript,"Subscript/...":tn.twSubscript,"Highlight/...":a.tags.special(a.tags.content),HighlightStyles:a.tags.string,"BoldMark ItalicMark UnderlineMark StrikethroughMark SuperscriptMark SubscriptMark HighlightMark":a.tags.processingInstruction,"InlineCode FencedCode TypedBlock CodeText":a.tags.monospace,"CodeMark TypedBlockMark InlineCodeMark":a.tags.processingInstruction,CodeInfo:a.tags.labelName,TypedBlockType:a.tags.labelName,"KaTeXBlock LaTeXContent":a.tags.monospace,KaTeXMark:a.tags.processingInstruction,"WikiLink ExternalLink CamelCaseLink":a.tags.link,"WikiLinkMark ExtLinkMark":a.tags.processingInstruction,LinkText:a.tags.string,LinkTarget:a.tags.url,LinkSeparator:a.tags.processingInstruction,ImageLink:a.tags.link,ImageMark:a.tags.processingInstruction,ImageSource:a.tags.url,ImageTooltip:a.tags.string,"URLLink SystemLink":a.tags.url,"Transclusion TransclusionBlock":a.tags.special(a.tags.link),TransclusionMark:a.tags.processingInstruction,TransclusionTarget:a.tags.special(a.tags.string),TransclusionTemplate:a.tags.special(a.tags.string),TransclusionField:a.tags.propertyName,TransclusionIndex:a.tags.propertyName,"FilteredTransclusion FilteredTransclusionBlock":a.tags.special(a.tags.link),FilteredTransclusionMark:a.tags.processingInstruction,FilterExpression:a.tags.special(a.tags.string),"MacroCall MacroCallBlock":a.tags.macroName,MacroCallMark:a.tags.processingInstruction,MacroName:a.tags.macroName,MacroParam:a.tags.attributeValue,MacroParamName:a.tags.attributeName,MacroParamValue:a.tags.attributeValue,"Widget InlineWidget HTMLBlock HTMLTag":a.tags.tagName,WidgetName:a.tags.tagName,TagName:a.tags.tagName,Attribute:a.tags.attributeName,AttributeName:a.tags.attributeName,"AttributeValue AttributeString":a.tags.attributeValue,AttributeNumber:a.tags.number,AttributeIndirect:a.tags.special(a.tags.link),AttributeFiltered:a.tags.special(a.tags.link),AttributeMacro:a.tags.macroName,AttributeSubstituted:a.tags.special(a.tags.string),AttributeParamRef:a.tags.special(a.tags.variableName),AttributeWikitext:a.tags.attributeValue,SelfClosingMarker:a.tags.processingInstruction,"BulletList OrderedList DefinitionList":a.tags.list,"ListItem DefinitionTerm DefinitionDescription":a.tags.list,ListMark:a.tags.processingInstruction,BlockQuote:a.tags.quote,QuoteMark:a.tags.processingInstruction,BlockQuoteClass:a.tags.className,"Table TableRow":a.tags.content,"TableHeader TableHeaderCell":a.tags.heading,TableCell:a.tags.content,TableDelimiter:a.tags.processingInstruction,HorizontalRule:a.tags.contentSeparator,HardLineBreaks:a.tags.content,HardLineBreaksMark:a.tags.processingInstruction,"CommentBlock CommentMarker":a.tags.comment,PragmaMark:a.tags.processingInstruction,PragmaKeyword:a.tags.keyword,PragmaName:a.tags.definition(a.tags.macroName),PragmaParams:a.tags.definition(a.tags.variableName),PragmaBody:a.tags.content,PragmaEnd:a.tags.keyword,Escape:a.tags.escape,Entity:a.tags.character,Dash:a.tags.punctuation,Variable:a.tags.special(a.tags.variableName),VariableMark:a.tags.processingInstruction,VariableName:a.tags.variableName,FilterSubstitution:a.tags.special(a.tags.string),FilterSubstitutionMark:a.tags.processingInstruction,Placeholder:a.tags.special(a.tags.variableName),PlaceholderMark:a.tags.processingInstruction,SubstitutedParam:a.tags.special(a.tags.variableName),SubstitutedParamMark:a.tags.processingInstruction,SubstitutedParamName:a.tags.variableName,HardBreak:a.tags.processingInstruction,FilterRun:a.tags.content,FilterOperator:a.tags.operator,FilterOperatorName:a.tags.operatorKeyword,FilterOperand:a.tags.string,FilterVariable:a.tags.variableName,FilterTextRef:a.tags.special(a.tags.string),FilterRegexp:a.tags.regexp,StyledBlock:a.tags.content,StyledBlockMark:a.tags.processingInstruction,StyledBlockClass:a.tags.className,ConditionalBlock:a.tags.content,Conditional:a.tags.content,ConditionalMark:a.tags.processingInstruction,ConditionalKeyword:a.tags.controlKeyword,ConditionalBranch:a.tags.content,Paragraph:a.tags.content,Text:a.tags.content,Mark:a.tags.processingInstruction,ProcessingInstruction:a.tags.processingInstruction});class rn extends s.Parser{constructor(t,n,r,a,i){super(),this.nodeSet=t||function(){const t=[],n=Object.keys(e).filter(e=>isNaN(Number(e)));for(const r of n){const n=e[r];if("number"==typeof n){for(;t.length<=n;)t.push(s.NodeType.none);t[n]=s.NodeType.define({id:n,name:r,props:[]})}}return new s.NodeSet(t).extend(nn)}(),this.pragmaParsers=n||te,this.blockParsers=r||Ue,this.inlineParsers=a||en,this.wrapFn=i}createParse(e,t,n){const r=new k(this,e,t,n);return this.wrapFn?this.wrapFn(r,e,t,n):r}configure(e){let t=this.nodeSet,n=[...this.pragmaParsers],r=[...this.blockParsers],a=[...this.inlineParsers],i=e.wrap||this.wrapFn;if(e.remove){const t=new Set(e.remove);n=n.filter(e=>!t.has(e.name)),r=r.filter(e=>!t.has(e.name)),a=a.filter(e=>!t.has(e.name))}if(e.parsePragma)for(const t of e.parsePragma)n=sn(n,t);if(e.parseBlock)for(const t of e.parseBlock)r=sn(r,t);if(e.parseInline)for(const t of e.parseInline)a=sn(a,t);if(e.defineNodes){const n=[...t.types];for(const t of e.defineNodes){const e="string"==typeof t?t:t.name,r=n.length;n.push(s.NodeType.define({id:r,name:e,props:[]}))}t=new s.NodeSet(n)}if(e.props)for(const n of e.props)t=t.extend(n);return new rn(t,n,r,a,i)}parseInline(e,t){return function(e,t,n){return new b(e,t,n).parse()}(this,e,t)}}function sn(e,t){const n=[...e];if(t.before){const e=n.findIndex(e=>e.name===t.before);if(e>=0)return n.splice(e,0,t),n}if(t.after){const e=n.findIndex(e=>e.name===t.after);if(e>=0)return n.splice(e+1,0,t),n}return n.push(t),n}const an=new rn,ln=i.defineLanguageFacet({commentTokens:{block:{open:"\x3c!--",close:"--\x3e"}}}),on=new s.NodeProp;function cn(e){const t=/^Heading(\d)$/.exec(e.name);return t?+t[1]:void 0}function dn(e,t){const n=e.state.doc.lineAt(t);let r=0;for(let t=0;t<n.text.length;t++){const s=n.text.charCodeAt(t);if(32===s)r++;else{if(9!==s)break;r+=e.unit}}return r}function un(e){const t=e.node,n=e.state.doc.lineAt(t.from),r=e.state.doc.lineAt(t.to),s=dn(e,t.from);if(n.number===r.number){if(fn(t.name)){const t=n.text.trim();return/^\\(?:define|procedure|function|widget)\s+\S+\s*\([^)]*\)\s*$/.test(t)?s+e.unit:s}if(!/^(ConditionalBlock|Widget|HTMLBlock)$/.test(t.name))return null}const a=e.state.doc.lineAt(e.pos);if(a.number===n.number){const t=a.text;if(e.pos>=a.from+t.trimEnd().length){if(/^\s*\\(?:define|procedure|function|widget)\s+\S+\s*\([^)]*\)\s*$/.test(t))return s+e.unit;if(/<%\s*(if|elseif)\s+.+%>\s*$/.test(t)||/<%\s*else\s*%>\s*$/.test(t))return s+e.unit;if(/<%\s*endif\s*%>\s*$/.test(t))return s;if(/<[$a-zA-Z][^>]*>\s*$/.test(t)&&!/<\//.test(t)&&!/\/>\s*$/.test(t))return s+e.unit;if(/\/>\s*$/.test(t))return s;if(/<\/[$a-zA-Z][^>]*>\s*$/.test(t))return s}return null}if(a.number>1){const t=e.state.doc.line(a.number-1).text.trim();if(/<%\s*(if|elseif)\s+.+%>\s*$/.test(t)||/<%\s*else\s*%>\s*$/.test(t))return s+e.unit}const i=a.text.trim();return/^<\/[$a-zA-Z]|^<%\s*endif\s*%>|^\\end(?:\s|$)/.test(i)||/^<%\s*(else|elseif)\s/.test(i)||/^<%\s*else\s*%>/.test(i)?s:(fn(t.name),s+e.unit)}function fn(e){return/^(MacroDefinition|ProcedureDefinition|FunctionDefinition|WidgetDefinition)$/.test(e)}const pn=an.configure({props:[i.foldNodeProp.add(e=>{if(function(e){return/^(Paragraph|Heading\d|BulletList|OrderedList|DefinitionList|BlockQuote|Table|FencedCode|TypedBlock|Widget|HTMLBlock|TransclusionBlock|FilteredTransclusionBlock|MacroCallBlock|CommentBlock|HorizontalRule|HardLineBreaks|ConditionalBlock|MacroDefinition|ProcedureDefinition|FunctionDefinition|WidgetDefinition|StyledBlock)$/.test(e.name)}(e)&&"Document"!==e.name&&null==cn(e)&&!function(e){return"BulletList"===e.name||"OrderedList"===e.name||"DefinitionList"===e.name}(e)&&"Paragraph"!==e.name)return fn(e.name)?(e,t)=>{const n=t.doc.lineAt(e.from).to;let r=e.lastChild;if(r&&"PragmaEnd"===r.name){const s=t.doc.lineAt(r.from);return{from:n,to:s.from>n?s.from-1:e.to}}return{from:n,to:e.to}}:"Widget"===e.name||"HTMLBlock"===e.name?(t,n)=>{const r=n.doc.lineAt(t.from).to,s="Widget"===e.name?t.getChild("WidgetEnd"):t.getChild("HTMLEndTag");if(s){const e=n.doc.lineAt(s.from);if(e.from>r)return{from:r,to:e.from-1}}return{from:r,to:t.to}}:"ConditionalBlock"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;let r=e.lastChild;for(;r&&"ConditionalMark"!==r.name;)r=r.prevSibling;if(r){const e=t.doc.lineAt(r.from);if(e.from>n)return{from:n,to:e.from-1}}return{from:n,to:e.to}}:"BlockQuote"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;let r=e.lastChild;for(;r&&"QuoteMark"!==r.name;)r=r.prevSibling;if(r&&r.from>e.from){const e=t.doc.lineAt(r.from);if(e.from>n)return{from:n,to:e.from-1}}return{from:n,to:e.to}}:"FencedCode"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;let r=e.lastChild;for(;r&&"CodeMark"!==r.name;)r=r.prevSibling;if(r&&r.from>e.from){const e=t.doc.lineAt(r.from);if(e.from>n)return{from:n,to:e.from-1}}return{from:n,to:e.to}}:"TypedBlock"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to;let r=e.lastChild;for(;r&&"TypedBlockMark"!==r.name;)r=r.prevSibling;if(r&&r.from>e.from){const e=t.doc.lineAt(r.from);if(e.from>n)return{from:n,to:e.from-1}}return{from:n,to:e.to}}:"Table"===e.name?(e,t)=>{const n=t.doc.lineAt(e.from).to,r=e.getChild("TableHeader")||e.getChild("TableRow");if(r){const n=t.doc.lineAt(r.to).to;if(n<e.to)return{from:n,to:e.to}}return{from:n,to:e.to}}:(e,t)=>({from:t.doc.lineAt(e.from).to,to:e.to})}),on.add(cn),i.indentNodeProp.add({Document:e=>{const t=e.state.doc.lineAt(e.pos);if(t.number>1){const n=e.state.doc.line(t.number-1),r=n.text;if(/^\s*\\(?:define|procedure|function|widget)\s+\S+\s*\([^)]*\)\s*$/.test(r)){return dn(e,n.from)+e.unit}if(/<%\s*(if|elseif)\s+.+%>\s*$/.test(r)||/<%\s*else\s*%>\s*$/.test(r)){return dn(e,n.from)+e.unit}if(/<[$a-zA-Z][^>]*>\s*$/.test(r)&&!/<\//.test(r)&&!/\/>\s*$/.test(r)){return dn(e,n.from)+e.unit}if(/^\s*\\end(?:\s|$)/.test(r)){return dn(e,n.from)}}return null},Widget:un,HTMLBlock:un,ConditionalBlock:un,ConditionalBranch:un,BlockQuote:un,MacroDefinition:un,ProcedureDefinition:un,FunctionDefinition:un,WidgetDefinition:un})]});function hn(e,t){let n=e;for(;;){const e=n.nextSibling;if(!e)break;const r=cn(e.type);if(null!=r&&r<=t)break;n=e}return n.to}const mn=i.foldService.of((e,t,n)=>{for(let r=i.syntaxTree(e).resolveInner(n,-1);r&&!(r.from<t);r=r.parent){const e=r.type.prop(on);if(null==e)continue;const t=hn(r,e);if(t>n)return{from:n,to:t}}return null});function gn(e){const t=e.configure({props:[i.languageDataProp.add({Document:ln})]});return new i.Language(ln,t,[],"tiddlywiki")}const kn=gn(pn);class bn{constructor(e,t,n,r,s,a,i){this.node=e,this.from=t,this.to=n,this.spaceBefore=r,this.spaceAfter=s,this.type=a,this.item=i}blank(e,t=!0){let n=this.spaceBefore;if("BlockQuote"==this.node.name&&(n+=">"),null!=e){for(;n.length<e;)n+=" ";return n}for(let e=this.to-this.from-n.length-this.spaceAfter.length;e>0;e--)n+=" ";return n+(t?this.spaceAfter:"")}marker(e,t){let n="";if("OrderedList"==this.node.name||"BulletList"==this.node.name){let t=e.sliceString(this.item.from,this.item.from+20),r=/^([*#]+)/.exec(t);r&&(n=r[1])}else if("DefinitionList"==this.node.name){let t=e.sliceString(this.item.from,this.item.from+20),r=/^([;:*#]+)/.exec(t);n=r?r[1]:this.type}else if("BlockQuote"==this.node.name)if("<<<"==this.type)n="<<<";else{let t=e.sliceString(this.item.from,this.item.from+20),r=/^([>*#]+)/.exec(t);n=r?r[1]:">"}return this.spaceBefore+n+this.spaceAfter}}function xn(e,t){let n=[],r=[];for(let t=e;t;t=t.parent){if("FencedCode"==t.name||"CodeBlock"==t.name)return r;"ListItem"!=t.name&&"BlockQuote"!=t.name&&"DefinitionTerm"!=t.name&&"DefinitionDescription"!=t.name||n.push(t)}for(let e=n.length-1;e>=0;e--){let s,a=n[e],i=t.lineAt(a.from),l=a.from-i.from;"BlockQuote"==a.name?(s=/^(\s*)(<<<)(\s*)/.exec(i.text.slice(l)),s&&r.push(new bn(a,l,l+s[0].length,s[1],s[3],"<<<",null))):"ListItem"!=a.name||"OrderedList"!=a.parent?.name&&"BulletList"!=a.parent?.name?"ListItem"==a.name&&"BlockQuote"==a.parent?.name?(s=/^(\s*)([>*#]+)(\s*)/.exec(i.text.slice(l)),s&&r.push(new bn(a.parent,l,l+s[0].length,s[1],s[3],s[2],a))):("DefinitionTerm"==a.name||"DefinitionDescription"==a.name)&&(s=/^(\s*)([;:*#]+)(\s*)/.exec(i.text.slice(l)),s&&r.push(new bn(a.parent,l,l+s[0].length,s[1],s[3],s[2],a))):(s=/^(\s*)([*#]+)(\s+)/.exec(i.text.slice(l)),s&&r.push(new bn(a.parent,l,l+s[0].length,s[1],s[3],s[2],a)))}return r}function yn(e,t){let r=/^[ \t]*/.exec(e)[0].length;if(!r||"\t"!=t.facet(i.indentUnit))return e;let s="";for(let t=n.countColumn(e,4,r);t>0;)t>=4?(s+="\t",t-=4):(s+=" ",t--);return s+e.slice(r)}const $n=(e={})=>({state:t,dispatch:r})=>{const s=e.fallbackBehavior||"smart";let a=i.syntaxTree(t),{doc:l}=t,o=null,c=t.changeByRange(e=>{if(!e.empty||!kn.isActiveAt(t,e.from,-1)&&!kn.isActiveAt(t,e.from,1))return o={range:e};let r=e.from,c=l.lineAt(r),d=a.resolveInner(r,-1);"Document"===d.name&&r>0&&(d=a.resolveInner(r-1,-1));let u=xn(d,l);for(;u.length&&u[u.length-1].from>r-c.from;)u.pop();if(!u.length){const e=c.text;if("none"===s){const e=t.lineBreak;return{range:n.EditorSelection.cursor(r+e.length),changes:{from:r,insert:e}}}if("indent"===s){let s="";for(let t=0;t<e.length;t++){const n=e.charAt(t);if(" "!==n&&"\t"!==n)break;s+=n}const a=t.lineBreak+s;return{range:n.EditorSelection.cursor(r+a.length),changes:{from:r,insert:a}}}const a=t.facet(i.indentUnit),l="\t"===a?t.tabSize:a.length;let o=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);if(32===r)o++;else{if(9!==r)break;o+=t.tabSize}}const d=r-c.from,u=e.slice(0,d),f=e.slice(d);if(/>$/.test(u)&&/^<\//.test(f)){let e="",s="";if("\t"===a){e="\t".repeat(Math.floor(o/t.tabSize));const n=o%t.tabSize;n>0&&(e+=" ".repeat(n)),s=e+"\t"}else e=" ".repeat(o),s=" ".repeat(o+l);const i=t.lineBreak+s+t.lineBreak+e,c=r+t.lineBreak.length+s.length;return{range:n.EditorSelection.cursor(c),changes:{from:r,insert:i}}}let p=i.getIndentation(t,r);const h=e.trim(),m=f.trim();/^\\end(?:\s|$)/.test(h)&&""===m?p=o:null!=p&&0!==p||(""===h||/^<[$a-zA-Z\/]/.test(m)||/^<%/.test(m)||/^\\end\b/.test(m)?p=o:/<%\s*(if|elseif)\s+.+%>\s*$/.test(h)||/<%\s*else\s*%>\s*$/.test(h)?p=o+l:!/<[$a-zA-Z][^>]*>\s*$/.test(h)||/<\//.test(h)||h.endsWith("/>")?(/<%\s*endif\s*%>\s*$/.test(h)||/<\/[$a-zA-Z][^>]*>\s*$/.test(h))&&(p=o):p=o+l);let g="";if(null!=p&&p>0)if("\t"===a){g="\t".repeat(Math.floor(p/t.tabSize));const e=p%t.tabSize;e>0&&(g+=" ".repeat(e))}else g=" ".repeat(p);const k=t.lineBreak+g;return{range:n.EditorSelection.cursor(r+k.length),changes:{from:r,insert:k}}}let f=u[u.length-1];if(f.to-f.spaceAfter.length>r-c.from)return o={range:e};let p=r>=f.to-f.spaceAfter.length&&!/\S/.test(c.text.slice(f.to));if(f.item&&p){let e,t=u.length>1?u[u.length-2]:null,s="";t&&t.item?(e=c.from+t.from,s=t.marker(l,1)):e=c.from+(t?t.to:0);let a=[{from:e,to:r,insert:s}];return{range:n.EditorSelection.cursor(e+s.length),changes:a}}let h=[],m=f.item&&f.item.from<c.from,g="";if(!m||/^[\s\*#;:>]*/.exec(c.text)[0].length>=f.to)for(let e=0,t=u.length-1;e<=t;e++)g+=e!=t||m?u[e].blank(e<t?n.countColumn(c.text,4,u[e+1].from)-g.length:null):u[e].marker(l,1);let k=r;for(;k>c.from&&/\s/.test(c.text.charAt(k-c.from-1));)k--;return g=yn(g,t),h.push({from:k,to:r,insert:t.lineBreak+g}),{range:n.EditorSelection.cursor(k+g.length+1),changes:h}});return!o&&(r(t.update(c,{scrollIntoView:!0,userEvent:"input"})),!0)},wn=$n();function Tn(e){return"QuoteMark"==e.name||"ListMark"==e.name||"HeadingMark"==e.name}const Mn=({state:e,dispatch:t})=>{let r=i.syntaxTree(e),s=null,a=e.changeByRange(t=>{let a=t.from,{doc:i}=e;if(t.empty&&kn.isActiveAt(e,t.from)){let t=i.lineAt(a),s=xn(function(e,t){let n=e.resolveInner(t,-1),r=t;Tn(n)&&(r=n.from,n=n.parent);for(let e;e=n.childBefore(r);)if(Tn(e))r=e.from;else{if("OrderedList"!=e.name&&"BulletList"!=e.name&&"DefinitionList"!=e.name)break;n=e.lastChild,r=n.to}return n}(r,a),i);if(s.length){let r=s[s.length-1],i=r.to-r.spaceAfter.length+(r.spaceAfter?1:0);if(a-t.from>i&&!/\S/.test(t.text.slice(i,a-t.from)))return{range:n.EditorSelection.cursor(t.from+i),changes:{from:t.from+i,to:a}};if(a-t.from==i&&(!r.item||t.from<=r.item.from||!/\S/.test(t.text.slice(0,r.to)))){let s=t.from+r.from;if(r.item&&r.node.from<r.item.from&&/\S/.test(t.text.slice(r.from,r.to))){let a=r.blank(n.countColumn(t.text,4,r.to)-n.countColumn(t.text,4,r.from));return s==t.from&&(a=yn(a,e)),{range:n.EditorSelection.cursor(s+a.length),changes:{from:s,to:t.from+r.to,insert:a}}}if(s<a)return{range:n.EditorSelection.cursor(s),changes:{from:s,to:a}}}}}return s={range:t}});return!s&&(t(e.update(a,{scrollIntoView:!0,userEvent:"delete"})),!0)},Sn={'"':'"',"'":"'","`":"`","(":")","[":"]","{":"}"},Cn=({state:e,dispatch:t})=>{let r=[],s=[];for(let t of e.selection.ranges){if(!t.empty)return!1;const n=t.from;if(0===n)return!1;const a=e.doc.sliceString(n-1,n),i=e.doc.sliceString(n,n+1),l=Sn[a];if(!l||i!==l)return!1;r.push({from:n-1,to:n+1}),s.push({anchor:n-1})}return 0!==r.length&&(t(e.update({changes:r,selection:n.EditorSelection.create(s.map(e=>n.EditorSelection.cursor(e.anchor))),scrollIntoView:!0,userEvent:"delete"})),!0)};function Pn(e,t,r){let s=e.changeByRange(t=>{if(t.empty)return{range:n.EditorSelection.cursor(t.from+r.length),changes:{from:t.from,insert:r+r}};{let s=e.doc.sliceString(t.from,t.to);if(s.startsWith(r)&&s.endsWith(r)&&s.length>=2*r.length){let e=s.slice(r.length,-r.length);return{range:n.EditorSelection.range(t.from,t.from+e.length),changes:{from:t.from,to:t.to,insert:e}}}return{range:n.EditorSelection.range(t.from,t.to+2*r.length),changes:[{from:t.from,insert:r},{from:t.to,insert:r}]}}});return t(e.update(s,{scrollIntoView:!0,userEvent:"input"})),!0}const Ln=({state:e,dispatch:t})=>Pn(e,t,"''"),vn=({state:e,dispatch:t})=>Pn(e,t,"//"),An=({state:e,dispatch:t})=>Pn(e,t,"__"),En=({state:e,dispatch:t})=>Pn(e,t,"~~"),Bn=({state:e,dispatch:t})=>Pn(e,t,"^^"),In=({state:e,dispatch:t})=>Pn(e,t,",,"),Nn=({state:e,dispatch:t})=>Pn(e,t,"`"),Fn=({state:e,dispatch:t})=>{let r=e.changeByRange(t=>{if(t.empty)return{range:n.EditorSelection.cursor(t.from+2),changes:{from:t.from,insert:"[[]]"}};{let r=e.doc.sliceString(t.from,t.to);return{range:n.EditorSelection.range(t.from+2,t.from+2+r.length),changes:{from:t.from,to:t.to,insert:`[[${r}]]`}}}});return t(e.update(r,{scrollIntoView:!0,userEvent:"input"})),!0},Wn=({state:e,dispatch:t})=>{let r=e.changeByRange(t=>{if(t.empty)return{range:n.EditorSelection.cursor(t.from+2),changes:{from:t.from,insert:"{{}}"}};{let r=e.doc.sliceString(t.from,t.to);return{range:n.EditorSelection.range(t.from+2,t.from+2+r.length),changes:{from:t.from,to:t.to,insert:`{{${r}}}`}}}});return t(e.update(r,{scrollIntoView:!0,userEvent:"input"})),!0};function On(e,t,r){let{doc:s}=e,a=new Set,i=e.changeByRange(e=>{let t=s.lineAt(e.from);if(a.has(t.number))return{range:e};a.add(t.number);let i=t.text,l=/^(!+)\s*/.exec(i),o=l?l[0].length:0,c=r>0?"!".repeat(r)+" ":"",d=c.length-o,u=Math.max(t.from+c.length,e.anchor+d),f=e.empty?u:Math.max(t.from+c.length,e.head+d);return{range:n.EditorSelection.range(u,f),changes:{from:t.from,to:t.from+o,insert:c}}});return t(e.update(i,{scrollIntoView:!0,userEvent:"input"})),!0}const Dn=({state:e,dispatch:t})=>On(e,t,1),Hn=({state:e,dispatch:t})=>On(e,t,2),zn=({state:e,dispatch:t})=>On(e,t,3),_n=({state:e,dispatch:t})=>On(e,t,4),Zn=({state:e,dispatch:t})=>On(e,t,5),Vn=({state:e,dispatch:t})=>On(e,t,6),Rn=({state:e,dispatch:t})=>On(e,t,0);function Kn(e,t,r){let{doc:s}=e,a=new Set,i=e.changeByRange(e=>{let t=s.lineAt(e.from);if(a.has(t.number))return{range:e};a.add(t.number);let i=t.text,l=new RegExp(`^(${r.replace(/[*#]/g,"\\$&")}+)\\s*`).exec(i);if(l){let r=-l[0].length,s=Math.max(t.from,e.anchor+r),a=e.empty?s:Math.max(t.from,e.head+r);return{range:n.EditorSelection.range(s,a),changes:{from:t.from,to:t.from+l[0].length,insert:""}}}{let s=/^([*#;:]+)\s*/.exec(i),a=r+" ",l=s?s[0].length:0,o=a.length-l,c=Math.max(t.from+a.length,e.anchor+o),d=e.empty?c:Math.max(t.from+a.length,e.head+o);return s?{range:n.EditorSelection.range(c,d),changes:{from:t.from,to:t.from+s[0].length,insert:a}}:{range:n.EditorSelection.range(c,d),changes:{from:t.from,insert:a}}}});return t(e.update(i,{scrollIntoView:!0,userEvent:"input"})),!0}const Xn=({state:e,dispatch:t})=>Kn(e,t,"*"),jn=({state:e,dispatch:t})=>Kn(e,t,"#"),Un=({state:e,dispatch:t})=>{let r=e.changeByRange(t=>{if(t.empty){let r=e.doc.lineAt(t.from),s="```\n\n```\n",a=r.from+4;return{range:n.EditorSelection.cursor(a),changes:{from:r.from,insert:s}}}{let r=e.doc.sliceString(t.from,t.to),s="```\n"+r+"\n```";return{range:n.EditorSelection.range(t.from+4,t.from+4+r.length),changes:{from:t.from,to:t.to,insert:s}}}});return t(e.update(r,{scrollIntoView:!0,userEvent:"input"})),!0},qn=r.EditorView.inputHandler.of((e,t,n,r)=>{if(!/^[*#>;:]$/.test(r))return!1;if(t!==n)return!1;let s=e.state.doc.lineAt(t),a=s.from,i=t-a,l=s.text,o=/^([*#>;:]+) $/.exec(l.slice(0,i));if(o){let n=o[1]+r+" ";return e.dispatch({changes:{from:a,to:t,insert:n},selection:{anchor:a+n.length}}),!0}return!1}),Qn=({state:e,dispatch:t})=>{let{doc:r,selection:s}=e,a=s.main;if(!a.empty)return!1;let i=a.from,l=r.lineAt(i),o=i-l.from,c=l.text,d=/^(\*{2,}) $/.exec(c.slice(0,o));if(d&&o===d[0].length){let r=d[1].slice(0,-1)+" ";return t(e.update({changes:{from:l.from,to:i,insert:r},selection:n.EditorSelection.cursor(l.from+r.length)})),!0}let u=/^(#{2,}) $/.exec(c.slice(0,o));if(u&&o===u[0].length){let r=u[1].slice(0,-1)+" ";return t(e.update({changes:{from:l.from,to:i,insert:r},selection:n.EditorSelection.cursor(l.from+r.length)})),!0}return!1},Gn=({state:e,dispatch:t})=>{let{doc:n,selection:r}=e,s=[],a=new Set,i=!1;for(let e of r.ranges){let t=n.lineAt(e.from),r=n.lineAt(e.to);for(let e=t.number;e<=r.number;e++){if(a.has(e))continue;a.add(e);let t=n.line(e),r=t.text,l=/^([*#>]+)( )/.exec(r);if(l){let e=l[1],n=e[e.length-1],r=t.from+e.length;s.push({from:r,to:r,insert:n}),i=!0;continue}let o=/^([;:]+)(\s*)/.exec(r);if(o){let e=o[1],n=e[e.length-1],r=t.from+e.length;s.push({from:r,to:r,insert:n}),i=!0;continue}}}return!(!i||0===s.length)&&(t(e.update({changes:s,scrollIntoView:!0,userEvent:"input"})),!0)},Jn=({state:e,dispatch:t})=>{let{doc:n,selection:r}=e,s=[],a=new Set,i=!1;for(let e of r.ranges){let t=n.lineAt(e.from),r=n.lineAt(e.to);for(let e=t.number;e<=r.number;e++){if(a.has(e))continue;a.add(e);let t=n.line(e),r=t.text,l=/^([*#>]{2,})( )/.exec(r);if(l){let e=l[1],n=t.from+e.length-1;s.push({from:n,to:n+1}),i=!0;continue}let o=/^([;:]{2,})(\s*)/.exec(r);if(o){let e=o[1],n=t.from+e.length-1;s.push({from:n,to:n+1}),i=!0;continue}/^([*#>]) /.exec(r)?(s.push({from:t.from,to:t.from+2}),i=!0):/^([;:]) /.exec(r)&&(s.push({from:t.from,to:t.from+2}),i=!0)}}return!!i&&(0===s.length||t(e.update({changes:s,scrollIntoView:!0,userEvent:"input"})),!0)},Yn=i.HighlightStyle.define([{tag:a.tags.heading1,class:"cm-tw-heading1"},{tag:a.tags.heading2,class:"cm-tw-heading2"},{tag:a.tags.heading3,class:"cm-tw-heading3"},{tag:a.tags.heading4,class:"cm-tw-heading4"},{tag:a.tags.heading5,class:"cm-tw-heading5"},{tag:a.tags.heading6,class:"cm-tw-heading6"},{tag:a.tags.heading,class:"cm-tw-tableheader"},{tag:a.tags.strong,class:"cm-tw-bold"},{tag:a.tags.emphasis,class:"cm-tw-italic"},{tag:a.tags.strikethrough,class:"cm-tw-strikethrough"},{tag:a.tags.link,class:"cm-tw-wikilink"},{tag:a.tags.url,class:"cm-tw-url"},{tag:a.tags.string,class:"cm-tw-linktext"},{tag:a.tags.special(a.tags.link),class:"cm-tw-transclusion"},{tag:a.tags.macroName,class:"cm-tw-macrocall"},{tag:a.tags.variableName,class:"cm-tw-variable"},{tag:a.tags.tagName,class:"cm-tw-widget"},{tag:a.tags.monospace,class:"cm-tw-code"},{tag:a.tags.labelName,class:"cm-tw-codeinfo"},{tag:a.tags.definitionKeyword,class:"cm-tw-pragma"},{tag:a.tags.keyword,class:"cm-tw-pragma-keyword"},{tag:a.tags.controlKeyword,class:"cm-tw-conditional"},{tag:a.tags.list,class:"cm-tw-list"},{tag:a.tags.quote,class:"cm-tw-blockquote"},{tag:a.tags.contentSeparator,class:"cm-tw-hr"},{tag:a.tags.comment,class:"cm-tw-comment"},{tag:a.tags.escape,class:"cm-tw-escape"},{tag:a.tags.character,class:"cm-tw-entity"},{tag:a.tags.processingInstruction,class:"cm-tw-mark"},{tag:a.tags.special(a.tags.string),class:"cm-tw-filter"},{tag:a.tags.attributeValue,class:"cm-tw-attribute-value"},{tag:a.tags.attributeName,class:"cm-tw-attribute"},{tag:a.tags.special(a.tags.variableName),class:"cm-tw-param-ref"},{tag:a.tags.special(a.tags.emphasis),class:"cm-tw-underline"},{tag:tn.twSuperscript,class:"cm-tw-superscript"},{tag:tn.twSubscript,class:"cm-tw-subscript"},{tag:a.tags.special(a.tags.content),class:"cm-tw-highlight"}]);function er(e={}){const{getTabOutsideListBehavior:t,getShiftTabOutsideListBehavior:n,getEnterIndentBehavior:r}=e,s=$n({fallbackBehavior:"smart"}),a=$n({fallbackBehavior:"indent"}),i=$n({fallbackBehavior:"none"});return[{key:"Enter",run:function(e){switch(r?r():"smart"){case"smart":default:return s(e);case"indent":return a(e);case"none":return i(e)}}},{key:"Backspace",run:e=>Cn(e)||Qn(e)||Mn(e)},{key:"Tab",run:function(e){if("active"===l.completionStatus(e.state))return l.acceptCompletion(e);if(Gn(e))return!0;switch(t?t():"indent"){case"indent":return c.indentMore(e);case"insertTab":return c.insertTab(e);default:return!1}}},{key:"Shift-Tab",run:function(e){return!!Jn(e)||"indent"===(n?n():"indent")&&c.indentLess(e)}}]}function tr(e,t,n,r){const a=function(e,t,n){const r=["tiddlywiki","wikitext","tw","tw5"];return s=>{if(s&&e){let a=null;if(s=/\S*/.exec(s)[0],r.includes(s.toLowerCase()))return n??t?.parser??null;if(a="function"==typeof e?e(s):i.LanguageDescription.matchLanguageName(e,s,!0),a instanceof i.LanguageDescription){const e=a.name?.toLowerCase()||"",s=a.alias?.map(e=>e.toLowerCase())||[];return"tiddlywiki"===e||r.some(e=>s.includes(e))?n??t?.parser??null:a.support?a.support.language.parser:i.ParseContext.getSkippingParser(a.load())}if(a)return a.parser}return t?t.parser:null}}(e,t,n);return s.parseMixed((t,s)=>{if("CodeText"===t.name){const r=t.node.parent;if("FencedCode"===r?.name){const e=r.getChild("CodeInfo"),t=e?s.read(e.from,e.to):"",n=a(t);if(n)return{parser:n,bracketed:!0}}if("TypedBlock"===r?.name){const t=r.getChild("TypedBlockType"),l=t?s.read(t.from,t.to):"";if(("text/vnd.tiddlywiki"===l||"text/x-tiddlywiki"===l)&&n)return{parser:n,bracketed:!0};if("text/plain"===l)return null;if(l.startsWith(".")){const t=function(e,t){if(!e.startsWith("."))return"";const n=e.slice(1).toLowerCase();if(t&&Array.isArray(t))for(const e of t)if(e.extensions&&e.extensions.some(e=>e.toLowerCase()===n))return e.name.toLowerCase();return""}(l,Array.isArray(e)?e:void 0);if(t){const e=a(t);if(e)return{parser:e,bracketed:!0}}}const o={"text/javascript":"javascript","application/javascript":"javascript","text/typescript":"typescript","application/typescript":"typescript","text/css":"css","text/html":"html","application/json":"json","text/x-markdown":"markdown","text/x-tiddlywiki":"","text/vnd.tiddlywiki":"","text/plain":""}[i=l]??i.replace(/^text\/x-/,"").replace(/^application\//,"").replace(/^text\//,"");if(o){const e=a(o);if(e)return{parser:e,bracketed:!0}}}}var i;if("HTMLBlock"===t.name){const e=t.node.getChild("TagName");if(e){const n=s.read(e.from,e.to).toLowerCase();if("style"===n||"script"===n){const e=a("style"===n?"css":"javascript");if(e){let n=-1,r=-1;const a=t.node.cursor();a.firstChild();do{if("TagMark"===a.name&&-1===n){">"===s.read(a.from,a.to)&&(n=a.to)}if("HTMLEndTag"===a.name){r=a.from;break}}while(a.nextSibling());if(n>0&&r>n)return{parser:e,overlay:[{from:n,to:r}]}}}}}if("LaTeXContent"===t.name){const e=a("latex");if(e)return{parser:e,bracketed:!0}}if("HighlightStyles"===t.name){const e=a("css");if(e){return{parser:e.configure({top:"Styles"}),bracketed:!0}}}if("AttributeString"===t.name){const e=t.node.parent;if("Attribute"===e?.name){const n=e.getChild("AttributeName");if(n){if("style"===s.read(n.from,n.to)){const n=e.parent;if(n&&("Widget"===n.name||"InlineWidget"===n.name)&&r){const e=n.getChild("WidgetName");if(e){const t=s.read(e.from,e.to),n=r(t);if(n&&!n.includes("style"))return null}}const i=a("css");if(i){const e=i.configure({top:"Styles"}),n=t.from+1,r=t.to-1;if(r>n)return{parser:e,overlay:[{from:n,to:r}],bracketed:!0}}}}}}if("AttributeString"===t.name){const e=t.node.parent;if("Attribute"===e?.name){const n=e.getChild("AttributeName");if(n){if("text"===s.read(n.from,n.to)){const n=e.parent;if(n&&("Widget"===n.name||"InlineWidget"===n.name)){const e=n.getChild("WidgetName");if(e){const n=s.read(e.from,e.to);if("$latex"===n||"$katex"===n){const e=a("latex");if(e){const n=t.from+1,r=t.to-1;if(r>n)return{parser:e,overlay:[{from:n,to:r}],bracketed:!0}}}}}}}}}return null})}er();const nr=n.StateEffect.define(),rr=r.EditorView.updateListener.of(e=>{for(const t of e.transactions)for(const n of t.effects)if(n.is(nr))return void setTimeout(()=>{null===l.completionStatus(e.view.state)&&l.startCompletion(e.view)},10)}),sr=new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]),ar=new Set(["$action-confirm","$action-createtiddler","$action-deletetiddler","$action-deletefield","$action-listops","$action-log","$action-navigate","$action-popup","$action-sendmessage","$action-setfield","$action-setmultiplefields","$audio","$codeblock","$count","$data","$edit-text","$encrypt","$entity","$error","$image","$jsontiddler","$raw","$text"]),ir=["transclusion","currentTiddler","storyTiddler","tv-story-list","tv-history-list","tv-config-toolbar-icons","tv-config-toolbar-text","tv-config-toolbar-class","tv-wikilinks","tv-show-missing-links","revealedTitle","tv-tiddler-preview"],lr=["title","text","tags","modified","created","creator","modifier","type","caption","description","list","list-before","list-after","draft.of","draft.title","plugin-type","plugin-priority","color","icon","library","source","code-body","throttle.refresh"];function or(e,t,n,r,s){const a=e.state.selection.ranges,i=e.state.selection.mainIndex;return a.map((e,a)=>a===i?{from:t,to:n,insert:r}:{from:e.from-s,to:e.from,insert:r})}function cr(e){return e.startsWith("$:/")?-1:1}let dr={text:"",result:null};function ur(e){if(dr.text===e&&dr.result)return dr.result;const t=[],n=[],r=[],s=[],a={},i={},l=/\\(define|procedure|function|widget)\s+([^\s(]+)(?:\(([^)]*)\))?/g;let o;for(;null!==(o=l.exec(e));){const l=o[1],c=o[2],d=o[3];if(!a[c]){switch(a[c]=!0,l){case"function":t.push(c);break;case"procedure":n.push(c);break;case"define":r.push(c);break;case"widget":s.push(c)}if(void 0!==d&&d.trim()){const e=d.split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0);e.length>0&&(i[c]=e)}else{const t=e.slice(o.index+o[0].length),n=/^\s*\n?\s*\\parameters\s*\(([^)]*)\)/.exec(t);if(n){const e=n[1].split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0);e.length>0&&(i[c]=e)}}}}const c=[],d=/<\$set\s+[^>]*name\s*=\s*["']([^"']+)["']/gi;for(;null!==(o=d.exec(e));){const e=o[1];a[e]||(a[e]=!0,c.push(e))}const u=/<\$vars\s+([^>]+)>/gi;for(;null!==(o=u.exec(e));){const e=o[1],t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];a[e]||(a[e]=!0,c.push(e))}}const f=/<\$let\s+([^>]+)>/gi;for(;null!==(o=f.exec(e));){const e=o[1],t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];a[e]||(a[e]=!0,c.push(e))}}const p=/<\$parameters\s+([^>]+)>/gi;for(;null!==(o=p.exec(e));){const e=o[1],t=/([a-zA-Z_][\w-]*)\s*=/g;let n;for(;null!==(n=t.exec(e));){const e=n[1];a[e]||(a[e]=!0,c.push(e))}}const h=/<\$list\s+[^>]*(?:variable|counter)\s*=\s*["']([^"']+)["']/gi;for(;null!==(o=h.exec(e));){const e=o[1];a[e]||(a[e]=!0,c.push(e))}const m=/<\$range\s+[^>]*variable\s*=\s*["']([^"']+)["']/gi;for(;null!==(o=m.exec(e));){const e=o[1];a[e]||(a[e]=!0,c.push(e))}const g=/<\$wikify\s+[^>]*name\s*=\s*["']([^"']+)["']/gi;for(;null!==(o=g.exec(e));){const e=o[1];a[e]||(a[e]=!0,c.push(e))}const k=[...ir,...t,...n,...r,...s,...c],b={functions:t,procedures:n,macros:r,widgets:s,widgetVars:c,builtIns:ir,variables:k,definitionParams:i};return dr={text:e,result:b},b}const fr=["now","tag","tabs","timeline","toc","toc-hierarchical","toc-selective-expandable","list-links","list-links-draggable","list-tagged-draggable","copy-to-clipboard","colour-picker","image-picker","keyboard-shortcut","dumpvariables","qualify","csvtiddlers","jsontiddlers","datauri","makedatauri","translink"];function pr(e,t,n){return r=>{const{state:s,pos:a}=r,l=s.sliceDoc(a-50,a),o=/<<[\w\-\.]*$/.exec(l);if(o&&"<"===l[o.index-1])return null;if(o&&/<<__/.test(o[0]))return null;const c=/[\[\]}>][\w\-:!]*<[\w\-\.]*$/.exec(l);if(c&&/<__/.test(c[0]))return null;const d=o||c;if(!d)return null;let u=i.syntaxTree(s).resolveInner(a,-1);for(;u&&!u.type.isTop;){if("FencedCode"===u.name||"CodeBlock"===u.name||"TypedBlock"===u.name||"CommentBlock"===u.name||"KaTeXBlock"===u.name||"LaTeXContent"===u.name)return null;u=u.parent}const f=new Set,p=[],h=s.doc.toString(),m=ur(h),g=mr(h,a);if(g&&g.params.length>0)for(const e of g.params)f.has(e)||(f.add(e),p.push({name:e,detail:"parameter",type:"variable",boost:10}));for(const e of m.macros)f.has(e)||(f.add(e),p.push({name:e,detail:"macro (local)",type:"function"}));for(const e of m.procedures)f.has(e)||(f.add(e),p.push({name:e,detail:"procedure (local)",type:"function"}));for(const e of m.functions)f.has(e)||(f.add(e),p.push({name:e,detail:"function (local)",type:"function"}));for(const e of m.widgetVars)f.has(e)||(f.add(e),p.push({name:e,detail:"variable (local)",type:"variable"}));for(const e of m.builtIns)f.has(e)||(f.add(e),p.push({name:e,detail:"variable (built-in)",type:"keyword"}));const k=e?e():[],b=k.length>0?k:fr;for(const e of b)f.has(e)||(f.add(e),p.push({name:e,detail:"macro",type:"function"}));const x=t?t():[];for(const e of x)f.has(e)||(f.add(e),p.push({name:e,detail:"function",type:"function"}));const y=n?n():[];for(const e of y)f.has(e)||(f.add(e),p.push({name:e,detail:"variable",type:"variable"}));if(c){const e=d[0].slice(0,d[0].lastIndexOf("<")+1),t=c[0].length,n=p.map(({name:n,detail:r,type:s,boost:a})=>({label:e+n,type:s,detail:r,boost:a,apply:(r,s,a,i)=>{const l=r.state.sliceDoc(i,i+2),o=">"===l[0],c="]"===l[1]||"]"===l[0];let d=">]";o&&c?d="":o?d="]":c&&(d=">");const u=e+n+d,f=a+e.length+n.length+1,p=or(r,a,i,u,t);r.dispatch({changes:p,selection:{anchor:f}})}}));return{from:a-c[0].length,to:a,options:n,validFor:/^[\[\]}>][\w\-:!]*<[\w\-\.]*$/}}const $=p.map(({name:e,detail:t,type:n,boost:r})=>({label:"<<"+e,type:n,detail:t,boost:r,apply:"<<"+e+">>"}));return{from:a-d[0].length,to:a,options:$,validFor:/^<<[\w\-\.]*$/}}}function hr(e){return t=>{const{state:n,pos:r}=t,s=n.sliceDoc(Math.max(0,r-200),r),a=/<<([\w\-\.]+)\s+[^>]*$/.exec(s),l=/<\$macrocall\s+[^>]*\$name=(?:"([^"]+)"|'([^']+)'|<<([^>]+)>>)[^>]*$/.exec(s);let o=null;if(a?o=a[1]:l&&(o=l[1]||l[2]||l[3]),!o)return null;const c=a?s.slice(s.lastIndexOf("<<")):s.slice(s.lastIndexOf("<$macrocall"));let d=!1,u="";for(const e of c)d||'"'!==e&&"'"!==e?d&&e===u&&(d=!1):(d=!0,u=e);if(d)return null;const f=/\s([$\w\-]*)$/.exec(s);if(!f)return null;const p=r-f[1].length;let h=i.syntaxTree(n).resolveInner(r,-1);for(;h&&!h.type.isTop;){if("FencedCode"===h.name||"CodeBlock"===h.name||"TypedBlock"===h.name||"CommentBlock"===h.name||"KaTeXBlock"===h.name||"LaTeXContent"===h.name)return null;h=h.parent}const m=ur(n.doc.toString());let g=null;if(m.definitionParams[o]?g=m.definitionParams[o]:e&&(g=e(o)),!g||0===g.length)return null;return{from:p,to:r,options:g.map(e=>({label:e,type:"property",detail:"parameter",apply:e+":"})),validFor:/^[$\w\-]*$/}}}function mr(e,t){const n=e.slice(0,t),r=/\\(define|procedure|function|widget)\s+([^\s(]+)(?:\(([^)]*)\))?/g;let s,a=null;for(;null!==(s=r.exec(n));){const t=s[1],n=s[2],r=s[3];let i=[];if(void 0!==r&&r.trim())i=r.split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0);else{const t=e.slice(s.index+s[0].length),n=/^\s*\n?\s*\\parameters\s*\(([^)]*)\)/.exec(t);n&&(i=n[1].split(",").map(e=>e.trim().split(":")[0].trim()).filter(e=>e.length>0))}a={name:n,type:t,params:i,startPos:s.index}}if(!a||0===a.params.length)return null;const i=e.slice(a.startPos),l=/\\end\b/.exec(i),o=/\\(define|procedure|function|widget)\s+/.exec(i.slice(1));let c=e.length;if(l&&(c=a.startPos+l.index+l[0].length),o){const e=a.startPos+1+o.index;e<c&&(c=e)}return t<=c?{name:a.name,type:a.type,params:a.params}:null}const gr=["classic","pop","zoomin"],kr=["application/javascript","application/json","application/x-tiddler","application/x-tiddler-html-div","application/x-tiddlers","text/css","text/html","text/plain","text/vnd.tiddlywiki"],br=["tm-add-field","tm-add-tag","tm-auto-save-wiki","tm-browser-refresh","tm-cancel-tiddler","tm-clear-password","tm-close-all-tiddlers","tm-close-all-windows","tm-close-other-tiddlers","tm-close-tiddler","tm-close-window","tm-copy-to-clipboard","tm-delete-tiddler","tm-download-file","tm-edit-bitmap-operation","tm-edit-text-operation","tm-edit-tiddler","tm-focus-selector","tm-fold-all-tiddlers","tm-fold-other-tiddlers","tm-fold-tiddler","tm-full-screen","tm-home","tm-http-cancel-all-requests","tm-http-request","tm-import-tiddlers","tm-load-plugin-from-library","tm-load-plugin-library","tm-login","tm-logout","tm-modal","tm-navigate","tm-new-tiddler","tm-notify","tm-open-external-window","tm-open-window","tm-perform-import","tm-permalink","tm-permaview","tm-print","tm-relink-tiddler","tm-remove-field","tm-remove-tag","tm-rename-tiddler","tm-save-tiddler","tm-save-wiki","tm-scroll","tm-server-refresh","tm-set-password","tm-unfold-all-tiddlers","tm-unload-plugin-library"];function xr(e,t,n,r,s,a,l,o,c){return d=>{const{state:u,pos:f}=d,p=u.sliceDoc(Math.max(0,f-200),f),h=/([$a-zA-Z][\w\-\.]*)\s*=\s*(["'])([^"']*)$/.exec(p);if(!h)return null;const m=h[1],g=h[2],k=h[3],b=f-k.length,x=k.length;let y=i.syntaxTree(u).resolveInner(f,-1),$=!1;for(;y&&!y.type.isTop;){if("FencedCode"===y.name||"CodeBlock"===y.name||"TypedBlock"===y.name||"CommentBlock"===y.name||"KaTeXBlock"===y.name||"LaTeXContent"===y.name)return null;"Widget"!==y.name&&"InlineWidget"!==y.name&&"HTMLTag"!==y.name&&"HTMLBlock"!==y.name||($=!0),y=y.parent}if(!$)return null;let w=[];if(m.startsWith("style.")&&c){const e=c();if(e&&e.length>0){const t=k.toLowerCase();w=e.filter(e=>e.toLowerCase().startsWith(t)).map(e=>({label:e,type:"keyword",detail:"CSS value",boost:2,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}}else if("$variable"===m){const t=new Set,s=[],a=ur(u.doc.toString());for(const e of a.macros)t.has(e)||(t.add(e),s.push({name:e,detail:"macro (local)",type:"function"}));for(const e of a.procedures)t.has(e)||(t.add(e),s.push({name:e,detail:"procedure (local)",type:"function"}));for(const e of a.functions)t.has(e)||(t.add(e),s.push({name:e,detail:"function (local)",type:"function"}));for(const e of a.widgetVars)t.has(e)||(t.add(e),s.push({name:e,detail:"variable (local)",type:"variable"}));for(const e of a.builtIns)t.has(e)||(t.add(e),s.push({name:e,detail:"variable (built-in)",type:"keyword"}));const i=e?e():[],l=i.length>0?i:fr;for(const e of l)t.has(e)||(t.add(e),s.push({name:e,detail:"macro",type:"function"}));const o=n?n():[];for(const e of o)t.has(e)||(t.add(e),s.push({name:e,detail:"function",type:"function"}));const c=r?r():[];for(const e of c)t.has(e)||(t.add(e),s.push({name:e,detail:"variable",type:"variable"}));const d=k.toLowerCase();w=s.filter(({name:e})=>e.toLowerCase().startsWith(d)).map(({name:e,detail:t,type:n})=>({label:e,type:n,detail:t,boost:2,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}else if("tiddler"===m||"$tiddler"===m){const e=t?t():[];if(0===e.length)return null;w=e.map(e=>({label:e,type:"variable",detail:"tiddler",boost:cr(e),apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}else if("to"===m||"$to"===m){const e=t?t():[];if(0===e.length)return null;w=e.map(e=>({label:e,type:"variable",detail:"tiddler",boost:cr(e),apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}else if("$message"===m||"message"===m){const e=/<\$([a-zA-Z][a-zA-Z0-9\-\.]*)\s+[^>]*$/.exec(p),t=["action-confirm","action-sendmessage"],n=["button","browse","linkcatcher"];let r=!1;if(e){const s=e[1];("$message"===m&&t.includes(s)||"message"===m&&n.includes(s))&&(r=!0)}if(r){const e=k.toLowerCase();w=br.filter(t=>t.toLowerCase().startsWith(e)).map(e=>({label:e,type:"keyword",detail:"message",boost:2,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}}else if("$field"===m||"field"===m){const e=s?s():lr,t=k.toLowerCase();w=e.filter(e=>e.toLowerCase().startsWith(t)).map(e=>({label:e,type:"property",detail:"field",boost:2,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}else if("$index"===m||"index"===m){if(a){const e=p.lastIndexOf("<"),t=e>=0?p.slice(e):p,n=/(?:\$tiddler|tiddler)\s*=\s*(["'])([^"']*)\1/.exec(t);if(n){const e=n[2],t=a(e);if(t.length>0){const e=k.toLowerCase();w=t.filter(t=>t.toLowerCase().startsWith(e)).map(e=>({label:e,type:"property",detail:"index",boost:2,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}}}}else if("storyview"===m){const e=l?l():gr,t=k.toLowerCase();w=e.filter(e=>e.toLowerCase().startsWith(t)).map(e=>({label:e,type:"keyword",detail:"storyview",boost:2,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}else if("deserializer"===m){const e=o?o():kr,t=k.toLowerCase();w=e.filter(e=>e.toLowerCase().startsWith(t)).map(e=>({label:e,type:"keyword",detail:"deserializer",boost:2,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}else if("$name"===m){const t=new Set,n=[],r=ur(u.doc.toString());for(const e of r.macros)t.has(e)||(t.add(e),n.push({name:e,detail:"macro (local)"}));for(const e of r.procedures)t.has(e)||(t.add(e),n.push({name:e,detail:"procedure (local)"}));for(const e of r.functions)t.has(e)||(t.add(e),n.push({name:e,detail:"function (local)"}));for(const e of r.widgets)t.has(e)||(t.add(e),n.push({name:e,detail:"widget (local)"}));const s=e?e():fr;for(const e of s)t.has(e)||(t.add(e),n.push({name:e,detail:"macro"}));const a=k.toLowerCase();w=n.filter(({name:e})=>e.toLowerCase().startsWith(a)).map(({name:e,detail:t})=>({label:e,type:"function",detail:t,boost:2,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+1),i=e+(a===g?"":g),l=or(t,r,s,i,x);t.dispatch({changes:l,selection:{anchor:r+i.length}})}}))}return 0===w.length?null:{from:b,to:f,options:w,validFor:/^[\w\-$:\/. ]*$/}}}const yr=["$action-confirm","$action-createtiddler","$action-deletefield","$action-deletetiddler","$action-listops","$action-log","$action-navigate","$action-popup","$action-sendmessage","$action-setfield","$action-setmultiplefields","$browse","$button","$checkbox","$codeblock","$count","$draggable","$droppable","$dropzone","$edit","$edit-bitmap","$edit-text","$element","$encrypt","$eventcatcher","$fieldmangler","$fill","$genesis","$image","$importvariables","$keyboard","$let","$link","$linkcatcher","$list","$log","$macrocall","$messagecatcher","$navigator","$password","$qualify","$radio","$range","$raw","$reveal","$scrollable","$select","$set","$setvariable","$slot","$text","$tiddler","$transclude","$type","$vars","$view","$wikify"],$r={"$action-confirm":["$message","$prompt"],"$action-createtiddler":["$basetitle","$savetitle","$saveoriginal","$template","$overwrite","$timestamp"],"$action-deletefield":["$tiddler","$field"],"$action-deletetiddler":["$tiddler","$filter"],"$action-listops":["$tiddler","$field","$index","$filter","$subfilter","$tags"],"$action-log":["$$filter","$$message","$$all"],"$action-navigate":["$to","$scroll"],"$action-popup":["$state","$coords","$floating","$absolute"],"$action-sendmessage":["$message","$param","$name","$value"],"$action-setfield":["$tiddler","$field","$index","$value","$timestamp"],"$action-setmultiplefields":["$tiddler","$fields","$values","$indexes"],$browse:["multiple","accept","message","param","tooltip","deserializer","class"],$button:["message","param","set","setTo","actions","to","tooltip","aria-label","popup","popupAbsolute","hoverpopup","selectedClass","default","disabled","tag","dragTiddler","dragFilter","class","style"],$checkbox:["tiddler","field","index","tag","invertTag","checked","unchecked","default","indeterminate","disabled","actions","uncheckactions","checkactions","class"],$codeblock:["code","language","class"],$count:["filter"],$draggable:["tiddler","filter","tag","enable","startactions","endactions","class"],$droppable:["actions","effect","tag","enable","disabledClass","class"],$dropzone:["deserializer","enable","autoOpenOnImport","importTitle","actions","contentTypesFilter","filesOnly","class"],$edit:["tiddler","field","index","default","placeholder","tabindex","focus","cancelPopups","inputActions","refreshTitle","autocomplete","class"],"$edit-bitmap":["tiddler","class"],"$edit-text":["tiddler","field","index","default","tag","type","placeholder","focusPopup","focus","tabindex","autocomplete","cancelPopups","inputActions","refreshTitle","disabled","fileDrop","rows","minHeight","size","class"],$element:["tag","attributes"],$encrypt:["filter"],$eventcatcher:["selector","matchSelector","stopPropagation","tag","class","events"],$fieldmangler:["tiddler"],$fill:["$name"],$genesis:["$type","$tag","$names","$values","$mode"],$image:["source","width","height","tooltip","alt","loading","usemap","class"],$importvariables:["filter"],$keyboard:["key","actions","tag","class"],$let:[],$link:["to","tooltip","aria-label","tabindex","draggable","tag","overrideClass","class"],$linkcatcher:["to","message","set","setTo","actions"],$list:["filter","variable","counter","emptyMessage","storyview","history","template","editTemplate","join"],$log:["$$filter","$$message","$$all"],$macrocall:["$name","$type","$output"],$messagecatcher:["type","actions"],$navigator:["story","history","openLinkFromInsideRiver","openLinkFromOutsideRiver","relinkOnRename"],$password:["name","class"],$qualify:["name"],$radio:["tiddler","field","index","value","default","disabled","actions","class"],$range:["tiddler","field","index","min","max","increment","default","disabled","actions","actionsStart","actionsStop","class"],$raw:[],$reveal:["type","text","state","tag","retain","default","popup","popupAbsolute","animate","stateTitle","stateIndex","stateField","class","style"],$scrollable:["tag","fallthrough","class"],$select:["tiddler","field","index","default","multiple","size","actions","class"],$set:["name","value","filter","select","tiddler","field","index","emptyValue"],$setvariable:["name","value","filter","select","tiddler","field","index","emptyValue"],$slot:["$name","$depth"],$text:["text"],$tiddler:["tiddler"],$transclude:["$tiddler","$field","$index","$subtiddler","$mode","$type","$output","$recursionMarker","$variable","$fillignore"],$type:["type","text","tiddler","field","index","mode"],$vars:[],$view:["tiddler","field","index","format","template","subtiddler","mode"],$wikify:["name","text","type","mode","output"]};function wr(e,t){return n=>{const{state:r,pos:s}=n,a=/<\$[\w\-\.]*$/.exec(r.sliceDoc(s-50,s));if(!a)return null;let l=i.syntaxTree(r).resolveInner(s,-1);for(;l&&!l.type.isTop;){if("FencedCode"===l.name||"CodeBlock"===l.name||"TypedBlock"===l.name||"CommentBlock"===l.name||"KaTeXBlock"===l.name||"LaTeXContent"===l.name)return null;l=l.parent}const o=new Set(ar);if(t)for(const e of t())o.add(e);const c=new Set,d=[],u=ur(r.doc.toString());for(const e of u.widgets)c.has(e)||(c.add(e),d.push({name:e,detail:"widget (local)"}));const f=e?e():[],p=f.length>0?f:yr;for(const e of p)if(!c.has(e)){c.add(e);const t=o.has(e);d.push({name:e,detail:t?"action":"widget"})}const h=a[0].length,m=d.map(({name:e,detail:t})=>{const n=o.has(e);return{label:"<"+e,type:"keyword",detail:t,apply:(t,r,s,a)=>{const i="<"+e,l=t.state.sliceDoc(a,a+1);let o,c;if(n)o=i+"/>",c=i.length;else{o=i+">"+("</"+e+">"),c=i.length+1}const d=or(t,s,">"===l?a+1:a,o,h);t.dispatch({changes:d,selection:{anchor:s+c}})}}});return{from:s-a[0].length,to:s,options:m,validFor:/^<\$[\w\-\.]*$/}}}function Tr(e,t,n){return r=>{const{state:s,pos:a}=r,l=s.sliceDoc(Math.max(0,a-200),a),o=/<\$([a-zA-Z][a-zA-Z0-9\-\.]*)\s+[^>]*$/.exec(l);if(!o)return null;const c="$"+o[1],d=l.slice(l.lastIndexOf("<"));let u=!1,f="";for(const e of d)u||'"'!==e&&"'"!==e?u&&e===f&&(u=!1):(u=!0,f=e);if(u)return null;const p=/\s([$a-zA-Z][a-zA-Z0-9\-\.]*)?$/.exec(l);if(!p)return null;const h=p[1]||"",m=a-h.length;let g=i.syntaxTree(s).resolveInner(a,-1);for(;g&&!g.type.isTop;){if("FencedCode"===g.name||"CodeBlock"===g.name||"TypedBlock"===g.name||"CommentBlock"===g.name||"KaTeXBlock"===g.name||"LaTeXContent"===g.name)return null;g=g.parent}if(h.startsWith("style.")&&n){const e=t?t(c):null;if(!(null!==e?e:$r[c]||[]).includes("style"))return null;const r=n();if(!r||0===r.length)return null;const s=h.slice(6).toLowerCase(),i=r.filter(e=>e.toLowerCase().startsWith(s));if(0===i.length)return null;const l=i.map(e=>({label:"style."+e,type:"property",detail:"CSS property",apply:(t,n,r,s)=>{const a="style."+e+'=""',i=r+6+e.length+2,l=or(t,r,s,a,h.length);t.dispatch({changes:l,selection:{anchor:i},effects:nr.of(null)})}}));return{from:m,to:a,options:l,validFor:/^style\.[a-zA-Z\-]*$/}}const k=ur(s.doc.toString()).definitionParams[c];let b;if(k&&k.length>0)b=[...k];else{const e=t?t(c):null,n=$r[c]||[];b=null!==e?[...e]:[...n]}if("$macrocall"===c||"$transclude"===c){const t=new RegExp(("$macrocall"===c?"\\$name":"\\$variable")+"\\s*=\\s*(?:\"([^\"]+)\"|'([^']+)'|<<([^>]+)>>)").exec(d);if(t){const n=t[1]||t[2]||t[3];if(n){const t=ur(s.doc.toString());let r=null;if(t.definitionParams[n]?r=t.definitionParams[n]:e&&(r=e(n)),r&&r.length>0){const e=new Set(b);for(const t of r)e.has(t)||b.push(t)}}}}if("$messagecatcher"===c){const e=new Set(b);for(const t of br){const n="$"+t;e.has(n)||b.push(n)}}if("$eventcatcher"===c){const e=["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","contextmenu","keydown","keyup","keypress","focus","blur","focusin","focusout","input","change","submit","reset","invalid","dragstart","drag","dragend","dragenter","dragleave","dragover","drop","touchstart","touchmove","touchend","touchcancel","pointerdown","pointerup","pointermove","pointerenter","pointerleave","pointerover","pointerout","pointercancel","wheel","scroll","copy","cut","paste","load","error","resize","select"],t=new Set(b);for(const n of e){const e="$"+n;t.has(e)||b.push(e)}}const x=h.length,y=b.map(e=>({label:e,type:"property",detail:e.startsWith("$")?"widget attr":"parameter",apply:(t,n,r,s)=>{const a='"'===t.state.sliceDoc(s,s+1),i=a?e+'="':e+'=""',l=a?s+1:s,o=r+e.length+2,c=or(t,r,l,i,x);t.dispatch({changes:c,selection:{anchor:o},effects:nr.of(null)})}}));return{from:m,to:a,options:y,validFor:/^[$a-zA-Z][a-zA-Z0-9\-\.]*$/}}}const Mr=["all","title","field","tag","has","is","indexes","fields","tags","links","backlinks","list","listed","tagging","untagged","prefix","suffix","contains","match","regexp","search","trim","lowercase","uppercase","titlecase","sentencecase","splitbefore","split","join","stringify","compare","minlength","maxlength","first","last","nth","limit","rest","butlast","range","sort","nsort","sortby","nsortby","reverse","count","unique","duplicates","allafter","allbefore","after","before","prepend","append","insertbefore","move","putafter","putbefore","putfirst","putlast","remove","replace","toggle","cycle","add","subtract","multiply","divide","negate","abs","ceil","floor","round","trunc","sign","min","max","average","sum","product","log","power","sqrt","exp","fixed","precision","remainder","random","sin","cos","tan","asin","acos","atan","atan2","now","format","days","weeks","months","years","hours","minutes","seconds","milliseconds","adddays","subtractdays","year","month","day","hour","minute","second","get","getindex","getvariable","lookup","jsonget","jsonindexes","jsontype","jsonextract","jsonstringify","encodehtml","decodehtml","encodeuri","encodeuricomponent","decodeuri","decodeuricomponent","escaperegexp","escapecss","base64encode","base64decode","each","eachday","filter","reduce","map","subfilter","else","then","variables","modules","plugintiddlers","shadowsource","storyviews","editions","lengths","commands","sha256hash","md5hash","encryptbase64","decryptbase64","draft.of","draft.for","draft","draftof","draftfor"],Sr=[{label:"+",detail:"intersection - filter the input (same as :and)"},{label:"-",detail:"subtraction - remove from results (same as :except)"},{label:"~",detail:"else - use if previous was empty (same as :else)"},{label:"=",detail:"literal - add title literally (same as :all)"},{label:":and",detail:"intersection - same as +"},{label:":except",detail:"subtraction - same as -"},{label:":else",detail:"else - same as ~"},{label:":all",detail:"literal - same as ="},{label:":filter",detail:"filter each title through subfilter"},{label:":map",detail:"transform each title via subfilter"},{label:":reduce",detail:"reduce to single value"},{label:":intersection",detail:"keep titles common to all runs"},{label:":cascade",detail:"cascade through filters"},{label:":some",detail:"pass to any matching run"},{label:":sort",detail:"sort by subfilter result"},{label:":flat",detail:"flatten list output"}],Cr={all:{operands:["current","missing","orphans","shadows","tags","tiddlers"],allowPlus:!0},is:{operands:["binary","blank","current","draft","image","missing","orphan","shadow","system","tag","tiddler","variable"]},has:{dynamicOperands:"fields",suffixes:["field","index","tag"]},get:{dynamicOperands:"fields"},getindex:{dynamicOperands:"fields"},field:{dynamicOperands:"fields"},fields:{operands:[]},type:{dynamicOperands:"types"},indexes:{operands:[]},tag:{dynamicOperands:"tags"},tagging:{operands:[]},tags:{operands:[]},untagged:{operands:[]},function:{dynamicOperands:"functions"},subfilter:{dynamicOperands:"functions"},contains:{flags:["casesensitive"],suffixes:["field","index"]},match:{flags:["casesensitive"]},regexp:{flags:["casesensitive"]},search:{flags:["casesensitive","anchored","literal","whitespace","regexp","words","some","all"],suffixes:["field"]},prefix:{flags:["casesensitive"]},suffix:{flags:["casesensitive"]},sort:{dynamicOperands:"fields",flags:["reverse","casesensitive"],suffixes:["alphanumeric","number","string","date","naturaldate"]},nsort:{dynamicOperands:"fields",flags:["reverse"]},sortan:{dynamicOperands:"fields",flags:["reverse"]},sortcs:{dynamicOperands:"fields",flags:["reverse"]},sortby:{dynamicOperands:"fields",flags:["reverse"]},nsortby:{dynamicOperands:"fields",flags:["reverse"]},compare:{suffixes:["number","string","integer","date","version"],flags:["casesensitive"]},limit:{operands:[]},first:{operands:[]},last:{operands:[]},nth:{operands:[]},range:{operands:[]},format:{operands:["date","relativedate","json","timestamp","titlelist"]},jsonget:{operands:[]},jsontype:{operands:[]},jsonindexes:{operands:[]},jsonextract:{operands:[]},lookup:{dynamicOperands:"fields"},getvariable:{dynamicOperands:"variables"},list:{dynamicOperands:"tiddlers"},listed:{dynamicOperands:"fields"},enlist:{operands:[]},split:{operands:[]},"draft.of":{operands:[]},"draft.for":{operands:[]},each:{dynamicOperands:"fields"},eachday:{dynamicOperands:"fields"},backlinks:{operands:[]},backtranscludes:{operands:[]},commands:{operands:[]},count:{operands:[]},deserializers:{operands:[]},duplicateslugs:{operands:[]},editions:{operands:[]},haschanged:{operands:[]},links:{operands:[]},moduletypes:{operands:[]},plugintiddlers:{operands:[]},shadowsource:{operands:[]},slugify:{operands:[]},storyviews:{operands:[]},title:{operands:[]},transcludes:{operands:[]},variables:{operands:[]}};function Pr(e,t){return n=>{const{state:r,pos:s}=n,a=r.sliceDoc(Math.max(0,s-100),s);if(/[\[\]}>][\w\-:!]*\[[^\]]*$/.test(a)||/[\[\]}>][\w\-:!]*\{[^}]*$/.test(a)||/[\[\]}>][\w\-:!]*<[^>]*$/.test(a))return null;const l=/\[(!?)(\w*)$/.exec(a);if(!l){const r=/\][:\w]*(\w+)$/.exec(a);if(!r)return null;const s=r[1];return Lr(n,s,s.length,e,t)}const o=i.syntaxTree(r).resolveInner(s,-1);let c=o,d=!1;for(;c&&!c.type.isTop;){if("FencedCode"===c.name||"CodeBlock"===c.name||"TypedBlock"===c.name||"CommentBlock"===c.name||"KaTeXBlock"===c.name||"LaTeXContent"===c.name)return null;"FilterExpression"!==c.name&&"FilteredTransclusion"!==c.name&&"FilteredTransclusionBlock"!==c.name&&"AttributeFiltered"!==c.name&&"ConditionalBlock"!==c.name&&"FilterRun"!==c.name&&"FilterOperator"!==c.name&&"FilterOperatorName"!==c.name||(d=!0),c=c.parent}if(!(d||/\{\{\{[^}]*$/.test(a)||/<%(?:if|elseif)\s+[^%]*$/.test(a)||/filter\s*=\s*["'][^"']*$/.test(a))){let e=!1,t=o;for(;t&&!t.type.isTop;){if("Widget"===t.name||"WidgetBlock"===t.name||"MacroCall"===t.name||"MacroCallBlock"===t.name||"HTMLTag"===t.name||"HTMLBlock"===t.name||"Attribute"===t.name||"AttributeName"===t.name||"AttributeValue"===t.name||"AttributeString"===t.name||"PragmaImport"===t.name||"PragmaDefine"===t.name||"PragmaProcedure"===t.name||"PragmaFunction"===t.name||"PragmaWidget"===t.name||"PragmaParameters"===t.name||"WikiLink"===t.name||"ImageLink"===t.name||"Transclusion"===t.name||"TransclusionBlock"===t.name){e=!0;break}t=t.parent}if(e)return null}const u=l[1],f=l[2];return Lr(n,f,f.length+u.length+1,e,t)}}function Lr(e,t,n,r,s){const{pos:a}=e,i=r?r():[],l=(i.length>0?i:Mr).map(e=>{const t=Cr[e],n=t&&Array.isArray(t.operands)&&0===t.operands.length;return{label:e,type:"function",detail:"filter operator",apply:(t,r,a,i)=>{const l=s?s():"always";if("none"===l)return void t.dispatch({changes:{from:a,to:i,insert:e},selection:{anchor:a+e.length}});const o=t.state.sliceDoc(i,i+2),c=o.startsWith("]"),d="]]"===o;"smart"!==l?n?d?t.dispatch({changes:{from:a,to:i,insert:e+"["},selection:{anchor:a+e.length+1}}):t.dispatch({changes:{from:a,to:i,insert:e+"[]"},selection:{anchor:a+e.length+1}}):t.dispatch({changes:{from:a,to:i,insert:e+"["},selection:{anchor:a+e.length+1}}):n?t.dispatch({changes:{from:a,to:i,insert:e+"[]"},selection:{anchor:a+e.length+1}}):c?t.dispatch({changes:{from:a,to:i,insert:e+"["},selection:{anchor:a+e.length+1}}):t.dispatch({changes:{from:a,to:i,insert:e+"[]"},selection:{anchor:a+e.length+1}})}}});return{from:a-t.length,to:a,options:l,validFor:/^\w*$/}}function vr(e){const{state:t,pos:n}=e,r=t.sliceDoc(Math.max(0,n-100),n),s=/(?:\{\{\{|[\]\s])\s*([:+\-~=][\w]*)$/.exec(r);if(!s)return null;let a=i.syntaxTree(t).resolveInner(n,-1),l=!1;for(;a&&!a.type.isTop;){if("FencedCode"===a.name||"CodeBlock"===a.name||"TypedBlock"===a.name||"CommentBlock"===a.name||"KaTeXBlock"===a.name||"LaTeXContent"===a.name)return null;"FilterExpression"!==a.name&&"FilteredTransclusion"!==a.name&&"FilteredTransclusionBlock"!==a.name&&"AttributeFiltered"!==a.name&&"ConditionalBlock"!==a.name||(l=!0),a=a.parent}if(!(l||/\{\{\{[^}]*$/.test(r)||/<%(?:if|elseif)\s+[^%]*$/.test(r)||/filter\s*=\s*["'][^"']*$/.test(r)))return null;const o=s[1],c=Sr.map(e=>({label:e.label,type:"keyword",detail:e.detail,apply:e.label.startsWith(":")?(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+10),i=/^\s*\]/.test(a)?e.label+"[":e.label+"[]",l=r+e.label.length+1;t.dispatch({changes:{from:r,to:s,insert:i},selection:{anchor:l}})}:e.label}));return{from:n-o.length,to:n,options:c,validFor:/^[:+\-~=][\w]*$/}}function Ar(e){return t=>{const{state:n,pos:r}=t,s=n.sliceDoc(Math.max(0,r-100),r),a=/\[(!?)([\w.]+)((?::[\w]*)*)$/.exec(s);if(!a)return null;const i=a[2],l=a[3];if(!l||!l.includes(":"))return null;const o=/:(\w*)$/.exec(l);if(!o)return null;const c=o[1],d=Cr[i];if(!d)return null;if(!d.flags&&!d.suffixes)return null;const u=l.split(":").filter(e=>e&&e!==c),f=[];if(d.flags)for(const e of d.flags)u.includes(e)||f.push({label:e,type:"keyword",detail:"flag"});if(d.suffixes)for(const e of d.suffixes)u.includes(e)||("field"===e?f.push({label:e,type:"property",detail:"use field suffix"}):f.push({label:e,type:"property",detail:"type"}));if(u.includes("field")||d.suffixes?.includes("field")&&!u.some(e=>d.suffixes?.includes(e)&&"field"!==e)){const t=e?e():lr;for(const e of t)u.includes(e)||f.push({label:e,type:"variable",detail:"field name"})}if(0===f.length)return null;const p=c.length>0?f.filter(e=>e.label.toLowerCase().startsWith(c.toLowerCase())):f;return 0===p.length?null:{from:r-c.length,to:r,options:p,validFor:/^\w*$/}}}function Er(e,t,n,r,s,a){return i=>{const{state:l,pos:o}=i,c=l.sliceDoc(Math.max(0,o-100),o),d=/[\[\]}>](!?)([\w.]+)((?::[\w]+)*)\[([^\]]*)$/.exec(c);if(!d)return null;const u=d[2],f=d[4],p=Cr[u];if(!p)return null;if(p.operands&&0===p.operands.length&&!p.dynamicOperands)return null;let h,m;if(p.allowPlus&&f.includes("+")){const e=f.split("+");h=e[e.length-1],m=e.slice(0,-1)}else h=f,m=[];let g=[];if(p.operands&&p.operands.length>0&&(g=p.operands.filter(e=>!m.includes(e)).map(e=>({label:e,type:"constant",detail:`${u}[] value`}))),p.dynamicOperands){const i=ur(l.doc.toString());let o=[],c=[],d="";switch(p.dynamicOperands){case"fields":o=n?n():lr,d="field";break;case"tags":o=t?t():[],d="tag";break;case"tiddlers":o=e?e():[],d="tiddler";break;case"functions":o=r?r():[],c=i.functions,d="function";break;case"variables":o=s?s():[],c=i.variables,d="variable";break;case"types":o=a?a():[],d="type"}const u=new Set(m),f="tags"===p.dynamicOperands||"tiddlers"===p.dynamicOperands;if(g.push(...o.filter(e=>!u.has(e)&&(u.add(e),!0)).map(e=>({label:e,type:"fields"===p.dynamicOperands?"variable":"functions"===p.dynamicOperands?"function":"text",detail:d,...f?{boost:cr(e)}:{}}))),c.length>0)if("variables"===p.dynamicOperands){g.push(...i.builtIns.filter(e=>!u.has(e)&&(u.add(e),!0)).map(e=>({label:e,type:"keyword",detail:`${d} (built-in)`})));const e=[...i.functions,...i.procedures,...i.macros,...i.widgets,...i.widgetVars];g.push(...e.filter(e=>!u.has(e)&&(u.add(e),!0)).map(e=>({label:e,type:"function",detail:`${d} (local)`})))}else g.push(...c.filter(e=>!u.has(e)&&(u.add(e),!0)).map(e=>({label:e,type:"function",detail:`${d} (local)`})))}if(0===g.length)return null;const k=h.length>0?g.filter(e=>e.label.toLowerCase().startsWith(h.toLowerCase())):g;return 0===k.length?null:{from:o-h.length,to:o,options:k,validFor:/^[^\]]*$/}}}function Br(e,t){return n=>{const{state:r,pos:s}=n,a=r.sliceDoc(Math.max(0,s-100),s),l=/\[\[[^\]|]*$/.exec(a),o=/\[\[.*?\|[^\]]*$/.exec(a);let c=/(?<!\{)\{\{[^{}|]*$/.exec(a);c&&(c[0].includes("!!")||c[0].includes("##"))&&(c=null);const d=/\[img(?:\s+[^\[]*)?\[[^\]|]*$/.exec(a),u=/\[ext\[[^\]|]*$/.exec(a),f=/[\[\]}>][\w\-:!]*\[[^\]]*$/.exec(a);let p=/[\[\]}>][\w\-:!]*\{[^}]*$/.exec(a);p&&(p[0].includes("!!")||p[0].includes("##"))&&(p=null);const h=/\{\{\{[^}]*$/.test(a)||/\bfilter\s*=\s*(?:"[^"]*|'[^']*|"""[^"]*)$/.test(a)||/<\$\w+[^>]*\bfilter\s*=\s*(?:"[^"]*|'[^']*|"""[^"]*)$/.test(a);let m;if(d)m=d;else{if(u)return null;m=h&&l&&f?f:l||o||c||f||p}if(!m)return null;let g=i.syntaxTree(r).resolveInner(s,-1),k=!1,b=!1;for(;g&&!g.type.isTop;){if("FencedCode"===g.name||"CodeBlock"===g.name||"TypedBlock"===g.name||"CommentBlock"===g.name||"KaTeXBlock"===g.name||"LaTeXContent"===g.name)return null;"ImageLink"!==g.name&&"ImageSource"!==g.name||(k=!0),"ExternalLink"!==g.name&&"URLLink"!==g.name||(b=!0),g=g.parent}if(b)return null;k&&d&&(m=d);let x,y,$,w,T=e?e():[];if(0===T.length)return null;if(m===p){x=m[0].slice(0,m[0].lastIndexOf("{")+1),$=/^[\[\]}>][\w\-:!]*\{[^}]*$/,w="text reference";const e=m[0].length,t=T.map(t=>({label:x+t,type:"variable",detail:w,boost:cr(t),apply:(n,r,s,a)=>{const i=n.state.sliceDoc(a,a+2),l="}"===i[0],o=!("]"===i[1]||"]"===i[0]||l&&"]"===i[1]),c=x+t+(l?"":"}")+(o?"]":""),d=s+x.length+t.length+1,u=or(n,s,a,c,e);n.dispatch({changes:u,selection:{anchor:d}})}}));return{from:s-m[0].length,to:s,options:t,validFor:$}}if(m===d){const e=m[0].lastIndexOf("[");if(x=m[0].slice(0,e+1),y="]]",$=/^\[img(?:\s+[^\[]*)?\[[^\]|]*$/,w="image",t){const e=t();e.length>0&&(T=e)}}else{if(m===f){const e=/[\[\]}>](!?)([\w.]+)(?::[\w]+)*\[[^\]]*$/.exec(m[0]);if(e){const t=e[2];if(Cr[t])return null}x=m[0].slice(0,m[0].lastIndexOf("[")+1),$=/^[\[\]}>][\w\-:!]*\[[^\]]*$/,w="filter operand";const t=m[0].length,n=T.map(e=>({label:x+e,type:"variable",detail:w,boost:cr(e),apply:(n,r,s,a)=>{const i=n.state.sliceDoc(a,a+2),l="]"===i[0],o="]"===i[1];let c="]]";l&&o?c="":l&&(c="]");const d=x+e+c,u=s+x.length+e.length+1,f=or(n,s,a,d,t);n.dispatch({changes:f,selection:{anchor:u}})}}));return{from:s-m[0].length,to:s,options:n,validFor:$}}if(m===l)x="[[",y="]]",$=/^\[\[[^\]|]*$/,w="tiddler";else if(m===o){const e=m[0].lastIndexOf("|");x=m[0].slice(0,e+1),y="]]",$=/^\[\[.*?\|[^\]]*$/,w="tiddler"}else{if(m!==c)return null;x="{{",y="}}",$=/^(?<!\{)\{\{[^{}|]*$/,w="tiddler"}}const M=m[0].length,S=T.map(e=>({label:x+e,type:"variable",detail:w,boost:cr(e),apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+y.length);let i=y,l=0;a===y?(i="",l=y.length):"]]"===y&&a.startsWith("]")?(i="]",l=1):"}}"===y&&a.startsWith("}")&&(i="}",l=1);const o=x+e+i,c=r+o.length+l,d=or(t,r,s,o,M);t.dispatch({changes:d,selection:{anchor:c}})}}));return{from:s-m[0].length,to:s,options:S,validFor:$}}}function Ir(e){return t=>{const{state:n,pos:r}=t,s=n.sliceDoc(Math.max(0,r-200),r),a=/\$:\/[\w\-\/\.]*$/.exec(s);if(!a)return null;const l=s.slice(0,s.length-a[0].length);if(/\[\[[^\]]*$/.test(l))return null;if(/\{\{[^}]*$/.test(l))return null;if(/\[img[^\]]*\[[^\]]*$/.test(l))return null;let o=i.syntaxTree(n).resolveInner(r,-1);for(;o&&!o.type.isTop;){if("FencedCode"===o.name||"CodeBlock"===o.name||"TypedBlock"===o.name||"CommentBlock"===o.name||"KaTeXBlock"===o.name||"LaTeXContent"===o.name)return null;o=o.parent}const c=(e?e():[]).filter(e=>e.startsWith("$:/"));if(0===c.length)return null;return{from:r-a[0].length,to:r,options:c.map(e=>({label:e,type:"variable",detail:"system tiddler",boost:cr(e)})),validFor:/^\$:\/[\w\-\/\.]*$/}}}function Nr(e,t){return n=>{const{state:r,pos:s}=n,a=r.sliceDoc(Math.max(0,s-200),s),l=/(?<!\{)\{\{([^{}|]*?)!![^{}|!]*$/.exec(a),o=/(?<!\{)\{\{([^{}|]*?)##[^{}|#]*$/.exec(a);let c=null,d=null;(/\[[^\]]*\{[^{}]*$/.test(a)||/\{\{\{[^}]*\{[^{}]*$/.test(a)||/\bfilter\s*=\s*(?:"[^"]*|'[^']*|"""[^"]*)\{[^{}]*$/.test(a))&&(c=/(?<!\{)\{(?!\{)([^{}]*?)!![^{}!]*$/.exec(a),d=/(?<!\{)\{(?!\{)([^{}]*?)##[^{}#]*$/.exec(a));const u=!(!l&&!o),f=!(!l&&!c),p=l||o||c||d;if(!p)return null;let h=i.syntaxTree(r).resolveInner(s,-1);for(;h&&!h.type.isTop;){if("FencedCode"===h.name||"CodeBlock"===h.name||"TypedBlock"===h.name||"CommentBlock"===h.name||"KaTeXBlock"===h.name||"LaTeXContent"===h.name)return null;h=h.parent}const m=f?"!!":"##",g=p[1]||"",k=p[0].lastIndexOf(m),b=p[0].slice(0,k+2),x=p[0].slice(k+2);let y,$;f?(y=e&&g?e(g):[],$="field"):(y=t&&g?t(g):[],$="index");const w=y.filter(e=>e.toLowerCase().startsWith(x.toLowerCase()));if(0===w.length)return null;const T=p[0].length,M=u?"}}":"}",S=w.map(e=>({label:b+e,type:"property",detail:$,apply:(t,n,r,s)=>{const a=t.state.sliceDoc(s,s+2);let i=M;u?"}}"===a?i="":a.startsWith("}")&&(i="}"):a.startsWith("}")&&(i="");const l=b+e+i,o=r+l.length,c=or(t,r,s,l,T);t.dispatch({changes:c,selection:{anchor:o}})}}));let C;return C=u?f?/^(?<!\{)\{\{[^{}|]*!![^{}|!]*$/:/^(?<!\{)\{\{[^{}|]*##[^{}|#]*$/:f?/^(?<!\{)\{(?!\{)[^{}]*!![^{}!]*$/:/^(?<!\{)\{(?!\{)[^{}]*##[^{}#]*$/,{from:s-p[0].length,to:s,options:S,validFor:C}}}const Fr=["div","span","p","a","img","br","hr","h1","h2","h3","h4","h5","h6","ul","ol","li","dl","dt","dd","table","tr","td","th","thead","tbody","tfoot","caption","colgroup","col","form","input","button","select","option","textarea","label","fieldset","legend","header","footer","nav","main","section","article","aside","figure","figcaption","strong","em","b","i","u","s","code","pre","blockquote","q","cite","kbd","samp","var","mark","small","sub","sup","abbr","time","dfn","ins","del","iframe","video","audio","source","canvas","svg","picture","script","style","link","meta","noscript","template","details","summary","dialog","menu"],Wr=["class","id","style","title","lang","dir","hidden","tabindex","accesskey","contenteditable","draggable","spellcheck","translate","data-","aria-","role"],Or={a:["href","target","rel","download","hreflang","type"],img:["src","alt","width","height","loading","srcset","sizes"],input:["type","name","value","placeholder","required","disabled","readonly","checked","maxlength","minlength","pattern","min","max","step"],button:["type","disabled","name","value","form"],form:["action","method","enctype","target","autocomplete","novalidate"],label:["for"],select:["name","multiple","required","disabled","size"],option:["value","selected","disabled"],textarea:["name","rows","cols","placeholder","required","disabled","readonly","maxlength","minlength"],link:["href","rel","type","media"],script:["src","type","async","defer","crossorigin"],meta:["name","content","charset","http-equiv"],iframe:["src","width","height","frameborder","allowfullscreen","sandbox"],video:["src","width","height","controls","autoplay","loop","muted","poster","preload"],audio:["src","controls","autoplay","loop","muted","preload"],source:["src","type","media","srcset","sizes"],table:["border","cellpadding","cellspacing"],td:["colspan","rowspan","headers"],th:["colspan","rowspan","headers","scope"],div:[],span:[],p:[]};function Dr(e){const{state:t,pos:n}=e,r=/<[:\-\.\w\u00b7-\uffff!]*$/.exec(t.sliceDoc(n-25,n));if(!r)return null;if(r[0].startsWith("<$"))return null;let s=i.syntaxTree(t).resolveInner(n,-1);for(;s&&!s.type.isTop;){if("FencedCode"===s.name||"CodeBlock"===s.name||"TypedBlock"===s.name||"CommentBlock"===s.name||"KaTeXBlock"===s.name||"LaTeXContent"===s.name)return null;if("AttributeValue"===s.name||"AttributeString"===s.name)return null;s=s.parent}const a=r[0].length,l=[];("<!"===r[0]||"<"===r[0])&&l.push({label:"\x3c!--",displayLabel:"\x3c!-- comment --\x3e",type:"keyword",detail:"comment",boost:"<!"===r[0]?10:0,apply:(e,t,n,r)=>{const s=n+5,i=n+12,l=or(e,n,r,"\x3c!-- comment --\x3e",a);e.dispatch({changes:l,selection:{anchor:s,head:i}})}});for(const e of Fr){const t=sr.has(e);l.push({label:"<"+e,type:"type",detail:t?"self-closing":"tag",apply:(n,r,s,i)=>{const l="<"+e,o=">"===n.state.sliceDoc(i,i+1)?i+1:i;let c,d;if(t)c=l+">",d=c.length;else{c=l+">"+("</"+e+">"),d=l.length+1}const u=or(n,s,o,c,a);n.dispatch({changes:u,selection:{anchor:s+d}})}})}return{from:n-r[0].length,to:n,options:l,validFor:/^<[:\-\.\w\u00b7-\uffff!]*$/}}function Hr(e){return t=>{const{state:n,pos:r}=t,s=n.sliceDoc(Math.max(0,r-200),r),a=/<([a-zA-Z][a-zA-Z0-9]*)\s+[^>]*$/.exec(s);if(!a)return null;const l=s.length-a[0].length;if(l>0&&"<"===s[l-1])return null;const o=a[1].toLowerCase();if(o.startsWith("$"))return null;const c=s.slice(s.lastIndexOf("<"));let d=!1,u="";for(const e of c)d||'"'!==e&&"'"!==e?d&&e===u&&(d=!1):(d=!0,u=e);if(d)return null;const f=/\s([a-zA-Z][a-zA-Z0-9\-\.]*)?$/.exec(s);if(!f)return null;const p=f[1]||"",h=r-p.length;let m=i.syntaxTree(n).resolveInner(r,-1);for(;m&&!m.type.isTop;){if("FencedCode"===m.name||"CodeBlock"===m.name||"TypedBlock"===m.name||"CommentBlock"===m.name||"KaTeXBlock"===m.name||"LaTeXContent"===m.name)return null;m=m.parent}if(p.startsWith("style.")&&e){const t=e();if(!t||0===t.length)return null;const n=p.slice(6).toLowerCase(),s=t.filter(e=>e.toLowerCase().startsWith(n));if(0===s.length)return null;const a=s.map(e=>({label:"style."+e,type:"property",detail:"CSS property",apply:(t,n,r,s)=>{const a="style."+e+'=""',i=r+6+e.length+2,l=or(t,r,s,a,p.length);t.dispatch({changes:l,selection:{anchor:i}})}}));return{from:h,to:r,options:a,validFor:/^style\.[a-zA-Z\-]*$/}}const g=[...new Set([...Or[o]||[],...Wr])],k=p.length,b=g.map(e=>({label:e,type:"property",apply:(t,n,r,s)=>{if(e.endsWith("-")){const n=or(t,r,s,e,k);return void t.dispatch({changes:n,selection:{anchor:r+e.length}})}const a='"'===t.state.sliceDoc(s,s+1),i=a?e+'="':e+'=""',l=a?s+1:s,o=r+e.length+2,c=or(t,r,l,i,k);t.dispatch({changes:c,selection:{anchor:o}})}}));return{from:h,to:r,options:b,validFor:/^[a-zA-Z][a-zA-Z0-9\-\.]*$/}}}const zr=[{label:"if",detail:"Conditional if",insert:" if [] %>",outdent:!1},{label:"elseif",detail:"Conditional else-if",insert:" elseif [] %>",outdent:!0},{label:"else",detail:"Conditional else",insert:" else %>",outdent:!0},{label:"endif",detail:"End conditional",insert:" endif %>",outdent:!0}];function _r(e){const t=e.pos,n=e.state.doc,r=n.lineAt(t),s=n.sliceString(r.from,t),a=/<%(\s*)(\w*)$/.exec(s);if(!a)return null;const l=a[1],o=a[2],c=l.length>0,d=t-o.length,u=o.length,f=s.lastIndexOf("<%"),p=zr.map(e=>{const t=c?e.insert.trimStart():e.insert;return{label:e.label,type:"keyword",detail:e.detail,apply:(n,a,l,o)=>{if(e.outdent&&f>0&&1===n.state.selection.ranges.length){const t=i.getIndentUnit(n.state),a=s.slice(0,f);let l=0;for(const e of a)" "===e?l++:"\t"===e&&(l+=t);const c=Math.max(0,l-t),d=" ".repeat(c)+"<%"+e.insert,u="elseif"===e.label?d.indexOf("[")+1:d.length;n.dispatch({changes:{from:r.from,to:o,insert:d},selection:{anchor:r.from+u}})}else{const r="if"===e.label||"elseif"===e.label?t.indexOf("[")+1:t.length,s=or(n,l,o,t,u);n.dispatch({changes:s,selection:{anchor:l+r}})}}}});return{from:d,to:t,options:p,validFor:/^\w*$/}}const Zr=[{label:"define",detail:"Define a macro"},{label:"procedure",detail:"Define a procedure"},{label:"function",detail:"Define a function"},{label:"widget",detail:"Define a widget"},{label:"import",detail:"Import tiddlers"},{label:"rules",detail:"Set parser rules"},{label:"parameters",detail:"Declare parameters"},{label:"whitespace",detail:"Whitespace handling"},{label:"end",detail:"End a definition"}];function Vr(e){const t=e.pos,n=e.state.doc,r=n.lineAt(t),s=n.sliceString(r.from,t),a=/^(\s*)\\(\w*)$/.exec(s);if(!a)return null;return{from:r.from+a[1].length+1,to:t,options:Zr.map(e=>({label:e.label,type:"keyword",detail:e.detail})),validFor:/^\w*$/}}function Rr(e){const t=e.pos,n=e.state.doc,r=n.lineAt(t),s=n.sliceString(r.from,t),a=/^(\s*)\\rules\s+(\w*)$/.exec(s);if(!a)return null;return{from:t-a[2].length,to:t,options:[{label:"only",type:"keyword",detail:"Only enable specified rules"},{label:"except",type:"keyword",detail:"Disable specified rules"}],validFor:/^\w*$/}}function Kr(e){const t=e.pos,n=e.state.doc,r=n.lineAt(t),s=n.sliceString(r.from,t),a=/^(\s*)\\whitespace\s+(\w*)$/.exec(s);if(!a)return null;return{from:t-a[2].length,to:t,options:[{label:"trim",type:"keyword",detail:"Remove leading/trailing whitespace"},{label:"notrim",type:"keyword",detail:"Preserve whitespace"}],validFor:/^\w*$/}}function Xr(e){const t=e.pos,n=e.state.doc,r=n.lineAt(t),s=n.sliceString(r.from,t),a=/^(\s*)\\end\s+(\S*)$/.exec(s);if(!a)return null;const l=r.from+s.length-a[2].length,o=i.syntaxTree(e.state),c=[];if(o.iterate({enter:e=>{const r=e.name;if(("MacroDefinition"===r||"ProcedureDefinition"===r||"FunctionDefinition"===r||"WidgetDefinition"===r)&&e.from<=t&&e.to>=t){let t=null;const s=e.node.cursor();s.firstChild();do{if("PragmaName"===s.name){t=n.sliceString(s.from,s.to);break}}while(s.nextSibling());t&&c.push({name:t,type:r.replace("Definition","")})}}}),0===c.length)return null;const d=c.reverse().map((e,t)=>({label:e.name,type:"variable",detail:`Close ${e.type.toLowerCase()}`,boost:c.length-t}));return{from:l,to:t,options:d,validFor:/^\S*$/}}const jr=[{name:"commentblock",types:"block, pragma"},{name:"fnprocdef",types:"pragma"},{name:"import",types:"pragma"},{name:"macrodef",types:"pragma"},{name:"parameters",types:"pragma"},{name:"parsermode",types:"pragma"},{name:"rules",types:"pragma"},{name:"whitespace",types:"pragma"},{name:"codeblock",types:"block"},{name:"filteredtranscludeblock",types:"block"},{name:"heading",types:"block"},{name:"horizrule",types:"block"},{name:"list",types:"block"},{name:"macrocallblock",types:"block"},{name:"quoteblock",types:"block"},{name:"styleblock",types:"block"},{name:"table",types:"block"},{name:"transcludeblock",types:"block"},{name:"typedblock",types:"block"},{name:"codeinline",types:"inline"},{name:"commentinline",types:"inline"},{name:"dash",types:"inline"},{name:"entity",types:"inline"},{name:"extlink",types:"inline"},{name:"filteredtranscludeinline",types:"inline"},{name:"hardlinebreaks",types:"inline"},{name:"image",types:"inline"},{name:"macrocallinline",types:"inline"},{name:"prettyextlink",types:"inline"},{name:"prettylink",types:"inline"},{name:"styleinline",types:"inline"},{name:"syslink",types:"inline"},{name:"transcludeinline",types:"inline"},{name:"wikilink",types:"inline"},{name:"wikilinkprefix",types:"inline"},{name:"conditional",types:"block, inline"},{name:"html",types:"block, inline"},{name:"bold",types:"inline"},{name:"italic",types:"inline"},{name:"strikethrough",types:"inline"},{name:"subscript",types:"inline"},{name:"superscript",types:"inline"},{name:"underscore",types:"inline"}];function Ur(e){return t=>{const n=t.pos,r=t.state.doc,s=r.lineAt(n),a=r.sliceString(s.from,n),i=/^(\s*)\\rules\s+(only|except)\s+/.exec(a);if(!i)return null;const l=a.slice(i[0].length),o=/(\S*)$/.exec(l);return{from:n-(o?o[1]:"").length,to:n,options:(e?e():jr).map(e=>({label:e.name,type:"constant",detail:e.types})),validFor:/^\S*$/}}}function qr(e,t,n,r,s){return a=>{if(!a.explicit)return null;const l=a.pos,o=a.state.doc,c=o.lineAt(l),d=o.sliceString(c.from,l);if(function(e){return[/<[a-zA-Z$][^>]*$/,/<<[^>]*$/,/\[\[[^\]]*$/,/\{\{[^}]*$/,/\[img\[[^\]]*$/,/\[[^\[\]]*$/,/^\s*\\[\w]*$/,/^\s*\\rules\s+(only|except)\s+/,/<%([ \t]*\w*)?$/].some(t=>t.test(e))}(d))return null;let u=i.syntaxTree(a.state).resolveInner(l,-1);for(;u&&!u.type.isTop;){if("FencedCode"===u.name||"CodeBlock"===u.name||"TypedBlock"===u.name||"CommentBlock"===u.name||"KaTeXBlock"===u.name||"LaTeXContent"===u.name)return null;u=u.parent}const f=/(\w*)$/.exec(d),p=l-(f?f[1]:"").length,h=[];if(e){const t=e();for(const e of t)h.push({label:e,type:"text",detail:"tiddler",boost:cr(e),apply:(t,n,r,s)=>{const a=`[[${e}]]`;t.dispatch({changes:{from:r,to:s,insert:a},selection:{anchor:r+a.length}})}})}const m=new Set;if(t)for(const e of t())m.add(e);for(const e of fr)m.add(e);const g=ur(a.state.doc.toString());for(const e of g.macros)m.add(e);for(const e of m)h.push({label:e,type:"function",detail:"macro",boost:2,apply:(t,n,r,s)=>{const a=`<<${e}>>`;t.dispatch({changes:{from:r,to:s,insert:a},selection:{anchor:r+a.length-2}})}});const k=new Set;if(n)for(const e of n())k.add(e);for(const e of yr)k.add(e);for(const e of g.widgets)k.add(e);for(const e of k)h.push({label:e,type:"type",detail:"widget",boost:1,apply:(t,n,r,s)=>{const a=`<$${e}></$${e}>`,i=r+e.length+3;t.dispatch({changes:{from:r,to:s,insert:a},selection:{anchor:i}})}});const b=new Set;if(r)for(const e of r())b.add(e);for(const e of g.functions)b.add(e);for(const e of b)m.has(e)||h.push({label:e,type:"function",detail:"function",boost:2,apply:(t,n,r,s)=>{const a=`<<${e}>>`;t.dispatch({changes:{from:r,to:s,insert:a},selection:{anchor:r+a.length-2}})}});const x=new Set;if(s)for(const e of s())x.add(e);for(const e of ir)x.add(e);for(const e of g.procedures)x.add(e);for(const e of x)m.has(e)||b.has(e)||h.push({label:e,type:"variable",detail:"variable",boost:1,apply:(t,n,r,s)=>{const a=`<<${e}>>`;t.dispatch({changes:{from:r,to:s,insert:a},selection:{anchor:r+a.length-2}})}});for(const e of Fr){const t=sr.has(e);h.push({label:e,type:"keyword",detail:t?"html (self-closing)":"html",boost:0,apply:(n,r,s,a)=>{let i,l;t?(i=`<${e}>`,l=s+i.length):(i=`<${e}></${e}>`,l=s+e.length+2),n.dispatch({changes:{from:s,to:a,insert:i},selection:{anchor:l}})}})}return 0===h.length?null:{from:p,to:l,options:h,validFor:/^\w*$/}}}function Qr(e,t,n){let r=0;const s="```"===n?/^(\s*)```/:/^(\s*)\$\$\$/;for(let n=1;n<t;n++){const t=e.line(n);s.test(t.text)&&r++}return r%2==1}function Gr(e){let t=i.syntaxTree(e.state).resolveInner(e.pos,-1);for(;t&&!t.type.isTop;){if("Highlight"===t.name||"StyledBlock"===t.name){const n=e.state.doc.sliceString(t.from,e.pos);return n.startsWith("@@")?n.slice(2):null}t=t.parent}const n=e.state.doc.lineAt(e.pos),r=e.state.doc.sliceString(n.from,e.pos);if(r.startsWith("@@")){if(e.state.doc.sliceString(e.pos,n.to).includes("@@")){const t=e.state.doc.sliceString(n.from,n.to),s=t.indexOf("@@"),a=t.indexOf("@@",s+2);if(-1!==a){const t=e.pos-n.from;return t>s+2&&t<=a?r.slice(2):null}}return r.slice(2)}let s=n.number-1;for(;s>=1;){const t=e.state.doc.line(s).text;if("@@"===t.trim())return null;if(t.startsWith("@@")){return t.slice(2).includes("@@")?null:r}s--}return null}function Jr(e,t){return function(n){if(!e)return null;let r=Gr(n);const s=null!==r;if(null===r&&(r=function(e,t){let n=i.syntaxTree(e.state).resolveInner(e.pos,-1);for(;n&&!n.type.isTop;){if("AttributeString"===n.name){const r=n.parent;if("Attribute"===r?.name){const s=r.getChild("AttributeName");if(s&&"style"===e.state.doc.sliceString(s.from,s.to)){const s=r.parent;if(s&&("Widget"===s.name||"InlineWidget"===s.name)){const n=s.getChild("WidgetName");if(n&&t){const r=t(e.state.doc.sliceString(n.from,n.to));if(r&&!r.includes("style"))return null}}return e.state.doc.sliceString(n.from+1,e.pos)}}return null}n=n.parent}const r=e.state.doc.lineAt(e.pos),s=e.state.doc.sliceString(r.from,e.pos),a=/style=["']([^"']*)$/.exec(s);if(a){const e=/<(\$[a-zA-Z][a-zA-Z0-9-]*)[^>]*style=["'][^"']*$/.exec(s);if(e&&t){const n=t(e[1]);if(n&&!n.includes("style"))return null}return a[1]}return null}(n,t)),null===r)return null;if(s&&/\.[a-zA-Z_-]*$/.test(r))return null;if(/:[^;]*$/.test(r))return null;const a=/(?:^|;)\s*([a-zA-Z-]*)$/.exec(r);if(!a)return null;const l=a[1],o=n.pos-l.length,c=e();if(!c||0===c.length)return null;const d=l.toLowerCase(),u=c.filter(e=>e.toLowerCase().startsWith(d));if(0===u.length)return null;const f=u.map(e=>({label:e,type:"property",detail:"CSS property",apply:e+":"}));return{from:o,to:n.pos,options:f,validFor:/^[a-zA-Z-]*$/}}}const Yr=o.html({matchClosingTags:!1});function es(e={}){const{codeLanguages:t,defaultCodeLanguage:s,addKeymap:a=!0,base:{parser:c}=kn,completeHTMLTags:d=!0,completeWidgets:u=!0,completeMacros:f=!0,completeTiddlers:p=!0,completeFilterOperators:h=!0,completeFilterRunPrefixes:m=!0,getTiddlerTitles:g,getImageTiddlerTitles:k,getMacroNames:b,getMacroParams:x,getWidgetNames:y,getWidgetAttributes:$,getFilterOperators:w,getFieldNames:T,getTagNames:M,getTypeNames:S,getFileExtensions:C,getFunctionNames:P,getVariableNames:L,getTiddlerIndexes:v,getTiddlerFields:A,getStoryViews:E,getDeserializers:B,getPageClasses:I,getCSSProperties:N,getCSSValues:F,htmlTagLanguage:W=Yr,getSelfClosingWidgets:O,getWikiRules:D,disableCamelCaseLinks:H=!1,enableKaTeX:z=!1,getTabOutsideListBehavior:_,getShiftTabOutsideListBehavior:Z,getEnterIndentBehavior:V,getFilterBracketMode:R,skipNestedLanguageExtensions:K=!1,nestedLanguageExtensions:X,nestedLanguageCompletionSources:j,nestedLanguageCompletions:U}=e;if(!(c instanceof rn))throw new RangeError("Base parser provided to `tiddlywiki` should be a TiddlyWiki parser");const q=e.extensions?[e.extensions]:[];H&&q.push({remove:["CamelCaseLink"]}),z&&q.push({parseBlock:[me],parseInline:[Ye]});let Q=null;U&&U.length>0?Q=e=>{for(const t of U)if(t.language&&"function"==typeof t.language.isActiveAt&&t.language.isActiveAt(e.state,e.pos))return t.source(e);return null}:j&&Object.keys(j).length>0&&(Q=e=>{const t=i.syntaxTree(e.state).resolveInner(e.pos,-1).type.name;if(j.javascript){if(["Script","VariableDeclaration","FunctionDeclaration","ExpressionStatement","CallExpression","Identifier","String","Number","PropertyName","Statement","Expression","Block","ArrowFunction","ClassDeclaration","VariableName","PropertyDefinition","MemberExpression","BinaryExpression"].some(e=>t===e||t.includes(e)))return j.javascript(e)}if(j.python){if(["Script","FunctionDefinition","ClassDefinition","ImportStatement","Name"].some(e=>t===e||t.includes(e)))return j.python(e)}if(j.css){if(["StyleSheet","RuleSet","Declaration","Selector","PropertyName","Block"].some(e=>t===e||t.includes(e)))return j.css(e)}if(j.html){if(["Document","Element","OpenTag","CloseTag","TagName","Attribute"].some(e=>t===e||t.includes(e)))return j.html(e)}if(j.go){if(["SourceFile","FunctionDecl","VarDecl","TypeDecl","PackageClause","ImportDecl"].some(e=>t===e||t.includes(e)))return j.go(e)}if(j.sql){if(["Script","Statement","Keyword","Identifier","String","Number"].some(e=>t===e||t.includes(e)))return j.sql(e)}if(j.latex){if(["Document","Command","Environment","Group","Text"].some(e=>t===e||t.includes(e)))return j.latex(e)}if(j.sass||j.scss){if(["StyleSheet","RuleSet","Declaration","Selector","Mixin","Include"].some(e=>t===e||t.includes(e))){return(j.sass||j.scss)(e)}}return null});const G=function(e){return t=>{const n=t.pos,r=t.state.doc.lineAt(n),s=t.state.doc.sliceString(r.from,n),a=/^(\s*)```(\w*)$/.exec(s);if(!a)return null;if(Qr(t.state.doc,r.number,"```"))return null;const i=a[1],l=a[2],o=r.from+i.length+3,c=new Set,d=[];if(e&&Array.isArray(e))for(const t of e){const e=t.name.toLowerCase();if(c.has(e)||(c.add(e),d.push({label:e,type:"keyword",detail:"language",boost:10})),t.alias)for(const n of t.alias){const t=n.toLowerCase();c.has(t)||(c.add(t),d.push({label:t,type:"keyword",detail:`language (${e})`,boost:8}))}}if(0===d.length)return null;const u=l.toLowerCase(),f=u?d.filter(e=>e.label.toLowerCase().startsWith(u)):d;return 0===f.length?null:{from:o,to:n,options:f,validFor:/^\w*$/}}}(t),J=function(e,t){return n=>{const r=n.pos,s=n.state.doc.lineAt(r),a=n.state.doc.sliceString(s.from,r),i=/^(\s*)\$\$\$([\w\/\-\.\+]*)$/.exec(a);if(!i)return null;if(Qr(n.state.doc,s.number,"$$$"))return null;const l=i[1],o=s.from+l.length+3,c=[],d=new Set;if(e){const t=e();for(const e of t)d.has(e)||(d.add(e),c.push({label:e,type:"type",detail:"content type",boost:10}))}if(t){const e=t();for(const t of e){const e=t.startsWith(".")?t:"."+t;d.has(e)||(d.add(e),c.push({label:e,type:"type",detail:"file extension",boost:8}))}}return 0===c.length?null:{from:o,to:r,options:c,validFor:/^[\w\/\-\.\+]*$/}}}(S,C),Y=function(e){return function(t){if(!e)return null;const n=Gr(t);if(null===n)return null;const r=/\.([a-zA-Z_-][a-zA-Z0-9_-]*)?$/.exec(n);if(!r)return null;const s=r[1]||"",a=t.pos-s.length,i=e();if(!i||0===i.length)return null;const l=s.toLowerCase(),o=i.filter(e=>e.toLowerCase().startsWith(l));if(0===o.length)return null;const c=o.map(e=>({label:e,type:"class",detail:"CSS class"}));return{from:a,to:t.pos,options:c,validFor:/^[a-zA-Z_-][a-zA-Z0-9_-]*$/}}}(I),ee=Jr(N,$),te=e=>e?.options?.length>0,ne=[mn,i.indentOnInput(),i.syntaxHighlighting(Yn),l.autocompletion({activateOnTyping:!0,override:[e=>{const t=G(e);if(te(t))return t;const n=J(e);if(te(n))return n;const r=Y(e);if(te(r))return r;const s=ee(e);if(te(s))return s;if(Q){const t=Q(e);if(te(t))return t}const a=e.state.languageDataAt("autocomplete",e.pos);for(const t of a){const n=t(e);if(te(n))return n}return null}]}),r.keymap.of(l.completionKeymap),qn,rr];let re;s instanceof i.LanguageSupport?re=s.language:s&&(re=s);const se=tr(t,re,c,$);if(q.push({wrap:se}),a){const e=er({getTabOutsideListBehavior:_,getShiftTabOutsideListBehavior:Z,getEnterIndentBehavior:V});ne.push(n.Prec.highest(r.keymap.of(e)))}let ae=c;if(q.length>0)for(const e of q)ae=ae.configure(e);const ie=gn(ae);return ne.push(ie.data.of({indentOnInput:/^\s*(<\/[a-zA-Z$][^>]*>|<%\s*(else|elseif|endif)[^%]*%>|\\end\s*)$/})),u&&(ne.push(ie.data.of({autocomplete:wr(y,O)})),ne.push(ie.data.of({autocomplete:Tr(x,$,N)})),ne.push(ie.data.of({autocomplete:xr(b,g,P,L,T,v,E,B,F)})),ne.push(r.EditorView.inputHandler.of((e,t,n,r)=>{if('"'!==r&&"'"!==r)return!1;return"="!==e.state.sliceDoc(Math.max(0,t-1),t)||setTimeout(()=>{null===l.completionStatus(e.state)&&l.startCompletion(e)},10),!1})),ne.push(r.EditorView.inputHandler.of((e,t,n,r)=>{if("_"!==r)return!1;const s=e.state.sliceDoc(Math.max(0,t-3),t);return(s.endsWith("<_")||s.endsWith("<<_"))&&setTimeout(()=>{null===l.completionStatus(e.state)&&l.startCompletion(e)},10),!1})),ne.push(r.EditorView.inputHandler.of((e,t,n,r)=>{if(">"!==r)return!1;if("/"===e.state.sliceDoc(Math.max(0,t-1),t))return!1;let s=i.syntaxTree(e.state).resolveInner(t,-1),a=null,l="",o=!1;for(;s&&!s.type.isTop;){const t=s.name;if("MacroCall"===t||"MacroName"===t)return!1;if("AttributeValue"===t||"AttributeString"===t)return!1;if("InlineWidget"===t||"Widget"===t||"HTMLBlock"===t||"HTMLTag"===t){let n=!1,r=null;const i=s.cursor();if(i.firstChild())do{"WidgetName"!==i.name&&"TagName"!==i.name||(r=i.node),"TagMark"===i.name&&i.from>s.from&&(n=!0)}while(i.nextSibling());if(!n&&r){a=s,l=e.state.sliceDoc(r.from,r.to),o="InlineWidget"===t||"Widget"===t;break}}s=s.parent}if(!a||!l)return!1;if(o){const e=new Set(ar);if(O)for(const t of O())e.add(t);if(e.has(l))return!1}else if(sr.has(l.toLowerCase()))return!1;const c=`</${l}>`;return e.dispatch({changes:{from:t,to:t,insert:">"+c},selection:{anchor:t+1}}),!0}))),f&&(ne.push(ie.data.of({autocomplete:e=>{const{state:t,pos:n}=e,r=t.sliceDoc(Math.max(0,n-50),n),s=/<<__[\w]*$/.exec(r);let a=null;s||(a=/<__[\w]*$/.exec(r));let l=null;s||a||(l=/\$\([\w]*$/.exec(r));let o=null;s||a||l||(o=/\$[\w]+$/.exec(r));const c=s||a||l||o;if(!c)return null;const d=s?"macroSubst":a?"filterSubst":l?"varsubst":"placeholder";let u=i.syntaxTree(t).resolveInner(n,-1);for(;u&&!u.type.isTop;){if("FencedCode"===u.name||"CodeBlock"===u.name||"TypedBlock"===u.name||"CommentBlock"===u.name||"KaTeXBlock"===u.name||"LaTeXContent"===u.name)return null;u=u.parent}const f=mr(t.doc.toString(),n);if(!f||0===f.params.length)return null;if("placeholder"===d&&"define"!==f.type)return null;let p;p="macroSubst"===d?f.params.map(e=>({label:"<<__"+e+"__>>",type:"variable",detail:"parameter",boost:10})):"filterSubst"===d?f.params.map(e=>({label:"<__"+e+"__>",type:"variable",detail:"parameter",boost:10})):"varsubst"===d?f.params.map(e=>({label:"$("+e+")$",type:"variable",detail:"parameter",boost:10})):f.params.map(e=>({label:"$"+e+"$",type:"variable",detail:"parameter",boost:10}));const h="macroSubst"===d?/^<<__[\w]*$/:"filterSubst"===d?/^<__[\w]*$/:"varsubst"===d?/^\$\([\w]*$/:/^\$[\w]*$/;return{from:n-c[0].length,to:n,options:p,validFor:h}}})),ne.push(ie.data.of({autocomplete:pr(b,P,L)})),x&&ne.push(ie.data.of({autocomplete:hr(x)}))),p&&(ne.push(ie.data.of({autocomplete:Br(g,k)})),ne.push(ie.data.of({autocomplete:Ir(g)})),ne.push(ie.data.of({autocomplete:Nr(A,v)}))),d&&(ne.push(ie.data.of({autocomplete:Dr})),ne.push(ie.data.of({autocomplete:Hr(N)})),ne.push(ie.data.of({autocomplete:e=>{const t=e.state.sliceDoc(Math.max(0,e.pos-100),e.pos);return/<[a-zA-Z][^>]*$/.test(t)?/<\$[\w\-\.]*$/.test(t)||/<\$[\w\-\.]+\s+[^>]*$/.test(t)?null:o.htmlCompletionSource(e):null}}))),h&&ne.push(ie.data.of({autocomplete:Pr(w,R)})),m&&ne.push(ie.data.of({autocomplete:vr})),h&&ne.push(ie.data.of({autocomplete:Ar(T)})),h&&ne.push(ie.data.of({autocomplete:Er(g,M,T,P,L,S)})),ne.push(ie.data.of({autocomplete:_r})),ne.push(ie.data.of({autocomplete:Vr})),ne.push(ie.data.of({autocomplete:Xr})),ne.push(ie.data.of({autocomplete:Kr})),ne.push(ie.data.of({autocomplete:Rr})),ne.push(ie.data.of({autocomplete:Ur(D)})),ne.push(ie.data.of({autocomplete:qr(g,b,y,P,L)})),new i.LanguageSupport(ie,ne)}const ts=kn,ns=kn;let rs=null,ss=null;const as=["","text/vnd.tiddlywiki","text/x-tiddlywiki","application/x-tiddler-dictionary"],is="tiddlywikiLanguage",ls=n.Prec.high(r.keymap.of([{key:"Enter",run:wn},{key:"Backspace",run:Mn},{key:"Mod-b",run:Ln},{key:"Mod-i",run:vn},{key:"Mod-u",run:An},{key:"Mod-`",run:Nn},{key:"Mod-k",run:Fn},{key:"Mod-Shift-k",run:Wn},{key:"Mod-1",run:Dn},{key:"Mod-2",run:Hn},{key:"Mod-3",run:zn},{key:"Mod-4",run:_n},{key:"Mod-5",run:Zn},{key:"Mod-6",run:Vn},{key:"Mod-0",run:Rn},{key:"Mod-Shift-8",run:Xn},{key:"Mod-Shift-7",run:jn},{key:"Mod-Shift-c",run:Un}]));function os(e){return{state:e.state,dispatch:e.dispatch.bind(e)}}const cs={tiddlerTitles:null,imageTiddlerTitles:null,tagNames:null,macroNames:null,widgetNames:null,globalWidgetDefs:null,filterOperators:null,wikiRules:null};let ds=!1;function us(){ds||"undefined"!=typeof $tw&&$tw.wiki&&(ds=!0,$tw.wiki.addEventListener("change",e=>{if(!e)return;let t=!1,n=!1,r=!1,s=!1;for(const a of Object.keys(e)){const i=e[a];if((i.deleted||i.created)&&(t=!0,a.startsWith("$:/")&&(r=!0),s=!0,n=!0),i.modified){const e=$tw.wiki.getTiddler(a);if(e){e.fields.tags&&(n=!0),(e.hasTag("$:/tags/Macro")||e.hasTag("$:/tags/Global"))&&(r=!0);(e.fields.type||"").startsWith("image/")&&(s=!0)}}}t&&cs.tiddlerTitles&&(cs.tiddlerTitles.valid=!1),n&&cs.tagNames&&(cs.tagNames.valid=!1),r&&cs.macroNames&&(cs.macroNames.valid=!1),r&&cs.globalWidgetDefs&&(cs.globalWidgetDefs.valid=!1),r&&cs.widgetNames&&(cs.widgetNames.valid=!1),s&&cs.imageTiddlerTitles&&(cs.imageTiddlerTitles.valid=!1)}))}function fs(e,t){const n=cs[e];if(n&&n.valid)return n.data;const r=t();return cs[e]={data:r,valid:!0},r}function ps(){return"undefined"==typeof $tw?[]:(us(),fs("tiddlerTitles",()=>{try{const e=ss?.widget?.wiki||$tw.wiki;if(!e)return[];const t=[];if(e.eachShadowPlusTiddlers)e.eachShadowPlusTiddlers((e,n)=>{t.push(n)});else{const n=e.allTitles?e.allTitles():[],r=e.allShadowTitles?e.allShadowTitles():[];t.push(...n,...r)}return[...new Set(t)].sort((e,t)=>{const n=e.startsWith("$:/");return n!==t.startsWith("$:/")?n?1:-1:e.localeCompare(t)})}catch(e){return[]}}))}function hs(){return"undefined"==typeof $tw?[]:(us(),fs("imageTiddlerTitles",()=>{try{const e=ss?.widget?.wiki||$tw.wiki;if(!e)return[];const t=ss?.widget;return(t?e.filterTiddlers("[all[tiddlers+shadows]is[image]]",t):e.filterTiddlers("[all[tiddlers+shadows]is[image]]"))||[]}catch(e){return[]}}))}function ms(){return"undefined"==typeof $tw?[]:(us(),fs("macroNames",()=>{try{const e=[];$tw.macros&&e.push(...Object.keys($tw.macros));const t=ss?.widget?.wiki||$tw.wiki;if(t){const n=t.filterTiddlers("[all[tiddlers+shadows]tag[$:/tags/Macro]] [all[tiddlers+shadows]tag[$:/tags/Global]]")||[];for(const r of n){const n=t.getTiddler(r);if(n){const t=(n.fields.text||"").matchAll(/\\(?:define|procedure|function)\s+([^\s(]+)/g);for(const n of t)e.push(n[1])}}}return[...new Set(e)]}catch(e){return[]}}))}function gs(e){const t=[];if(e&&e.trim()){const n=e.split(",");for(const e of n){const n=e.trim().split(":")[0].trim();n&&t.push(n)}}return t}function ks(){return"undefined"==typeof $tw?{}:(us(),fs("globalWidgetDefs",()=>{try{const e={},t=ss?.widget?.wiki||$tw.wiki;if(t){const n=t.filterTiddlers("[all[tiddlers+shadows]tag[$:/tags/Macro]] [all[tiddlers+shadows]tag[$:/tags/Global]]")||[];for(const r of n){const n=t.getTiddler(r);if(n){const t=n.fields.text||"",r=/\\widget\s+(\$[^\s(]+)(?:\(([^)]*)\))?/g;let s;for(;null!==(s=r.exec(t));){const n=s[1],r=s[2];if(!e[n]){let a=gs(r);if(0===a.length){const e=t.slice(s.index+s[0].length),n=/^\s*\n?\s*\\parameters\s*\(([^)]*)\)/.exec(e);n&&(a=gs(n[1]))}e[n]=a}}}}}return e}catch(e){return{}}}))}function bs(){return"undefined"==typeof $tw?[]:(us(),fs("widgetNames",()=>{try{const e=[];if($tw.widgets)for(const t of Object.keys($tw.widgets))e.push("$"+t);const t=ks();for(const n of Object.keys(t))e.includes(n)||e.push(n);return e}catch(e){return[]}}))}function xs(){return"undefined"==typeof $tw?[]:fs("filterOperators",()=>{try{const e=ss?.widget?.wiki||$tw.wiki;return e?.filterOperators?Object.keys(e.filterOperators).sort():[]}catch(e){return[]}})}function ys(){return"undefined"==typeof $tw?[]:(us(),fs("tagNames",()=>{try{const e=ss?.widget?.wiki||$tw.wiki;if(!e)return[];const t=ss?.widget;return(t?e.filterTiddlers("[all[tiddlers+shadows]is[tag]]",t):e.filterTiddlers("[all[tiddlers+shadows]is[tag]]"))||[]}catch(e){return[]}}))}function $s(e){if("undefined"==typeof $tw||!e)return[];try{const t=ss?.widget?.wiki||$tw.wiki;if(!t)return[];const n=t.getTiddler(e);return n&&n.fields?Object.keys(n.fields).sort():[]}catch(e){return[]}}function ws(e){if("undefined"==typeof $tw||!e)return[];try{const t=ss?.widget?.wiki||$tw.wiki;if(!t)return[];const n=t.getTiddlerDataCached(e);return n&&"object"==typeof n?Object.keys(n).sort():[]}catch(e){return[]}}function Ts(e){if("undefined"==typeof $tw)return null;try{if($tw.macros&&$tw.macros[e]&&$tw.macros[e].params){const t=$tw.macros[e].params;if(Array.isArray(t))return t.map(e=>e.name)}const t=ss?.widget;if(t?.getVariableInfo){const n=t.getVariableInfo(e);if(n&&n.params&&Array.isArray(n.params))return n.params.map(e=>e.name)}return null}catch(e){return null}}function Ms(e){if("undefined"==typeof $tw)return null;try{const t=ss?.widget;if(t?.getVariableInfo){const n=t.getVariableInfo(e);if(n&&n.params&&Array.isArray(n.params))return n.params.map(e=>e.name)}const n=ks();return n[e]&&n[e].length>0?n[e]:null}catch(e){return null}}function Ss(){const e=ss;return e?.options?.codeLanguages?e.options.codeLanguages:[]}function Cs(){return"undefined"==typeof $tw?[]:fs("wikiRules",()=>{try{const e=[],t=$tw.modules.getModulesByTypeAsHashmap("wikirule");if(!t)return[];for(const n of Object.keys(t)){const r=t[n];if(!r||!r.name)continue;const s=[];r.types&&(r.types.pragma&&s.push("pragma"),r.types.block&&s.push("block"),r.types.inline&&s.push("inline")),e.push({name:r.name,types:s.join(", ")||"unknown"})}return e.sort((e,t)=>e.name.localeCompare(t.name))}catch(e){return[]}})}const Ps=(()=>{if("undefined"==typeof $tw)return!1;try{const e=$tw.wiki?.getTiddlerText("$:/config/WikiParserRules/Inline/wikilink","enable");return"disable"===e}catch(e){return!1}})();function Ls(){if("undefined"==typeof $tw)return!1;try{if($tw.modules&&$tw.modules.forEachModuleOfType){let e=!1;return $tw.modules.forEachModuleOfType("widget",(t,n)=>{n&&(n.latex||n.katex)&&(e=!0)}),e}return!1}catch(e){return!1}}function vs(e,t=!1){const n=e.options||{};return ss=e.engine,es({addKeymap:!1,codeLanguages:Ss(),completeHTMLTags:!1!==n.completeHTMLTags,completeWidgets:!1!==n.completeWidgets,completeMacros:!1!==n.completeMacros,completeTiddlers:!1!==n.completeTiddlers,completeFilterOperators:!1!==n.completeFilterOperators,completeFilterRunPrefixes:!1!==n.completeFilterRunPrefixes,disableCamelCaseLinks:Ps,enableKaTeX:Ls(),skipNestedLanguageExtensions:t,getTiddlerTitles:ps,getImageTiddlerTitles:hs,getMacroNames:ms,getMacroParams:Ts,getWidgetNames:bs,getWidgetAttributes:Ms,getFilterOperators:xs,getTagNames:ys,getTiddlerFields:$s,getTiddlerIndexes:ws,getWikiRules:Cs})}const As={name:"tiddlywiki-syntax",description:"TiddlyWiki5 Wikitext syntax highlighting and editing support",priority:100,init(e){rs=e},condition(e){const t=e.tiddlerType;return as.includes(t||"")},registerCompartments(){if(!rs)return{};const e=rs.state.Compartment;return{[is]:new e}},getExtensions(e){const t=[],n=e.engine,r=n?._compartments,s=vs(e,!1);if(r?.[is]?(t.push(r[is].of(s.language)),s.support&&t.push(s.support)):t.push(s),!e.readOnly){const n=e.engine?.widget?.wiki||("undefined"!=typeof $tw?$tw.wiki:null);"default"===(n?.getTiddlerText?.("$:/config/codemirror-6/editor/keymap","default")??"default")&&t.push(ls)}return t},getCompartmentContent(e){const t=vs(e,!0);return t&&"object"==typeof t&&"language"in t?[t.language]:[]},extendAPI:(e,t)=>({toggleBold:()=>!(e._destroyed||!e.view)&&Ln(os(e.view)),toggleItalic:()=>!(e._destroyed||!e.view)&&vn(os(e.view)),toggleUnderline:()=>!(e._destroyed||!e.view)&&An(os(e.view)),toggleStrikethrough:()=>!(e._destroyed||!e.view)&&En(os(e.view)),toggleSuperscript:()=>!(e._destroyed||!e.view)&&Bn(os(e.view)),toggleSubscript:()=>!(e._destroyed||!e.view)&&In(os(e.view)),toggleInlineCode:()=>!(e._destroyed||!e.view)&&Nn(os(e.view)),insertWikiLink:()=>!(e._destroyed||!e.view)&&Fn(os(e.view)),insertTransclusion:()=>!(e._destroyed||!e.view)&&Wn(os(e.view)),setHeading(t){if(e._destroyed||!e.view)return!1;const n=[null,Dn,Hn,zn,_n,Zn,Vn][t];return!!n&&n(os(e.view))},removeHeading:()=>!(e._destroyed||!e.view)&&Rn(os(e.view)),toggleBulletList:()=>!(e._destroyed||!e.view)&&Xn(os(e.view)),toggleNumberedList:()=>!(e._destroyed||!e.view)&&jn(os(e.view)),insertCodeBlock:()=>!(e._destroyed||!e.view)&&Un(os(e.view))}),registerEvents:(e,t)=>({textOperation(t){if(t&&!e._destroyed&&(null===t.replacement||void 0===t.replacement))switch(t.type){case"toggle-bold":e.toggleBold?.();break;case"toggle-italic":e.toggleItalic?.();break;case"toggle-underline":e.toggleUnderline?.();break;case"toggle-strikethrough":e.toggleStrikethrough?.();break;case"toggle-superscript":e.toggleSuperscript?.();break;case"toggle-subscript":e.toggleSubscript?.();break;case"toggle-code":e.toggleInlineCode?.();break;case"insert-link":e.insertWikiLink?.();break;case"insert-transclusion":e.insertTransclusion?.();break;case"set-heading":"number"==typeof t.level&&e.setHeading?.(t.level);break;case"remove-heading":e.removeHeading?.();break;case"toggle-bullet-list":e.toggleBulletList?.();break;case"toggle-numbered-list":e.toggleNumberedList?.();break;case"insert-code-block":e.insertCodeBlock?.()}}}),destroy(e){}};exports.TiddlyWikiLanguage=ns,exports.default=As,exports.deleteBracketPair=Cn,exports.deleteMarkupBackward=Mn,exports.indentList=Gn,exports.insertCodeBlock=Un,exports.insertHorizontalRule=({state:e,dispatch:t})=>{let n=e.doc.lineAt(e.selection.main.from);return t(e.update({changes:{from:n.to,insert:"\n---\n"},scrollIntoView:!0,userEvent:"input"})),!0},exports.insertMacroCall=({state:e,dispatch:t})=>{let r=e.changeByRange(t=>{if(t.empty)return{range:n.EditorSelection.cursor(t.from+2),changes:{from:t.from,insert:"<<>>"}};{let r=e.doc.sliceString(t.from,t.to);return{range:n.EditorSelection.range(t.from+2,t.from+2+r.length),changes:{from:t.from,to:t.to,insert:`<<${r}>>`}}}});return t(e.update(r,{scrollIntoView:!0,userEvent:"input"})),!0},exports.insertNewlineContinueMarkup=wn,exports.insertNewlineContinueMarkupCommand=$n,exports.insertTransclusion=Wn,exports.insertWikiLink=Fn,exports.listMarkerDowngrade=Qn,exports.listMarkerUpgradeHandler=qn,exports.outdentList=Jn,exports.plugin=As,exports.removeHeading=Rn,exports.setHeading1=Dn,exports.setHeading2=Hn,exports.setHeading3=zn,exports.setHeading4=_n,exports.setHeading5=Zn,exports.setHeading6=Vn,exports.tiddlywiki=es,exports.tiddlywikiBaseLanguage=ts,exports.tiddlywikiLanguage=kn,exports.toggleBold=Ln,exports.toggleBulletList=Xn,exports.toggleInlineCode=Nn,exports.toggleItalic=vn,exports.toggleNumberedList=jn,exports.toggleStrikethrough=En,exports.toggleSubscript=In,exports.toggleSuperscript=Bn,exports.toggleUnderline=An;
